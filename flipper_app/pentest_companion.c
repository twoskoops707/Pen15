#include <furi.h>
#include <furi_hal.h>
#include <gui/gui.h>
#include <gui/view.h>
#include <gui/view_dispatcher.h>
#include <gui/modules/submenu.h>
#include <notification/notification_messages.h>
#include <cli/cli.h>

typedef struct {
    Gui* gui;
    ViewDispatcher* view_dispatcher;
    Submenu* submenu;
    NotificationApp* notifications;
} PentestCompanion;

typedef enum {
    PentestCompanionViewSubmenu,
} PentestCompanionView;

// Command handlers
void pentest_subghz_rx_handler(Cli* cli, FuriString* args, void* context) {
    UNUSED(context);
    uint32_t frequency = 433920000; // Default 433.92 MHz

    if(furi_string_size(args) > 0) {
        frequency = atoi(furi_string_get_cstr(args));
    }

    printf("SubGHz RX started on %lu Hz\r\n", frequency);
    printf("Listening for signals...\r\n");

    // TODO: Actual SubGHz RX implementation using furi_hal_subghz
    // This requires accessing the CC1101 radio chip
}

void pentest_subghz_tx_handler(Cli* cli, FuriString* args, void* context) {
    UNUSED(context);
    printf("SubGHz TX: %s\r\n", furi_string_get_cstr(args));

    // TODO: Transmit SubGHz signal
}

void pentest_rfid_read_handler(Cli* cli, FuriString* args, void* context) {
    UNUSED(context);
    UNUSED(args);

    printf("RFID Read started...\r\n");

    // TODO: Read RFID card using furi_hal_rfid
}

void pentest_nfc_read_handler(Cli* cli, FuriString* args, void* context) {
    UNUSED(context);
    UNUSED(args);

    printf("NFC Read started...\r\n");

    // TODO: Read NFC card
}

void pentest_gpio_set_handler(Cli* cli, FuriString* args, void* context) {
    UNUSED(context);
    printf("GPIO: %s\r\n", furi_string_get_cstr(args));

    // TODO: Set GPIO pin
}

// Register CLI commands
void pentest_companion_cli_init() {
    Cli* cli = furi_record_open(RECORD_CLI);

    cli_add_command(cli, "subghz_rx", CliCommandFlagDefault, pentest_subghz_rx_handler, NULL);
    cli_add_command(cli, "subghz_tx", CliCommandFlagDefault, pentest_subghz_tx_handler, NULL);
    cli_add_command(cli, "rfid_read", CliCommandFlagDefault, pentest_rfid_read_handler, NULL);
    cli_add_command(cli, "nfc_read", CliCommandFlagDefault, pentest_nfc_read_handler, NULL);
    cli_add_command(cli, "gpio_set", CliCommandFlagDefault, pentest_gpio_set_handler, NULL);

    furi_record_close(RECORD_CLI);
}

// App entry point
int32_t pentest_companion_app(void* p) {
    UNUSED(p);

    PentestCompanion* app = malloc(sizeof(PentestCompanion));

    // Initialize CLI commands
    pentest_companion_cli_init();

    app->gui = furi_record_open(RECORD_GUI);
    app->notifications = furi_record_open(RECORD_NOTIFICATION);

    app->view_dispatcher = view_dispatcher_alloc();
    view_dispatcher_enable_queue(app->view_dispatcher);

    app->submenu = submenu_alloc();
    submenu_add_item(app->submenu, "SubGHz Operations", 0, NULL, app);
    submenu_add_item(app->submenu, "RFID Operations", 1, NULL, app);
    submenu_add_item(app->submenu, "NFC Operations", 2, NULL, app);
    submenu_add_item(app->submenu, "GPIO Operations", 3, NULL, app);
    submenu_add_item(app->submenu, "About", 4, NULL, app);

    view_dispatcher_add_view(
        app->view_dispatcher, PentestCompanionViewSubmenu, submenu_get_view(app->submenu));

    view_dispatcher_attach_to_gui(app->view_dispatcher, app->gui, ViewDispatcherTypeFullscreen);
    view_dispatcher_switch_to_view(app->view_dispatcher, PentestCompanionViewSubmenu);

    // Show notification that app is ready
    notification_message(app->notifications, &sequence_success);

    // Run dispatcher
    view_dispatcher_run(app->view_dispatcher);

    // Cleanup
    view_dispatcher_remove_view(app->view_dispatcher, PentestCompanionViewSubmenu);
    submenu_free(app->submenu);
    view_dispatcher_free(app->view_dispatcher);

    furi_record_close(RECORD_GUI);
    furi_record_close(RECORD_NOTIFICATION);

    free(app);

    return 0;
}
