name: Android CI Build with Debugging

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  debug-and-build:
    runs-on: ubuntu-latest

    steps:
      # ============================================
      # STEP 1: Checkout Repository
      # ============================================
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better debugging

      # ============================================
      # STEP 2: System Environment Diagnostics
      # ============================================
      - name: üîç System Environment Diagnostics
        run: |
          echo "=================================================="
          echo "SYSTEM DIAGNOSTICS"
          echo "=================================================="
          echo ""
          echo "üñ•Ô∏è  Operating System:"
          uname -a
          lsb_release -a || cat /etc/os-release
          echo ""
          echo "üíæ Disk Space:"
          df -h
          echo ""
          echo "üß† Memory:"
          free -h
          echo ""
          echo "‚öôÔ∏è  CPU Info:"
          lscpu | grep -E "Model name|CPU\(s\)|Thread"
          echo ""
          echo "üåê Network:"
          ip addr show || ifconfig
          echo ""
          echo "=================================================="

      # ============================================
      # STEP 3: Repository Structure Validation
      # ============================================
      - name: üìÇ Validate Repository Structure
        run: |
          echo "=================================================="
          echo "REPOSITORY STRUCTURE VALIDATION"
          echo "=================================================="
          echo ""
          echo "üìÅ Project Root Files:"
          ls -lah
          echo ""
          echo "üìÅ App Directory Structure:"
          find app -type f -name "*.gradle" -o -name "*.xml" -o -name "*.kt" | head -20
          echo ""
          echo "‚úÖ Checking Required Files:"

          required_files=(
            "build.gradle"
            "settings.gradle"
            "gradle.properties"
            "app/build.gradle"
            "app/src/main/AndroidManifest.xml"
            "app/src/main/java/com/pentest/dashboard/MainActivity.kt"
          )

          all_present=true
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "  ‚úÖ $file - EXISTS"
            else
              echo "  ‚ùå $file - MISSING"
              all_present=false
            fi
          done

          if [ "$all_present" = false ]; then
            echo ""
            echo "‚ùå ERROR: Required files are missing!"
            exit 1
          fi

          echo ""
          echo "‚úÖ All required files present"
          echo "=================================================="

      # ============================================
      # STEP 4: Gradle Configuration Validation
      # ============================================
      - name: üîß Validate Gradle Configuration
        run: |
          echo "=================================================="
          echo "GRADLE CONFIGURATION VALIDATION"
          echo "=================================================="
          echo ""
          echo "üìÑ build.gradle (root):"
          cat build.gradle
          echo ""
          echo "üìÑ app/build.gradle:"
          cat app/build.gradle
          echo ""
          echo "üìÑ settings.gradle:"
          cat settings.gradle
          echo ""
          echo "üìÑ gradle.properties:"
          cat gradle.properties
          echo ""
          echo "=================================================="

      # ============================================
      # STEP 5: Set up JDK
      # ============================================
      - name: ‚òï Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: ‚úÖ Verify Java Installation
        run: |
          echo "=================================================="
          echo "JAVA ENVIRONMENT VERIFICATION"
          echo "=================================================="
          echo ""
          echo "‚òï Java Version:"
          java -version
          echo ""
          echo "üìç JAVA_HOME:"
          echo $JAVA_HOME
          echo ""
          echo "üîç Which Java:"
          which java
          echo ""
          echo "=================================================="

      # ============================================
      # STEP 6: Generate Gradle Wrapper
      # ============================================
      - name: üîÑ Generate Gradle Wrapper
        run: |
          echo "=================================================="
          echo "GRADLE WRAPPER GENERATION"
          echo "=================================================="
          echo ""

          if [ -f "gradlew" ]; then
            echo "‚úÖ gradlew already exists"
            ls -lah gradlew
          else
            echo "‚ö†Ô∏è  gradlew not found, generating..."
            # Install Gradle 8.5 (compatible with AGP 8.2.0 and Kotlin 1.9.20)
            wget https://services.gradle.org/distributions/gradle-8.5-bin.zip
            unzip -q gradle-8.5-bin.zip
            gradle-8.5/bin/gradle wrapper --gradle-version 8.5
            echo ""
            echo "‚úÖ Gradle wrapper generated:"
            ls -lah gradlew gradle/
          fi

          echo ""
          echo "üìÑ Gradle Wrapper Properties:"
          cat gradle/wrapper/gradle-wrapper.properties || echo "‚ö†Ô∏è  gradle-wrapper.properties not found"
          echo ""
          echo "=================================================="

      - name: üîê Grant Execute Permission for gradlew
        run: |
          chmod +x gradlew
          echo "‚úÖ Execute permission granted to gradlew"
          ls -lah gradlew

      # ============================================
      # STEP 7: Gradle Dependencies Check
      # ============================================
      - name: üì¶ Check Gradle Dependencies
        run: |
          echo "=================================================="
          echo "GRADLE DEPENDENCIES CHECK"
          echo "=================================================="
          echo ""
          ./gradlew dependencies --configuration debugCompileClasspath || echo "‚ö†Ô∏è  Dependencies check completed with warnings"
          echo ""
          echo "=================================================="

      # ============================================
      # STEP 8: Pre-Build Validation
      # ============================================
      - name: üîç Pre-Build Validation
        run: |
          echo "=================================================="
          echo "PRE-BUILD VALIDATION"
          echo "=================================================="
          echo ""

          echo "üìã Running Gradle Tasks List:"
          ./gradlew tasks --all
          echo ""

          echo "üìä Project Information:"
          ./gradlew projects
          echo ""

          echo "üîç Build Environment:"
          ./gradlew --version
          echo ""

          echo "=================================================="

      # ============================================
      # STEP 9: Clean Build (Remove Old Artifacts)
      # ============================================
      - name: üßπ Clean Build Directory
        run: |
          echo "=================================================="
          echo "CLEANING BUILD DIRECTORY"
          echo "=================================================="
          echo ""

          echo "üìä Before Clean:"
          du -sh app/build 2>/dev/null || echo "No build directory yet"
          echo ""

          ./gradlew clean
          echo ""

          echo "‚úÖ Clean completed"
          echo "=================================================="

      # ============================================
      # STEP 10: Build Debug APK (Verbose)
      # ============================================
      - name: üèóÔ∏è  Build Debug APK
        run: |
          echo "=================================================="
          echo "BUILDING DEBUG APK"
          echo "=================================================="
          echo ""

          ./gradlew assembleDebug \
            --stacktrace \
            --info \
            --warning-mode all \
            --build-cache

          echo ""
          echo "=================================================="

      # ============================================
      # STEP 11: Post-Build Validation
      # ============================================
      - name: ‚úÖ Validate Build Output
        run: |
          echo "=================================================="
          echo "POST-BUILD VALIDATION"
          echo "=================================================="
          echo ""

          APK_PATH="app/build/outputs/apk/debug/app-debug.apk"

          if [ -f "$APK_PATH" ]; then
            echo "‚úÖ APK Generated Successfully!"
            echo ""
            echo "üì¶ APK Details:"
            ls -lh $APK_PATH
            echo ""
            echo "üìä APK Size:"
            du -h $APK_PATH
            echo ""
            echo "üîç APK Info (using aapt):"
            # Try to get APK info if aapt is available
            if command -v aapt &> /dev/null; then
              aapt dump badging $APK_PATH | grep -E "package|sdkVersion|targetSdkVersion|application-label"
            else
              echo "‚ö†Ô∏è  aapt not available, skipping APK analysis"
            fi
            echo ""
            echo "üìÇ Build Outputs Directory:"
            find app/build/outputs -type f -name "*.apk" -o -name "*.aab"
          else
            echo "‚ùå ERROR: APK not found at $APK_PATH"
            echo ""
            echo "üìÇ Checking build/outputs directory:"
            ls -lR app/build/outputs/ || echo "Build outputs directory not found"
            exit 1
          fi

          echo ""
          echo "=================================================="

      # ============================================
      # STEP 12: Upload Debug APK
      # ============================================
      - name: üì§ Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: pentest-dashboard-debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30
          if-no-files-found: error

      # ============================================
      # STEP 13: Build Outputs Summary
      # ============================================
      - name: üìã Build Summary
        run: |
          echo "=================================================="
          echo "BUILD SUMMARY"
          echo "=================================================="
          echo ""
          echo "‚úÖ Build Status: SUCCESS"
          echo ""
          echo "üì¶ Artifacts Generated:"
          find app/build/outputs -type f \( -name "*.apk" -o -name "*.aab" \) -exec ls -lh {} \;
          echo ""
          echo "üìä Total Build Size:"
          du -sh app/build
          echo ""
          echo "üéâ APK ready for download in GitHub Actions Artifacts!"
          echo ""
          echo "=================================================="

      # ============================================
      # STEP 14: Optional - Build Release APK
      # ============================================
      - name: üèóÔ∏è  Build Release APK (Unsigned)
        run: |
          echo "=================================================="
          echo "BUILDING RELEASE APK (UNSIGNED)"
          echo "=================================================="
          echo ""

          ./gradlew assembleRelease --stacktrace --info || {
            echo "‚ö†Ô∏è  Release build failed (expected without signing config)"
            echo "This is normal for unsigned builds"
          }

          echo "=================================================="
        continue-on-error: true

      - name: üì§ Upload Release APK (if exists)
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: pentest-dashboard-release-apk
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30
          if-no-files-found: ignore

      # ============================================
      # STEP 15: Lint Check (Code Quality)
      # ============================================
      - name: üîç Run Lint Checks
        run: |
          echo "=================================================="
          echo "RUNNING LINT CHECKS"
          echo "=================================================="
          echo ""

          ./gradlew lint || echo "‚ö†Ô∏è  Lint found issues (non-blocking)"

          if [ -f "app/build/reports/lint-results-debug.html" ]; then
            echo "üìä Lint report generated"
          fi

          echo "=================================================="
        continue-on-error: true

      - name: üì§ Upload Lint Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-report
          path: app/build/reports/lint-results*.html
          retention-days: 30
          if-no-files-found: ignore

      # ============================================
      # STEP 16: Error Diagnostics (Only on Failure)
      # ============================================
      - name: üö® Build Failure Diagnostics
        if: failure()
        run: |
          echo "=================================================="
          echo "BUILD FAILURE DIAGNOSTICS"
          echo "=================================================="
          echo ""

          echo "‚ùå Build failed! Collecting diagnostic information..."
          echo ""

          echo "üìÇ Build Logs:"
          find . -name "*.log" -type f -exec echo "--- {} ---" \; -exec cat {} \;
          echo ""

          echo "üìÇ Build Directory Contents:"
          ls -lR app/build/ || echo "Build directory not accessible"
          echo ""

          echo "üìä Gradle Daemon Status:"
          ./gradlew --status || echo "Could not get daemon status"
          echo ""

          echo "=================================================="

      # ============================================
      # STEP 17: Upload Build Logs (Always)
      # ============================================
      - name: üì§ Upload Build Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs
          path: |
            app/build/outputs/logs/
            **/*.log
          retention-days: 7
          if-no-files-found: ignore

  # ============================================
  # JOB 2: Notification (Optional)
  # ============================================
  notify:
    runs-on: ubuntu-latest
    needs: debug-and-build
    if: always()
    steps:
      - name: üì¢ Build Status Notification
        run: |
          if [ "${{ needs.debug-and-build.result }}" == "success" ]; then
            echo "‚úÖ BUILD SUCCESSFUL!"
            echo "Download your APK from the Artifacts section above."
          else
            echo "‚ùå BUILD FAILED!"
            echo "Check the logs above for error details."
          fi
