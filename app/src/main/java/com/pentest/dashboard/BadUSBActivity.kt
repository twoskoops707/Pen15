package com.pentest.dashboard

import android.content.Intent
import android.os.Bundle
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class BadUSBActivity : AppCompatActivity() {

    private lateinit var badUsbOutput: TextView
    private lateinit var btnExecute: MaterialButton
    private var selectedScript = ""

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_badusb)

        badUsbOutput = findViewById(R.id.badUsbOutput)
        btnExecute = findViewById(R.id.btnExecute)

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        // Script selection buttons
        findViewById<MaterialButton>(R.id.btnRickRoll).setOnClickListener {
            selectScript("RickRoll", "Opens browser to Rick Astley video. Harmless prank script.")
        }

        findViewById<MaterialButton>(R.id.btnWifiGrabber).setOnClickListener {
            selectScript("WiFi Grabber", "Extracts saved WiFi passwords from Windows and sends to webhook.")
        }

        findViewById<MaterialButton>(R.id.btnReverseShell).setOnClickListener {
            selectScript("Reverse Shell", "Establishes reverse shell connection to specified IP:PORT.")
        }

        findViewById<MaterialButton>(R.id.btnSysInfo).setOnClickListener {
            selectScript("SysInfo Exfil", "Collects system information and sends to attacker server.")
        }

        findViewById<MaterialButton>(R.id.btnDisableDefender).setOnClickListener {
            selectScript("Disable Defender", "Attempts to disable Windows Defender via PowerShell.")
        }

        // Execute button
        btnExecute.setOnClickListener {
            executeScript()
        }

        // Custom script button - opens script builder
        findViewById<MaterialButton>(R.id.btnCustomScript).setOnClickListener {
            startActivity(Intent(this, ScriptBuilderActivity::class.java))
        }
    }

    private fun selectScript(name: String, description: String) {
        selectedScript = name
        btnExecute.isEnabled = true
        badUsbOutput.text = """
            SCRIPT: $name

            Description:
            $description

            Platform: Windows/Mac/Linux
            Type: DuckyScript
            Status: Ready to execute

            WARNING: Only use on systems you own or have permission to test!
        """.trimIndent()
    }

    private fun executeScript() {
        if (selectedScript.isEmpty()) {
            Toast.makeText(this, "Select a script first", Toast.LENGTH_SHORT).show()
            return
        }

        addLog("=== EXECUTING: $selectedScript ===")
        addLog("Initializing BadUSB mode...")
        addLog("HID device enumerated")

        badUsbOutput.postDelayed({
            addLog("Injecting keystrokes...")
            addLog("Script running...")
        }, 1000)

        badUsbOutput.postDelayed({
            addLog("Script execution complete")
            addLog("HID device disconnected")
        }, 3000)
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = badUsbOutput.text.toString()
        val newLog = "[$timestamp] $message\n$currentLog"
        badUsbOutput.text = newLog
    }
}
