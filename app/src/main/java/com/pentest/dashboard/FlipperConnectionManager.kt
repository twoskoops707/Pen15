package com.pentest.dashboard

import android.content.Context

/**
 * Singleton manager for Flipper Zero connection
 * Handles both USB and Bluetooth connections and provides unified interface
 */
object FlipperConnectionManager {

    var usbManager: FlipperUSBManager? = null
        private set

    var bluetoothManager: FlipperBluetoothManager? = null
        private set

    var connectionType: String = "" // "usb" or "bluetooth"
        private set

    fun initialize(context: Context) {
        if (usbManager == null) {
            usbManager = FlipperUSBManager(context)
        }
        if (bluetoothManager == null) {
            bluetoothManager = FlipperBluetoothManager(context)
        }
    }

    fun isConnected(): Boolean {
        return when (connectionType) {
            "usb" -> usbManager?.isConnected() == true
            "bluetooth" -> bluetoothManager != null && connectionType == "bluetooth"
            else -> false
        }
    }

    fun sendCommand(command: String): Boolean {
        return when (connectionType) {
            "usb" -> usbManager?.sendCommand(command) == true
            "bluetooth" -> {
                // Ensure command ends with \r\n
                val cmd = if (!command.endsWith("\r\n") && !command.endsWith("\n")) {
                    "$command\r\n"
                } else {
                    command
                }
                bluetoothManager?.sendCommand(cmd) == true
            }
            else -> false
        }
    }

    fun setConnectionType(type: String) {
        connectionType = type
    }

    fun setDataReceivedCallback(callback: (String) -> Unit) {
        usbManager?.setDataReceivedCallback(callback)
        bluetoothManager?.setDataReceivedCallback(callback)
    }

    fun disconnect() {
        when (connectionType) {
            "usb" -> usbManager?.disconnect()
            "bluetooth" -> bluetoothManager?.disconnect()
        }
        connectionType = ""
    }

    fun cleanup() {
        usbManager?.cleanup()
        bluetoothManager?.disconnect()
        connectionType = ""
    }
}
