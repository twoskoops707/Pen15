package com.pentest.dashboard

import android.os.Bundle
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class RFIDActivity : AppCompatActivity() {

    private lateinit var cardStatus: TextView
    private lateinit var cardId: TextView
    private lateinit var cardInfo: TextView
    private lateinit var btnSaveCard: MaterialButton
    private lateinit var btnEmulateCard: MaterialButton

    private var hasCard = false

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_rfid)

        cardStatus = findViewById(R.id.cardStatus)
        cardId = findViewById(R.id.cardId)
        cardInfo = findViewById(R.id.cardInfo)
        btnSaveCard = findViewById(R.id.btnSaveCard)
        btnEmulateCard = findViewById(R.id.btnEmulateCard)

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        findViewById<MaterialButton>(R.id.btnReadCard).setOnClickListener {
            readCard()
        }

        btnSaveCard.setOnClickListener {
            Toast.makeText(this, "Card saved to archive", Toast.LENGTH_SHORT).show()
        }

        btnEmulateCard.setOnClickListener {
            Toast.makeText(this, "Emulating card...", Toast.LENGTH_SHORT).show()
        }

        findViewById<MaterialButton>(R.id.btnRollingCode).setOnClickListener {
            startRollingCodeRecorder()
        }

        findViewById<MaterialButton>(R.id.btnBruteFob).setOnClickListener {
            startBruteFob()
        }

        findViewById<MaterialButton>(R.id.btnSavedCards).setOnClickListener {
            Toast.makeText(this, "Saved Cards - Coming soon", Toast.LENGTH_SHORT).show()
        }
    }

    private fun readCard() {
        cardStatus.text = "READING..."
        cardInfo.text = "Scanning for 125kHz RFID signal..."

        // Simulate card read
        cardStatus.postDelayed({
            hasCard = true
            cardStatus.text = "CARD FOUND"
            cardId.text = "ID: 1A:4B:2C:8D:9F"
            cardInfo.text = """
                Type: EM4100
                ID: 1A:4B:2C:8D:9F
                Frequency: 125 kHz
                Format: H10301
                Facility Code: 042
                Card Number: 12345

                Compatible: Yes
            """.trimIndent()

            btnSaveCard.isEnabled = true
            btnEmulateCard.isEnabled = true
        }, 1500)
    }

    private fun startRollingCodeRecorder() {
        cardStatus.text = "RECORDING..."
        cardInfo.text = """
            === ROLLING CODE RECORDER ===

            Waiting for key presses...
            Press your car key fob button 3 times

            This will capture the rolling code sequence
            and predict the next valid codes.
        """.trimIndent()

        cardStatus.postDelayed({
            cardInfo.text = """
                === ROLLING CODE RECORDER ===

                Press 1: Code captured (0x4A3B2C1D)
                Counter: 145

                Waiting for press 2/3...
            """.trimIndent()
        }, 2000)

        cardStatus.postDelayed({
            cardInfo.text = """
                === ROLLING CODE RECORDER ===

                Press 1: 0x4A3B2C1D (Counter: 145)
                Press 2: 0x4A3B2C1E (Counter: 146)

                Waiting for press 3/3...
            """.trimIndent()
        }, 4000)

        cardStatus.postDelayed({
            cardStatus.text = "CODES CAPTURED"
            cardInfo.text = """
                === ROLLING CODE ANALYSIS ===

                Captured Sequence:
                  Press 1: 0x4A3B2C1D (Counter: 145)
                  Press 2: 0x4A3B2C1E (Counter: 146)
                  Press 3: 0x4A3B2C1F (Counter: 147)

                Algorithm: KeeLoq
                Increment: Sequential (+1)

                PREDICTED NEXT CODES:
                  Next: 0x4A3B2C20 (Counter: 148)
                  +1:   0x4A3B2C21 (Counter: 149)
                  +2:   0x4A3B2C22 (Counter: 150)

                Ready to replay or emulate!
            """.trimIndent()
        }, 6000)
    }

    private fun startBruteFob() {
        cardStatus.text = "BRUTE FORCING..."
        cardInfo.text = """
            === BRUTE FOB OPENER ===

            Target: HID Proximity Cards (H10301)
            Facility Code: 042
            Range: 00001 to 65535

            Starting attack...
        """.trimIndent()

        cardStatus.postDelayed({
            cardInfo.text = """
                === BRUTE FOB OPENER ===

                Progress: 1245 / 65535 (1.9%)
                Current: FC:042 CN:01245

                Transmitting codes at 125 kHz...
                Estimated time: 18 hours

                (Use card reader to test immediately)
            """.trimIndent()
        }, 2000)

        cardStatus.postDelayed({
            cardStatus.text = "POSSIBLE MATCH"
            cardInfo.text = """
                === BRUTE FOB OPENER ===

                ! DOOR RESPONSE DETECTED !

                Working Code Found:
                  Facility Code: 042
                  Card Number: 12345
                  Full ID: 1A:4B:2C:8D:9F

                Attack paused - verify manually
                Code saved to archive
            """.trimIndent()
        }, 5000)
    }
}
