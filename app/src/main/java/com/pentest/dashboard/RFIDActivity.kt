package com.pentest.dashboard

import android.os.Bundle
import android.view.View
import android.widget.ImageView
import android.widget.LinearLayout
import android.widget.ProgressBar
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton
import com.google.android.material.floatingactionbutton.ExtendedFloatingActionButton
import com.google.android.material.tabs.TabLayout
import java.io.File

class RFIDActivity : AppCompatActivity() {

    // Views
    private lateinit var tabLayout: TabLayout
    private lateinit var fabControl: ExtendedFloatingActionButton
    private lateinit var cardId: TextView
    private lateinit var cardInfo: TextView
    private lateinit var tagType: TextView
    private lateinit var signalStrength: TextView
    private lateinit var statusBadge: TextView
    private lateinit var progressBar: ProgressBar

    // State containers
    private lateinit var idleState: LinearLayout
    private lateinit var scanningState: LinearLayout
    private lateinit var resultsState: LinearLayout

    // Buttons
    private lateinit var btnSaveCard: MaterialButton
    private lateinit var btnEmulateCard: MaterialButton
    private lateinit var btnBruteFob: MaterialButton
    private lateinit var btnRollingCode: MaterialButton

    // State
    private var currentMode = "READ"
    private var isScanning = false
    private var hasCard = false
    private var lastCardData: String? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_rfid)

        ProcessManager.stopCurrentProcess(this)
        initViews()
        setupTabs()
        setupFAB()
        setupButtons()
        showIdleState()
    }

    private fun initViews() {
        tabLayout = findViewById(R.id.tabLayout)
        fabControl = findViewById(R.id.fabControl)
        cardId = findViewById(R.id.cardId)
        cardInfo = findViewById(R.id.cardInfo)
        tagType = findViewById(R.id.tagType)
        signalStrength = findViewById(R.id.signalStrength)
        statusBadge = findViewById(R.id.statusBadge)
        progressBar = findViewById(R.id.progressBar)

        idleState = findViewById(R.id.idleState)
        scanningState = findViewById(R.id.scanningState)
        resultsState = findViewById(R.id.resultsState)

        btnSaveCard = findViewById(R.id.btnSaveCard)
        btnEmulateCard = findViewById(R.id.btnEmulateCard)
        btnBruteFob = findViewById(R.id.btnBruteFob)
        btnRollingCode = findViewById(R.id.btnRollingCode)

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }
    }

    private fun setupTabs() {
        tabLayout.addOnTabSelectedListener(object : TabLayout.OnTabSelectedListener {
            override fun onTabSelected(tab: TabLayout.Tab?) {
                when (tab?.position) {
                    0 -> switchMode("READ")
                    1 -> switchMode("EMULATE")
                    2 -> switchMode("SAVED")
                }
            }
            override fun onTabUnselected(tab: TabLayout.Tab?) {}
            override fun onTabReselected(tab: TabLayout.Tab?) {}
        })
    }

    private fun setupFAB() {
        fabControl.setOnClickListener {
            when (currentMode) {
                "READ" -> startRead()
                "EMULATE" -> startEmulate()
                "SAVED" -> showSavedCards()
            }
        }
    }

    private fun setupButtons() {
        btnSaveCard.setOnClickListener {
            if (hasCard) {
                Toast.makeText(this, "Card saved to Flipper", Toast.LENGTH_SHORT).show()
            }
        }

        btnEmulateCard.setOnClickListener {
            if (hasCard) {
                startEmulate()
            }
        }

        btnBruteFob.setOnClickListener {
            Toast.makeText(this, "Brute force - Coming soon", Toast.LENGTH_SHORT).show()
        }

        btnRollingCode.setOnClickListener {
            Toast.makeText(this, "Rolling code - Coming soon", Toast.LENGTH_SHORT).show()
        }
    }

    private fun switchMode(mode: String) {
        currentMode = mode
        statusBadge.text = mode

        when (mode) {
            "READ" -> {
                fabControl.text = "START READ"
                fabControl.setIconResource(android.R.drawable.ic_media_play)
                statusBadge.setBackgroundColor(0x2200FF41)
            }
            "EMULATE" -> {
                fabControl.text = "START EMULATE"
                fabControl.setIconResource(android.R.drawable.ic_menu_share)
                statusBadge.setBackgroundColor(0x2200FFFF)
            }
            "SAVED" -> {
                fabControl.text = "VIEW SAVED"
                fabControl.setIconResource(android.R.drawable.ic_menu_view)
                statusBadge.setBackgroundColor(0x22FFFF00)
            }
        }

        showIdleState()
    }

    private fun showIdleState() {
        idleState.visibility = View.VISIBLE
        scanningState.visibility = View.GONE
        resultsState.visibility = View.GONE
        isScanning = false
    }

    private fun showScanningState() {
        idleState.visibility = View.GONE
        scanningState.visibility = View.VISIBLE
        resultsState.visibility = View.GONE
        isScanning = true
    }

    private fun showResultsState() {
        idleState.visibility = View.GONE
        scanningState.visibility = View.GONE
        resultsState.visibility = View.VISIBLE
        isScanning = false
    }

    private fun startRead() {
        showScanningState()
        statusBadge.text = "SCANNING"
        fabControl.text = "STOP"
        fabControl.setIconResource(android.R.drawable.ic_media_pause)

        val termux = TermuxIntegration(this)
        val outputFile = File(cacheDir, "rfid_output.txt")

        val command = """
            cd /data/data/com.termux/files/home/Pen15/scripts && \
            python3 rfid_read.py > ${outputFile.absolutePath} 2>&1
        """.trimIndent()

        termux.runCommand(command, background = true)

        android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({
            Thread {
                try {
                    Thread.sleep(3000)
                    val output = if (outputFile.exists()) outputFile.readText() else "ERROR|No output"
                    runOnUiThread {
                        parseRFIDOutput(output)
                    }
                } catch (e: Exception) {
                    runOnUiThread {
                        showIdleState()
                        statusBadge.text = "ERROR"
                        fabControl.text = "START READ"
                        fabControl.setIconResource(android.R.drawable.ic_media_play)
                        Toast.makeText(this, "Error: ${e.message}", Toast.LENGTH_SHORT).show()
                    }
                }
            }.start()
        }, 500)
    }

    private fun startEmulate() {
        if (!hasCard && currentMode == "EMULATE") {
            Toast.makeText(this, "Read a card first", Toast.LENGTH_SHORT).show()
            return
        }
        showScanningState()
        statusBadge.text = "EMULATING"
        Toast.makeText(this, "Emulation started", Toast.LENGTH_SHORT).show()
    }

    private fun showSavedCards() {
        Toast.makeText(this, "Saved cards list - Coming soon", Toast.LENGTH_SHORT).show()
    }

    private fun parseRFIDOutput(output: String) {
        when {
            output.contains("SUCCESS") -> {
                val parts = output.lines().last().split("|")
                if (parts.size >= 3 && parts[0] == "SUCCESS") {
                    val type = parts[1]
                    val id = parts[2]

                    hasCard = true
                    lastCardData = "$type|$id"

                    cardId.text = id
                    tagType.text = type
                    cardInfo.text = "Frequency: 125kHz\nFormat: EM4100"

                    showResultsState()
                    statusBadge.text = "CARD FOUND"
                    Toast.makeText(this, "âœ“ Card read successfully", Toast.LENGTH_SHORT).show()
                }
            }

            output.contains("ERROR") -> {
                val error = output.substringAfter("ERROR|")
                showIdleState()
                statusBadge.text = "ERROR"
                Toast.makeText(this, "Error: $error", Toast.LENGTH_LONG).show()
            }

            output.contains("No card") -> {
                showIdleState()
                statusBadge.text = "NO CARD"
                Toast.makeText(this, "No card detected", Toast.LENGTH_SHORT).show()
            }

            else -> {
                showIdleState()
                statusBadge.text = "FAILED"
                Toast.makeText(this, "Unexpected response", Toast.LENGTH_SHORT).show()
            }
        }

        fabControl.text = "START " + currentMode
        fabControl.setIconResource(android.R.drawable.ic_media_play)
    }

    override fun onDestroy() {
        super.onDestroy()
        ProcessManager.stopCurrentProcess(this)
    }
}
