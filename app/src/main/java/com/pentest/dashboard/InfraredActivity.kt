package com.pentest.dashboard

import android.os.Bundle
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class InfraredActivity : AppCompatActivity() {

    private lateinit var irOutput: TextView
    private var flipperUSB: FlipperUSBManager? = null
    private var currentRemoteType = ""

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_infrared)

        irOutput = findViewById(R.id.irOutput)

        flipperUSB = FlipperUSBManager(this)
        flipperUSB?.setDataReceivedCallback { data ->
            runOnUiThread {
                addLog("FLIPPER: $data")
            }
        }

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        // Remote type buttons
        findViewById<MaterialButton>(R.id.btnTV).setOnClickListener {
            selectRemoteType("TV")
        }

        findViewById<MaterialButton>(R.id.btnAC).setOnClickListener {
            selectRemoteType("AC")
        }

        findViewById<MaterialButton>(R.id.btnAudio).setOnClickListener {
            selectRemoteType("Audio")
        }

        findViewById<MaterialButton>(R.id.btnProjector).setOnClickListener {
            selectRemoteType("Projector")
        }

        // Learn button
        findViewById<MaterialButton>(R.id.btnLearn).setOnClickListener {
            learnRemote()
        }

        // Test button
        findViewById<MaterialButton>(R.id.btnTest).setOnClickListener {
            testSignal()
        }

        // Saved remotes button
        findViewById<MaterialButton>(R.id.btnSavedRemotes).setOnClickListener {
            showSavedRemotes()
        }
    }

    private fun selectRemoteType(type: String) {
        currentRemoteType = type
        addLog("=== INFRARED REMOTE: $type ===")
        addLog("Opening Flipper Infrared app...")

        if (flipperUSB?.isConnected() == true) {
            flipperUSB?.sendCommand("loader open Infrared")
            addLog("Sent: loader open Infrared")
            addLog("Remote type: $type selected")
            addLog("Ready to learn or transmit")
        } else {
            Toast.makeText(this, "Connect Flipper Zero via USB first", Toast.LENGTH_LONG).show()
        }
    }

    private fun learnRemote() {
        addLog("=== LEARN IR SIGNAL ===")
        addLog("Opening Infrared app...")

        if (flipperUSB?.isConnected() == true) {
            flipperUSB?.sendCommand("loader open Infrared")

            // Wait then start learning
            irOutput.postDelayed({
                flipperUSB?.sendCommand("ir rx")
                addLog("Sent: ir rx")
                addLog("Point remote at Flipper and press button...")
            }, 2000)
        } else {
            executeViaTermux("learn")
        }
    }

    private fun testSignal() {
        if (currentRemoteType.isEmpty()) {
            Toast.makeText(this, "Select a remote type first", Toast.LENGTH_SHORT).show()
            return
        }

        addLog("=== TRANSMIT IR SIGNAL ===")
        addLog("Transmitting $currentRemoteType command...")

        if (flipperUSB?.isConnected() == true) {
            flipperUSB?.sendCommand("loader open Infrared")

            irOutput.postDelayed({
                flipperUSB?.sendCommand("ir tx /ext/infrared/${currentRemoteType}_Power.ir")
                addLog("Sent: ir tx command")
                addLog("Signal transmitted")
            }, 2000)
        } else {
            executeViaTermux("transmit")
        }
    }

    private fun showSavedRemotes() {
        addLog("=== SAVED IR REMOTES ===")
        addLog("Listing saved remotes on Flipper...")

        if (flipperUSB?.isConnected() == true) {
            flipperUSB?.sendCommand("storage list /ext/infrared")
            addLog("Sent: storage list /ext/infrared")
        } else {
            Toast.makeText(this, "Connect Flipper to view saved remotes", Toast.LENGTH_SHORT).show()
        }
    }

    private fun executeViaTermux(mode: String) {
        addLog("Flipper not connected via USB")
        addLog("Launching Termux script for IR $mode...")

        val irScript = """
            #!/data/data/com.termux/files/usr/bin/bash

            echo "=== INFRARED ${mode.uppercase()} ==="
            echo "This requires:"
            echo "1. Flipper Zero connected via USB"
            echo "2. Infrared app running on Flipper"
            echo ""

            # Try to send command to Flipper
            for dev in /dev/ttyACM0 /dev/ttyUSB0; do
                if [ -e "${'$'}dev" ]; then
                    echo "Found Flipper at: ${'$'}dev"
                    echo "loader open Infrared" > ${'$'}dev
                    sleep 2

                    if [ "$mode" = "learn" ]; then
                        echo "ir rx" > ${'$'}dev
                        echo "Sent IR receive command"
                        echo "Point remote at Flipper and press button"
                    else
                        echo "ir tx /ext/infrared/TV_Power.ir" > ${'$'}dev
                        echo "Sent IR transmit command"
                        echo "Signal transmitted"
                    fi

                    echo "Check Flipper screen for results"
                    exit 0
                fi
            done

            echo "ERROR: Flipper not found on USB"
            echo "Make sure Flipper is connected and USB permission granted"
        """.trimIndent()

        val termux = TermuxIntegration(this)
        termux.runCommand(irScript, background = false)

        Toast.makeText(this, "IR $mode script launched in Termux", Toast.LENGTH_LONG).show()
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = irOutput.text.toString()
        val newLog = "[$timestamp] $message\n$currentLog"
        irOutput.text = newLog
    }

    override fun onDestroy() {
        super.onDestroy()
        flipperUSB?.cleanup()
    }
}
