package com.pentest.dashboard

import android.os.Bundle
import android.view.View
import android.widget.ImageView
import android.widget.ProgressBar
import android.widget.ScrollView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class InfraredActivity : AppCompatActivity() {

    private lateinit var irOutput: TextView
    private lateinit var irOutputScroll: ScrollView
    private lateinit var progressBar: ProgressBar
    private var lastSignalData: String? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_infrared)

        ProcessManager.stopCurrentProcess(this)

        irOutput = findViewById(R.id.irOutput)
        irOutputScroll = findViewById(R.id.irOutputScroll)
        progressBar = findViewById(R.id.progressBar)

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        findViewById<MaterialButton>(R.id.btnLearn).setOnClickListener {
            learnSignal()
        }

        findViewById<MaterialButton>(R.id.btnTest).setOnClickListener {
            Toast.makeText(this, "Test feature - Coming soon", Toast.LENGTH_SHORT).show()
        }

        findViewById<MaterialButton>(R.id.btnSavedRemotes).setOnClickListener {
            Toast.makeText(this, "Saved remotes - Coming soon", Toast.LENGTH_SHORT).show()
        }

        addLog("Infrared Learning Ready")
        addLog("Using pyflipper - REAL Flipper API")
        addLog("")
        addLog("Click LEARN to capture IR remote signals")
    }

    private fun learnSignal() {
        progressBar.visibility = View.VISIBLE
        irOutput.text = ""
        addLog("=== STARTING IR LEARN ===")
        addLog("Running: python infrared_learn.py")

        val termux = TermuxIntegration(this)

        // Run the REAL Python script
        termux.runCommand("cd /data/data/com.termux/files/home/Pen15/scripts && python3 infrared_learn.py") { output ->
            runOnUiThread {
                progressBar.visibility = View.GONE
                parseIROutput(output)
            }
        }
    }

    private fun parseIROutput(output: String) {
        addLog("")
        addLog("=== FLIPPER RESPONSE ===")
        addLog(output)

        when {
            output.contains("SUCCESS") -> {
                val parts = output.lines().last().split("|")
                if (parts.size >= 4 && parts[0] == "SUCCESS") {
                    val protocol = parts[1]
                    val address = parts[2]
                    val command = parts[3]

                    lastSignalData = "$protocol|$address|$command"

                    addLog("")
                    addLog("✅ Protocol: $protocol")
                    addLog("✅ Address: $address")
                    addLog("✅ Command: $command")
                    addLog("")
                    addLog("Signal learned - ready to transmit")

                    Toast.makeText(this, "✓ IR signal learned!", Toast.LENGTH_SHORT).show()
                }
            }

            output.contains("ERROR") -> {
                val error = output.substringAfter("ERROR|")
                addLog("")
                addLog("❌ $error")
                Toast.makeText(this, "Error: $error", Toast.LENGTH_LONG).show()
            }

            output.contains("No signal detected") -> {
                addLog("")
                addLog("⚠️ No signal detected")
                addLog("Point remote at Flipper and press button")
                Toast.makeText(this, "No signal - try again", Toast.LENGTH_SHORT).show()
            }

            else -> {
                addLog("⚠️ Unexpected response")
                Toast.makeText(this, "Check logs", Toast.LENGTH_SHORT).show()
            }
        }
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentText = irOutput.text.toString()
        irOutput.text = "$currentText\n[$timestamp] $message"

        irOutputScroll?.post {
            irOutputScroll.fullScroll(ScrollView.FOCUS_DOWN)
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        ProcessManager.stopCurrentProcess(this)
    }
}
