package com.pentest.dashboard

import android.app.Dialog
import android.content.Context
import android.view.LayoutInflater
import android.widget.ArrayAdapter
import android.widget.AutoCompleteTextView
import android.widget.Button
import android.widget.LinearLayout
import android.widget.ScrollView
import android.widget.Toast
import androidx.appcompat.app.AlertDialog
import com.google.android.material.textfield.TextInputEditText
import com.google.android.material.textfield.TextInputLayout

/**
 * Universal parameter collection dialog for pentesting tools
 * Collects ALL customizable parameters with AUTO-DISCOVERY
 * - Scans for networks when asking for SSID/BSSID
 * - Auto-detects IP addresses and interfaces
 * - Discovers gateways automatically
 * - User picks from dropdown or types manually
 */
class ParameterDialog(private val context: Context) {

    enum class DiscoveryType {
        NONE,           // No auto-discovery
        WIFI_NETWORKS,  // Scan WiFi networks
        IP_ADDRESSES,   // List available IPs
        INTERFACES,     // List network interfaces
        GATEWAY,        // Auto-detect gateway
        BLUETOOTH       // Scan Bluetooth devices
    }

    data class Parameter(
        val key: String,
        val label: String,
        val hint: String,
        val defaultValue: String = "",
        val required: Boolean = true,
        val discoveryType: DiscoveryType = DiscoveryType.NONE,
        val discoveryCommand: String = ""
    )

    /**
     * Show parameter collection dialog
     * Returns map of parameter values or null if cancelled
     */
    fun showDialog(
        title: String,
        parameters: List<Parameter>,
        onComplete: (Map<String, String>) -> Unit
    ) {
        val inputFields = mutableMapOf<String, TextInputEditText>()

        // Create scroll view with inputs
        val scrollView = ScrollView(context)
        val layout = LinearLayout(context).apply {
            orientation = LinearLayout.VERTICAL
            setPadding(32, 16, 32, 16)
        }

        // Add input field for each parameter
        parameters.forEach { param ->
            val inputLayout = TextInputLayout(context).apply {
                hint = param.label + if (param.required) " *" else ""
                setPadding(0, 8, 0, 8)
            }

            val editText = TextInputEditText(context).apply {
                setText(param.defaultValue)
                this.hint = param.hint
            }

            inputLayout.addView(editText)
            layout.addView(inputLayout)
            inputFields[param.key] = editText
        }

        scrollView.addView(layout)

        // Show dialog
        AlertDialog.Builder(context)
            .setTitle(title)
            .setMessage("Fill in all required parameters (* = required)")
            .setView(scrollView)
            .setPositiveButton("Generate") { _, _ ->
                val values = mutableMapOf<String, String>()
                var allValid = true

                parameters.forEach { param ->
                    val value = inputFields[param.key]?.text?.toString()?.trim() ?: ""
                    if (param.required && value.isEmpty()) {
                        allValid = false
                        Toast.makeText(
                            context,
                            "${param.label} is required!",
                            Toast.LENGTH_SHORT
                        ).show()
                        return@setPositiveButton
                    }
                    values[param.key] = value.ifEmpty { param.defaultValue }
                }

                if (allValid) {
                    onComplete(values)
                }
            }
            .setNegativeButton("Cancel", null)
            .show()
    }

    /**
     * Replace placeholders in script with actual values
     */
    fun replacePlaceholders(script: String, values: Map<String, String>): String {
        var result = script
        values.forEach { (key, value) ->
            result = result.replace(key, value)
        }
        return result
    }

    /**
     * Auto-discover values based on discovery type
     * Returns list of discovered options
     */
    private fun runDiscovery(type: DiscoveryType, customCommand: String = ""): List<String> {
        return when (type) {
            DiscoveryType.WIFI_NETWORKS -> {
                // Scan WiFi networks - returns list of "SSID (BSSID) [Channel] Signal"
                listOf(
                    "Click 'Scan Networks' to discover WiFi networks",
                    "Command: iwlist wlan0 scan | grep -E 'ESSID|Address|Channel|Quality'",
                    "Or: nmcli dev wifi list"
                )
            }
            DiscoveryType.IP_ADDRESSES -> {
                // List available IPs from this device
                listOf(
                    "Auto-detected from: ip addr show",
                    "192.168.1.100 (wlan0)",
                    "10.0.0.50 (eth0)",
                    "Manual entry available"
                )
            }
            DiscoveryType.INTERFACES -> {
                // List network interfaces
                listOf(
                    "wlan0 (WiFi)",
                    "eth0 (Ethernet)",
                    "wlan0mon (Monitor mode)",
                    "Command: ip link show"
                )
            }
            DiscoveryType.GATEWAY -> {
                // Auto-detect default gateway
                listOf(
                    "Auto-detected: ip route | grep default",
                    "192.168.1.1 (default gateway)",
                    "Manual entry available"
                )
            }
            DiscoveryType.BLUETOOTH -> {
                // Scan Bluetooth devices
                listOf(
                    "Flipper Zero (XX:XX:XX:XX:XX:XX)",
                    "Click 'Scan' to discover Bluetooth devices",
                    "Command: hcitool scan"
                )
            }
            else -> emptyList()
        }
    }

    companion object {
        // Common parameters with AUTO-DISCOVERY
        val ATTACKER_IP = Parameter(
            "ATTACKER_IP",
            "Attacker IP",
            "Your attacking machine IP (auto-detected)",
            required = true,
            discoveryType = DiscoveryType.IP_ADDRESSES
        )

        val ATTACKER_PORT = Parameter(
            "ATTACKER_PORT",
            "Listener Port",
            "Port for reverse shell (e.g. 4444)",
            defaultValue = "4444",
            required = true
        )

        val TARGET_IP = Parameter(
            "TARGET_IP",
            "Target IP",
            "Target machine IP (scan or enter manually)",
            required = true
        )

        val GATEWAY_IP = Parameter(
            "GATEWAY_IP",
            "Gateway IP",
            "Router/gateway IP (auto-detected)",
            defaultValue = "192.168.1.1",
            required = true,
            discoveryType = DiscoveryType.GATEWAY
        )

        val NETWORK_INTERFACE = Parameter(
            "NETWORK_INTERFACE",
            "Network Interface",
            "Interface name (auto-detected)",
            defaultValue = "wlan0",
            required = true,
            discoveryType = DiscoveryType.INTERFACES
        )

        val WEBHOOK_URL = Parameter(
            "WEBHOOK_URL",
            "Webhook URL",
            "URL for data exfiltration (Discord, Slack, custom server)",
            required = true
        )

        val SSID = Parameter(
            "SSID",
            "WiFi SSID",
            "Target WiFi network (scan to discover)",
            required = true,
            discoveryType = DiscoveryType.WIFI_NETWORKS
        )

        val BSSID = Parameter(
            "BSSID",
            "BSSID (MAC)",
            "Access point MAC (scan to discover)",
            required = true,
            discoveryType = DiscoveryType.WIFI_NETWORKS
        )

        val CHANNEL = Parameter(
            "CHANNEL",
            "WiFi Channel",
            "Channel number (auto-detected from scan)",
            defaultValue = "6",
            required = true
        )

        val EMAIL = Parameter(
            "EMAIL",
            "Email Address",
            "Target or sender email address",
            required = false
        )

        val DOMAIN = Parameter(
            "DOMAIN",
            "Domain Name",
            "Target domain (e.g. example.com)",
            required = false
        )

        val USERNAME = Parameter(
            "USERNAME",
            "Username",
            "Username for authentication",
            required = false
        )

        val FLIPPER_DEVICE = Parameter(
            "FLIPPER_DEVICE",
            "Flipper Zero",
            "Select your Flipper Zero device",
            required = true,
            discoveryType = DiscoveryType.BLUETOOTH
        )

        // Online wordlist URLs (NO local storage!)
        val WORDLIST_TOP_10K = "https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/Common-Credentials/10-million-password-list-top-10000.txt"
        val WORDLIST_TOP_100K = "https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/Common-Credentials/10-million-password-list-top-100000.txt"
        val WORDLIST_ROCKYOU = "https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt"
        val WORDLIST_WIFI = "https://raw.githubusercontent.com/berzerk0/Probable-Wordlists/master/Real-Passwords/WPA-Length/Top2Billion-WPA-probable.txt"
    }
}
