package com.pentest.dashboard

import android.bluetooth.*
import android.content.Context
import android.os.Handler
import android.os.Looper
import android.util.Log
import java.util.*

/**
 * Flipper Zero Bluetooth Serial Communication Manager
 *
 * Handles Bluetooth Low Energy (BLE) communication with Flipper Zero device
 * using the official serial-over-Bluetooth protocol.
 *
 * Protocol Details:
 * - TX Channel: 19ed82ae-ed21-4c9d-4145-228e62fe0000 (Flipper sends data)
 * - RX Channel: 19ed82ae-ed21-4c9d-4145-228e61fe0000 (Flipper receives data)
 * - Service UUID: 8fe5b3d5-2e7f-4a98-2a48-7acc60fe0000
 */
class FlipperBluetoothManager(private val context: Context) {

    companion object {
        private const val TAG = "FlipperBT"

        // Flipper Zero BLE Service and Characteristics UUIDs
        private const val FLIPPER_SERVICE_UUID = "8fe5b3d5-2e7f-4a98-2a48-7acc60fe0000"
        private const val FLIPPER_TX_CHAR_UUID = "19ed82ae-ed21-4c9d-4145-228e62fe0000" // Flipper transmits
        private const val FLIPPER_RX_CHAR_UUID = "19ed82ae-ed21-4c9d-4145-228e61fe0000" // Flipper receives
    }

    private var bluetoothGatt: BluetoothGatt? = null
    private var txCharacteristic: BluetoothGattCharacteristic? = null
    private var rxCharacteristic: BluetoothGattCharacteristic? = null

    private val handler = Handler(Looper.getMainLooper())
    private var connectionCallback: ((Boolean, String) -> Unit)? = null
    private var dataReceivedCallback: ((String) -> Unit)? = null

    private val gattCallback = object : BluetoothGattCallback() {
        override fun onConnectionStateChange(gatt: BluetoothGatt, status: Int, newState: Int) {
            when (newState) {
                BluetoothProfile.STATE_CONNECTED -> {
                    Log.d(TAG, "Connected to Flipper Zero")
                    gatt.discoverServices()
                }
                BluetoothProfile.STATE_DISCONNECTED -> {
                    Log.d(TAG, "Disconnected from Flipper Zero")
                    handler.post {
                        connectionCallback?.invoke(false, "Disconnected")
                    }
                }
            }
        }

        override fun onServicesDiscovered(gatt: BluetoothGatt, status: Int) {
            if (status == BluetoothGatt.GATT_SUCCESS) {
                val service = gatt.getService(UUID.fromString(FLIPPER_SERVICE_UUID))
                if (service != null) {
                    txCharacteristic = service.getCharacteristic(UUID.fromString(FLIPPER_TX_CHAR_UUID))
                    rxCharacteristic = service.getCharacteristic(UUID.fromString(FLIPPER_RX_CHAR_UUID))

                    // Enable notifications for TX characteristic (receiving data from Flipper)
                    txCharacteristic?.let {
                        gatt.setCharacteristicNotification(it, true)
                        val descriptor = it.getDescriptor(
                            UUID.fromString("00002902-0000-1000-8000-00805f9b34fb")
                        )
                        descriptor?.value = BluetoothGattDescriptor.ENABLE_NOTIFICATION_VALUE
                        gatt.writeDescriptor(descriptor)
                    }

                    handler.post {
                        connectionCallback?.invoke(true, "Connected to Flipper Zero")
                    }
                    Log.d(TAG, "Flipper Zero services discovered and configured")
                } else {
                    Log.e(TAG, "Flipper service not found")
                    handler.post {
                        connectionCallback?.invoke(false, "Flipper service not found")
                    }
                }
            }
        }

        override fun onCharacteristicChanged(
            gatt: BluetoothGatt,
            characteristic: BluetoothGattCharacteristic
        ) {
            if (characteristic.uuid == UUID.fromString(FLIPPER_TX_CHAR_UUID)) {
                val data = String(characteristic.value)
                Log.d(TAG, "Received from Flipper: $data")
                handler.post {
                    dataReceivedCallback?.invoke(data)
                }
            }
        }

        override fun onCharacteristicWrite(
            gatt: BluetoothGatt,
            characteristic: BluetoothGattCharacteristic,
            status: Int
        ) {
            if (status == BluetoothGatt.GATT_SUCCESS) {
                Log.d(TAG, "Data sent to Flipper successfully")
            } else {
                Log.e(TAG, "Failed to send data to Flipper")
            }
        }
    }

    /**
     * Connect to Flipper Zero device
     */
    fun connect(device: BluetoothDevice, callback: (Boolean, String) -> Unit) {
        connectionCallback = callback
        bluetoothGatt = device.connectGatt(context, false, gattCallback)
    }

    /**
     * Disconnect from Flipper Zero
     */
    fun disconnect() {
        bluetoothGatt?.disconnect()
        bluetoothGatt?.close()
        bluetoothGatt = null
    }

    /**
     * Send command to Flipper Zero
     */
    fun sendCommand(command: String): Boolean {
        val characteristic = rxCharacteristic ?: return false
        characteristic.value = command.toByteArray()
        return bluetoothGatt?.writeCharacteristic(characteristic) ?: false
    }

    /**
     * Set callback for receiving data from Flipper
     */
    fun setDataReceivedCallback(callback: (String) -> Unit) {
        dataReceivedCallback = callback
    }

    /**
     * Flipper Zero CLI Commands
     */
    object Commands {
        // System Commands
        fun getInfo() = "device_info\r\n"
        fun getStorage() = "storage list /ext\r\n"
        fun getBattery() = "power info\r\n"

        // Sub-GHz Commands
        fun subGhzRx(frequency: Double) = "subghz rx ${frequency * 1000000}\r\n"
        fun subGhzTx(frequency: Double, protocol: String, data: String) =
            "subghz tx $frequency $protocol $data\r\n"
        fun subGhzRead() = "subghz read\r\n"

        // RFID Commands
        fun rfidRead() = "rfid read\r\n"
        fun rfidEmulate(data: String) = "rfid emulate $data\r\n"

        // NFC Commands
        fun nfcDetect() = "nfc detect\r\n"
        fun nfcRead() = "nfc read\r\n"
        fun nfcEmulate(uid: String) = "nfc emulate $uid\r\n"

        // GPIO Commands
        fun gpioMode(pin: Int, mode: String) = "gpio mode $pin $mode\r\n" // mode: input, output
        fun gpioRead(pin: Int) = "gpio read $pin\r\n"
        fun gpioWrite(pin: Int, value: Int) = "gpio write $pin $value\r\n" // value: 0 or 1

        // BadUSB Commands
        fun badUsbRun(scriptPath: String) = "storage read $scriptPath | bad_usb run\r\n"
        fun badUsbWrite(scriptPath: String, content: String) =
            "storage write $scriptPath $content\r\n"

        // iButton Commands
        fun iButtonRead() = "ibutton read\r\n"
        fun iButtonEmulate(key: String) = "ibutton emulate $key\r\n"

        // Infrared Commands
        fun irLearn() = "ir learn\r\n"
        fun irTx(data: String) = "ir tx $data\r\n"
    }
}
