package com.pentest.dashboard

import android.bluetooth.*
import android.content.Context
import android.os.Handler
import android.os.Looper
import android.util.Log
import java.util.*

/**
 * Flipper Zero Bluetooth Serial Communication Manager
 *
 * Handles Bluetooth Low Energy (BLE) communication with Flipper Zero device
 * using the official serial-over-Bluetooth protocol.
 *
 * Protocol Details:
 * - TX Channel: 19ed82ae-ed21-4c9d-4145-228e62fe0000 (Flipper sends data)
 * - RX Channel: 19ed82ae-ed21-4c9d-4145-228e61fe0000 (Flipper receives data)
 * - Service UUID: 8fe5b3d5-2e7f-4a98-2a48-7acc60fe0000
 */
class FlipperBluetoothManager(private val context: Context) {

    companion object {
        private const val TAG = "FlipperBT"

        // Flipper Zero BLE Service and Characteristics UUIDs
        private const val FLIPPER_SERVICE_UUID = "8fe5b3d5-2e7f-4a98-2a48-7acc60fe0000"
        private const val FLIPPER_TX_CHAR_UUID = "19ed82ae-ed21-4c9d-4145-228e62fe0000" // Flipper transmits
        private const val FLIPPER_RX_CHAR_UUID = "19ed82ae-ed21-4c9d-4145-228e61fe0000" // Flipper receives
    }

    private var bluetoothGatt: BluetoothGatt? = null
    private var txCharacteristic: BluetoothGattCharacteristic? = null
    private var rxCharacteristic: BluetoothGattCharacteristic? = null

    private val handler = Handler(Looper.getMainLooper())
    private var connectionCallback: ((Boolean, String) -> Unit)? = null
    private var dataReceivedCallback: ((String) -> Unit)? = null

    private var isConnected = false

    private val gattCallback = object : BluetoothGattCallback() {
        override fun onConnectionStateChange(gatt: BluetoothGatt, status: Int, newState: Int) {
            when (newState) {
                BluetoothProfile.STATE_CONNECTED -> {
                    Log.d(TAG, "✓ BLE Connected - discovering services...")
                    isConnected = true
                    // Discover services with delay to ensure stable connection
                    handler.postDelayed({
                        gatt.discoverServices()
                    }, 600)
                }
                BluetoothProfile.STATE_DISCONNECTED -> {
                    Log.d(TAG, "✗ BLE Disconnected")
                    isConnected = false
                    handler.post {
                        android.widget.Toast.makeText(context, "Bluetooth disconnected", android.widget.Toast.LENGTH_SHORT).show()
                        connectionCallback?.invoke(false, "Disconnected")
                    }
                }
                BluetoothProfile.STATE_CONNECTING -> {
                    Log.d(TAG, "Connecting to Flipper Zero...")
                }
                BluetoothProfile.STATE_DISCONNECTING -> {
                    Log.d(TAG, "Disconnecting from Flipper Zero...")
                }
            }

            // Handle connection errors
            if (status != BluetoothGatt.GATT_SUCCESS) {
                Log.e(TAG, "GATT error: status=$status, newState=$newState")
                handler.post {
                    connectionCallback?.invoke(false, "Connection error: status $status")
                }
            }
        }

        override fun onServicesDiscovered(gatt: BluetoothGatt, status: Int) {
            if (status == BluetoothGatt.GATT_SUCCESS) {
                Log.d(TAG, "Services discovered, searching for Flipper service...")

                // List all services for debugging
                gatt.services.forEach { service ->
                    Log.d(TAG, "Found service: ${service.uuid}")
                }

                val service = gatt.getService(UUID.fromString(FLIPPER_SERVICE_UUID))
                if (service != null) {
                    Log.d(TAG, "✓ Flipper service found!")
                    txCharacteristic = service.getCharacteristic(UUID.fromString(FLIPPER_TX_CHAR_UUID))
                    rxCharacteristic = service.getCharacteristic(UUID.fromString(FLIPPER_RX_CHAR_UUID))

                    if (txCharacteristic != null && rxCharacteristic != null) {
                        Log.d(TAG, "✓ TX and RX characteristics found")

                        // Enable notifications for TX characteristic (receiving data from Flipper)
                        txCharacteristic?.let {
                            val notifySuccess = gatt.setCharacteristicNotification(it, true)
                            Log.d(TAG, "Notification setup: $notifySuccess")

                            val descriptor = it.getDescriptor(
                                UUID.fromString("00002902-0000-1000-8000-00805f9b34fb")
                            )

                            if (descriptor != null) {
                                descriptor.value = BluetoothGattDescriptor.ENABLE_NOTIFICATION_VALUE
                                val writeSuccess = gatt.writeDescriptor(descriptor)
                                Log.d(TAG, "Descriptor write initiated: $writeSuccess")

                                // Give it time to complete
                                handler.postDelayed({
                                    handler.post {
                                        android.widget.Toast.makeText(context, "✓ Flipper Zero connected via Bluetooth!", android.widget.Toast.LENGTH_SHORT).show()
                                        connectionCallback?.invoke(true, "Connected via Bluetooth")
                                    }
                                }, 500)
                            } else {
                                Log.e(TAG, "CCCD descriptor not found")
                                handler.post {
                                    connectionCallback?.invoke(false, "Descriptor not found")
                                }
                            }
                        }
                    } else {
                        Log.e(TAG, "TX or RX characteristic not found")
                        handler.post {
                            connectionCallback?.invoke(false, "Characteristics not found")
                        }
                    }
                } else {
                    Log.e(TAG, "✗ Flipper service not found - not a Flipper device?")

                    // Show what services we did find
                    val foundServices = gatt.services.joinToString(", ") { it.uuid.toString() }
                    Log.w(TAG, "Found services: $foundServices")

                    handler.post {
                        android.widget.Toast.makeText(context,
                            "Device connected but Flipper service not found.\n\nNot a Flipper Zero device?",
                            android.widget.Toast.LENGTH_LONG).show()
                        connectionCallback?.invoke(false, "Not a Flipper Zero device")
                    }
                }
            } else {
                Log.e(TAG, "Service discovery failed with status: $status")
                handler.post {
                    connectionCallback?.invoke(false, "Service discovery failed")
                }
            }
        }

        override fun onCharacteristicChanged(
            gatt: BluetoothGatt,
            characteristic: BluetoothGattCharacteristic
        ) {
            if (characteristic.uuid == UUID.fromString(FLIPPER_TX_CHAR_UUID)) {
                val data = String(characteristic.value ?: byteArrayOf())
                if (data.isNotEmpty()) {
                    Log.d(TAG, "← Received: $data")
                    handler.post {
                        dataReceivedCallback?.invoke(data)
                    }
                }
            }
        }

        override fun onDescriptorWrite(
            gatt: BluetoothGatt,
            descriptor: BluetoothGattDescriptor,
            status: Int
        ) {
            if (status == BluetoothGatt.GATT_SUCCESS) {
                Log.d(TAG, "✓ Descriptor written successfully - notifications enabled")
            } else {
                Log.e(TAG, "✗ Descriptor write failed: status=$status")
            }
        }

        override fun onCharacteristicWrite(
            gatt: BluetoothGatt,
            characteristic: BluetoothGattCharacteristic,
            status: Int
        ) {
            if (status == BluetoothGatt.GATT_SUCCESS) {
                Log.d(TAG, "→ Sent successfully")
            } else {
                Log.e(TAG, "✗ Send failed: status=$status")
            }
        }
    }

    /**
     * Connect to Flipper Zero device
     */
    fun connect(device: BluetoothDevice, callback: (Boolean, String) -> Unit) {
        connectionCallback = callback
        bluetoothGatt = device.connectGatt(context, false, gattCallback)
    }

    /**
     * Disconnect from Flipper Zero
     */
    fun disconnect() {
        bluetoothGatt?.disconnect()
        bluetoothGatt?.close()
        bluetoothGatt = null
    }

    /**
     * Send command to Flipper Zero
     */
    fun sendCommand(command: String): Boolean {
        val characteristic = rxCharacteristic ?: return false
        characteristic.setValue(command.toByteArray())
        return bluetoothGatt?.writeCharacteristic(characteristic) ?: false
    }

    /**
     * Set callback for receiving data from Flipper
     */
    fun setDataReceivedCallback(callback: (String) -> Unit) {
        dataReceivedCallback = callback
    }

    /**
     * Flipper Zero CLI Commands
     */
    object Commands {
        // System Commands
        fun getInfo() = "device_info\r\n"
        fun getStorage() = "storage list /ext\r\n"
        fun getBattery() = "power info\r\n"

        // Sub-GHz Commands
        fun subGhzRx(frequency: Double) = "subghz rx ${frequency * 1000000}\r\n"
        fun subGhzTx(frequency: Double, protocol: String, data: String) =
            "subghz tx $frequency $protocol $data\r\n"
        fun subGhzRead() = "subghz read\r\n"

        // RFID Commands
        fun rfidRead() = "rfid read\r\n"
        fun rfidEmulate(data: String) = "rfid emulate $data\r\n"

        // NFC Commands
        fun nfcDetect() = "nfc detect\r\n"
        fun nfcRead() = "nfc read\r\n"
        fun nfcEmulate(uid: String) = "nfc emulate $uid\r\n"

        // GPIO Commands
        fun gpioMode(pin: Int, mode: String) = "gpio mode $pin $mode\r\n" // mode: input, output
        fun gpioRead(pin: Int) = "gpio read $pin\r\n"
        fun gpioWrite(pin: Int, value: Int) = "gpio write $pin $value\r\n" // value: 0 or 1

        // BadUSB Commands
        fun badUsbRun(scriptPath: String) = "storage read $scriptPath | bad_usb run\r\n"
        fun badUsbWrite(scriptPath: String, content: String) =
            "storage write $scriptPath $content\r\n"

        // iButton Commands
        fun iButtonRead() = "ibutton read\r\n"
        fun iButtonEmulate(key: String) = "ibutton emulate $key\r\n"

        // Infrared Commands
        fun irLearn() = "ir learn\r\n"
        fun irTx(data: String) = "ir tx $data\r\n"
    }
}
