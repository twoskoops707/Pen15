package com.pentest.dashboard

import android.os.Bundle
import android.widget.ArrayAdapter
import android.widget.ImageView
import android.widget.ListView
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton
import com.google.android.material.textfield.TextInputEditText

class PacketSnifferActivity : AppCompatActivity() {

    private lateinit var inputInterface: TextInputEditText
    private lateinit var inputFilter: TextInputEditText
    private lateinit var logOutput: TextView
    private lateinit var btnStartCapture: MaterialButton
    private lateinit var btnStopCapture: MaterialButton
    private lateinit var btnSaveCapture: MaterialButton
    private lateinit var btnAnalyze: MaterialButton

    private var isCapturing = false

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_packet_sniffer)

        // Stop any running processes from other activities
        ProcessManager.stopCurrentProcess(this)

        initializeViews()
        setupClickListeners()
    }

    private fun initializeViews() {
        inputInterface = findViewById(R.id.inputInterface)
        inputFilter = findViewById(R.id.inputFilter)
        logOutput = findViewById(R.id.logOutput)
        btnStartCapture = findViewById(R.id.btnStartCapture)
        btnStopCapture = findViewById(R.id.btnStopCapture)
        btnSaveCapture = findViewById(R.id.btnSaveCapture)
        btnAnalyze = findViewById(R.id.btnAnalyze)

        btnStopCapture.isEnabled = false
        btnSaveCapture.isEnabled = false
        btnAnalyze.isEnabled = false
    }

    private fun setupClickListeners() {
        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnStartCapture.setOnClickListener {
            val iface = inputInterface.text.toString().ifEmpty { "wlan0" }
            val filter = inputFilter.text.toString()
            startCapture(iface, filter)
        }

        btnStopCapture.setOnClickListener {
            stopCapture()
        }

        btnSaveCapture.setOnClickListener {
            saveCapture()
        }

        btnAnalyze.setOnClickListener {
            analyzeCapture()
        }
    }

    private fun startCapture(iface: String, filter: String) {
        addLog("=== PACKET CAPTURE STARTED ===")
        addLog("Interface: $iface")
        if (filter.isNotEmpty()) {
            addLog("Filter: $filter")
        }
        addLog("")

        val command = if (filter.isNotEmpty()) {
            """
                echo "Starting packet capture with filter..."
                sudo tcpdump -i $iface -w /sdcard/Download/capture.pcap '$filter' -v
            """.trimIndent()
        } else {
            """
                echo "Starting full packet capture..."
                sudo tcpdump -i $iface -w /sdcard/Download/capture.pcap -v
            """.trimIndent()
        }

        addLog("Executing tcpdump in Termux...")
        addLog("")

        // Execute via ProcessManager so it can be stopped
        val processId = ProcessManager.startProcess(this, command)
        val scriptFile = java.io.File(getExternalFilesDir(null), "scripts/script_$processId.sh")

        val termux = TermuxIntegration(this)
        termux.runCommand("bash ${scriptFile.absolutePath}", background = true)

        addLog("✓ Process ID: $processId")
        addLog("✓ Packet capture started")
        addLog("")
        addLog("Capturing packets... Check Termux for live output")
        addLog("Press STOP or switch activities to stop.")

        isCapturing = true
        btnStartCapture.isEnabled = false
        btnStopCapture.isEnabled = true
        btnSaveCapture.isEnabled = true
    }

    private fun stopCapture() {
        addLog("")
        addLog("=== CAPTURE STOPPED ===")
        addLog("Packets saved to: /sdcard/Download/capture.pcap")
        addLog("")
        addLog("Use ANALYZE to extract credentials/data")

        isCapturing = false
        btnStartCapture.isEnabled = true
        btnStopCapture.isEnabled = false
        btnAnalyze.isEnabled = true
    }

    private fun saveCapture() {
        val timestamp = java.text.SimpleDateFormat("yyyyMMdd_HHmmss", java.util.Locale.US)
            .format(java.util.Date())
        val filename = "capture_$timestamp.pcap"

        addLog("Saving capture as: $filename")
        addLog("Location: /sdcard/Download/$filename")
    }

    private fun analyzeCapture() {
        addLog("")
        addLog("=== ANALYZING CAPTURE ===")
        addLog("")

        val commands = """
            echo "Extracting HTTP credentials..."
            tshark -r /sdcard/Download/capture.pcap -Y "http.request.method == POST" -T fields -e http.file_data | grep -i "user\|pass\|login"

            echo ""
            echo "Extracting FTP credentials..."
            tshark -r /sdcard/Download/capture.pcap -Y "ftp" -T fields -e ftp.request.command -e ftp.request.arg

            echo ""
            echo "Extracting DNS queries..."
            tshark -r /sdcard/Download/capture.pcap -Y "dns.qry.name" -T fields -e dns.qry.name | sort | uniq

            echo ""
            echo "Top talkers..."
            tshark -r /sdcard/Download/capture.pcap -q -z conv,ip

            echo ""
            echo "HTTP hosts..."
            tshark -r /sdcard/Download/capture.pcap -Y "http.request" -T fields -e http.host | sort | uniq
        """.trimIndent()

        addLog("Running tshark analysis...")
        addLog("")

        // Execute via ProcessManager so it can be stopped
        val processId = ProcessManager.startProcess(this, commands)
        val scriptFile = java.io.File(getExternalFilesDir(null), "scripts/script_$processId.sh")

        val termux = TermuxIntegration(this)
        termux.runCommand("bash ${scriptFile.absolutePath}", background = false)

        addLog("✓ Process ID: $processId")
        addLog("✓ Analysis started")
        addLog("")
        addLog("Check Termux for extracted credentials and data!")
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = logOutput.text.toString()
        logOutput.text = "[$timestamp] $message\n$currentLog"
    }

    override fun onPause() {
        super.onPause()
        ProcessManager.stopCurrentProcess(this)
    }

    override fun onDestroy() {
        super.onDestroy()
        ProcessManager.stopCurrentProcess(this)
    }
}
