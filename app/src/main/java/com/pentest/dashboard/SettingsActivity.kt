package com.pentest.dashboard

import android.content.Context
import android.content.Intent
import android.content.SharedPreferences
import android.net.Uri
import android.os.Bundle
import android.provider.Settings
import android.widget.ImageView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton
import com.google.android.material.switchmaterial.SwitchMaterial

class SettingsActivity : AppCompatActivity() {

    private lateinit var prefs: SharedPreferences
    private lateinit var switchAutoConnect: SwitchMaterial
    private lateinit var switchShowTutorial: SwitchMaterial
    private lateinit var switchVerboseLogging: SwitchMaterial
    private lateinit var switchKeepScreenOn: SwitchMaterial

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_settings)

        prefs = getSharedPreferences("pentest_settings", Context.MODE_PRIVATE)

        initializeViews()
        loadSettings()
        setupClickListeners()
    }

    private fun initializeViews() {
        switchAutoConnect = findViewById(R.id.switchAutoConnect)
        switchShowTutorial = findViewById(R.id.switchShowTutorial)
        switchVerboseLogging = findViewById(R.id.switchVerboseLogging)
        switchKeepScreenOn = findViewById(R.id.switchKeepScreenOn)
    }

    private fun loadSettings() {
        switchAutoConnect.isChecked = prefs.getBoolean("auto_connect", false)
        switchShowTutorial.isChecked = prefs.getBoolean("show_tutorial", true)
        switchVerboseLogging.isChecked = prefs.getBoolean("verbose_logging", false)
        switchKeepScreenOn.isChecked = prefs.getBoolean("keep_screen_on", false)
    }

    private fun setupClickListeners() {
        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        // Auto-connect toggle
        switchAutoConnect.setOnCheckedChangeListener { _, isChecked ->
            prefs.edit().putBoolean("auto_connect", isChecked).apply()
            Toast.makeText(this,
                if (isChecked) "Auto-connect enabled" else "Auto-connect disabled",
                Toast.LENGTH_SHORT).show()
        }

        // Tutorial toggle
        switchShowTutorial.setOnCheckedChangeListener { _, isChecked ->
            prefs.edit().putBoolean("show_tutorial", isChecked).apply()
        }

        // Verbose logging toggle
        switchVerboseLogging.setOnCheckedChangeListener { _, isChecked ->
            prefs.edit().putBoolean("verbose_logging", isChecked).apply()
        }

        // Keep screen on toggle
        switchKeepScreenOn.setOnCheckedChangeListener { _, isChecked ->
            prefs.edit().putBoolean("keep_screen_on", isChecked).apply()
        }

        // Bluetooth Settings button
        findViewById<MaterialButton>(R.id.btnBluetoothSettings).setOnClickListener {
            try {
                startActivity(Intent(Settings.ACTION_BLUETOOTH_SETTINGS))
            } catch (e: Exception) {
                Toast.makeText(this, "Could not open Bluetooth settings", Toast.LENGTH_SHORT).show()
            }
        }

        // Install Termux button
        findViewById<MaterialButton>(R.id.btnInstallTermux).setOnClickListener {
            try {
                val intent = Intent(Intent.ACTION_VIEW, Uri.parse("https://f-droid.org/packages/com.termux/"))
                startActivity(intent)
            } catch (e: Exception) {
                Toast.makeText(this, "Could not open F-Droid", Toast.LENGTH_SHORT).show()
            }
        }

        // Reset tutorial button
        findViewById<MaterialButton>(R.id.btnResetTutorial).setOnClickListener {
            prefs.edit().putBoolean("tutorial_completed", false).apply()
            switchShowTutorial.isChecked = true
            Toast.makeText(this, "Tutorial will show on next launch", Toast.LENGTH_SHORT).show()
        }

        // Clear cache button
        findViewById<MaterialButton>(R.id.btnClearCache).setOnClickListener {
            try {
                cacheDir.deleteRecursively()
                Toast.makeText(this, "Cache cleared", Toast.LENGTH_SHORT).show()
            } catch (e: Exception) {
                Toast.makeText(this, "Could not clear cache", Toast.LENGTH_SHORT).show()
            }
        }

        // About button
        findViewById<MaterialButton>(R.id.btnAbout).setOnClickListener {
            Toast.makeText(this, "Flipper Zero Dashboard v1.0\nFor authorized security testing only", Toast.LENGTH_LONG).show()
        }
    }
}
