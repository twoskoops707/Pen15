package com.pentest.dashboard

import android.os.Bundle
import android.widget.ArrayAdapter
import android.widget.ImageView
import android.widget.Spinner
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton
import com.google.android.material.textfield.TextInputEditText

class HashCrackerActivity : AppCompatActivity() {

    private lateinit var inputHash: TextInputEditText
    private lateinit var spinnerHashType: Spinner
    private lateinit var spinnerWordlist: Spinner
    private lateinit var logOutput: TextView
    private lateinit var btnCrackHashcat: MaterialButton
    private lateinit var btnCrackJohn: MaterialButton
    private lateinit var btnIdentifyHash: MaterialButton

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_hash_cracker)

        initializeViews()
        setupClickListeners()
    }

    private fun initializeViews() {
        inputHash = findViewById(R.id.inputHash)
        spinnerHashType = findViewById(R.id.spinnerHashType)
        spinnerWordlist = findViewById(R.id.spinnerWordlist)
        logOutput = findViewById(R.id.logOutput)
        btnCrackHashcat = findViewById(R.id.btnCrackHashcat)
        btnCrackJohn = findViewById(R.id.btnCrackJohn)
        btnIdentifyHash = findViewById(R.id.btnIdentifyHash)

        // Hash types
        val hashTypes = arrayOf(
            "0 - MD5",
            "100 - SHA1",
            "1000 - NTLM",
            "1400 - SHA256",
            "1700 - SHA512",
            "1800 - sha512crypt",
            "3200 - bcrypt",
            "5600 - NetNTLMv2",
            "13100 - Kerberos 5 TGS-REP",
            "18200 - Kerberos 5 AS-REP"
        )
        spinnerHashType.adapter = ArrayAdapter(this, android.R.layout.simple_spinner_item, hashTypes)

        // Wordlists (online URLs to save storage)
        val wordlists = arrayOf(
            "rockyou.txt (143MB)",
            "Top 10K passwords (online)",
            "Top 100K passwords (online)",
            "Common WiFi passwords (online)",
            "Custom wordlist"
        )
        spinnerWordlist.adapter = ArrayAdapter(this, android.R.layout.simple_spinner_item, wordlists)
    }

    private fun setupClickListeners() {
        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnIdentifyHash.setOnClickListener {
            identifyHash()
        }

        btnCrackHashcat.setOnClickListener {
            crackWithHashcat()
        }

        btnCrackJohn.setOnClickListener {
            crackWithJohn()
        }
    }

    private fun identifyHash() {
        val hash = inputHash.text.toString().trim()
        if (hash.isEmpty()) {
            addLog("ERROR: Please enter a hash")
            return
        }

        addLog("=== HASH IDENTIFICATION ===")
        addLog("Hash: $hash")
        addLog("")

        val length = hash.length
        val identified = when {
            length == 32 && hash.matches(Regex("[a-f0-9]{32}")) -> "Possibly MD5"
            length == 40 && hash.matches(Regex("[a-f0-9]{40}")) -> "Possibly SHA1"
            length == 64 && hash.matches(Regex("[a-f0-9]{64}")) -> "Possibly SHA256"
            length == 128 && hash.matches(Regex("[a-f0-9]{128}")) -> "Possibly SHA512"
            hash.startsWith("${'$'}1${'$'}") -> "MD5 crypt"
            hash.startsWith("${'$'}2a${'$'}") || hash.startsWith("${'$'}2b${'$'}") || hash.startsWith("${'$'}2y${'$'}") -> "bcrypt"
            hash.startsWith("${'$'}6${'$'}") -> "sha512crypt"
            hash.startsWith("${'$'}5${'$'}") -> "sha256crypt"
            else -> "Unknown - check hash length and format"
        }

        addLog("Identified: $identified")
        addLog("")
        addLog("Using hash_identifier command:")
        addLog("echo '$hash' | hash-identifier")
    }

    private fun crackWithHashcat() {
        val hash = inputHash.text.toString().trim()
        if (hash.isEmpty()) {
            addLog("ERROR: Please enter a hash")
            return
        }

        val hashTypeStr = spinnerHashType.selectedItem.toString()
        val hashMode = hashTypeStr.split(" - ")[0]

        val wordlistOption = spinnerWordlist.selectedItemPosition
        val wordlist = when (wordlistOption) {
            0 -> "/data/data/com.termux/files/usr/share/wordlists/rockyou.txt"
            1 -> "<(curl -s 'https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/Common-Credentials/10-million-password-list-top-10000.txt')"
            2 -> "<(curl -s 'https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/Common-Credentials/10-million-password-list-top-100000.txt')"
            3 -> "<(curl -s 'https://raw.githubusercontent.com/berzerk0/Probable-Wordlists/master/Real-Passwords/WPA-Length/Top2Billion-WPA-probable.txt')"
            else -> "/sdcard/Download/wordlist.txt"
        }

        addLog("=== HASHCAT CRACK ===")
        addLog("Hash: $hash")
        addLog("Mode: $hashMode")
        addLog("")

        val command = """
            echo "Cracking with hashcat..."
            echo '$hash' > /tmp/hash.txt
            hashcat -m $hashMode /tmp/hash.txt $wordlist --force
            echo ""
            echo "If cracked, run:"
            echo "hashcat -m $hashMode /tmp/hash.txt --show"
        """.trimIndent()

        addLog("Command:")
        addLog(command)
        addLog("")
        addLog("This may take minutes to hours depending on hash complexity and wordlist size.")
    }

    private fun crackWithJohn() {
        val hash = inputHash.text.toString().trim()
        if (hash.isEmpty()) {
            addLog("ERROR: Please enter a hash")
            return
        }

        val wordlistOption = spinnerWordlist.selectedItemPosition
        val wordlist = when (wordlistOption) {
            0 -> "/data/data/com.termux/files/usr/share/wordlists/rockyou.txt"
            1 -> "<(curl -s 'https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/Common-Credentials/10-million-password-list-top-10000.txt')"
            else -> "/sdcard/Download/wordlist.txt"
        }

        addLog("=== JOHN THE RIPPER ===")
        addLog("Hash: $hash")
        addLog("")

        val command = """
            echo "Cracking with John the Ripper..."
            echo '$hash' > /tmp/hash.txt
            john --wordlist=$wordlist /tmp/hash.txt
            echo ""
            echo "Show cracked passwords:"
            john --show /tmp/hash.txt
        """.trimIndent()

        addLog("Command:")
        addLog(command)
        addLog("")
        addLog("John will auto-detect hash type.")
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = logOutput.text.toString()
        logOutput.text = "[$timestamp] $message\n$currentLog"
    }
}
