package com.pentest.dashboard

import android.graphics.Color
import android.os.Bundle
import android.os.Handler
import android.os.Looper
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.ImageView
import android.widget.ProgressBar
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import com.google.android.material.button.MaterialButton

/**
 * WiFi Deauth using Flipper Zero WiFi Dev Board (ESP32 Marauder)
 * Tactical HUD-style interface for professional pentesting
 */
class WiFiDeauthActivity : AppCompatActivity() {

    // UI Components
    private lateinit var txtStatusIndicator: TextView
    private lateinit var connectionStatusDot: View
    private lateinit var txtConnectionStatus: TextView
    private lateinit var btnScan: MaterialButton
    private lateinit var networkRecyclerView: RecyclerView
    private lateinit var emptyStateContainer: View
    private lateinit var txtNetworkCount: TextView
    private lateinit var attackMetricsPanel: View
    private lateinit var txtAttackTarget: TextView
    private lateinit var txtAttackStatus: TextView
    private lateinit var attackProgressBar: ProgressBar
    private lateinit var btnDeauth: MaterialButton
    private lateinit var btnStop: MaterialButton
    private lateinit var logOutput: TextView

    // Data & State
    private val networks = mutableListOf<NetworkTarget>()
    private lateinit var networkAdapter: NetworkAdapter
    private var selectedNetworkIndex: Int = -1
    private var isAttacking = false

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_wifi_deauth)

        ProcessManager.stopCurrentProcess(this)
        initializeViews()
        setupRecyclerView()
        setupListeners()
        updateConnectionStatus()
        addLog("SYSTEM INITIALIZED")
        addLog("AWAITING COMMANDS...")
        addLog("")
        addLog("━━━ DEVICE REQUIREMENTS ━━━")
        addLog("• Flipper WiFi Dev Board")
        addLog("• ESP32 Marauder firmware")
        addLog("• USB connection established")
        addLog("")
        addLog("Ready to initiate network scan.")
    }

    private fun initializeViews() {
        txtStatusIndicator = findViewById(R.id.txtStatusIndicator)
        connectionStatusDot = findViewById(R.id.connectionStatusDot)
        txtConnectionStatus = findViewById(R.id.txtConnectionStatus)
        btnScan = findViewById(R.id.btnScan)
        networkRecyclerView = findViewById(R.id.networkRecyclerView)
        emptyStateContainer = findViewById(R.id.emptyStateContainer)
        txtNetworkCount = findViewById(R.id.txtNetworkCount)
        attackMetricsPanel = findViewById(R.id.attackMetricsPanel)
        txtAttackTarget = findViewById(R.id.txtAttackTarget)
        txtAttackStatus = findViewById(R.id.txtAttackStatus)
        attackProgressBar = findViewById(R.id.attackProgressBar)
        btnDeauth = findViewById(R.id.btnDeauth)
        btnStop = findViewById(R.id.btnStop)
        logOutput = findViewById(R.id.logOutput)
    }

    private fun setupRecyclerView() {
        networkAdapter = NetworkAdapter(networks) { position ->
            onNetworkSelected(position)
        }
        networkRecyclerView.apply {
            layoutManager = LinearLayoutManager(this@WiFiDeauthActivity)
            adapter = networkAdapter
        }
    }

    private fun setupListeners() {
        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnScan.setOnClickListener {
            scanNetworks()
        }

        btnDeauth.setOnClickListener {
            if (selectedNetworkIndex >= 0) {
                startDeauth()
            } else {
                Toast.makeText(this, "Select a target first", Toast.LENGTH_SHORT).show()
            }
        }

        btnStop.setOnClickListener {
            stopAttack()
        }

        // Set up Flipper data callback
        FlipperConnectionManager.setDataReceivedCallback { data ->
            runOnUiThread {
                parseMarauderResponse(data)
            }
        }
    }

    private fun updateConnectionStatus() {
        val isConnected = FlipperConnectionManager.isConnected()
        if (isConnected) {
            connectionStatusDot.setBackgroundResource(R.drawable.status_dot_connected)
            txtConnectionStatus.text = "ONLINE"
            txtConnectionStatus.setTextColor(Color.parseColor("#30d158"))
        } else {
            connectionStatusDot.setBackgroundResource(R.drawable.status_dot_disconnected)
            txtConnectionStatus.text = "OFFLINE"
            txtConnectionStatus.setTextColor(Color.parseColor("#666d7a"))
        }
    }

    private fun updateSystemStatus(status: String, color: String = "#666d7a") {
        txtStatusIndicator.text = "◉ $status"
        txtStatusIndicator.setTextColor(Color.parseColor(color))
    }

    private fun scanNetworks() {
        if (!FlipperConnectionManager.isConnected()) {
            addLog("❌ ERROR: Flipper not connected")
            Toast.makeText(this, "Connect Flipper first", Toast.LENGTH_SHORT).show()
            return
        }

        networks.clear()
        networkAdapter.notifyDataSetChanged()
        selectedNetworkIndex = -1
        btnDeauth.isEnabled = false
        updateNetworkCount()
        showEmptyState(true)

        addLog("")
        addLog("━━━ INITIATING SCAN ━━━")
        addLog("Frequency sweep in progress...")
        addLog("Sending 'scanap' command to Marauder")

        btnScan.isEnabled = false
        btnScan.text = "SCANNING..."
        updateSystemStatus("SCANNING", "#ff9500")

        FlipperConnectionManager.sendCommand("scanap")

        Handler(Looper.getMainLooper()).postDelayed({
            btnScan.isEnabled = true
            btnScan.text = "INITIATE NETWORK SCAN"
            updateSystemStatus("STANDBY", "#666d7a")

            if (networks.isEmpty()) {
                addLog("")
                addLog("⚠ No targets detected")
                addLog("Verify WiFi Dev Board connection")
            } else {
                addLog("")
                addLog("✓ Scan complete: ${networks.size} targets")
            }
        }, 10000)
    }

    private fun onNetworkSelected(position: Int) {
        selectedNetworkIndex = position
        networkAdapter.setSelectedPosition(position)
        btnDeauth.isEnabled = true

        val network = networks[position]
        addLog("")
        addLog("━━━ TARGET SELECTED ━━━")
        addLog("Index: #$position")
        addLog("SSID: ${network.ssid}")
        addLog("BSSID: ${network.bssid}")
        addLog("Signal: ${network.rssi} dBm")
        addLog("")
        addLog("Ready to execute attack.")

        // Show attack metrics panel
        attackMetricsPanel.visibility = View.VISIBLE
        txtAttackTarget.text = network.ssid
        txtAttackStatus.text = "ARMED"
        txtAttackStatus.setTextColor(Color.parseColor("#ff9500"))
    }

    private fun startDeauth() {
        if (!FlipperConnectionManager.isConnected()) {
            Toast.makeText(this, "Flipper not connected", Toast.LENGTH_SHORT).show()
            return
        }

        val network = networks[selectedNetworkIndex]

        addLog("")
        addLog("━━━ ATTACK INITIATED ━━━")
        addLog("Protocol: Deauthentication")
        addLog("Target: ${network.ssid}")
        addLog("Index: #$selectedNetworkIndex")
        addLog("")

        // Update UI state
        updateSystemStatus("ATTACKING", "#ff3b30")
        connectionStatusDot.setBackgroundResource(R.drawable.status_dot_attacking)

        txtAttackStatus.text = "ACTIVE"
        txtAttackStatus.setTextColor(Color.parseColor("#ff3b30"))
        attackProgressBar.visibility = View.VISIBLE

        // Send Marauder commands
        FlipperConnectionManager.sendCommand("select -a $selectedNetworkIndex")

        Handler(Looper.getMainLooper()).postDelayed({
            addLog("Transmitting deauth frames...")
            FlipperConnectionManager.sendCommand("deauth")

            isAttacking = true
            btnDeauth.isEnabled = false
            btnStop.isEnabled = true
            btnScan.isEnabled = false

            addLog("✓ Attack sequence active")
            addLog("")
            addLog("Press TERMINATE to stop")
        }, 500)
    }

    private fun stopAttack() {
        addLog("")
        addLog("━━━ TERMINATING ATTACK ━━━")

        FlipperConnectionManager.sendCommand("stopscan")

        isAttacking = false
        btnStop.isEnabled = false
        btnScan.isEnabled = true
        btnDeauth.isEnabled = selectedNetworkIndex >= 0

        updateSystemStatus("STANDBY", "#666d7a")
        connectionStatusDot.setBackgroundResource(R.drawable.status_dot_connected)

        txtAttackStatus.text = "TERMINATED"
        txtAttackStatus.setTextColor(Color.parseColor("#666d7a"))
        attackProgressBar.visibility = View.GONE

        addLog("Attack sequence stopped")
        addLog("System returned to standby")
    }

    private fun parseMarauderResponse(data: String) {
        addLog(data.trim())

        // Parse network scan results
        if (data.contains("SSID:", ignoreCase = true) ||
            data.contains("CH:", ignoreCase = true)) {

            val lines = data.split("\n")
            for (line in lines) {
                if (line.trim().isNotEmpty() &&
                    (line.contains("SSID") || line.contains("CH:") || line.contains("RSSI"))) {

                    // Try to parse network info
                    val ssid = extractValue(line, "SSID")
                    val bssid = extractValue(line, "BSSID")
                    val channel = extractValue(line, "CH")
                    val rssi = extractValue(line, "RSSI")

                    if (ssid.isNotEmpty()) {
                        val network = NetworkTarget(
                            ssid = ssid.ifEmpty { "Unknown" },
                            bssid = bssid.ifEmpty { "00:00:00:00:00:00" },
                            channel = channel.ifEmpty { "--" },
                            rssi = rssi.ifEmpty { "-00" }
                        )

                        if (!networks.any { it.ssid == network.ssid && it.bssid == network.bssid }) {
                            networks.add(network)
                            runOnUiThread {
                                networkAdapter.notifyItemInserted(networks.size - 1)
                                updateNetworkCount()
                                showEmptyState(false)
                            }
                        }
                    }
                }
            }
        }

        // Detect attack confirmation
        if (data.contains("deauth", ignoreCase = true) &&
            (data.contains("sent", ignoreCase = true) ||
             data.contains("attack", ignoreCase = true))) {
            addLog("✓ Deauth frames transmitted")
        }
    }

    private fun extractValue(line: String, key: String): String {
        return try {
            val regex = "$key[:\\s]+([^\\s,]+)".toRegex(RegexOption.IGNORE_CASE)
            regex.find(line)?.groupValues?.get(1)?.trim() ?: ""
        } catch (e: Exception) {
            ""
        }
    }

    private fun updateNetworkCount() {
        txtNetworkCount.text = networks.size.toString()
    }

    private fun showEmptyState(show: Boolean) {
        if (show) {
            emptyStateContainer.visibility = View.VISIBLE
            networkRecyclerView.visibility = View.GONE
        } else {
            emptyStateContainer.visibility = View.GONE
            networkRecyclerView.visibility = View.VISIBLE
        }
    }

    private fun addLog(message: String) {
        val currentText = logOutput.text.toString()
        logOutput.text = if (currentText.isEmpty()) {
            message
        } else {
            "$currentText\n$message"
        }

        // Auto-scroll to bottom
        findViewById<android.widget.ScrollView>(R.id.logScroll)?.post {
            findViewById<android.widget.ScrollView>(R.id.logScroll)?.fullScroll(View.FOCUS_DOWN)
        }
    }

    override fun onResume() {
        super.onResume()
        updateConnectionStatus()
    }

    override fun onDestroy() {
        super.onDestroy()
        if (isAttacking) {
            FlipperConnectionManager.sendCommand("stopscan")
        }
    }

    // Data class for network targets
    data class NetworkTarget(
        val ssid: String,
        val bssid: String,
        val channel: String,
        val rssi: String
    )

    // RecyclerView Adapter
    inner class NetworkAdapter(
        private val networks: List<NetworkTarget>,
        private val onItemClick: (Int) -> Unit
    ) : RecyclerView.Adapter<NetworkAdapter.NetworkViewHolder>() {

        private var selectedPosition = -1

        fun setSelectedPosition(position: Int) {
            val previousPosition = selectedPosition
            selectedPosition = position
            notifyItemChanged(previousPosition)
            notifyItemChanged(selectedPosition)
        }

        override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): NetworkViewHolder {
            val view = LayoutInflater.from(parent.context)
                .inflate(R.layout.item_network_target, parent, false)
            return NetworkViewHolder(view)
        }

        override fun onBindViewHolder(holder: NetworkViewHolder, position: Int) {
            val network = networks[position]
            val isSelected = position == selectedPosition

            holder.bind(network, position, isSelected)
            holder.itemView.setOnClickListener {
                onItemClick(position)
            }
        }

        override fun getItemCount() = networks.size

        inner class NetworkViewHolder(view: View) : RecyclerView.ViewHolder(view) {
            private val selectionIndicator: View = view.findViewById(R.id.selectionIndicator)
            private val txtNetworkSsid: TextView = view.findViewById(R.id.txtNetworkSsid)
            private val txtNetworkBssid: TextView = view.findViewById(R.id.txtNetworkBssid)
            private val txtNetworkChannel: TextView = view.findViewById(R.id.txtNetworkChannel)
            private val txtSignalStrength: TextView = view.findViewById(R.id.txtSignalStrength)
            private val txtTargetIndex: TextView = view.findViewById(R.id.txtTargetIndex)
            private val signalBar1: View = view.findViewById(R.id.signalBar1)
            private val signalBar2: View = view.findViewById(R.id.signalBar2)
            private val signalBar3: View = view.findViewById(R.id.signalBar3)
            private val signalBar4: View = view.findViewById(R.id.signalBar4)

            fun bind(network: NetworkTarget, index: Int, isSelected: Boolean) {
                txtNetworkSsid.text = network.ssid
                txtNetworkBssid.text = network.bssid
                txtNetworkChannel.text = "CH:${network.channel}"
                txtSignalStrength.text = network.rssi
                txtTargetIndex.text = "#${index.toString().padStart(2, '0')}"

                // Update selection indicator
                if (isSelected) {
                    selectionIndicator.setBackgroundColor(Color.parseColor("#ff9500"))
                    itemView.setBackgroundColor(Color.parseColor("#1a1f2b"))
                } else {
                    selectionIndicator.setBackgroundColor(Color.parseColor("#0a0e14"))
                    itemView.setBackgroundColor(Color.parseColor("#141920"))
                }

                // Update signal strength bars
                val rssiValue = network.rssi.replace("-", "").toIntOrNull() ?: 100
                updateSignalBars(rssiValue)
            }

            private fun updateSignalBars(rssi: Int) {
                val strongColor = Color.parseColor("#30d158")
                val mediumColor = Color.parseColor("#ff9500")
                val weakColor = Color.parseColor("#ff3b30")
                val inactiveColor = Color.parseColor("#666d7a")

                when {
                    rssi <= 50 -> { // Excellent
                        signalBar1.setBackgroundColor(strongColor)
                        signalBar2.setBackgroundColor(strongColor)
                        signalBar3.setBackgroundColor(strongColor)
                        signalBar4.setBackgroundColor(strongColor)
                    }
                    rssi <= 60 -> { // Good
                        signalBar1.setBackgroundColor(strongColor)
                        signalBar2.setBackgroundColor(strongColor)
                        signalBar3.setBackgroundColor(strongColor)
                        signalBar4.setBackgroundColor(inactiveColor)
                    }
                    rssi <= 70 -> { // Fair
                        signalBar1.setBackgroundColor(mediumColor)
                        signalBar2.setBackgroundColor(mediumColor)
                        signalBar3.setBackgroundColor(inactiveColor)
                        signalBar4.setBackgroundColor(inactiveColor)
                    }
                    else -> { // Weak
                        signalBar1.setBackgroundColor(weakColor)
                        signalBar2.setBackgroundColor(inactiveColor)
                        signalBar3.setBackgroundColor(inactiveColor)
                        signalBar4.setBackgroundColor(inactiveColor)
                    }
                }
            }
        }
    }
}
