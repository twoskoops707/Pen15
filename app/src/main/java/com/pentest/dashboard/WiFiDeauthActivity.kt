package com.pentest.dashboard

import android.os.Bundle
import android.view.View
import android.widget.ArrayAdapter
import android.widget.ImageView
import android.widget.LinearLayout
import android.widget.ListView
import android.widget.ProgressBar
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton
import com.google.android.material.floatingactionbutton.ExtendedFloatingActionButton
import com.google.android.material.tabs.TabLayout

class WiFiDeauthActivity : AppCompatActivity() {

    // Views
    private lateinit var tabLayout: TabLayout
    private lateinit var fabControl: ExtendedFloatingActionButton
    private lateinit var networkList: ListView
    private lateinit var networkCount: TextView
    private lateinit var resultsCount: TextView
    private lateinit var scanningText: TextView
    private lateinit var statusBadge: TextView
    private lateinit var progressBar: ProgressBar

    // State containers
    private lateinit var idleState: LinearLayout
    private lateinit var scanningState: LinearLayout
    private lateinit var resultsState: LinearLayout

    // Buttons
    private lateinit var btnDeauth: MaterialButton
    private lateinit var btnCapture: MaterialButton
    private lateinit var btnSelectTarget: MaterialButton

    // State
    private var currentMode = "SCAN"
    private var isScanning = false
    private var isAttacking = false
    private val networks = mutableListOf<String>()
    private lateinit var adapter: ArrayAdapter<String>
    private var selectedNetworkIndex: Int = -1

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_wifi_deauth)

        ProcessManager.stopCurrentProcess(this)
        initViews()
        setupTabs()
        setupFAB()
        setupButtons()
        showIdleState()
    }

    private fun initViews() {
        tabLayout = findViewById(R.id.tabLayout)
        fabControl = findViewById(R.id.fabControl)
        networkList = findViewById(R.id.networkList)
        networkCount = findViewById(R.id.networkCount)
        resultsCount = findViewById(R.id.resultsCount)
        scanningText = findViewById(R.id.scanningText)
        statusBadge = findViewById(R.id.statusBadge)
        progressBar = findViewById(R.id.progressBar)

        idleState = findViewById(R.id.idleState)
        scanningState = findViewById(R.id.scanningState)
        resultsState = findViewById(R.id.resultsState)

        btnDeauth = findViewById(R.id.btnDeauth)
        btnCapture = findViewById(R.id.btnCapture)
        btnSelectTarget = findViewById(R.id.btnSelectTarget)

        adapter = ArrayAdapter(this, android.R.layout.simple_list_item_1, networks)
        networkList.adapter = adapter

        networkList.setOnItemClickListener { _, _, position, _ ->
            selectedNetworkIndex = position
            Toast.makeText(this, "Selected: ${networks[position]}", Toast.LENGTH_SHORT).show()
        }

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }
    }

    private fun setupTabs() {
        tabLayout.addOnTabSelectedListener(object : TabLayout.OnTabSelectedListener {
            override fun onTabSelected(tab: TabLayout.Tab?) {
                when (tab?.position) {
                    0 -> switchMode("SCAN")
                    1 -> switchMode("DEAUTH")
                    2 -> switchMode("CAPTURE")
                }
            }
            override fun onTabUnselected(tab: TabLayout.Tab?) {}
            override fun onTabReselected(tab: TabLayout.Tab?) {}
        })
    }

    private fun setupFAB() {
        fabControl.setOnClickListener {
            when (currentMode) {
                "SCAN" -> if (isScanning) stopScan() else startScan()
                "DEAUTH" -> if (isAttacking) stopAttack() else startDeauth()
                "CAPTURE" -> startCapture()
            }
        }
    }

    private fun setupButtons() {
        btnDeauth.setOnClickListener {
            if (selectedNetworkIndex >= 0) {
                startDeauth()
            } else {
                Toast.makeText(this, "Select a network first", Toast.LENGTH_SHORT).show()
            }
        }

        btnCapture.setOnClickListener {
            Toast.makeText(this, "Packet capture - Coming soon", Toast.LENGTH_SHORT).show()
        }

        btnSelectTarget.setOnClickListener {
            if (networks.isNotEmpty()) {
                Toast.makeText(this, "Select from list above", Toast.LENGTH_SHORT).show()
            } else {
                Toast.makeText(this, "Scan for networks first", Toast.LENGTH_SHORT).show()
            }
        }
    }

    private fun switchMode(mode: String) {
        currentMode = mode
        statusBadge.text = mode

        when (mode) {
            "SCAN" -> {
                fabControl.text = "START SCAN"
                fabControl.setIconResource(android.R.drawable.ic_media_play)
                statusBadge.setBackgroundColor(0x2200FF41)
            }
            "DEAUTH" -> {
                fabControl.text = "START DEAUTH"
                fabControl.setIconResource(android.R.drawable.ic_delete)
                statusBadge.setBackgroundColor(0x22FF0055)
            }
            "CAPTURE" -> {
                fabControl.text = "START CAPTURE"
                fabControl.setIconResource(android.R.drawable.ic_menu_save)
                statusBadge.setBackgroundColor(0x2200FFFF)
            }
        }

        if (!isScanning && !isAttacking) {
            showIdleState()
        }
    }

    private fun showIdleState() {
        idleState.visibility = View.VISIBLE
        scanningState.visibility = View.GONE
        resultsState.visibility = View.GONE
    }

    private fun showScanningState() {
        idleState.visibility = View.GONE
        scanningState.visibility = View.VISIBLE
        resultsState.visibility = View.GONE
    }

    private fun showResultsState() {
        idleState.visibility = View.GONE
        scanningState.visibility = View.GONE
        resultsState.visibility = View.VISIBLE
    }

    private fun startScan() {
        isScanning = true
        showScanningState()
        scanningText.text = "Scanning for WiFi networks..."
        statusBadge.text = "SCANNING"
        fabControl.text = "STOP"
        fabControl.setIconResource(android.R.drawable.ic_media_pause)

        networks.clear()

        android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({
            // Mock network detection
            networks.add("Network_1 (Ch 6, -45dBm)")
            networks.add("Network_2 (Ch 11, -62dBm)")
            networks.add("Network_3 (Ch 1, -78dBm)")

            networkCount.text = "${networks.size}"
            resultsCount.text = "${networks.size} NETWORKS"
            adapter.notifyDataSetChanged()

            showResultsState()
            isScanning = false
            fabControl.text = "START SCAN"
            fabControl.setIconResource(android.R.drawable.ic_media_play)
            Toast.makeText(this, "Found ${networks.size} networks", Toast.LENGTH_SHORT).show()
        }, 3000)
    }

    private fun stopScan() {
        isScanning = false
        showIdleState()
        fabControl.text = "START SCAN"
        fabControl.setIconResource(android.R.drawable.ic_media_play)
        Toast.makeText(this, "Scan stopped", Toast.LENGTH_SHORT).show()
    }

    private fun startDeauth() {
        if (selectedNetworkIndex < 0) {
            Toast.makeText(this, "Select a target network first", Toast.LENGTH_SHORT).show()
            return
        }

        isAttacking = true
        showScanningState()
        scanningText.text = "Deauth attack in progress..."
        statusBadge.text = "ATTACKING"
        fabControl.text = "STOP ATTACK"
        fabControl.setIconResource(android.R.drawable.ic_media_pause)
        Toast.makeText(this, "Deauth attack started on ${networks[selectedNetworkIndex]}", Toast.LENGTH_SHORT).show()
    }

    private fun stopAttack() {
        isAttacking = false
        showResultsState()
        statusBadge.text = currentMode
        fabControl.text = "START DEAUTH"
        fabControl.setIconResource(android.R.drawable.ic_delete)
        Toast.makeText(this, "Attack stopped", Toast.LENGTH_SHORT).show()
    }

    private fun startCapture() {
        Toast.makeText(this, "Packet capture - Coming soon", Toast.LENGTH_SHORT).show()
    }

    override fun onDestroy() {
        super.onDestroy()
        if (isAttacking) {
            FlipperConnectionManager.sendCommand("stopscan")
        }
        ProcessManager.stopCurrentProcess(this)
    }
}
