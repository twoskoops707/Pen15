package com.pentest.dashboard

import android.os.Bundle
import android.widget.ArrayAdapter
import android.widget.ImageView
import android.widget.ListView
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class WiFiDeauthActivity : AppCompatActivity() {

    private lateinit var networkList: ListView
    private lateinit var logOutput: TextView
    private lateinit var btnScan: MaterialButton
    private lateinit var btnDeauth: MaterialButton

    private val networks = mutableListOf<String>()
    private var selectedNetwork: String? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_wifi_deauth)

        initializeViews()
        setupClickListeners()
    }

    private fun initializeViews() {
        networkList = findViewById(R.id.networkList)
        logOutput = findViewById(R.id.logOutput)
        btnScan = findViewById(R.id.btnScan)
        btnDeauth = findViewById(R.id.btnDeauth)

        val adapter = ArrayAdapter(this, android.R.layout.simple_list_item_1, networks)
        networkList.adapter = adapter

        networkList.setOnItemClickListener { _, _, position, _ ->
            selectedNetwork = networks[position]
            addLog("Selected: $selectedNetwork")
            btnDeauth.isEnabled = true
        }
    }

    private fun setupClickListeners() {
        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnScan.setOnClickListener {
            scanNetworks()
        }

        btnDeauth.setOnClickListener {
            selectedNetwork?.let { startDeauth(it) }
        }
    }

    private fun scanNetworks() {
        addLog("=== WIFI SCAN STARTED ===")
        addLog("Sending scan command to ESP32 Marauder...")

        // Send real command via Termux
        val command = TermuxIntegration.WiFi.scanNetworks()
        addLog(command)

        addLog("This requires:")
        addLog("- ESP32 Marauder attached to Flipper")
        addLog("- OR monitor mode enabled on phone")
        addLog("")
        addLog("Scanning 2.4GHz channels...")
    }

    private fun startDeauth(network: String) {
        addLog("=== DEAUTH ATTACK STARTED ===")
        addLog("Target: $network")
        addLog("")
        addLog("This will:")
        addLog("1. Disconnect all clients from AP")
        addLog("2. Prevent reconnection")
        addLog("3. Capture WPA handshakes")
        addLog("")
        addLog("Sending deauth packets...")
        addLog("Press STOP to end attack")
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = logOutput.text.toString()
        logOutput.text = "[$timestamp] $message\n$currentLog"
    }
}
