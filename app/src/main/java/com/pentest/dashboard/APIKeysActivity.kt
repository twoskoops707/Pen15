package com.pentest.dashboard

import android.content.Context
import android.content.SharedPreferences
import android.os.Bundle
import android.widget.ImageView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton
import com.google.android.material.textfield.TextInputEditText

/**
 * API Keys Manager for OSINT/Recon Tools
 *
 * Manages API keys for:
 * - SpiderFoot (70+ modules)
 * - Recon-NG
 * - TheHarvester
 * - Other OSINT tools
 */
class APIKeysActivity : AppCompatActivity() {

    private lateinit var prefs: SharedPreferences

    // API Key Input Fields
    private lateinit var inputShodanApi: TextInputEditText
    private lateinit var inputVirusTotalApi: TextInputEditText
    private lateinit var inputHunterApi: TextInputEditText
    private lateinit var inputSecurityTrailsApi: TextInputEditText
    private lateinit var inputCensysApi: TextInputEditText
    private lateinit var inputBinaryEdgeApi: TextInputEditText
    private lateinit var inputFullContactApi: TextInputEditText
    private lateinit var inputHaveIBeenPwnedApi: TextInputEditText
    private lateinit var inputIPInfoApi: TextInputEditText
    private lateinit var inputIPQualityScoreApi: TextInputEditText
    private lateinit var inputGitHubApi: TextInputEditText
    private lateinit var inputTwitterApi: TextInputEditText
    private lateinit var inputFacebookApi: TextInputEditText
    private lateinit var inputLinkedInApi: TextInputEditText
    private lateinit var inputGoogleApi: TextInputEditText
    private lateinit var inputBingApi: TextInputEditText
    private lateinit var inputZoomEyeApi: TextInputEditText
    private lateinit var inputOnypheApi: TextInputEditText
    private lateinit var inputGreyNoiseApi: TextInputEditText
    private lateinit var inputAlienVaultApi: TextInputEditText

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_api_keys)

        prefs = getSharedPreferences("api_keys", Context.MODE_PRIVATE)

        initializeViews()
        loadApiKeys()
        setupClickListeners()
    }

    private fun initializeViews() {
        // Network Intelligence
        inputShodanApi = findViewById(R.id.inputShodanApi)
        inputCensysApi = findViewById(R.id.inputCensysApi)
        inputBinaryEdgeApi = findViewById(R.id.inputBinaryEdgeApi)
        inputZoomEyeApi = findViewById(R.id.inputZoomEyeApi)
        inputOnypheApi = findViewById(R.id.inputOnypheApi)
        inputGreyNoiseApi = findViewById(R.id.inputGreyNoiseApi)

        // Threat Intelligence
        inputVirusTotalApi = findViewById(R.id.inputVirusTotalApi)
        inputAlienVaultApi = findViewById(R.id.inputAlienVaultApi)
        inputIPQualityScoreApi = findViewById(R.id.inputIPQualityScoreApi)

        // Domain/DNS Intelligence
        inputSecurityTrailsApi = findViewById(R.id.inputSecurityTrailsApi)
        inputIPInfoApi = findViewById(R.id.inputIPInfoApi)

        // People/Email Intelligence
        inputHunterApi = findViewById(R.id.inputHunterApi)
        inputFullContactApi = findViewById(R.id.inputFullContactApi)
        inputHaveIBeenPwnedApi = findViewById(R.id.inputHaveIBeenPwnedApi)

        // Social Media APIs
        inputGitHubApi = findViewById(R.id.inputGitHubApi)
        inputTwitterApi = findViewById(R.id.inputTwitterApi)
        inputFacebookApi = findViewById(R.id.inputFacebookApi)
        inputLinkedInApi = findViewById(R.id.inputLinkedInApi)

        // Search Engine APIs
        inputGoogleApi = findViewById(R.id.inputGoogleApi)
        inputBingApi = findViewById(R.id.inputBingApi)
    }

    private fun loadApiKeys() {
        // Network Intelligence
        inputShodanApi.setText(prefs.getString("shodan_api", ""))
        inputCensysApi.setText(prefs.getString("censys_api", ""))
        inputBinaryEdgeApi.setText(prefs.getString("binaryedge_api", ""))
        inputZoomEyeApi.setText(prefs.getString("zoomeye_api", ""))
        inputOnypheApi.setText(prefs.getString("onyphe_api", ""))
        inputGreyNoiseApi.setText(prefs.getString("greynoise_api", ""))

        // Threat Intelligence
        inputVirusTotalApi.setText(prefs.getString("virustotal_api", ""))
        inputAlienVaultApi.setText(prefs.getString("alienvault_api", ""))
        inputIPQualityScoreApi.setText(prefs.getString("ipqualityscore_api", ""))

        // Domain/DNS Intelligence
        inputSecurityTrailsApi.setText(prefs.getString("securitytrails_api", ""))
        inputIPInfoApi.setText(prefs.getString("ipinfo_api", ""))

        // People/Email Intelligence
        inputHunterApi.setText(prefs.getString("hunter_api", ""))
        inputFullContactApi.setText(prefs.getString("fullcontact_api", ""))
        inputHaveIBeenPwnedApi.setText(prefs.getString("haveibeenpwned_api", ""))

        // Social Media
        inputGitHubApi.setText(prefs.getString("github_api", ""))
        inputTwitterApi.setText(prefs.getString("twitter_api", ""))
        inputFacebookApi.setText(prefs.getString("facebook_api", ""))
        inputLinkedInApi.setText(prefs.getString("linkedin_api", ""))

        // Search Engines
        inputGoogleApi.setText(prefs.getString("google_api", ""))
        inputBingApi.setText(prefs.getString("bing_api", ""))
    }

    private fun setupClickListeners() {
        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        // Save all API keys
        findViewById<MaterialButton>(R.id.btnSaveApiKeys).setOnClickListener {
            saveAllApiKeys()
        }

        // Export API keys to SpiderFoot config
        findViewById<MaterialButton>(R.id.btnExportToSpiderFoot).setOnClickListener {
            exportToSpiderFoot()
        }

        // Export to Recon-NG
        findViewById<MaterialButton>(R.id.btnExportToReconNG).setOnClickListener {
            exportToReconNG()
        }

        // Test API keys
        findViewById<MaterialButton>(R.id.btnTestApiKeys).setOnClickListener {
            testApiKeys()
        }
    }

    private fun saveAllApiKeys() {
        val editor = prefs.edit()

        // Network Intelligence
        editor.putString("shodan_api", inputShodanApi.text.toString())
        editor.putString("censys_api", inputCensysApi.text.toString())
        editor.putString("binaryedge_api", inputBinaryEdgeApi.text.toString())
        editor.putString("zoomeye_api", inputZoomEyeApi.text.toString())
        editor.putString("onyphe_api", inputOnypheApi.text.toString())
        editor.putString("greynoise_api", inputGreyNoiseApi.text.toString())

        // Threat Intelligence
        editor.putString("virustotal_api", inputVirusTotalApi.text.toString())
        editor.putString("alienvault_api", inputAlienVaultApi.text.toString())
        editor.putString("ipqualityscore_api", inputIPQualityScoreApi.text.toString())

        // Domain/DNS
        editor.putString("securitytrails_api", inputSecurityTrailsApi.text.toString())
        editor.putString("ipinfo_api", inputIPInfoApi.text.toString())

        // People/Email
        editor.putString("hunter_api", inputHunterApi.text.toString())
        editor.putString("fullcontact_api", inputFullContactApi.text.toString())
        editor.putString("haveibeenpwned_api", inputHaveIBeenPwnedApi.text.toString())

        // Social Media
        editor.putString("github_api", inputGitHubApi.text.toString())
        editor.putString("twitter_api", inputTwitterApi.text.toString())
        editor.putString("facebook_api", inputFacebookApi.text.toString())
        editor.putString("linkedin_api", inputLinkedInApi.text.toString())

        // Search Engines
        editor.putString("google_api", inputGoogleApi.text.toString())
        editor.putString("bing_api", inputBingApi.text.toString())

        editor.apply()

        Toast.makeText(this, "API keys saved successfully!", Toast.LENGTH_SHORT).show()
    }

    private fun exportToSpiderFoot() {
        val shodanApi = prefs.getString("shodan_api", "") ?: ""
        val virusTotalApi = prefs.getString("virustotal_api", "") ?: ""
        val hunterApi = prefs.getString("hunter_api", "") ?: ""
        val securityTrailsApi = prefs.getString("securitytrails_api", "") ?: ""
        val censysApi = prefs.getString("censys_api", "") ?: ""
        val binaryEdgeApi = prefs.getString("binaryedge_api", "") ?: ""
        val fullContactApi = prefs.getString("fullcontact_api", "") ?: ""
        val haveibeenpwnedApi = prefs.getString("haveibeenpwned_api", "") ?: ""
        val githubApi = prefs.getString("github_api", "") ?: ""
        val twitterApi = prefs.getString("twitter_api", "") ?: ""
        val googleApi = prefs.getString("google_api", "") ?: ""
        val bingApi = prefs.getString("bing_api", "") ?: ""
        val zoomeyeApi = prefs.getString("zoomeye_api", "") ?: ""
        val onypheApi = prefs.getString("onyphe_api", "") ?: ""
        val greynoiseApi = prefs.getString("greynoise_api", "") ?: ""
        val alienvaultApi = prefs.getString("alienvault_api", "") ?: ""

        // Create SpiderFoot config
        val configScript = """
            #!/data/data/com.termux/files/usr/bin/bash

            echo "=== CONFIGURING SPIDERFOOT API KEYS ==="
            cd ~/spiderfoot

            # Create config directory if doesn't exist
            mkdir -p ~/.spiderfoot

            # Write API keys to SpiderFoot config
            cat > ~/.spiderfoot/spiderfoot.conf <<EOF
            [main]
            __logging = True
            __database = spiderfoot.db
            __webaddr = 0.0.0.0
            __webport = 5001

            [apikeys]
            shodan = $shodanApi
            virustotal = $virusTotalApi
            hunter = $hunterApi
            securitytrails = $securityTrailsApi
            censys = $censysApi
            binaryedge = $binaryEdgeApi
            fullcontact = $fullContactApi
            haveibeenpwned = $haveibeenpwnedApi
            github = $githubApi
            twitter = $twitterApi
            google_api = $googleApi
            bing_api = $bingApi
            zoomeye = $zoomeyeApi
            onyphe = $onypheApi
            greynoise = $greynoiseApi
            alienvault = $alienvaultApi
            EOF

            echo "✓ SpiderFoot config created at ~/.spiderfoot/spiderfoot.conf"
            echo "✓ API keys configured for 16 services"
            echo ""
            echo "Start SpiderFoot:"
            echo "  cd ~/spiderfoot"
            echo "  python3 sf.py -l 0.0.0.0:5001"
        """.trimIndent()

        val termux = TermuxIntegration(this)
        termux.runCommand(configScript, background = false)

        Toast.makeText(this, "API keys exported to SpiderFoot!", Toast.LENGTH_LONG).show()
    }

    private fun exportToReconNG() {
        val shodanApi = prefs.getString("shodan_api", "") ?: ""
        val censysApi = prefs.getString("censys_api", "") ?: ""
        val binaryEdgeApi = prefs.getString("binaryedge_api", "") ?: ""
        val securityTrailsApi = prefs.getString("securitytrails_api", "") ?: ""
        val githubApi = prefs.getString("github_api", "") ?: ""

        val configScript = """
            #!/data/data/com.termux/files/usr/bin/bash

            echo "=== CONFIGURING RECON-NG API KEYS ==="

            # Add API keys to Recon-NG
            recon-ng -C "keys add shodan_api $shodanApi" \
                     -C "keys add censys_api $censysApi" \
                     -C "keys add binaryedge_api $binaryEdgeApi" \
                     -C "keys add securitytrails_api $securityTrailsApi" \
                     -C "keys add github_api $githubApi"

            echo "✓ Recon-NG API keys configured"
            echo ""
            echo "Start Recon-NG:"
            echo "  recon-ng"
        """.trimIndent()

        val termux = TermuxIntegration(this)
        termux.runCommand(configScript, background = false)

        Toast.makeText(this, "API keys exported to Recon-NG!", Toast.LENGTH_LONG).show()
    }

    private fun testApiKeys() {
        Toast.makeText(this, "Testing API keys... Check Termux for results", Toast.LENGTH_SHORT).show()

        val shodanApi = prefs.getString("shodan_api", "") ?: ""
        val virusTotalApi = prefs.getString("virustotal_api", "") ?: ""

        val testScript = """
            #!/data/data/com.termux/files/usr/bin/bash

            echo "=== TESTING API KEYS ==="
            echo ""

            # Test Shodan API
            if [ -n "$shodanApi" ]; then
                echo "[*] Testing Shodan API..."
                curl -s "https://api.shodan.io/api-info?key=$shodanApi" | grep -q "query_credits" && echo "  ✓ Shodan API valid" || echo "  ✗ Shodan API invalid"
            fi

            # Test VirusTotal API
            if [ -n "$virusTotalApi" ]; then
                echo "[*] Testing VirusTotal API..."
                curl -s "https://www.virustotal.com/api/v3/ip_addresses/8.8.8.8" -H "x-apikey: $virusTotalApi" | grep -q "data" && echo "  ✓ VirusTotal API valid" || echo "  ✗ VirusTotal API invalid"
            fi

            echo ""
            echo "=== API TEST COMPLETE ==="
        """.trimIndent()

        val termux = TermuxIntegration(this)
        termux.runCommand(testScript, background = false)
    }

    companion object {
        /**
         * Get API key from shared preferences
         */
        fun getApiKey(context: Context, keyName: String): String {
            val prefs = context.getSharedPreferences("api_keys", Context.MODE_PRIVATE)
            return prefs.getString(keyName, "") ?: ""
        }
    }
}
