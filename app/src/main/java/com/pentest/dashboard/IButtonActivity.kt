package com.pentest.dashboard

import android.os.Bundle
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class IButtonActivity : AppCompatActivity() {

    private lateinit var keyStatus: TextView
    private lateinit var keyId: TextView
    private lateinit var keyInfo: TextView
    private lateinit var btnWriteKey: MaterialButton
    private lateinit var btnEmulateKey: MaterialButton

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_ibutton)

        keyStatus = findViewById(R.id.keyStatus)
        keyId = findViewById(R.id.keyId)
        keyInfo = findViewById(R.id.keyInfo)
        btnWriteKey = findViewById(R.id.btnWriteKey)
        btnEmulateKey = findViewById(R.id.btnEmulateKey)

        FlipperConnectionManager.setDataReceivedCallback { data ->
            runOnUiThread {
                addLog("FLIPPER: $data")
            }
        }

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        findViewById<MaterialButton>(R.id.btnReadKey).setOnClickListener {
            readKey()
        }

        btnWriteKey.setOnClickListener {
            writeKey()
        }

        btnEmulateKey.setOnClickListener {
            emulateKey()
        }

        findViewById<MaterialButton>(R.id.btnSavedKeys).setOnClickListener {
            showSavedKeys()
        }
    }

    private fun readKey() {
        keyStatus.text = "READING IBUTTON..."
        addLog("=== IBUTTON READ STARTED ===")
        addLog("Opening Flipper iButton app...")

        if (FlipperConnectionManager.isConnected()) {
            // Launch iButton app on Flipper
            FlipperConnectionManager.sendCommand("loader open iButton")

            // Wait then send read command
            keyStatus.postDelayed({
                FlipperConnectionManager.sendCommand("ibutton read")
                addLog("Sent: ibutton read")
                addLog("Touch iButton key to Flipper contact...")
            }, 2000)
        } else {
            executeViaTermux()
        }
    }

    private fun executeViaTermux() {
        addLog("Flipper not connected via USB")
        addLog("Launching Termux script for iButton read...")

        val ibuttonScript = """
            #!/data/data/com.termux/files/usr/bin/bash

            echo "=== IBUTTON KEY READ ==="
            echo "This requires:"
            echo "1. Flipper Zero connected via USB"
            echo "2. iButton app running on Flipper"
            echo "3. iButton key touched to Flipper contacts"
            echo ""

            # Try to send command to Flipper
            for dev in /dev/ttyACM0 /dev/ttyUSB0; do
                if [ -e "${'$'}dev" ]; then
                    echo "Found Flipper at: ${'$'}dev"
                    echo "loader open iButton" > ${'$'}dev
                    sleep 2
                    echo "ibutton read" > ${'$'}dev
                    echo "Sent iButton read command"
                    echo "Touch key to Flipper - check Flipper screen for results"
                    exit 0
                fi
            done

            echo "ERROR: Flipper not found on USB"
            echo "Make sure Flipper is connected and USB permission granted"
        """.trimIndent()

        val termux = TermuxIntegration(this)
        termux.runCommand(ibuttonScript, background = false)

        Toast.makeText(this, "iButton read script launched in Termux", Toast.LENGTH_LONG).show()
    }

    private fun writeKey() {
        if (flipperUSB?.isConnected() != true) {
            Toast.makeText(this, "Connect Flipper Zero via USB first", Toast.LENGTH_LONG).show()
            return
        }

        addLog("=== IBUTTON WRITE ===")
        addLog("Opening iButton app...")

        FlipperConnectionManager.sendCommand("loader open iButton")
        keyStatus.postDelayed({
            FlipperConnectionManager.sendCommand("ibutton write")
            addLog("Sent: ibutton write")
            addLog("Touch writable key to Flipper")
        }, 2000)
    }

    private fun emulateKey() {
        if (flipperUSB?.isConnected() != true) {
            Toast.makeText(this, "Connect Flipper Zero via USB first", Toast.LENGTH_LONG).show()
            return
        }

        addLog("=== IBUTTON EMULATE ===")
        addLog("Opening iButton app...")

        FlipperConnectionManager.sendCommand("loader open iButton")
        keyStatus.postDelayed({
            FlipperConnectionManager.sendCommand("ibutton emulate")
            addLog("Sent: ibutton emulate")
            addLog("Flipper is now emulating saved iButton key")
        }, 2000)
    }

    private fun showSavedKeys() {
        addLog("=== SAVED IBUTTON KEYS ===")
        addLog("Listing saved keys on Flipper...")

        if (FlipperConnectionManager.isConnected()) {
            FlipperConnectionManager.sendCommand("storage list /ext/ibutton")
            addLog("Sent: storage list /ext/ibutton")
        } else {
            Toast.makeText(this, "Connect Flipper to view saved keys", Toast.LENGTH_SHORT).show()
        }
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = keyInfo.text.toString()
        val newLog = "[$timestamp] $message\n$currentLog"
        keyInfo.text = newLog
    }

    override fun onDestroy() {
        super.onDestroy()
    }
}
