package com.pentest.dashboard

import android.os.Bundle
import android.view.View
import android.widget.ImageView
import android.widget.ProgressBar
import android.widget.ScrollView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton
import java.io.File

class IButtonActivity : AppCompatActivity() {

    private lateinit var keyStatus: TextView
    private lateinit var keyId: TextView
    private lateinit var keyInfo: TextView
    private lateinit var keyInfoScroll: ScrollView
    private lateinit var btnWriteKey: MaterialButton
    private lateinit var btnEmulateKey: MaterialButton
    private lateinit var progressBar: ProgressBar

    private var hasKey = false
    private var lastKeyData: String? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_ibutton)

        ProcessManager.stopCurrentProcess(this)

        keyStatus = findViewById(R.id.keyStatus)
        keyId = findViewById(R.id.keyId)
        keyInfo = findViewById(R.id.keyInfo)
        keyInfoScroll = findViewById(R.id.keyInfoScroll)
        btnWriteKey = findViewById(R.id.btnWriteKey)
        btnEmulateKey = findViewById(R.id.btnEmulateKey)
        progressBar = findViewById(R.id.progressBar)

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        findViewById<MaterialButton>(R.id.btnReadKey).setOnClickListener {
            readKey()
        }

        btnWriteKey.setOnClickListener {
            Toast.makeText(this, "Write key - Coming soon", Toast.LENGTH_SHORT).show()
        }

        btnEmulateKey.setOnClickListener {
            Toast.makeText(this, "Emulating key...", Toast.LENGTH_SHORT).show()
        }

        addLog("iButton Reader Ready")
        addLog("Using pyflipper - REAL Flipper API")
        addLog("")
        addLog("Click READ KEY to scan Dallas/iButton key")
    }

    private fun readKey() {
        keyStatus.text = "READING..."
        progressBar.visibility = View.VISIBLE
        addLog("")
        addLog("=== STARTING IBUTTON READ ===")
        addLog("Running: python ibutton_read.py")

        val termux = TermuxIntegration(this)
        val outputFile = File(cacheDir, "ibutton_output.txt")
        
        val command = """
            cd /data/data/com.termux/files/home/Pen15/scripts && \
            python3 ibutton_read.py > ${outputFile.absolutePath} 2>&1
        """.trimIndent()
        
        termux.runCommand(command, background = true)
        
        // Poll for results
        android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({
            Thread {
                try {
                    Thread.sleep(3000)
                    val output = if (outputFile.exists()) outputFile.readText() else "ERROR|No output"
                    runOnUiThread {
                        progressBar.visibility = View.GONE
                        parseIButtonOutput(output)
                    }
                } catch (e: Exception) {
                    runOnUiThread {
                        progressBar.visibility = View.GONE
                        addLog("ERROR: ${e.message}")
                    }
                }
            }.start()
        }, 500)
    }

    private fun parseIButtonOutput(output: String) {
        addLog("")
        addLog("=== FLIPPER RESPONSE ===")
        addLog(output)

        when {
            output.contains("SUCCESS") -> {
                val parts = output.lines().last().split("|")
                if (parts.size >= 3 && parts[0] == "SUCCESS") {
                    val keyType = parts[1]
                    val keyData = parts[2]

                    hasKey = true
                    lastKeyData = "$keyType|$keyData"

                    keyStatus.text = "KEY DETECTED"
                    keyId.text = "ID: $keyData"

                    addLog("")
                    addLog("✅ Key Type: $keyType")
                    addLog("✅ Key Data: $keyData")

                    btnWriteKey.isEnabled = true
                    btnEmulateKey.isEnabled = true

                    Toast.makeText(this, "✓ iButton key read!", Toast.LENGTH_SHORT).show()
                }
            }

            output.contains("ERROR") -> {
                val error = output.substringAfter("ERROR|")
                keyStatus.text = "ERROR"
                addLog("")
                addLog("❌ $error")
                Toast.makeText(this, "Error: $error", Toast.LENGTH_LONG).show()
            }

            output.contains("No key detected") -> {
                keyStatus.text = "NO KEY"
                addLog("")
                addLog("⚠️ No key detected")
                addLog("Touch iButton key to Flipper contact pad")
                Toast.makeText(this, "No key found", Toast.LENGTH_SHORT).show()
            }

            else -> {
                keyStatus.text = "WAITING..."
                addLog("⚠️ Unexpected response")
                Toast.makeText(this, "Check logs", Toast.LENGTH_SHORT).show()
            }
        }
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentText = keyInfo.text.toString()
        keyInfo.text = "$currentText\n[$timestamp] $message"

        keyInfoScroll?.post {
            keyInfoScroll.fullScroll(ScrollView.FOCUS_DOWN)
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        ProcessManager.stopCurrentProcess(this)
    }
}
