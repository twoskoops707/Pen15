package com.pentest.dashboard

import android.os.Bundle
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class GPIOActivity : AppCompatActivity() {

    private lateinit var gpioOutput: TextView
    private var flipperUSB: FlipperUSBManager? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_gpio)

        gpioOutput = findViewById(R.id.gpioOutput)

        flipperUSB = FlipperUSBManager(this)
        flipperUSB?.setDataReceivedCallback { data ->
            runOnUiThread {
                addLog("FLIPPER: $data")
            }
        }

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        // GPIO Pin Control
        findViewById<MaterialButton>(R.id.btnPinControl).setOnClickListener {
            controlGPIO()
        }

        // ESP32 Marauder Controls
        findViewById<MaterialButton>(R.id.btnMarauder).setOnClickListener {
            launchMarauder()
        }

        findViewById<MaterialButton>(R.id.btnDeauth).setOnClickListener {
            marauderDeauth()
        }

        findViewById<MaterialButton>(R.id.btnEvilPortal).setOnClickListener {
            marauderEvilPortal()
        }

        findViewById<MaterialButton>(R.id.btnWifiScan).setOnClickListener {
            marauderWiFiScan()
        }

        findViewById<MaterialButton>(R.id.btnBLESpam).setOnClickListener {
            marauderBLESpam()
        }

        findViewById<MaterialButton>(R.id.btnBeaconSpam).setOnClickListener {
            marauderBeaconSpam()
        }

        findViewById<MaterialButton>(R.id.btnProbeSniff).setOnClickListener {
            marauderProbeSniff()
        }

        findViewById<MaterialButton>(R.id.btnPacketCapture).setOnClickListener {
            marauderPacketCapture()
        }
    }

    private fun controlGPIO() {
        addLog("=== GPIO PIN CONTROL ===")
        addLog("Flipper GPIO pins: 0-15")

        if (flipperUSB?.isConnected() == true) {
            // Example: Set pin 5 high
            flipperUSB?.sendCommand("gpio mode 5 1")  // Set as output
            addLog("Sent: gpio mode 5 1")

            gpioOutput.postDelayed({
                flipperUSB?.sendCommand("gpio set 5 1")  // Set high
                addLog("Sent: gpio set 5 1")
                addLog("Pin 5 is now HIGH (3.3V)")
            }, 500)
        } else {
            Toast.makeText(this, "Connect Flipper via USB for GPIO control", Toast.LENGTH_LONG).show()
        }
    }

    private fun launchMarauder() {
        addLog("=== ESP32 MARAUDER ===")
        addLog("Launching Marauder interface...")
        addLog("")
        addLog("ESP32 Marauder Commands:")
        addLog("• WiFi Deauth Attack")
        addLog("• Evil Portal (Fake AP)")
        addLog("• WiFi Scanner")
        addLog("• BLE Spam")
        addLog("• Beacon Spam")
        addLog("• Probe Request Sniffer")
        addLog("• Packet Capture → Crack")
        addLog("")
        addLog("Select an attack from the buttons above")
    }

    private fun marauderDeauth() {
        addLog("=== WiFi DEAUTH ATTACK ===")
        addLog("Sends deauth packets to disconnect clients")

        if (flipperUSB?.isConnected() == true) {
            flipperUSB?.sendCommand("gpio uart_tx")
            addLog("Opening UART to ESP32...")

            gpioOutput.postDelayed({
                val cmd = "deauth -a"  // Deauth all
                flipperUSB?.sendCommand(cmd)
                addLog("Sent to Marauder: $cmd")
                addLog("Deauth attack running...")
            }, 1000)
        } else {
            executeMarauderViaTermux("deauth")
        }
    }

    private fun marauderEvilPortal() {
        addLog("=== EVIL PORTAL ===")
        addLog("Creates fake captive portal AP")

        if (flipperUSB?.isConnected() == true) {
            val cmd = "ap -s FreeWiFi -p password123"
            flipperUSB?.sendCommand("gpio uart_tx")
            gpioOutput.postDelayed({
                flipperUSB?.sendCommand(cmd)
                addLog("Sent: $cmd")
                addLog("Evil portal launched")
            }, 1000)
        } else {
            executeMarauderViaTermux("evilportal")
        }
    }

    private fun marauderWiFiScan() {
        addLog("=== WiFi SCANNER ===")
        addLog("Scanning for WiFi networks...")

        if (flipperUSB?.isConnected() == true) {
            flipperUSB?.sendCommand("gpio uart_tx")
            gpioOutput.postDelayed({
                flipperUSB?.sendCommand("scan -w")
                addLog("Sent: scan -w")
                addLog("WiFi scan in progress...")
            }, 1000)
        } else {
            executeMarauderViaTermux("wifiscan")
        }
    }

    private fun marauderBLESpam() {
        addLog("=== BLE SPAM ===")
        addLog("Spamming BLE advertisements")

        if (flipperUSB?.isConnected() == true) {
            flipperUSB?.sendCommand("gpio uart_tx")
            gpioOutput.postDelayed({
                flipperUSB?.sendCommand("blespam")
                addLog("Sent: blespam")
                addLog("BLE spam active")
            }, 1000)
        } else {
            executeMarauderViaTermux("blespam")
        }
    }

    private fun marauderBeaconSpam() {
        addLog("=== BEACON SPAM ===")
        addLog("Flooding fake WiFi beacons")

        if (flipperUSB?.isConnected() == true) {
            flipperUSB?.sendCommand("gpio uart_tx")
            gpioOutput.postDelayed({
                flipperUSB?.sendCommand("beaconspam -r")
                addLog("Sent: beaconspam -r")
                addLog("Beacon spam running")
            }, 1000)
        } else {
            executeMarauderViaTermux("beaconspam")
        }
    }

    private fun marauderProbeSniff() {
        addLog("=== PROBE SNIFFER ===")
        addLog("Capturing WiFi probe requests")

        if (flipperUSB?.isConnected() == true) {
            flipperUSB?.sendCommand("gpio uart_tx")
            gpioOutput.postDelayed({
                flipperUSB?.sendCommand("sniffprobe")
                addLog("Sent: sniffprobe")
                addLog("Sniffing probe requests...")
            }, 1000)
        } else {
            executeMarauderViaTermux("probesniff")
        }
    }

    private fun marauderPacketCapture() {
        addLog("=== PACKET CAPTURE → CRACK ===")
        addLog("Capturing handshakes for cracking")

        if (flipperUSB?.isConnected() == true) {
            flipperUSB?.sendCommand("gpio uart_tx")
            gpioOutput.postDelayed({
                flipperUSB?.sendCommand("sniff -c 6")
                addLog("Sent: sniff -c 6")
                addLog("Capturing on channel 6...")
            }, 1000)
        } else {
            executeMarauderViaTermux("capture")
        }
    }

    private fun executeMarauderViaTermux(attack: String) {
        addLog("Flipper not connected")
        addLog("Launching Termux script for $attack...")

        val marauderScript = """
            #!/data/data/com.termux/files/usr/bin/bash

            echo "=== ESP32 MARAUDER: ${attack.uppercase()} ==="
            echo "This requires:"
            echo "1. Flipper Zero connected via USB"
            echo "2. ESP32 Marauder on GPIO"
            echo "3. UART bridge enabled"
            echo ""

            # Send commands to Flipper which forwards to ESP32
            for dev in /dev/ttyACM0 /dev/ttyUSB0; do
                if [ -e "${'$'}dev" ]; then
                    echo "Found Flipper at: ${'$'}dev"

                    case "$attack" in
                        deauth)
                            echo "deauth -a" > ${'$'}dev
                            ;;
                        evilportal)
                            echo "ap -s FreeWiFi -p password123" > ${'$'}dev
                            ;;
                        wifiscan)
                            echo "scan -w" > ${'$'}dev
                            ;;
                        blespam)
                            echo "blespam" > ${'$'}dev
                            ;;
                        beaconspam)
                            echo "beaconspam -r" > ${'$'}dev
                            ;;
                        probesniff)
                            echo "sniffprobe" > ${'$'}dev
                            ;;
                        capture)
                            echo "sniff -c 6" > ${'$'}dev
                            ;;
                    esac

                    echo "Marauder command sent"
                    echo "Check Flipper screen for results"
                    exit 0
                fi
            done

            echo "ERROR: Flipper not found"
        """.trimIndent()

        val termux = TermuxIntegration(this)
        termux.runCommand(marauderScript, background = false)

        Toast.makeText(this, "Marauder $attack script launched in Termux", Toast.LENGTH_LONG).show()
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = gpioOutput.text.toString()
        val newLog = "[$timestamp] $message\n$currentLog"
        gpioOutput.text = newLog
    }

    override fun onDestroy() {
        super.onDestroy()
        flipperUSB?.cleanup()
    }
}
