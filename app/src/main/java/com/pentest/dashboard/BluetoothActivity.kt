package com.pentest.dashboard

import android.Manifest
import android.bluetooth.BluetoothAdapter
import android.bluetooth.BluetoothDevice
import android.bluetooth.BluetoothManager
import android.bluetooth.le.BluetoothLeScanner
import android.bluetooth.le.ScanCallback
import android.bluetooth.le.ScanResult
import android.content.Context
import android.content.pm.PackageManager
import android.os.Build
import android.os.Bundle
import android.widget.ArrayAdapter
import android.widget.ImageView
import android.widget.ListView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.core.app.ActivityCompat
import com.google.android.material.button.MaterialButton

data class BLEDevice(
    val name: String,
    val address: String,
    val rssi: Int
) {
    override fun toString(): String {
        return "$name\n$address\nSignal: $rssi dBm"
    }
}

class BluetoothActivity : AppCompatActivity() {

    private lateinit var deviceCount: TextView
    private lateinit var bleDevices: TextView
    private lateinit var bleDeviceList: ListView
    private lateinit var btnScanBLE: MaterialButton
    private var isScanning = false

    private val scannedDevices = mutableListOf<BLEDevice>()
    private lateinit var deviceAdapter: ArrayAdapter<BLEDevice>
    private var bluetoothLeScanner: BluetoothLeScanner? = null
    private var bluetoothAdapter: BluetoothAdapter? = null

    private val leScanCallback = object : ScanCallback() {
        override fun onScanResult(callbackType: Int, result: ScanResult) {
            if (ActivityCompat.checkSelfPermission(
                    this@BluetoothActivity,
                    Manifest.permission.BLUETOOTH_CONNECT
                ) != PackageManager.PERMISSION_GRANTED
            ) {
                return
            }

            val device = result.device
            val deviceName = device.name ?: "Unknown Device"
            val deviceAddress = device.address
            val rssi = result.rssi

            // Check if already in list
            val existingIndex = scannedDevices.indexOfFirst { it.address == deviceAddress }
            if (existingIndex >= 0) {
                // Update existing device
                scannedDevices[existingIndex] = BLEDevice(deviceName, deviceAddress, rssi)
            } else {
                // Add new device
                scannedDevices.add(BLEDevice(deviceName, deviceAddress, rssi))
            }

            runOnUiThread {
                deviceAdapter.notifyDataSetChanged()
                deviceCount.text = scannedDevices.size.toString()
                addDevice("DEVICE", "Found: $deviceName ($deviceAddress) $rssi dBm")
            }
        }

        override fun onScanFailed(errorCode: Int) {
            addDevice("ERROR", "Scan failed with error: $errorCode")
            Toast.makeText(this@BluetoothActivity, "Scan failed: $errorCode", Toast.LENGTH_SHORT).show()
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_bluetooth)

        deviceCount = findViewById(R.id.deviceCount)
        bleDevices = findViewById(R.id.bleDevices)
        bleDeviceList = findViewById(R.id.bleDeviceList)
        btnScanBLE = findViewById(R.id.btnScanBLE)

        // Setup Bluetooth
        val bluetoothManager = getSystemService(Context.BLUETOOTH_SERVICE) as BluetoothManager
        bluetoothAdapter = bluetoothManager.adapter
        bluetoothLeScanner = bluetoothAdapter?.bluetoothLeScanner

        // Setup ListView
        deviceAdapter = ArrayAdapter(this, android.R.layout.simple_list_item_1, scannedDevices)
        bleDeviceList.adapter = deviceAdapter

        FlipperConnectionManager.setDataReceivedCallback { data ->
            runOnUiThread {
                addDevice("FLIPPER", data)
            }
        }

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnScanBLE.setOnClickListener {
            if (isScanning) {
                stopScan()
            } else {
                startScan()
            }
        }

        findViewById<MaterialButton>(R.id.btnSniff).setOnClickListener {
            bleSniff()
        }

        findViewById<MaterialButton>(R.id.btnSpoof).setOnClickListener {
            bleSpam()
        }

        findViewById<MaterialButton>(R.id.btnClearList).setOnClickListener {
            clearList()
        }
    }

    private fun startScan() {
        isScanning = true
        btnScanBLE.text = "STOP SCANNING"
        btnScanBLE.backgroundTintList = getColorStateList(R.color.status_disconnected)

        addDevice("BLE SCAN", "Starting Bluetooth scan...")

        if (FlipperConnectionManager.isConnected()) {
            FlipperConnectionManager.sendCommand("loader open Bluetooth")
            addDevice("CMD", "Sent: loader open Bluetooth")

            bleDevices.postDelayed({
                FlipperConnectionManager.sendCommand("bt scan")
                addDevice("CMD", "Sent: bt scan")
                addDevice("STATUS", "Scanning for BLE devices...")
            }, 2000)
        } else {
            executeViaTermux("scan")
        }
    }

    private fun stopScan() {
        isScanning = false
        btnScanBLE.text = "START BLE SCAN"
        btnScanBLE.backgroundTintList = getColorStateList(R.color.func_bluetooth)

        if (FlipperConnectionManager.isConnected()) {
            FlipperConnectionManager.sendCommand("bt stop")
            addDevice("CMD", "Sent: bt stop")
            addDevice("STATUS", "Scan stopped")
        } else {
            addDevice("STATUS", "Scan stopped")
        }
    }

    private fun bleSniff() {
        addDevice("BLE SNIFF", "Starting packet sniffer...")

        if (FlipperConnectionManager.isConnected()) {
            FlipperConnectionManager.sendCommand("loader open Bluetooth")

            bleDevices.postDelayed({
                FlipperConnectionManager.sendCommand("bt sniff")
                addDevice("CMD", "Sent: bt sniff")
                addDevice("STATUS", "Sniffing BLE packets...")
            }, 2000)
        } else {
            executeViaTermux("sniff")
        }
    }

    private fun bleSpam() {
        addDevice("BLE SPAM", "Starting advertisement spam...")

        if (FlipperConnectionManager.isConnected()) {
            FlipperConnectionManager.sendCommand("loader open Bluetooth")

            bleDevices.postDelayed({
                FlipperConnectionManager.sendCommand("bt spam")
                addDevice("CMD", "Sent: bt spam")
                addDevice("STATUS", "Spamming BLE advertisements")
            }, 2000)
        } else {
            executeViaTermux("spam")
        }
    }

    private fun executeViaTermux(mode: String) {
        addDevice("TERMUX", "Launching $mode script...")

        val bleScript = """
            #!/data/data/com.termux/files/usr/bin/bash

            echo "=== BLE ${mode.uppercase()} ==="
            echo "This requires:"
            echo "1. Flipper Zero connected via USB"
            echo "2. Bluetooth app on Flipper"
            echo ""

            # Send commands to Flipper
            for dev in /dev/ttyACM0 /dev/ttyUSB0; do
                if [ -e "${'$'}dev" ]; then
                    echo "Found Flipper at: ${'$'}dev"
                    echo "loader open Bluetooth" > ${'$'}dev
                    sleep 2

                    case "$mode" in
                        scan)
                            echo "bt scan" > ${'$'}dev
                            echo "BLE scan started"
                            ;;
                        sniff)
                            echo "bt sniff" > ${'$'}dev
                            echo "BLE sniffer started"
                            ;;
                        spam)
                            echo "bt spam" > ${'$'}dev
                            echo "BLE spam started"
                            ;;
                    esac

                    echo "Check Flipper screen for results"
                    exit 0
                fi
            done

            echo "ERROR: Flipper not found on USB"
        """.trimIndent()

        val termux = TermuxIntegration(this)
        termux.runCommand(bleScript, background = false)

        Toast.makeText(this, "BLE $mode script launched in Termux", Toast.LENGTH_LONG).show()
    }

    private fun clearList() {
        bleDevices.text = ""
        deviceCount.text = "0"
    }

    private fun addDevice(label: String, info: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentText = bleDevices.text.toString()
        bleDevices.text = """
            $currentText
            [$timestamp] $label: $info
        """.trimIndent()

        // Update device count
        val count = bleDevices.text.toString().split("\n").size
        deviceCount.text = count.toString()
    }
}
