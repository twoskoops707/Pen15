package com.pentest.dashboard

import android.os.Bundle
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class BluetoothActivity : AppCompatActivity() {

    private lateinit var deviceCount: TextView
    private lateinit var bleDevices: TextView
    private lateinit var btnScanBLE: MaterialButton
    private var flipperUSB: FlipperUSBManager? = null
    private var isScanning = false

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_bluetooth)

        deviceCount = findViewById(R.id.deviceCount)
        bleDevices = findViewById(R.id.bleDevices)
        btnScanBLE = findViewById(R.id.btnScanBLE)

        flipperUSB = FlipperUSBManager(this)
        flipperUSB?.setDataReceivedCallback { data ->
            runOnUiThread {
                addDevice("FLIPPER DATA", data)
            }
        }

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnScanBLE.setOnClickListener {
            if (isScanning) {
                stopScan()
            } else {
                startScan()
            }
        }

        findViewById<MaterialButton>(R.id.btnSniff).setOnClickListener {
            bleSniff()
        }

        findViewById<MaterialButton>(R.id.btnSpoof).setOnClickListener {
            bleSpam()
        }

        findViewById<MaterialButton>(R.id.btnClearList).setOnClickListener {
            clearList()
        }
    }

    private fun startScan() {
        isScanning = true
        btnScanBLE.text = "STOP SCANNING"
        btnScanBLE.backgroundTintList = getColorStateList(R.color.status_disconnected)

        addDevice("BLE SCAN", "Starting Bluetooth scan...")

        if (flipperUSB?.isConnected() == true) {
            flipperUSB?.sendCommand("loader open Bluetooth")
            addDevice("CMD", "Sent: loader open Bluetooth")

            bleDevices.postDelayed({
                flipperUSB?.sendCommand("bt scan")
                addDevice("CMD", "Sent: bt scan")
                addDevice("STATUS", "Scanning for BLE devices...")
            }, 2000)
        } else {
            executeViaTermux("scan")
        }
    }

    private fun stopScan() {
        isScanning = false
        btnScanBLE.text = "START BLE SCAN"
        btnScanBLE.backgroundTintList = getColorStateList(R.color.func_bluetooth)

        if (flipperUSB?.isConnected() == true) {
            flipperUSB?.sendCommand("bt stop")
            addDevice("CMD", "Sent: bt stop")
            addDevice("STATUS", "Scan stopped")
        } else {
            addDevice("STATUS", "Scan stopped")
        }
    }

    private fun bleSniff() {
        addDevice("BLE SNIFF", "Starting packet sniffer...")

        if (flipperUSB?.isConnected() == true) {
            flipperUSB?.sendCommand("loader open Bluetooth")

            bleDevices.postDelayed({
                flipperUSB?.sendCommand("bt sniff")
                addDevice("CMD", "Sent: bt sniff")
                addDevice("STATUS", "Sniffing BLE packets...")
            }, 2000)
        } else {
            executeViaTermux("sniff")
        }
    }

    private fun bleSpam() {
        addDevice("BLE SPAM", "Starting advertisement spam...")

        if (flipperUSB?.isConnected() == true) {
            flipperUSB?.sendCommand("loader open Bluetooth")

            bleDevices.postDelayed({
                flipperUSB?.sendCommand("bt spam")
                addDevice("CMD", "Sent: bt spam")
                addDevice("STATUS", "Spamming BLE advertisements")
            }, 2000)
        } else {
            executeViaTermux("spam")
        }
    }

    private fun executeViaTermux(mode: String) {
        addDevice("TERMUX", "Launching $mode script...")

        val bleScript = """
            #!/data/data/com.termux/files/usr/bin/bash

            echo "=== BLE ${mode.uppercase()} ==="
            echo "This requires:"
            echo "1. Flipper Zero connected via USB"
            echo "2. Bluetooth app on Flipper"
            echo ""

            # Send commands to Flipper
            for dev in /dev/ttyACM0 /dev/ttyUSB0; do
                if [ -e "${'$'}dev" ]; then
                    echo "Found Flipper at: ${'$'}dev"
                    echo "loader open Bluetooth" > ${'$'}dev
                    sleep 2

                    case "$mode" in
                        scan)
                            echo "bt scan" > ${'$'}dev
                            echo "BLE scan started"
                            ;;
                        sniff)
                            echo "bt sniff" > ${'$'}dev
                            echo "BLE sniffer started"
                            ;;
                        spam)
                            echo "bt spam" > ${'$'}dev
                            echo "BLE spam started"
                            ;;
                    esac

                    echo "Check Flipper screen for results"
                    exit 0
                fi
            done

            echo "ERROR: Flipper not found on USB"
        """.trimIndent()

        val termux = TermuxIntegration(this)
        termux.runCommand(bleScript, background = false)

        Toast.makeText(this, "BLE $mode script launched in Termux", Toast.LENGTH_LONG).show()
    }

    private fun clearList() {
        bleDevices.text = ""
        deviceCount.text = "0"
    }

    private fun addDevice(label: String, info: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentText = bleDevices.text.toString()
        bleDevices.text = """
            $currentText
            [$timestamp] $label: $info
        """.trimIndent()

        // Update device count
        val count = bleDevices.text.toString().split("\n").size
        deviceCount.text = count.toString()
    }

    override fun onDestroy() {
        super.onDestroy()
        flipperUSB?.cleanup()
    }
}
