package com.pentest.dashboard

import android.os.Bundle
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class BluetoothActivity : AppCompatActivity() {

    private lateinit var deviceCount: TextView
    private lateinit var bleDevices: TextView
    private lateinit var btnScanBLE: MaterialButton

    private var isScanning = false
    private var foundDevices = 0

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_bluetooth)

        deviceCount = findViewById(R.id.deviceCount)
        bleDevices = findViewById(R.id.bleDevices)
        btnScanBLE = findViewById(R.id.btnScanBLE)

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnScanBLE.setOnClickListener {
            if (isScanning) {
                stopScan()
            } else {
                startScan()
            }
        }

        findViewById<MaterialButton>(R.id.btnSniff).setOnClickListener {
            Toast.makeText(this, "Packet Sniffer - Coming soon", Toast.LENGTH_SHORT).show()
        }

        findViewById<MaterialButton>(R.id.btnSpoof).setOnClickListener {
            Toast.makeText(this, "MAC Spoofing - Coming soon", Toast.LENGTH_SHORT).show()
        }

        findViewById<MaterialButton>(R.id.btnClearList).setOnClickListener {
            clearList()
        }
    }

    private fun startScan() {
        isScanning = true
        btnScanBLE.text = "STOP SCANNING"
        btnScanBLE.backgroundTintList = getColorStateList(R.color.status_disconnected)
        bleDevices.text = """
            REAL BLE SCAN - Requires Android Bluetooth API

            This feature is NOT yet implemented.

            Needs: Android Bluetooth LE scan
            Would show actual devices in range
            NO FAKE DEVICES will appear
        """.trimIndent()
    }

    private fun stopScan() {
        isScanning = false
        btnScanBLE.text = "START BLE SCAN"
        btnScanBLE.backgroundTintList = getColorStateList(R.color.func_bluetooth)
        val currentText = bleDevices.text.toString()
        bleDevices.text = "$currentText\nScan stopped."
    }

    private fun addDevice(name: String, mac: String, rssi: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentText = bleDevices.text.toString()
        bleDevices.text = """
            $currentText
            [$timestamp] $name
            MAC: $mac | Signal: $rssi

        """.trimIndent()
    }

    private fun clearList() {
        foundDevices = 0
        deviceCount.text = "0"
        bleDevices.text = "Device list cleared.\n"
    }
}
