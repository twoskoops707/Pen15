package com.pentest.dashboard

import android.os.Bundle
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class BluetoothActivity : AppCompatActivity() {

    private lateinit var deviceCount: TextView
    private lateinit var bleDevices: TextView
    private lateinit var btnScanBLE: MaterialButton

    private var isScanning = false
    private var foundDevices = 0

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_bluetooth)

        deviceCount = findViewById(R.id.deviceCount)
        bleDevices = findViewById(R.id.bleDevices)
        btnScanBLE = findViewById(R.id.btnScanBLE)

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnScanBLE.setOnClickListener {
            if (isScanning) {
                stopScan()
            } else {
                startScan()
            }
        }

        findViewById<MaterialButton>(R.id.btnSniff).setOnClickListener {
            Toast.makeText(this, "Packet Sniffer - Coming soon", Toast.LENGTH_SHORT).show()
        }

        findViewById<MaterialButton>(R.id.btnSpoof).setOnClickListener {
            Toast.makeText(this, "MAC Spoofing - Coming soon", Toast.LENGTH_SHORT).show()
        }

        findViewById<MaterialButton>(R.id.btnClearList).setOnClickListener {
            clearList()
        }
    }

    private fun startScan() {
        isScanning = true
        btnScanBLE.text = "STOP SCANNING"
        btnScanBLE.backgroundTintList = getColorStateList(R.color.status_disconnected)
        bleDevices.text = "Scanning for BLE devices...\n"

        // Simulate BLE device discovery
        btnScanBLE.postDelayed({
            if (isScanning) {
                addDevice("iPhone 13", "4A:3B:2C:1D:9E:8F", "-42 dBm")
                foundDevices++
                deviceCount.text = foundDevices.toString()
            }
        }, 1000)

        btnScanBLE.postDelayed({
            if (isScanning) {
                addDevice("Samsung Galaxy", "7F:2A:4B:3C:5D:6E", "-55 dBm")
                foundDevices++
                deviceCount.text = foundDevices.toString()
            }
        }, 2000)

        btnScanBLE.postDelayed({
            if (isScanning) {
                addDevice("Apple Watch", "9D:1E:2F:3A:4B:5C", "-38 dBm")
                foundDevices++
                deviceCount.text = foundDevices.toString()
            }
        }, 3000)

        btnScanBLE.postDelayed({
            if (isScanning) {
                addDevice("Fitbit Charge", "2C:5D:7E:8F:9A:0B", "-67 dBm")
                foundDevices++
                deviceCount.text = foundDevices.toString()
            }
        }, 4000)
    }

    private fun stopScan() {
        isScanning = false
        btnScanBLE.text = "START BLE SCAN"
        btnScanBLE.backgroundTintList = getColorStateList(R.color.func_bluetooth)
        val currentText = bleDevices.text.toString()
        bleDevices.text = "$currentText\nScan stopped."
    }

    private fun addDevice(name: String, mac: String, rssi: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentText = bleDevices.text.toString()
        bleDevices.text = """
            $currentText
            [$timestamp] $name
            MAC: $mac | Signal: $rssi

        """.trimIndent()
    }

    private fun clearList() {
        foundDevices = 0
        deviceCount.text = "0"
        bleDevices.text = "Device list cleared.\n"
    }
}
