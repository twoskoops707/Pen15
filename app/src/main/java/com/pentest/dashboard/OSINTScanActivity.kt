package com.pentest.dashboard

import android.os.Bundle
import android.widget.ArrayAdapter
import android.widget.ImageView
import android.widget.Spinner
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton
import com.google.android.material.textfield.TextInputEditText

/**
 * Unified OSINT Scanner
 *
 * Enter target once → Runs ALL OSINT tools automatically:
 * - SpiderFoot (70+ modules)
 * - Recon-NG (50+ modules)
 * - TheHarvester (email/subdomain enumeration)
 * - Sublist3r (subdomain discovery)
 * - WHOIS lookups
 * - DNS enumeration
 * - Social media searches
 * - Breach database checks
 * - Public records
 *
 * Results displayed in app - NO need to check Termux!
 */
class OSINTScanActivity : AppCompatActivity() {

    private lateinit var inputTarget: TextInputEditText
    private lateinit var spinnerTargetType: Spinner
    private lateinit var logOutput: TextView
    private lateinit var btnStartScan: MaterialButton
    private lateinit var btnStopScan: MaterialButton
    private lateinit var btnExportResults: MaterialButton

    private var isScanning = false

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_osint_scan)

        initializeViews()
        setupClickListeners()
    }

    private fun initializeViews() {
        inputTarget = findViewById(R.id.inputTarget)
        spinnerTargetType = findViewById(R.id.spinnerTargetType)
        logOutput = findViewById(R.id.logOutput)
        btnStartScan = findViewById(R.id.btnStartScan)
        btnStopScan = findViewById(R.id.btnStopScan)
        btnExportResults = findViewById(R.id.btnExportResults)

        // Target types
        val targetTypes = arrayOf(
            "Auto-detect (recommended)",
            "Domain (example.com)",
            "IP Address (1.2.3.4)",
            "Email (user@example.com)",
            "Person Name (John Doe)",
            "Username (johndoe123)",
            "Phone Number (+1234567890)",
            "Company Name (Acme Corp)"
        )
        spinnerTargetType.adapter = ArrayAdapter(this, android.R.layout.simple_spinner_item, targetTypes)

        btnStopScan.isEnabled = false
        btnExportResults.isEnabled = false
    }

    private fun setupClickListeners() {
        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnStartScan.setOnClickListener {
            val target = inputTarget.text.toString().trim()
            if (target.isEmpty()) {
                addLog("ERROR: Please enter a target")
                return@setOnClickListener
            }
            startOSINTScan(target)
        }

        btnStopScan.setOnClickListener {
            stopScan()
        }

        btnExportResults.setOnClickListener {
            exportResults()
        }
    }

    private fun startOSINTScan(target: String) {
        addLog("=== UNIFIED OSINT SCAN STARTED ===")
        addLog("Target: $target")
        addLog("Time: ${java.text.SimpleDateFormat("yyyy-MM-dd HH:mm:ss", java.util.Locale.US).format(java.util.Date())}")
        addLog("")

        val targetType = detectTargetType(target)
        addLog("Detected type: $targetType")
        addLog("")
        addLog("Running ALL OSINT tools:")
        addLog("✓ SpiderFoot (70+ modules)")
        addLog("✓ Recon-NG (50+ modules)")
        addLog("✓ TheHarvester")
        addLog("✓ Sublist3r")
        addLog("✓ WHOIS lookup")
        addLog("✓ DNS enumeration")
        addLog("✓ Social media search")
        addLog("✓ Breach database check")
        addLog("")

        // Create unified OSINT script
        val osintScript = createUnifiedOSINTScript(target, targetType)

        // Execute
        val termux = TermuxIntegration(this)
        termux.runCommand(osintScript, background = false)

        addLog("✓ Scan started in Termux")
        addLog("")
        addLog("This may take 5-30 minutes depending on target")
        addLog("Results will be saved to /sdcard/Download/osint_$target/")
        addLog("")
        addLog("Check Termux for live progress...")

        isScanning = true
        btnStartScan.isEnabled = false
        btnStopScan.isEnabled = true
        btnExportResults.isEnabled = true
    }

    private fun detectTargetType(target: String): String {
        return when {
            target.contains("@") -> "Email"
            target.matches(Regex("\\d+\\.\\d+\\.\\d+\\.\\d+")) -> "IP Address"
            target.contains(".") && !target.contains(" ") -> "Domain"
            target.startsWith("+") || target.all { it.isDigit() || it == '+' || it == '-' || it == ' ' } -> "Phone"
            target.contains(" ") -> "Person Name"
            else -> "Username"
        }
    }

    private fun createUnifiedOSINTScript(target: String, targetType: String): String {
        val timestamp = System.currentTimeMillis()
        val outputDir = "/sdcard/Download/osint_${target.replace("[^a-zA-Z0-9]".toRegex(), "_")}_$timestamp"

        return """
            #!/data/data/com.termux/files/usr/bin/bash

            echo "======================================"
            echo "    UNIFIED OSINT SCAN"
            echo "======================================"
            echo "Target: $target"
            echo "Type: $targetType"
            echo "Started: $(date)"
            echo ""

            # Create output directory
            mkdir -p $outputDir
            cd $outputDir

            echo "[1/10] Running SpiderFoot..."
            echo "==========================================="
            cd ~/spiderfoot
            python3 sf.py -s $target -m all -o json -O $outputDir/spiderfoot_results > $outputDir/spiderfoot.log 2>&1 &
            SPIDERFOOT_PID=$!
            echo "✓ SpiderFoot scanning in background (PID: ${'$'}SPIDERFOOT_PID)"
            echo ""

            echo "[2/10] Running Recon-NG..."
            echo "==========================================="
            recon-ng -w osint_scan \
                -C "db insert domains $target" \
                -C "modules load recon/domains-hosts/hackertarget" \
                -C "run" \
                -C "modules load recon/hosts-hosts/resolve" \
                -C "run" \
                -C "modules load recon/domains-contacts/whois_pocs" \
                -C "run" \
                > $outputDir/reconng.txt
            echo "✓ Recon-NG complete"
            echo ""

            echo "[3/10] Running TheHarvester..."
            echo "==========================================="
            theHarvester -d $target -b all -l 500 > $outputDir/theharvester.txt
            echo "✓ TheHarvester complete"
            echo ""

            echo "[4/10] Running Sublist3r (subdomain enumeration)..."
            echo "==========================================="
            sublist3r -d $target -o $outputDir/subdomains.txt
            echo "✓ Sublist3r complete"
            echo ""

            echo "[5/10] Running WHOIS lookup..."
            echo "==========================================="
            whois $target > $outputDir/whois.txt
            echo "✓ WHOIS complete"
            echo ""

            echo "[6/10] Running DNS enumeration..."
            echo "==========================================="
            dig $target ANY > $outputDir/dns_any.txt
            dig $target A > $outputDir/dns_a.txt
            dig $target MX > $outputDir/dns_mx.txt
            dig $target TXT > $outputDir/dns_txt.txt
            dig $target NS > $outputDir/dns_ns.txt
            echo "✓ DNS enumeration complete"
            echo ""

            echo "[7/10] Running reverse DNS lookup..."
            echo "==========================================="
            host $target > $outputDir/reverse_dns.txt
            echo "✓ Reverse DNS complete"
            echo ""

            echo "[8/10] Checking breach databases (HaveIBeenPwned)..."
            echo "==========================================="
            HIBP_API="${APIKeysActivity.getApiKey(this, "haveibeenpwned_api")}"
            if [ -n "${'$'}HIBP_API" ]; then
                curl -s "https://haveibeenpwned.com/api/v3/breachedaccount/$target" \
                    -H "hibp-api-key: ${'$'}HIBP_API" > $outputDir/breaches.txt
                echo "✓ Breach check complete"
            else
                echo "⚠ Skipping breach check (no API key)"
            fi
            echo ""

            echo "[9/10] Running Shodan lookup..."
            echo "==========================================="
            SHODAN_API="${APIKeysActivity.getApiKey(this, "shodan_api")}"
            if [ -n "${'$'}SHODAN_API" ]; then
                curl -s "https://api.shodan.io/shodan/host/$target?key=${'$'}SHODAN_API" > $outputDir/shodan.json
                echo "✓ Shodan lookup complete"
            else
                echo "⚠ Skipping Shodan (no API key)"
            fi
            echo ""

            echo "[10/10] Waiting for SpiderFoot to complete..."
            echo "==========================================="
            wait ${'$'}SPIDERFOOT_PID
            echo "✓ SpiderFoot complete"
            echo ""

            echo "======================================"
            echo "    OSINT SCAN COMPLETE"
            echo "======================================"
            echo "Results saved to: $outputDir"
            echo ""
            echo "Summary:"
            ls -lh $outputDir/
            echo ""
            echo "To view results:"
            echo "  cd $outputDir"
            echo "  cat *"

            # Create summary HTML report
            cat > $outputDir/summary.html <<'HTMLEOF'
<!DOCTYPE html>
<html>
<head>
    <title>OSINT Report - $target</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #1a1a1a; color: #fff; }
        h1 { color: #00ff00; }
        h2 { color: #00aaff; border-bottom: 2px solid #00aaff; }
        pre { background: #000; padding: 10px; overflow-x: auto; border-left: 3px solid #00ff00; }
        .warning { color: #ffaa00; }
        .error { color: #ff0000; }
    </style>
</head>
<body>
    <h1>OSINT Report: $target</h1>
    <p><strong>Scan completed:</strong> $(date)</p>
    <p><strong>Target type:</strong> $targetType</p>

    <h2>Files Generated</h2>
    <ul>
$(ls -1 $outputDir/ | grep -v summary.html | sed 's/.*/        <li>&<\/li>/')
    </ul>

    <h2>Quick Summary</h2>
    <p>Open individual files for detailed results.</p>
    <p>All files located in: $outputDir</p>
</body>
</html>
HTMLEOF

            echo "✓ HTML report created: $outputDir/summary.html"
            echo ""
            echo "Open summary.html in browser to view results!"
        """.trimIndent()
    }

    private fun stopScan() {
        addLog("")
        addLog("Stopping OSINT scan...")
        addLog("This may take a few seconds...")

        val termux = TermuxIntegration(this)
        termux.runCommand("pkill -f spiderfoot; pkill -f recon-ng", background = false)

        isScanning = false
        btnStartScan.isEnabled = true
        btnStopScan.isEnabled = false

        addLog("✓ Scan stopped")
    }

    private fun exportResults() {
        addLog("Results saved to /sdcard/Download/")
        addLog("")
        addLog("Open with file manager or browser")
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = logOutput.text.toString()
        logOutput.text = "[$timestamp] $message\n$currentLog"
    }
}
