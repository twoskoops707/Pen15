package com.pentest.dashboard

import android.os.Bundle
import android.view.View
import android.widget.ImageView
import android.widget.ProgressBar
import android.widget.ScrollView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class NFCActivity : AppCompatActivity() {

    private lateinit var tagStatus: TextView
    private lateinit var tagUid: TextView
    private lateinit var tagInfo: TextView
    private lateinit var tagInfoScroll: ScrollView
    private lateinit var btnWriteTag: MaterialButton
    private lateinit var btnEmulateTag: MaterialButton
    private lateinit var progressBar: ProgressBar

    private var lastTagData: String? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_nfc)

        ProcessManager.stopCurrentProcess(this)

        tagStatus = findViewById(R.id.tagStatus)
        tagUid = findViewById(R.id.tagUid)
        tagInfo = findViewById(R.id.tagInfo)
        tagInfoScroll = findViewById(R.id.tagInfoScroll)
        btnWriteTag = findViewById(R.id.btnWriteTag)
        btnEmulateTag = findViewById(R.id.btnEmulateTag)
        progressBar = findViewById(R.id.progressBar)

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        findViewById<MaterialButton>(R.id.btnReadTag).setOnClickListener {
            readTag()
        }

        btnWriteTag.setOnClickListener {
            writeTag()
        }

        btnEmulateTag.setOnClickListener {
            emulateTag()
        }

        findViewById<MaterialButton>(R.id.btnSavedTags).setOnClickListener {
            showSavedTags()
        }
    }

    private fun readTag() {
        tagStatus.text = "READING..."
        progressBar.visibility = View.VISIBLE
        tagInfo.text = ""
        addLog("=== STARTING NFC READ ===")
        addLog("Running: python nfc_read.py")

        val termux = TermuxIntegration(this)

        // Run the REAL Python script
        termux.runCommand("cd /data/data/com.termux/files/home/Pen15/scripts && python3 nfc_read.py") { output ->
            runOnUiThread {
                progressBar.visibility = View.GONE
                parseNFCOutput(output)
            }
        }
    }

    private fun parseNFCOutput(output: String) {
        addLog("")
        addLog("=== FLIPPER RESPONSE ===")
        addLog(output)

        when {
            output.contains("SUCCESS") -> {
                val parts = output.lines().last().split("|")
                if (parts.size >= 3 && parts[0] == "SUCCESS") {
                    val type = parts[1]
                    val uid = parts[2]
                    val atqa = if (parts.size > 3) parts[3] else "N/A"
                    val sak = if (parts.size > 4) parts[4] else "N/A"

                    tagStatus.text = "TAG DETECTED"
                    tagUid.text = uid
                    lastTagData = uid

                    btnWriteTag.isEnabled = true
                    btnEmulateTag.isEnabled = true

                    addLog("")
                    addLog("✅ Card Type: $type")
                    addLog("✅ UID: $uid")
                    addLog("✅ ATQA: $atqa")
                    addLog("✅ SAK: $sak")
                    addLog("")
                    addLog("Tag data saved - ready to clone/emulate")

                    Toast.makeText(this, "✓ NFC tag read successfully!", Toast.LENGTH_SHORT).show()
                }
            }

            output.contains("ERROR") -> {
                val error = output.substringAfter("ERROR|")
                tagStatus.text = "ERROR"
                addLog("")
                addLog("❌ $error")
                Toast.makeText(this, "Error: $error", Toast.LENGTH_LONG).show()
            }

            output.contains("No card detected") -> {
                tagStatus.text = "NO TAG"
                addLog("")
                addLog("⚠️ No tag detected")
                addLog("Make sure NFC tag is near Flipper antenna")
                Toast.makeText(this, "No tag detected - try again", Toast.LENGTH_SHORT).show()
            }

            else -> {
                tagStatus.text = "UNKNOWN"
                addLog("⚠️ Unexpected response")
                Toast.makeText(this, "Check logs", Toast.LENGTH_SHORT).show()
            }
        }
    }

    private fun writeTag() {
        Toast.makeText(this, "Write feature - Coming soon", Toast.LENGTH_SHORT).show()
    }

    private fun emulateTag() {
        Toast.makeText(this, "Emulate feature - Coming soon", Toast.LENGTH_SHORT).show()
    }

    private fun showSavedTags() {
        Toast.makeText(this, "Saved tags - Coming soon", Toast.LENGTH_SHORT).show()
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = tagInfo.text.toString()
        val newLog = "[$timestamp] $message\n$currentLog"
        tagInfo.text = newLog
    }

    override fun onDestroy() {
        super.onDestroy()
        stopAllProcesses()
    }

    override fun onPause() {
        super.onPause()
        // Stop processes when leaving activity
        ProcessManager.stopCurrentProcess(this)
    }
}
