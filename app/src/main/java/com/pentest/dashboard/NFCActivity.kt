package com.pentest.dashboard

import android.os.Bundle
import android.view.View
import android.widget.ImageView
import android.widget.LinearLayout
import android.widget.ProgressBar
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton
import com.google.android.material.floatingactionbutton.ExtendedFloatingActionButton
import com.google.android.material.tabs.TabLayout
import java.io.File

class NFCActivity : AppCompatActivity() {

    // Views
    private lateinit var tabLayout: TabLayout
    private lateinit var fabControl: ExtendedFloatingActionButton
    private lateinit var nfcStatus: TextView
    private lateinit var tagUid: TextView
    private lateinit var tagInfo: TextView
    private lateinit var statusBadge: TextView
    private lateinit var progressBar: ProgressBar

    // State containers
    private lateinit var idleState: LinearLayout
    private lateinit var scanningState: LinearLayout
    private lateinit var resultsState: LinearLayout

    // Buttons
    private lateinit var btnSaveTag: MaterialButton
    private lateinit var btnWriteTag: MaterialButton
    private lateinit var btnEmulateTag: MaterialButton
    private lateinit var btnSavedTags: MaterialButton

    // State
    private var currentMode = "READ" // READ, WRITE, EMULATE
    private var isScanning = false
    private var hasTag = false
    private var lastTagData: String? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_nfc)

        ProcessManager.stopCurrentProcess(this)
        initViews()
        setupTabs()
        setupFAB()
        setupButtons()

        showIdleState()
    }

    private fun initViews() {
        tabLayout = findViewById(R.id.tabLayout)
        fabControl = findViewById(R.id.fabControl)
        nfcStatus = findViewById(R.id.nfcStatus)
        tagUid = findViewById(R.id.tagUid)
        tagInfo = findViewById(R.id.tagInfo)
        statusBadge = findViewById(R.id.statusBadge)
        progressBar = findViewById(R.id.progressBar)

        idleState = findViewById(R.id.idleState)
        scanningState = findViewById(R.id.scanningState)
        resultsState = findViewById(R.id.resultsState)

        btnSaveTag = findViewById(R.id.btnSaveTag)
        btnWriteTag = findViewById(R.id.btnWriteTag)
        btnEmulateTag = findViewById(R.id.btnEmulateTag)
        btnSavedTags = findViewById(R.id.btnSavedTags)

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }
    }

    private fun setupTabs() {
        tabLayout.addOnTabSelectedListener(object : TabLayout.OnTabSelectedListener {
            override fun onTabSelected(tab: TabLayout.Tab?) {
                when (tab?.position) {
                    0 -> switchMode("READ")
                    1 -> switchMode("WRITE")
                    2 -> switchMode("EMULATE")
                }
            }
            override fun onTabUnselected(tab: TabLayout.Tab?) {}
            override fun onTabReselected(tab: TabLayout.Tab?) {}
        })
    }

    private fun setupFAB() {
        fabControl.setOnClickListener {
            when (currentMode) {
                "READ" -> startRead()
                "WRITE" -> startWrite()
                "EMULATE" -> startEmulate()
            }
        }
    }

    private fun setupButtons() {
        btnSaveTag.setOnClickListener {
            if (hasTag) {
                Toast.makeText(this, "Tag saved to Flipper", Toast.LENGTH_SHORT).show()
            }
        }

        btnWriteTag.setOnClickListener {
            Toast.makeText(this, "Write mode - Coming soon", Toast.LENGTH_SHORT).show()
        }

        btnEmulateTag.setOnClickListener {
            if (hasTag) {
                Toast.makeText(this, "Emulating tag...", Toast.LENGTH_SHORT).show()
            }
        }

        btnSavedTags.setOnClickListener {
            Toast.makeText(this, "Opening saved tags...", Toast.LENGTH_SHORT).show()
        }
    }

    private fun switchMode(mode: String) {
        currentMode = mode
        statusBadge.text = mode

        // Update FAB based on mode
        when (mode) {
            "READ" -> {
                fabControl.text = "START READ"
                fabControl.setIconResource(android.R.drawable.ic_media_play)
                statusBadge.setBackgroundColor(0x2200FF41)
            }
            "WRITE" -> {
                fabControl.text = "START WRITE"
                fabControl.setIconResource(android.R.drawable.ic_menu_edit)
                statusBadge.setBackgroundColor(0x22FF0055)
            }
            "EMULATE" -> {
                fabControl.text = "START EMULATE"
                fabControl.setIconResource(android.R.drawable.ic_menu_share)
                statusBadge.setBackgroundColor(0x2200FFFF)
            }
        }

        // Reset to idle state when switching modes
        showIdleState()
    }

    private fun showIdleState() {
        idleState.visibility = View.VISIBLE
        scanningState.visibility = View.GONE
        resultsState.visibility = View.GONE
        isScanning = false
    }

    private fun showScanningState() {
        idleState.visibility = View.GONE
        scanningState.visibility = View.VISIBLE
        resultsState.visibility = View.GONE
        isScanning = true
    }

    private fun showResultsState() {
        idleState.visibility = View.GONE
        scanningState.visibility = View.GONE
        resultsState.visibility = View.VISIBLE
        isScanning = false
    }

    private fun startRead() {
        showScanningState()
        nfcStatus.text = "READING..."
        statusBadge.text = "SCANNING"

        fabControl.text = "STOP"
        fabControl.setIconResource(android.R.drawable.ic_media_pause)

        val termux = TermuxIntegration(this)
        val outputFile = File(cacheDir, "nfc_output.txt")

        val command = """
            cd /data/data/com.termux/files/home/Pen15/scripts && \
            python3 nfc_read.py > ${outputFile.absolutePath} 2>&1
        """.trimIndent()

        termux.runCommand(command, background = true)

        // Poll for results
        android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({
            Thread {
                try {
                    Thread.sleep(3000)
                    val output = if (outputFile.exists()) outputFile.readText() else "ERROR|No output"
                    runOnUiThread {
                        parseNFCOutput(output)
                    }
                } catch (e: Exception) {
                    runOnUiThread {
                        nfcStatus.text = "ERROR: ${e.message}"
                        showIdleState()
                        fabControl.text = "START READ"
                        fabControl.setIconResource(android.R.drawable.ic_media_play)
                    }
                }
            }.start()
        }, 500)
    }

    private fun startWrite() {
        if (!hasTag) {
            Toast.makeText(this, "Read a tag first", Toast.LENGTH_SHORT).show()
            return
        }
        Toast.makeText(this, "Write functionality - Coming soon", Toast.LENGTH_SHORT).show()
    }

    private fun startEmulate() {
        if (!hasTag) {
            Toast.makeText(this, "Read a tag first", Toast.LENGTH_SHORT).show()
            return
        }
        showScanningState()
        nfcStatus.text = "EMULATING TAG..."
        statusBadge.text = "ACTIVE"
        Toast.makeText(this, "Emulation started", Toast.LENGTH_SHORT).show()
    }

    private fun parseNFCOutput(output: String) {
        when {
            output.contains("SUCCESS") -> {
                val parts = output.lines().last().split("|")
                if (parts.size >= 5 && parts[0] == "SUCCESS") {
                    val tagType = parts[1]
                    val uid = parts[2]
                    val atqa = parts[3]
                    val sak = parts[4]

                    hasTag = true
                    lastTagData = "$tagType|$uid|$atqa|$sak"

                    tagUid.text = uid
                    tagInfo.text = "Type: $tagType\nSAK: $sak\nATQA: $atqa"

                    showResultsState()
                    statusBadge.text = "TAG FOUND"
                    Toast.makeText(this, "âœ“ Tag read successfully", Toast.LENGTH_SHORT).show()
                }
            }

            output.contains("ERROR") -> {
                val error = output.substringAfter("ERROR|")
                showIdleState()
                statusBadge.text = "ERROR"
                Toast.makeText(this, "Error: $error", Toast.LENGTH_LONG).show()
            }

            output.contains("No tag") -> {
                showIdleState()
                statusBadge.text = "NO TAG"
                Toast.makeText(this, "No tag detected", Toast.LENGTH_SHORT).show()
            }

            else -> {
                showIdleState()
                statusBadge.text = "FAILED"
                Toast.makeText(this, "Unexpected response", Toast.LENGTH_SHORT).show()
            }
        }

        fabControl.text = "START " + currentMode
        fabControl.setIconResource(android.R.drawable.ic_media_play)
    }

    override fun onDestroy() {
        super.onDestroy()
        ProcessManager.stopCurrentProcess(this)
    }
}
