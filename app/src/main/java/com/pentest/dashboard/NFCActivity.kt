package com.pentest.dashboard

import android.os.Bundle
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class NFCActivity : AppCompatActivity() {

    private lateinit var tagStatus: TextView
    private lateinit var tagUid: TextView
    private lateinit var tagInfo: TextView
    private lateinit var btnWriteTag: MaterialButton
    private lateinit var btnEmulateTag: MaterialButton
    private lateinit var btnStopProcess: MaterialButton

    private var lastTagData: String? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_nfc)

        // Stop any running processes from other activities
        ProcessManager.stopCurrentProcess(this)

        tagStatus = findViewById(R.id.tagStatus)
        tagUid = findViewById(R.id.tagUid)
        tagInfo = findViewById(R.id.tagInfo)
        btnWriteTag = findViewById(R.id.btnWriteTag)
        btnEmulateTag = findViewById(R.id.btnEmulateTag)
        btnStopProcess = findViewById(R.id.btnStopProcess)

        btnStopProcess.setOnClickListener {
            stopAllProcesses()
        }

        // Set up callback to receive REAL data from Flipper
        FlipperConnectionManager.setDataReceivedCallback { data ->
            runOnUiThread {
                parseFlipperResponse(data)
            }
        }

        findViewById<ImageView>(R.id.btnBack).setOnClickListener {
            stopAllProcesses()
            finish()
        }

        findViewById<MaterialButton>(R.id.btnReadTag).setOnClickListener {
            readTag()
        }

        btnWriteTag.setOnClickListener {
            writeTag()
        }

        btnEmulateTag.setOnClickListener {
            emulateTag()
        }

        findViewById<MaterialButton>(R.id.btnSavedTags).setOnClickListener {
            showSavedTags()
        }
    }

    private fun readTag() {
        tagStatus.text = "READING NFC..."
        tagInfo.text = ""
        addLog("=== NFC READ STARTED ===")

        if (!FlipperConnectionManager.isConnected()) {
            addLog("ERROR: Flipper Zero not connected!")
            addLog("Connect via USB or Bluetooth first")
            tagStatus.text = "NOT CONNECTED"
            Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_SHORT).show()
            return
        }

        addLog("Connected to Flipper via ${if (FlipperConnectionManager.connectionType == "usb") "USB-C" else "Bluetooth"}")
        addLog("")
        addLog("Opening NFC app on Flipper...")
        FlipperConnectionManager.sendCommand("loader open NFC")

        tagStatus.postDelayed({
            addLog("Sending detect command...")
            FlipperConnectionManager.sendCommand("nfc detect")
            addLog("")
            addLog("ðŸ“¡ PLACE NFC TAG NEAR FLIPPER ANTENNA")
            addLog("")
            addLog("Waiting for tag data from Flipper...")
            addLog("(This shows REAL hardware responses)")
        }, 1500)
    }

    private fun parseFlipperResponse(data: String) {
        addLog("ðŸ“© FLIPPER RESPONSE: $data")

        // Parse different response types
        when {
            data.contains("NFC_DETECT", ignoreCase = true) || data.contains("NFC_READ", ignoreCase = true) -> {
                // Extract tag data from response
                val parts = data.split("|")
                if (parts.size > 1) {
                    val tagData = parts[1]
                    lastTagData = tagData
                    tagUid.text = tagData
                    tagStatus.text = "TAG DETECTED"
                    btnWriteTag.isEnabled = true
                    btnEmulateTag.isEnabled = true
                    addLog("")
                    addLog("âœ… TAG READ SUCCESSFUL!")
                    addLog("Tag UID: $tagData")
                }
            }
            data.contains("OK", ignoreCase = true) -> {
                addLog("âœ“ Command acknowledged by Flipper")
            }
            data.contains("ERROR", ignoreCase = true) -> {
                addLog("âŒ Error from Flipper: $data")
                tagStatus.text = "ERROR"
            }
            else -> {
                // Show any other data from Flipper
                addLog("Data: $data")
            }
        }
    }

    private fun stopAllProcesses() {
        ProcessManager.stopCurrentProcess(this)
        tagStatus.text = "STOPPED"
        addLog("")
        addLog("=== PROCESSES STOPPED ===")
        Toast.makeText(this, "All processes stopped", Toast.LENGTH_SHORT).show()
    }

    private fun writeTag() {
        if (!FlipperConnectionManager.isConnected()) {
            Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_LONG).show()
            return
        }

        addLog("=== NFC WRITE ===")
        addLog("Opening NFC app...")

        FlipperConnectionManager.sendCommand("loader open NFC")
        tagStatus.postDelayed({
            FlipperConnectionManager.sendCommand("nfc write")
            addLog("Sent: nfc write")
            addLog("Place writable tag near antenna")
        }, 2000)
    }

    private fun emulateTag() {
        if (!FlipperConnectionManager.isConnected()) {
            Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_LONG).show()
            return
        }

        addLog("=== NFC EMULATE ===")
        addLog("Opening NFC app...")

        FlipperConnectionManager.sendCommand("loader open NFC")
        tagStatus.postDelayed({
            FlipperConnectionManager.sendCommand("nfc emulate")
            addLog("Sent: nfc emulate")
            addLog("Flipper is now emulating saved NFC tag")
        }, 2000)
    }

    private fun showSavedTags() {
        addLog("=== SAVED NFC TAGS ===")
        addLog("Listing saved tags on Flipper...")

        if (FlipperConnectionManager.isConnected()) {
            FlipperConnectionManager.sendCommand("storage list /ext/nfc")
            addLog("Sent: storage list /ext/nfc")
        } else {
            Toast.makeText(this, "Connect Flipper to view saved tags", Toast.LENGTH_SHORT).show()
        }
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = tagInfo.text.toString()
        val newLog = "[$timestamp] $message\n$currentLog"
        tagInfo.text = newLog
    }

    override fun onDestroy() {
        super.onDestroy()
        stopAllProcesses()
    }

    override fun onPause() {
        super.onPause()
        // Stop processes when leaving activity
        ProcessManager.stopCurrentProcess(this)
    }
}
