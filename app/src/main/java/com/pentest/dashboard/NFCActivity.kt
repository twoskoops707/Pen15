package com.pentest.dashboard

import android.os.Bundle
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class NFCActivity : AppCompatActivity() {

    private lateinit var tagStatus: TextView
    private lateinit var tagUid: TextView
    private lateinit var tagInfo: TextView
    private lateinit var btnWriteTag: MaterialButton
    private lateinit var btnEmulateTag: MaterialButton
    private var flipperUSB: FlipperUSBManager? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_nfc)

        tagStatus = findViewById(R.id.tagStatus)
        tagUid = findViewById(R.id.tagUid)
        tagInfo = findViewById(R.id.tagInfo)
        btnWriteTag = findViewById(R.id.btnWriteTag)
        btnEmulateTag = findViewById(R.id.btnEmulateTag)

        flipperUSB = FlipperUSBManager(this)
        flipperUSB?.setDataReceivedCallback { data ->
            runOnUiThread {
                addLog("FLIPPER: $data")
            }
        }

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        findViewById<MaterialButton>(R.id.btnReadTag).setOnClickListener {
            readTag()
        }

        btnWriteTag.setOnClickListener {
            writeTag()
        }

        btnEmulateTag.setOnClickListener {
            emulateTag()
        }

        findViewById<MaterialButton>(R.id.btnSavedTags).setOnClickListener {
            showSavedTags()
        }
    }

    private fun readTag() {
        tagStatus.text = "READING NFC..."
        addLog("=== NFC READ STARTED ===")
        addLog("Opening Flipper NFC app...")

        if (flipperUSB?.isConnected() == true) {
            // Launch NFC app on Flipper
            flipperUSB?.sendCommand("loader open NFC")

            // Wait then send read command
            tagStatus.postDelayed({
                flipperUSB?.sendCommand("nfc detect")
                addLog("Sent: nfc detect")
                addLog("Place NFC tag near Flipper antenna...")
            }, 2000)
        } else {
            executeViaTermux()
        }
    }

    private fun executeViaTermux() {
        addLog("Flipper not connected via USB")
        addLog("Launching Termux script for NFC read...")

        val nfcScript = """
            #!/data/data/com.termux/files/usr/bin/bash

            echo "=== NFC TAG READ ==="
            echo "This requires:"
            echo "1. Flipper Zero connected via USB"
            echo "2. NFC app running on Flipper"
            echo "3. Tag placed near antenna"
            echo ""

            # Try to send command to Flipper
            for dev in /dev/ttyACM0 /dev/ttyUSB0; do
                if [ -e "${'$'}dev" ]; then
                    echo "Found Flipper at: ${'$'}dev"
                    echo "loader open NFC" > ${'$'}dev
                    sleep 2
                    echo "nfc detect" > ${'$'}dev
                    echo "Sent NFC read command"
                    echo "Check Flipper screen for results"
                    exit 0
                fi
            done

            echo "ERROR: Flipper not found on USB"
            echo "Make sure Flipper is connected and USB permission granted"
        """.trimIndent()

        val termux = TermuxIntegration(this)
        termux.runCommand(nfcScript, background = false)

        Toast.makeText(this, "NFC read script launched in Termux", Toast.LENGTH_LONG).show()
    }

    private fun writeTag() {
        if (flipperUSB?.isConnected() != true) {
            Toast.makeText(this, "Connect Flipper Zero via USB first", Toast.LENGTH_LONG).show()
            return
        }

        addLog("=== NFC WRITE ===")
        addLog("Opening NFC app...")

        flipperUSB?.sendCommand("loader open NFC")
        tagStatus.postDelayed({
            flipperUSB?.sendCommand("nfc write")
            addLog("Sent: nfc write")
            addLog("Place writable tag near antenna")
        }, 2000)
    }

    private fun emulateTag() {
        if (flipperUSB?.isConnected() != true) {
            Toast.makeText(this, "Connect Flipper Zero via USB first", Toast.LENGTH_LONG).show()
            return
        }

        addLog("=== NFC EMULATE ===")
        addLog("Opening NFC app...")

        flipperUSB?.sendCommand("loader open NFC")
        tagStatus.postDelayed({
            flipperUSB?.sendCommand("nfc emulate")
            addLog("Sent: nfc emulate")
            addLog("Flipper is now emulating saved NFC tag")
        }, 2000)
    }

    private fun showSavedTags() {
        addLog("=== SAVED NFC TAGS ===")
        addLog("Listing saved tags on Flipper...")

        if (flipperUSB?.isConnected() == true) {
            flipperUSB?.sendCommand("storage list /ext/nfc")
            addLog("Sent: storage list /ext/nfc")
        } else {
            Toast.makeText(this, "Connect Flipper to view saved tags", Toast.LENGTH_SHORT).show()
        }
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = tagInfo.text.toString()
        val newLog = "[$timestamp] $message\n$currentLog"
        tagInfo.text = newLog
    }

    override fun onDestroy() {
        super.onDestroy()
        flipperUSB?.cleanup()
    }
}
