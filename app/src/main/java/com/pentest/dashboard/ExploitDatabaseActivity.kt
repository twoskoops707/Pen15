package com.pentest.dashboard

import android.content.Intent
import android.net.Uri
import android.os.Bundle
import android.widget.ArrayAdapter
import android.widget.ImageView
import android.widget.ListView
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton
import com.google.android.material.textfield.TextInputEditText

data class Exploit(val id: String, val title: String, val type: String, val url: String)

class ExploitDatabaseActivity : AppCompatActivity() {

    private lateinit var inputSearch: TextInputEditText
    private lateinit var exploitList: ListView
    private lateinit var detailsText: TextView
    private lateinit var btnSearch: MaterialButton
    private lateinit var btnOpenBrowser: MaterialButton

    private val exploits = mutableListOf<Exploit>()
    private var selectedExploit: Exploit? = null

    // Pre-loaded exploits (real CVEs and exploits)
    private val commonExploits = listOf(
        Exploit("CVE-2021-44228", "Log4Shell - Apache Log4j RCE", "RCE", "https://nvd.nist.gov/vuln/detail/CVE-2021-44228"),
        Exploit("CVE-2023-23397", "Microsoft Outlook Elevation of Privilege", "EoP", "https://nvd.nist.gov/vuln/detail/CVE-2023-23397"),
        Exploit("CVE-2023-0386", "Linux Kernel OverlayFS LPE", "LPE", "https://nvd.nist.gov/vuln/detail/CVE-2023-0386"),
        Exploit("CVE-2022-30190", "Follina - Microsoft Office RCE", "RCE", "https://nvd.nist.gov/vuln/detail/CVE-2022-30190"),
        Exploit("CVE-2021-3156", "Sudo Baron Samedit", "LPE", "https://nvd.nist.gov/vuln/detail/CVE-2021-3156"),
        Exploit("MS17-010", "EternalBlue - SMB RCE", "RCE", "https://www.exploit-db.com/exploits/42315"),
        Exploit("CVE-2022-22965", "Spring4Shell - Spring Framework RCE", "RCE", "https://nvd.nist.gov/vuln/detail/CVE-2022-22965"),
        Exploit("CVE-2023-22809", "Sudo Privilege Escalation", "PE", "https://nvd.nist.gov/vuln/detail/CVE-2023-22809"),
        Exploit("CVE-2022-26134", "Atlassian Confluence RCE", "RCE", "https://nvd.nist.gov/vuln/detail/CVE-2022-26134"),
        Exploit("CVE-2023-32315", "Openfire Admin Console Auth Bypass", "Auth Bypass", "https://nvd.nist.gov/vuln/detail/CVE-2023-32315")
    )

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_exploit_database)

        initializeViews()
        setupClickListeners()
        loadExploits()
    }

    private fun initializeViews() {
        inputSearch = findViewById(R.id.inputSearch)
        exploitList = findViewById(R.id.exploitList)
        detailsText = findViewById(R.id.detailsText)
        btnSearch = findViewById(R.id.btnSearch)
        btnOpenBrowser = findViewById(R.id.btnOpenBrowser)

        exploitList.setOnItemClickListener { _, _, position, _ ->
            selectedExploit = exploits[position]
            showExploitDetails(exploits[position])
            btnOpenBrowser.isEnabled = true
        }
    }

    private fun setupClickListeners() {
        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnSearch.setOnClickListener {
            val query = inputSearch.text.toString()
            if (query.isNotEmpty()) {
                searchExploits(query)
            } else {
                loadExploits()
            }
        }

        btnOpenBrowser.setOnClickListener {
            selectedExploit?.let {
                val intent = Intent(Intent.ACTION_VIEW, Uri.parse(it.url))
                startActivity(intent)
            }
        }
    }

    private fun loadExploits() {
        exploits.clear()
        exploits.addAll(commonExploits)
        updateList()
    }

    private fun searchExploits(query: String) {
        exploits.clear()
        exploits.addAll(commonExploits.filter {
            it.title.contains(query, ignoreCase = true) ||
                    it.id.contains(query, ignoreCase = true) ||
                    it.type.contains(query, ignoreCase = true)
        })
        updateList()
    }

    private fun updateList() {
        val adapter = ArrayAdapter(
            this,
            android.R.layout.simple_list_item_1,
            exploits.map { "${it.id} - ${it.title}" }
        )
        exploitList.adapter = adapter
    }

    private fun showExploitDetails(exploit: Exploit) {
        detailsText.text = """
            ID: ${exploit.id}
            Title: ${exploit.title}
            Type: ${exploit.type}

            URL: ${exploit.url}

            Click "OPEN IN BROWSER" to view full details and proof-of-concept code.

            WARNING: Only use exploits for authorized penetration testing.
        """.trimIndent()
    }
}
