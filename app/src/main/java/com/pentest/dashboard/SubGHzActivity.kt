package com.pentest.dashboard

import android.os.Bundle
import android.view.View
import android.widget.ImageView
import android.widget.LinearLayout
import android.widget.ListView
import android.widget.ProgressBar
import android.widget.TextView
import android.widget.Toast
import android.widget.ArrayAdapter
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton
import com.google.android.material.floatingactionbutton.ExtendedFloatingActionButton

class SubGHzActivity : AppCompatActivity() {

    // Views
    private lateinit var fabControl: ExtendedFloatingActionButton
    private lateinit var frequencyDisplay: TextView
    private lateinit var scanningText: TextView
    private lateinit var resultsCount: TextView
    private lateinit var signalCount: TextView
    private lateinit var signalsList: ListView
    private lateinit var progressBar: ProgressBar

    // State containers
    private lateinit var idleState: LinearLayout
    private lateinit var scanningState: LinearLayout
    private lateinit var resultsState: LinearLayout

    // Frequency buttons
    private lateinit var btn315: MaterialButton
    private lateinit var btn390: MaterialButton
    private lateinit var btn433: MaterialButton
    private lateinit var btn868: MaterialButton
    private lateinit var btn915: MaterialButton

    // Action buttons
    private lateinit var btnBruteForce: MaterialButton
    private lateinit var btnReplay: MaterialButton
    private lateinit var btnSaveSignal: MaterialButton

    // State
    private var currentFrequency = 433.920
    private var isScanning = false
    private val signals = mutableListOf<String>()
    private lateinit var adapter: ArrayAdapter<String>

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_subghz)

        ProcessManager.stopCurrentProcess(this)
        initViews()
        setupFrequencyButtons()
        setupFAB()
        setupButtons()
        showIdleState()
    }

    private fun initViews() {
        fabControl = findViewById(R.id.fabControl)
        frequencyDisplay = findViewById(R.id.frequencyDisplay)
        scanningText = findViewById(R.id.scanningText)
        resultsCount = findViewById(R.id.resultsCount)
        signalCount = findViewById(R.id.signalCount)
        signalsList = findViewById(R.id.signalsList)
        progressBar = findViewById(R.id.progressBar)

        idleState = findViewById(R.id.idleState)
        scanningState = findViewById(R.id.scanningState)
        resultsState = findViewById(R.id.resultsState)

        btn315 = findViewById(R.id.btn315)
        btn390 = findViewById(R.id.btn390)
        btn433 = findViewById(R.id.btn433)
        btn868 = findViewById(R.id.btn868)
        btn915 = findViewById(R.id.btn915)

        btnBruteForce = findViewById(R.id.btnBruteForce)
        btnReplay = findViewById(R.id.btnReplay)
        btnSaveSignal = findViewById(R.id.btnSaveSignal)

        adapter = ArrayAdapter(this, android.R.layout.simple_list_item_1, signals)
        signalsList.adapter = adapter

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }
    }

    private fun setupFrequencyButtons() {
        btn315.setOnClickListener { setFrequency(315.000) }
        btn390.setOnClickListener { setFrequency(390.000) }
        btn433.setOnClickListener { setFrequency(433.920) }
        btn868.setOnClickListener { setFrequency(868.000) }
        btn915.setOnClickListener { setFrequency(915.000) }
    }

    private fun setupFAB() {
        fabControl.setOnClickListener {
            if (isScanning) {
                stopScan()
            } else {
                startScan()
            }
        }
    }

    private fun setupButtons() {
        btnBruteForce.setOnClickListener {
            Toast.makeText(this, "Brute force - Coming soon", Toast.LENGTH_SHORT).show()
        }

        btnReplay.setOnClickListener {
            if (signals.isNotEmpty()) {
                Toast.makeText(this, "Replaying signal...", Toast.LENGTH_SHORT).show()
            } else {
                Toast.makeText(this, "No signals captured", Toast.LENGTH_SHORT).show()
            }
        }

        btnSaveSignal.setOnClickListener {
            if (signals.isNotEmpty()) {
                Toast.makeText(this, "Signal saved to Flipper", Toast.LENGTH_SHORT).show()
            } else {
                Toast.makeText(this, "No signals to save", Toast.LENGTH_SHORT).show()
            }
        }
    }

    private fun setFrequency(freq: Double) {
        currentFrequency = freq
        frequencyDisplay.text = String.format("%.3f MHz", freq)
        Toast.makeText(this, "Frequency: ${String.format("%.3f", freq)} MHz", Toast.LENGTH_SHORT).show()

        // Update button states
        btn315.isEnabled = (freq != 315.000)
        btn390.isEnabled = (freq != 390.000)
        btn433.isEnabled = (freq != 433.920)
        btn868.isEnabled = (freq != 868.000)
        btn915.isEnabled = (freq != 915.000)
    }

    private fun showIdleState() {
        idleState.visibility = View.VISIBLE
        scanningState.visibility = View.GONE
        resultsState.visibility = View.GONE
        isScanning = false
    }

    private fun showScanningState() {
        idleState.visibility = View.GONE
        scanningState.visibility = View.VISIBLE
        resultsState.visibility = View.GONE
        isScanning = true
    }

    private fun showResultsState() {
        idleState.visibility = View.GONE
        scanningState.visibility = View.GONE
        resultsState.visibility = View.VISIBLE
        isScanning = false
    }

    private fun startScan() {
        showScanningState()
        scanningText.text = "Scanning on ${String.format("%.3f", currentFrequency)} MHz..."
        fabControl.text = "STOP SCAN"
        fabControl.setIconResource(android.R.drawable.ic_media_pause)

        signals.clear()

        // Simulate scanning
        android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({
            // Mock signal detection
            signals.add("Signal 1: ${String.format("%.3f", currentFrequency)} MHz")
            signals.add("Signal 2: ${String.format("%.3f", currentFrequency)} MHz")

            signalCount.text = "${signals.size}"
            resultsCount.text = "${signals.size} SIGNALS"
            adapter.notifyDataSetChanged()

            showResultsState()
            fabControl.text = "START SCAN"
            fabControl.setIconResource(android.R.drawable.ic_media_play)
            Toast.makeText(this, "Scan complete - ${signals.size} signals found", Toast.LENGTH_SHORT).show()
        }, 3000)
    }

    private fun stopScan() {
        showIdleState()
        fabControl.text = "START SCAN"
        fabControl.setIconResource(android.R.drawable.ic_media_play)
        Toast.makeText(this, "Scan stopped", Toast.LENGTH_SHORT).show()
    }

    override fun onDestroy() {
        super.onDestroy()
        ProcessManager.stopCurrentProcess(this)
    }
}
