package com.pentest.dashboard

import android.os.Bundle
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class SubGHzActivity : AppCompatActivity() {

    private lateinit var frequencyDisplay: TextView
    private lateinit var logOutput: TextView
    private lateinit var btnScan: MaterialButton

    private var isScanning = false
    private var currentFrequency = 433.920

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_subghz)

        frequencyDisplay = findViewById(R.id.frequencyDisplay)
        logOutput = findViewById(R.id.logOutput)
        btnScan = findViewById(R.id.btnScan)

        findViewById<ImageView>(R.id.btnBack).setOnClickListener {
            finish()
        }

        // Frequency preset buttons
        findViewById<MaterialButton>(R.id.btn315).setOnClickListener {
            setFrequency(315.000)
        }
        findViewById<MaterialButton>(R.id.btn433).setOnClickListener {
            setFrequency(433.920)
        }
        findViewById<MaterialButton>(R.id.btn868).setOnClickListener {
            setFrequency(868.000)
        }
        findViewById<MaterialButton>(R.id.btn390).setOnClickListener {
            setFrequency(390.000)
        }
        findViewById<MaterialButton>(R.id.btn915).setOnClickListener {
            setFrequency(915.000)
        }

        // Scan button
        btnScan.setOnClickListener {
            if (isScanning) {
                stopScanning()
            } else {
                startScanning()
            }
        }

        // Read Raw button
        findViewById<MaterialButton>(R.id.btnRead).setOnClickListener {
            addLog("Starting RAW signal capture...")
            addLog("Listening on ${String.format("%.3f", currentFrequency)} MHz")
            Toast.makeText(this, "Capturing RAW signal - Point remote at Flipper", Toast.LENGTH_LONG).show()
        }

        // Brute Force button
        findViewById<MaterialButton>(R.id.btnBruteForce).setOnClickListener {
            startBruteForce()
        }

        // Saved Signals button
        findViewById<MaterialButton>(R.id.btnSaved).setOnClickListener {
            addLog("Opening saved signals archive...")
            Toast.makeText(this, "Saved Signals - Feature coming soon", Toast.LENGTH_SHORT).show()
        }
    }

    private fun setFrequency(freq: Double) {
        currentFrequency = freq
        frequencyDisplay.text = String.format("%.3f MHz", freq)
        addLog("Frequency set to ${String.format("%.3f", freq)} MHz")
    }

    private fun startScanning() {
        isScanning = true
        btnScan.text = "STOP SCANNING"
        btnScan.backgroundTintList = getColorStateList(R.color.status_disconnected)
        addLog("=== SCAN STARTED ===")
        addLog("Frequency: ${String.format("%.3f", currentFrequency)} MHz")
        addLog("Bandwidth: 650 kHz")
        addLog("Listening for signals...")

        // Simulate scan results
        btnScan.postDelayed({
            if (isScanning) {
                addLog("Signal detected! Press: 0x1A4B2C")
                addLog("Protocol: Princeton 433")
            }
        }, 2000)
    }

    private fun stopScanning() {
        isScanning = false
        btnScan.text = "START SCANNING"
        btnScan.backgroundTintList = getColorStateList(R.color.func_subghz)
        addLog("=== SCAN STOPPED ===")
        addLog("Ready.")
    }

    private fun startBruteForce() {
        addLog("=== BRUTE FORCE ATTACK STARTED ===")
        addLog("Target frequency: ${String.format("%.3f", currentFrequency)} MHz")
        addLog("Mode: Sequential code iteration")
        addLog("Range: 0x000000 to 0xFFFFFF")

        btnScan.postDelayed({
            addLog("Trying code: 0x1A4B2C...")
            addLog("Transmitting...")
        }, 1000)

        btnScan.postDelayed({
            addLog("Trying code: 0x2B5C3D...")
            addLog("Transmitting...")
        }, 2000)

        btnScan.postDelayed({
            addLog("Trying code: 0x3C6D4E...")
            addLog("Transmitting...")
        }, 3000)

        btnScan.postDelayed({
            addLog("! POSSIBLE MATCH DETECTED !")
            addLog("Code: 0x3C6D4E may have triggered response")
            addLog("Brute force paused - verify manually")
        }, 4000)
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = logOutput.text.toString()
        val newLog = "[$timestamp] $message\n$currentLog"
        logOutput.text = newLog
    }
}
