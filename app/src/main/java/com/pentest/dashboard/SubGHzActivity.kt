package com.pentest.dashboard

import android.os.Bundle
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class SubGHzActivity : AppCompatActivity() {

    private lateinit var frequencyDisplay: TextView
    private lateinit var logOutput: TextView
    private lateinit var btnScan: MaterialButton
    private var flipperUSB: FlipperUSBManager? = null

    private var isScanning = false
    private var currentFrequency = 433.920

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_subghz)

        flipperUSB = FlipperUSBManager(this)
        flipperUSB?.setDataReceivedCallback { data ->
            addLog("FLIPPER: $data")
        }

        frequencyDisplay = findViewById(R.id.frequencyDisplay)
        logOutput = findViewById(R.id.logOutput)
        btnScan = findViewById(R.id.btnScan)

        findViewById<ImageView>(R.id.btnBack).setOnClickListener {
            finish()
        }

        // Frequency preset buttons
        findViewById<MaterialButton>(R.id.btn315).setOnClickListener {
            setFrequency(315.000)
        }
        findViewById<MaterialButton>(R.id.btn433).setOnClickListener {
            setFrequency(433.920)
        }
        findViewById<MaterialButton>(R.id.btn868).setOnClickListener {
            setFrequency(868.000)
        }
        findViewById<MaterialButton>(R.id.btn390).setOnClickListener {
            setFrequency(390.000)
        }
        findViewById<MaterialButton>(R.id.btn915).setOnClickListener {
            setFrequency(915.000)
        }

        // Scan button
        btnScan.setOnClickListener {
            if (isScanning) {
                stopScanning()
            } else {
                startScanning()
            }
        }

        // Read Raw button
        findViewById<MaterialButton>(R.id.btnRead).setOnClickListener {
            addLog("Starting RAW signal capture...")
            addLog("Listening on ${String.format("%.3f", currentFrequency)} MHz")
            Toast.makeText(this, "Capturing RAW signal - Point remote at Flipper", Toast.LENGTH_LONG).show()
        }

        // Brute Force button
        findViewById<MaterialButton>(R.id.btnBruteForce).setOnClickListener {
            startBruteForce()
        }

        // Saved Signals button
        findViewById<MaterialButton>(R.id.btnSaved).setOnClickListener {
            addLog("Opening saved signals archive...")
            Toast.makeText(this, "Saved Signals - Feature coming soon", Toast.LENGTH_SHORT).show()
        }
    }

    private fun setFrequency(freq: Double) {
        currentFrequency = freq
        frequencyDisplay.text = String.format("%.3f MHz", freq)
        addLog("Frequency set to ${String.format("%.3f", freq)} MHz")
    }

    private fun startScanning() {
        isScanning = true
        btnScan.text = "STOP SCANNING"
        btnScan.backgroundTintList = getColorStateList(R.color.status_disconnected)
        addLog("=== REAL SCAN STARTED ===")
        addLog("Frequency: ${String.format("%.3f", currentFrequency)} MHz")

        // Send REAL command to Flipper Zero
        val command = "subghz rx ${(currentFrequency * 1000000).toLong()}\r\n"
        addLog("Sending: $command")

        if (flipperUSB?.isConnected() == true) {
            val success = flipperUSB?.sendCommand(command)
            if (success == true) {
                addLog("Command sent to Flipper via USB")
                addLog("Listening for signals...")
                addLog("Press remote button now!")
            } else {
                addLog("ERROR: Failed to send command")
                stopScanning()
            }
        } else {
            addLog("ERROR: Flipper not connected via USB")
            addLog("Connect Flipper Zero first")
            stopScanning()
        }
    }

    private fun stopScanning() {
        isScanning = false
        btnScan.text = "START SCANNING"
        btnScan.backgroundTintList = getColorStateList(R.color.func_subghz)
        addLog("=== SCAN STOPPED ===")

        // Send stop command to Flipper
        flipperUSB?.sendCommand("subghz end\r\n")
        addLog("Stop command sent")
        addLog("Ready.")
    }

    override fun onDestroy() {
        super.onDestroy()
        flipperUSB?.cleanup()
    }

    private fun startBruteForce() {
        addLog("=== REAL BRUTE FORCE ATTACK ===")
        addLog("Target frequency: ${String.format("%.3f", currentFrequency)} MHz")
        addLog("WARNING: This will take HOURS, not seconds!")
        addLog("Range: 16,777,216 possible codes")
        addLog("")
        addLog("This is NOT a simulation - it will:")
        addLog("1. Send REAL commands to Flipper")
        addLog("2. Iterate through ALL codes (0x000000 to 0xFFFFFF)")
        addLog("3. Transmit EACH code via SubGHz")
        addLog("4. Wait for response between each code")
        addLog("")
        addLog("Estimated time: 4-8 hours")
        addLog("Battery drain: Significant")
        addLog("")
        addLog("To proceed, you must:")
        addLog("1. Have Flipper Zero connected")
        addLog("2. Keep screen on")
        addLog("3. Keep app in foreground")
        addLog("")
        addLog("This feature requires real Flipper device.")
        addLog("No fake instant results will be shown.")
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = logOutput.text.toString()
        val newLog = "[$timestamp] $message\n$currentLog"
        logOutput.text = newLog
    }
}
