package com.pentest.dashboard

import android.os.Bundle
import android.view.View
import android.widget.ImageView
import android.widget.ProgressBar
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton
import java.io.File

class CreditCardReaderActivity : AppCompatActivity() {

    private lateinit var cardStatus: TextView
    private lateinit var cardNumber: TextView
    private lateinit var cardExpiry: TextView
    private lateinit var cardHolder: TextView
    private lateinit var cardInfo: TextView
    private lateinit var progressBar: ProgressBar
    private lateinit var btnReadCard: MaterialButton

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_credit_card_reader)

        ProcessManager.stopCurrentProcess(this)

        cardStatus = findViewById(R.id.cardStatus)
        cardNumber = findViewById(R.id.cardNumber)
        cardExpiry = findViewById(R.id.cardExpiry)
        cardHolder = findViewById(R.id.cardHolder)
        cardInfo = findViewById(R.id.cardInfo)
        progressBar = findViewById(R.id.progressBar)
        btnReadCard = findViewById(R.id.btnReadCard)

        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnReadCard.setOnClickListener {
            readCreditCard()
        }

        addLog("=== NFC CREDIT CARD READER ===")
        addLog("Extracts: Card number, expiration, name")
        addLog("")
        addLog("‚ö†Ô∏è NOTE: CVV/CVC is NOT stored on chip")
        addLog("CVV is only printed on physical card (security feature)")
        addLog("")
        addLog("Click READ CARD to scan payment card")
    }

    private fun readCreditCard() {
        cardStatus.text = "SCANNING..."
        cardNumber.text = ""
        cardExpiry.text = ""
        cardHolder.text = ""
        progressBar.visibility = View.VISIBLE
        btnReadCard.isEnabled = false
        
        addLog("")
        addLog("=== STARTING CARD SCAN ===")
        addLog("Hold payment card near Flipper...")

        val termux = TermuxIntegration(this)
        val outputFile = File(cacheDir, "credit_card_output.txt")
        
        val command = """
            cd /data/data/com.termux/files/home/Pen15/scripts && \
            python3 nfc_credit_card_read.py > ${outputFile.absolutePath} 2>&1
        """.trimIndent()
        
        termux.runCommand(command, background = true)
        
        // Poll for results (extended timeout for card interaction)
        android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({
            Thread {
                try {
                    Thread.sleep(5000) // Longer wait for EMV processing
                    val output = if (outputFile.exists()) outputFile.readText() else "ERROR|No output"
                    runOnUiThread {
                        progressBar.visibility = View.GONE
                        btnReadCard.isEnabled = true
                        parseCardOutput(output)
                    }
                } catch (e: Exception) {
                    runOnUiThread {
                        progressBar.visibility = View.GONE
                        btnReadCard.isEnabled = true
                        addLog("ERROR: ${e.message}")
                    }
                }
            }.start()
        }, 500)
    }

    private fun parseCardOutput(output: String) {
        addLog("")
        addLog("=== SCAN RESULT ===")
        addLog(output)

        when {
            output.contains("SUCCESS") -> {
                val parts = output.lines().last().split("|")
                if (parts.size >= 5 && parts[0] == "SUCCESS") {
                    val cardType = parts[1]
                    val pan = parts[2]
                    val exp = parts[3]
                    val name = parts[4]
                    val cvvNote = if (parts.size > 5) parts[5] else ""

                    cardStatus.text = "CARD READ SUCCESSFULLY"
                    
                    if (pan != "PROTECTED" && pan != "BASIC_READ") {
                        cardNumber.text = "üí≥ $pan"
                        cardExpiry.text = "üìÖ EXP: $exp"
                        cardHolder.text = "üë§ $name"
                        
                        addLog("")
                        addLog("‚úÖ Card Type: $cardType")
                        addLog("‚úÖ Number: $pan")
                        addLog("‚úÖ Expires: $exp")
                        addLog("‚úÖ Holder: $name")
                        addLog("")
                        addLog("‚ö†Ô∏è $cvvNote")
                        
                        Toast.makeText(this, "Card data extracted!", Toast.LENGTH_LONG).show()
                    } else {
                        cardNumber.text = "üîí Card detected (data protected)"
                        cardExpiry.text = "Modern cards encrypt payment data"
                        cardHolder.text = "Only basic UID readable"
                        
                        addLog("")
                        addLog("‚ÑπÔ∏è Payment card detected")
                        addLog("‚ÑπÔ∏è Full card data is encrypted/protected")
                        addLog("‚ÑπÔ∏è This is a security feature")
                        
                        Toast.makeText(this, "Card protected by EMV security", Toast.LENGTH_LONG).show()
                    }
                }
            }

            output.contains("ERROR") -> {
                val error = output.substringAfter("ERROR|")
                cardStatus.text = "SCAN FAILED"
                cardNumber.text = ""
                cardExpiry.text = ""
                cardHolder.text = ""
                addLog("")
                addLog("‚ùå $error")
                Toast.makeText(this, "Error: $error", Toast.LENGTH_LONG).show()
            }

            output.contains("WARNING") -> {
                val warning = output.substringAfter("WARNING|")
                cardStatus.text = "NOT A PAYMENT CARD"
                cardNumber.text = ""
                cardExpiry.text = ""
                cardHolder.text = ""
                addLog("")
                addLog("‚ö†Ô∏è $warning")
                Toast.makeText(this, warning, Toast.LENGTH_SHORT).show()
            }

            else -> {
                cardStatus.text = "NO CARD DETECTED"
                addLog("")
                addLog("‚ö†Ô∏è No card detected - try again")
                Toast.makeText(this, "No card found", Toast.LENGTH_SHORT).show()
            }
        }
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentText = cardInfo.text.toString()
        cardInfo.text = if (currentText.isEmpty()) {
            "[$timestamp] $message"
        } else {
            "$currentText\n[$timestamp] $message"
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        ProcessManager.stopCurrentProcess(this)
    }
}
