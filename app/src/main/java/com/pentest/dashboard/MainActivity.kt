package com.pentest.dashboard

import android.Manifest
import android.content.Intent
import android.content.pm.PackageManager
import android.net.Uri
import android.os.Bundle
import android.widget.Button
import android.widget.EditText
import android.widget.ScrollView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.core.app.ActivityCompat
import androidx.core.content.ContextCompat
import com.google.android.material.button.MaterialButton
import com.google.android.material.textfield.TextInputEditText
import kotlinx.coroutines.*
import java.io.BufferedReader
import java.io.InputStreamReader

class MainActivity : AppCompatActivity() {

    private lateinit var outputTextView: TextView
    private lateinit var scrollView: ScrollView
    private lateinit var targetInput: EditText

    private val PERMISSION_REQUEST_CODE = 1001

    companion object {
        const val TERMUX_PACKAGE = "com.termux"
        const val TERMUX_SERVICE = "com.termux.app.RunCommandService"
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        // Initialize views
        outputTextView = findViewById(R.id.outputTextView)
        scrollView = findViewById(R.id.scrollView)
        targetInput = findViewById(R.id.targetInput)

        // Check and request permissions
        checkPermissions()

        // Button click listeners
        findViewById<MaterialButton>(R.id.btnUpdatePackages).setOnClickListener {
            executeTermuxCommand("pkg update -y && pkg upgrade -y")
        }

        findViewById<MaterialButton>(R.id.btnInstallTools).setOnClickListener {
            executeTermuxCommand("pkg install nmap hashcat aircrack-ng bluez net-tools arp-scan termux-api python git wget curl -y")
        }

        findViewById<MaterialButton>(R.id.btnNmapQuick).setOnClickListener {
            val target = targetInput.text.toString().ifEmpty { "192.168.1.0/24" }
            executeTermuxCommand("nmap -sn $target")
        }

        findViewById<MaterialButton>(R.id.btnNmapDetailed).setOnClickListener {
            val target = targetInput.text.toString().ifEmpty { "192.168.1.1" }
            executeTermuxCommand("nmap -A -T4 $target")
        }

        findViewById<MaterialButton>(R.id.btnArpScan).setOnClickListener {
            executeTermuxCommand("arp-scan --localnet")
        }

        findViewById<MaterialButton>(R.id.btnBluetoothScan).setOnClickListener {
            executeTermuxCommand("hcitool scan")
        }

        findViewById<MaterialButton>(R.id.btnCheckHashcat).setOnClickListener {
            executeTermuxCommand("hashcat --version")
        }

        findViewById<MaterialButton>(R.id.btnOpenTermux).setOnClickListener {
            openTermux()
        }

        findViewById<MaterialButton>(R.id.btnClearOutput).setOnClickListener {
            outputTextView.text = ""
        }

        // Initial message
        appendOutput("üì± Pentest Dashboard Ready\n")
        appendOutput("‚ö†Ô∏è  Only use on networks/devices you OWN\n")
        appendOutput("Select a command to execute...\n\n")
    }

    private fun checkPermissions() {
        val permissionsNeeded = mutableListOf<String>()

        if (ContextCompat.checkSelfPermission(this, Manifest.permission.INTERNET) != PackageManager.PERMISSION_GRANTED) {
            permissionsNeeded.add(Manifest.permission.INTERNET)
        }
        if (ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_WIFI_STATE) != PackageManager.PERMISSION_GRANTED) {
            permissionsNeeded.add(Manifest.permission.ACCESS_WIFI_STATE)
        }
        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.S) {
            if (ContextCompat.checkSelfPermission(this, Manifest.permission.BLUETOOTH_CONNECT) != PackageManager.PERMISSION_GRANTED) {
                permissionsNeeded.add(Manifest.permission.BLUETOOTH_CONNECT)
            }
        }

        if (permissionsNeeded.isNotEmpty()) {
            ActivityCompat.requestPermissions(this, permissionsNeeded.toTypedArray(), PERMISSION_REQUEST_CODE)
        }
    }

    private fun executeTermuxCommand(command: String) {
        appendOutput("\nüöÄ Executing: $command\n")
        appendOutput("‚îÄ".repeat(50) + "\n")

        // Method 1: Try Termux:API Intent
        try {
            val intent = Intent()
            intent.setClassName(TERMUX_PACKAGE, TERMUX_SERVICE)
            intent.action = "$TERMUX_SERVICE.RUN_COMMAND"
            intent.putExtra("com.termux.RUN_COMMAND_PATH", "/data/data/com.termux/files/usr/bin/bash")
            intent.putExtra("com.termux.RUN_COMMAND_ARGUMENTS", arrayOf("-c", command))
            intent.putExtra("com.termux.RUN_COMMAND_WORKDIR", "/data/data/com.termux/files/home")
            intent.putExtra("com.termux.RUN_COMMAND_BACKGROUND", false)

            startService(intent)
            appendOutput("‚úÖ Command sent to Termux\n")
            appendOutput("üí° Check Termux app for output\n\n")
        } catch (e: Exception) {
            appendOutput("‚ö†Ô∏è  Termux API method failed: ${e.message}\n")

            // Method 2: Fallback - Open Termux with instructions
            appendOutput("üí° Opening Termux... Please run command manually:\n")
            appendOutput("   $command\n\n")

            try {
                val termuxIntent = packageManager.getLaunchIntentForPackage(TERMUX_PACKAGE)
                if (termuxIntent != null) {
                    startActivity(termuxIntent)
                } else {
                    appendOutput("‚ùå Termux not installed. Install from F-Droid:\n")
                    appendOutput("   https://f-droid.org/en/packages/com.termux/\n\n")
                }
            } catch (e2: Exception) {
                appendOutput("‚ùå Error opening Termux: ${e2.message}\n\n")
            }
        }
    }

    private fun openTermux() {
        try {
            val intent = packageManager.getLaunchIntentForPackage(TERMUX_PACKAGE)
            if (intent != null) {
                startActivity(intent)
                appendOutput("‚úÖ Opened Termux\n\n")
            } else {
                appendOutput("‚ùå Termux not installed\n")
                appendOutput("Install from: https://f-droid.org/en/packages/com.termux/\n\n")

                // Offer to open F-Droid or browser
                val browserIntent = Intent(Intent.ACTION_VIEW, Uri.parse("https://f-droid.org/en/packages/com.termux/"))
                startActivity(browserIntent)
            }
        } catch (e: Exception) {
            appendOutput("‚ùå Error: ${e.message}\n\n")
        }
    }

    private fun appendOutput(text: String) {
        runOnUiThread {
            outputTextView.append(text)
            scrollView.post {
                scrollView.fullScroll(ScrollView.FOCUS_DOWN)
            }
        }
    }

    override fun onRequestPermissionsResult(
        requestCode: Int,
        permissions: Array<out String>,
        grantResults: IntArray
    ) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults)
        if (requestCode == PERMISSION_REQUEST_CODE) {
            val allGranted = grantResults.all { it == PackageManager.PERMISSION_GRANTED }
            if (allGranted) {
                Toast.makeText(this, "Permissions granted", Toast.LENGTH_SHORT).show()
            } else {
                Toast.makeText(this, "Some permissions denied. App may not work correctly.", Toast.LENGTH_LONG).show()
            }
        }
    }
}
