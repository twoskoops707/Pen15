package com.pentest.dashboard

import android.Manifest
import android.bluetooth.BluetoothAdapter
import android.bluetooth.BluetoothManager
import android.content.Context
import android.content.Intent
import android.content.pm.PackageManager
import android.net.Uri
import android.os.Build
import android.os.Bundle
import android.view.View
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.core.app.ActivityCompat
import androidx.core.content.ContextCompat
import com.google.android.material.button.MaterialButton
import com.google.android.material.card.MaterialCardView

class MainActivity : AppCompatActivity() {

    private lateinit var statusIndicator: View
    private lateinit var statusText: TextView
    private lateinit var btnConnect: MaterialButton

    private var bluetoothAdapter: BluetoothAdapter? = null
    private var isConnected = false

    companion object {
        private const val PERMISSION_REQUEST_CODE = 1001
        private const val BLUETOOTH_REQUEST_CODE = 1002
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        initializeViews()
        setupBluetoothAdapter()
        setupClickListeners()
        checkPermissions()
    }

    private fun initializeViews() {
        statusIndicator = findViewById(R.id.statusIndicator)
        statusText = findViewById(R.id.statusText)
        btnConnect = findViewById(R.id.btnConnect)

        updateConnectionStatus(false)
    }

    private fun setupBluetoothAdapter() {
        val bluetoothManager = getSystemService(Context.BLUETOOTH_SERVICE) as BluetoothManager
        bluetoothAdapter = bluetoothManager.adapter
    }

    private fun setupClickListeners() {
        // Settings button
        findViewById<ImageView>(R.id.btnSettings).setOnClickListener {
            Toast.makeText(this, "Settings - Coming soon", Toast.LENGTH_SHORT).show()
        }

        // Connect button
        btnConnect.setOnClickListener {
            if (isConnected) {
                disconnect()
            } else {
                attemptConnection()
            }
        }

        // Archive button
        findViewById<ImageView>(R.id.btnArchive).setOnClickListener {
            Toast.makeText(this, "Archive - Coming soon", Toast.LENGTH_SHORT).show()
        }

        // Function cards
        findViewById<MaterialCardView>(R.id.cardSubGHz).setOnClickListener {
            launchFunction("Sub-GHz", "Radio frequency scanner for 300-928MHz")
        }

        findViewById<MaterialCardView>(R.id.cardRFID).setOnClickListener {
            launchFunction("RFID", "Read and emulate 125kHz access cards")
        }

        findViewById<MaterialCardView>(R.id.cardNFC).setOnClickListener {
            launchFunction("NFC", "Read and write 13.56MHz NFC tags")
        }

        findViewById<MaterialCardView>(R.id.cardInfrared).setOnClickListener {
            launchFunction("Infrared", "Universal remote control")
        }

        findViewById<MaterialCardView>(R.id.cardGPIO).setOnClickListener {
            launchFunction("GPIO", "Hardware interface control")
        }

        findViewById<MaterialCardView>(R.id.cardBadUSB).setOnClickListener {
            launchFunction("BadUSB", "Keyboard/Mouse HID emulation")
        }

        findViewById<MaterialCardView>(R.id.cardIButton).setOnClickListener {
            launchFunction("iButton", "1-Wire contact key reader/writer")
        }

        findViewById<MaterialCardView>(R.id.cardBluetooth).setOnClickListener {
            launchFunction("Bluetooth", "BLE device scanner")
        }
    }

    private fun checkPermissions() {
        val permissions = mutableListOf<String>()

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
            if (ContextCompat.checkSelfPermission(this, Manifest.permission.BLUETOOTH_CONNECT)
                != PackageManager.PERMISSION_GRANTED) {
                permissions.add(Manifest.permission.BLUETOOTH_CONNECT)
            }
            if (ContextCompat.checkSelfPermission(this, Manifest.permission.BLUETOOTH_SCAN)
                != PackageManager.PERMISSION_GRANTED) {
                permissions.add(Manifest.permission.BLUETOOTH_SCAN)
            }
        }

        if (permissions.isNotEmpty()) {
            ActivityCompat.requestPermissions(this, permissions.toTypedArray(), PERMISSION_REQUEST_CODE)
        }
    }

    private fun attemptConnection() {
        if (bluetoothAdapter == null) {
            Toast.makeText(this, "Bluetooth not supported on this device", Toast.LENGTH_LONG).show()
            return
        }

        if (!bluetoothAdapter!!.isEnabled) {
            val enableBtIntent = Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE)
            startActivityForResult(enableBtIntent, BLUETOOTH_REQUEST_CODE)
            return
        }

        // Show Bluetooth device picker
        Toast.makeText(this, "Scanning for Flipper Zero devices...", Toast.LENGTH_SHORT).show()

        // Simulate connection (in real implementation, this would scan and connect)
        btnConnect.postDelayed({
            updateConnectionStatus(true)
            Toast.makeText(this, "Connected to Flipper Zero", Toast.LENGTH_SHORT).show()
        }, 1500)
    }

    private fun disconnect() {
        updateConnectionStatus(false)
        Toast.makeText(this, "Disconnected", Toast.LENGTH_SHORT).show()
    }

    private fun updateConnectionStatus(connected: Boolean) {
        isConnected = connected

        if (connected) {
            statusIndicator.backgroundTintList = ContextCompat.getColorStateList(this, R.color.status_connected)
            statusText.text = "CONNECTED â€¢ FLIPPER ZERO"
            btnConnect.text = "DISCONNECT"
            btnConnect.backgroundTintList = ContextCompat.getColorStateList(this, R.color.status_disconnected)
        } else {
            statusIndicator.backgroundTintList = ContextCompat.getColorStateList(this, R.color.status_disconnected)
            statusText.text = "DISCONNECTED"
            btnConnect.text = "CONNECT"
            btnConnect.backgroundTintList = ContextCompat.getColorStateList(this, R.color.electric_blue)
        }
    }

    private fun launchFunction(functionName: String, description: String) {
        if (!isConnected) {
            Toast.makeText(this, "Please connect Flipper Zero first", Toast.LENGTH_SHORT).show()
            return
        }

        Toast.makeText(this, "$functionName\n$description\n\nOpening in Flipper Zero...", Toast.LENGTH_LONG).show()

        // In real implementation, this would send command to Flipper Zero via Bluetooth
    }

    override fun onRequestPermissionsResult(
        requestCode: Int,
        permissions: Array<out String>,
        grantResults: IntArray
    ) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults)

        if (requestCode == PERMISSION_REQUEST_CODE) {
            if (grantResults.isNotEmpty() && grantResults.all { it == PackageManager.PERMISSION_GRANTED }) {
                Toast.makeText(this, "Permissions granted", Toast.LENGTH_SHORT).show()
            } else {
                Toast.makeText(this, "Bluetooth permissions required", Toast.LENGTH_LONG).show()
            }
        }
    }

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)

        if (requestCode == BLUETOOTH_REQUEST_CODE) {
            if (resultCode == RESULT_OK) {
                attemptConnection()
            } else {
                Toast.makeText(this, "Bluetooth must be enabled", Toast.LENGTH_SHORT).show()
            }
        }
    }
}
