package com.pentest.dashboard

import android.Manifest
import android.bluetooth.BluetoothAdapter
import android.bluetooth.BluetoothDevice
import android.bluetooth.BluetoothManager
import android.content.Context
import android.content.Intent
import android.content.pm.PackageManager
import android.net.Uri
import android.os.Build
import android.os.Bundle
import android.view.View
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.core.app.ActivityCompat
import androidx.core.content.ContextCompat
import com.google.android.material.button.MaterialButton
import com.google.android.material.card.MaterialCardView

class MainActivity : AppCompatActivity() {

    private lateinit var statusIndicator: View
    private lateinit var statusText: TextView
    private lateinit var btnConnect: MaterialButton

    private var bluetoothAdapter: BluetoothAdapter? = null
    private var isConnected = false

    companion object {
        private const val PERMISSION_REQUEST_CODE = 1001
        private const val BLUETOOTH_REQUEST_CODE = 1002
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        initializeViews()
        setupBluetoothAdapter()
        setupClickListeners()
        checkPermissions()
    }

    private fun initializeViews() {
        statusIndicator = findViewById(R.id.statusIndicator)
        statusText = findViewById(R.id.statusText)
        btnConnect = findViewById(R.id.btnConnect)

        // Initialize Flipper connection manager (singleton)
        FlipperConnectionManager.initialize(this)

        updateConnectionStatus(false)
    }

    private fun setupBluetoothAdapter() {
        val bluetoothManager = getSystemService(Context.BLUETOOTH_SERVICE) as BluetoothManager
        bluetoothAdapter = bluetoothManager.adapter
    }

    private fun setupClickListeners() {
        // Settings button
        findViewById<ImageView>(R.id.btnSettings).setOnClickListener {
            startActivity(Intent(this, SettingsActivity::class.java))
        }

        // Connect button
        btnConnect.setOnClickListener {
            if (isConnected) {
                disconnect()
            } else {
                attemptConnection()
            }
        }

        // Archive button
        findViewById<ImageView>(R.id.btnArchive).setOnClickListener {
            Toast.makeText(this, "Archive - Coming soon", Toast.LENGTH_SHORT).show()
        }

        // Function cards - Navigate to detail screens
        findViewById<MaterialCardView>(R.id.cardSubGHz).setOnClickListener {
            if (!isConnected) {
                Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            startActivity(Intent(this, SubGHzActivity::class.java))
        }

        findViewById<MaterialCardView>(R.id.cardRFID).setOnClickListener {
            if (!isConnected) {
                Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            startActivity(Intent(this, RFIDActivity::class.java))
        }

        findViewById<MaterialCardView>(R.id.cardNFC).setOnClickListener {
            if (!isConnected) {
                Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            startActivity(Intent(this, NFCActivity::class.java))
        }

        findViewById<MaterialCardView>(R.id.cardInfrared).setOnClickListener {
            if (!isConnected) {
                Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            startActivity(Intent(this, InfraredActivity::class.java))
        }

        findViewById<MaterialCardView>(R.id.cardGPIO).setOnClickListener {
            if (!isConnected) {
                Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            startActivity(Intent(this, GPIOActivity::class.java))
        }

        findViewById<MaterialCardView>(R.id.cardBadUSB).setOnClickListener {
            if (!isConnected) {
                Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            startActivity(Intent(this, BadUSBActivity::class.java))
        }

        findViewById<MaterialCardView>(R.id.cardIButton).setOnClickListener {
            if (!isConnected) {
                Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            startActivity(Intent(this, IButtonActivity::class.java))
        }

        findViewById<MaterialCardView>(R.id.cardBluetooth).setOnClickListener {
            if (!isConnected) {
                Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            startActivity(Intent(this, BluetoothActivity::class.java))
        }
    }

    private fun checkPermissions() {
        val permissions = mutableListOf<String>()

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
            if (ContextCompat.checkSelfPermission(this, Manifest.permission.BLUETOOTH_CONNECT)
                != PackageManager.PERMISSION_GRANTED) {
                permissions.add(Manifest.permission.BLUETOOTH_CONNECT)
            }
            if (ContextCompat.checkSelfPermission(this, Manifest.permission.BLUETOOTH_SCAN)
                != PackageManager.PERMISSION_GRANTED) {
                permissions.add(Manifest.permission.BLUETOOTH_SCAN)
            }
        }

        if (permissions.isNotEmpty()) {
            ActivityCompat.requestPermissions(this, permissions.toTypedArray(), PERMISSION_REQUEST_CODE)
        }
    }

    private fun attemptConnection() {
        // Try USB first (more reliable)
        statusText.text = "SEARCHING USB..."
        Toast.makeText(this, "ðŸ” Searching for Flipper Zero via USB...", Toast.LENGTH_LONG).show()

        FlipperConnectionManager.usbManager?.connect { success, message ->
            runOnUiThread {
                if (success) {
                    FlipperConnectionManager.setConnectionType("usb")
                    updateConnectionStatus(true)
                    statusText.text = "CONNECTED â€¢ USB-C"
                    Toast.makeText(this, "âœ“ Connected via USB-C!", Toast.LENGTH_LONG).show()
                } else {
                    // Show USB failure message
                    statusText.text = "USB FAILED"
                    Toast.makeText(this, "âœ— USB: $message", Toast.LENGTH_LONG).show()

                    // Try Bluetooth after showing USB error
                    android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({
                        attemptBluetoothConnection()
                    }, 1500)
                }
            }
        }
    }

    private fun attemptBluetoothConnection() {
        if (bluetoothAdapter == null) {
            Toast.makeText(this, "No USB or Bluetooth connection available", Toast.LENGTH_LONG).show()
            updateConnectionStatus(false)
            return
        }

        if (!bluetoothAdapter!!.isEnabled) {
            val enableBtIntent = Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE)
            startActivityForResult(enableBtIntent, BLUETOOTH_REQUEST_CODE)
            return
        }

        Toast.makeText(this, "ðŸ” Scanning for Flipper Zero devices...", Toast.LENGTH_LONG).show()
        statusText.text = "SCANNING BT..."

        // REAL Bluetooth scan for paired Flipper devices
        try {
            if (ActivityCompat.checkSelfPermission(this, Manifest.permission.BLUETOOTH_CONNECT) != PackageManager.PERMISSION_GRANTED) {
                Toast.makeText(this, "Bluetooth permission required", Toast.LENGTH_SHORT).show()
                updateConnectionStatus(false)
                return
            }

            val pairedDevices = bluetoothAdapter!!.bondedDevices
            var flipperDevice: BluetoothDevice? = null

            for (device in pairedDevices) {
                if (device.name?.contains("Flipper", ignoreCase = true) == true) {
                    flipperDevice = device
                    statusText.text = "FOUND: ${device.name}"
                    Toast.makeText(this, "âœ“ Found ${device.name} - Connecting...", Toast.LENGTH_SHORT).show()
                    break
                }
            }

            if (flipperDevice != null) {
                // Connect via Bluetooth using FlipperConnectionManager
                FlipperConnectionManager.bluetoothManager?.connect(flipperDevice) { success, message ->
                    runOnUiThread {
                        if (success) {
                            FlipperConnectionManager.setConnectionType("bluetooth")
                            updateConnectionStatus(true)
                            statusText.text = "CONNECTED â€¢ BLE"
                            Toast.makeText(this, "âœ“ Connected via Bluetooth!", Toast.LENGTH_LONG).show()
                        } else {
                            statusText.text = "BT FAILED"
                            Toast.makeText(this, "âœ— Bluetooth: $message", Toast.LENGTH_LONG).show()
                            updateConnectionStatus(false)
                        }
                    }
                }
            } else {
                statusText.text = "NO FLIPPER FOUND"
                Toast.makeText(this, "No Flipper Zero found in paired devices.\n\nPair it first:\nSettings â†’ Bluetooth â†’ Pair new device â†’ Select your Flipper", Toast.LENGTH_LONG).show()
                updateConnectionStatus(false)
            }
        } catch (e: Exception) {
            updateConnectionStatus(false)
            statusText.text = "CONNECTION FAILED"
            Toast.makeText(this, "Connection error: ${e.message}", Toast.LENGTH_LONG).show()
        }
    }

    private fun disconnect() {
        FlipperConnectionManager.disconnect()
        updateConnectionStatus(false)
        Toast.makeText(this, "Disconnected from Flipper Zero", Toast.LENGTH_SHORT).show()
    }

    override fun onDestroy() {
        super.onDestroy()
        FlipperConnectionManager.cleanup()
    }

    private fun updateConnectionStatus(connected: Boolean) {
        isConnected = connected

        if (connected) {
            statusIndicator.backgroundTintList = ContextCompat.getColorStateList(this, R.color.status_connected)
            statusText.text = "CONNECTED â€¢ FLIPPER ZERO"
            btnConnect.text = "DISCONNECT"
            btnConnect.backgroundTintList = ContextCompat.getColorStateList(this, R.color.status_disconnected)
        } else {
            statusIndicator.backgroundTintList = ContextCompat.getColorStateList(this, R.color.status_disconnected)
            statusText.text = "DISCONNECTED"
            btnConnect.text = "CONNECT"
            btnConnect.backgroundTintList = ContextCompat.getColorStateList(this, R.color.electric_blue)
        }
    }


    override fun onRequestPermissionsResult(
        requestCode: Int,
        permissions: Array<out String>,
        grantResults: IntArray
    ) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults)

        if (requestCode == PERMISSION_REQUEST_CODE) {
            if (grantResults.isNotEmpty() && grantResults.all { it == PackageManager.PERMISSION_GRANTED }) {
                Toast.makeText(this, "Permissions granted", Toast.LENGTH_SHORT).show()
            } else {
                Toast.makeText(this, "Bluetooth permissions required", Toast.LENGTH_LONG).show()
            }
        }
    }

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)

        if (requestCode == BLUETOOTH_REQUEST_CODE) {
            if (resultCode == RESULT_OK) {
                attemptConnection()
            } else {
                Toast.makeText(this, "Bluetooth must be enabled", Toast.LENGTH_SHORT).show()
            }
        }
    }
}
