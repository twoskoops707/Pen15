package com.pentest.dashboard

import android.Manifest
import android.bluetooth.BluetoothAdapter
import android.bluetooth.BluetoothDevice
import android.bluetooth.BluetoothManager
import android.content.Context
import android.content.Intent
import android.content.pm.PackageManager
import android.net.Uri
import android.os.Build
import android.os.Bundle
import android.view.View
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.core.app.ActivityCompat
import androidx.core.content.ContextCompat
import com.google.android.material.button.MaterialButton
import com.google.android.material.card.MaterialCardView

class MainActivity : AppCompatActivity() {

    private lateinit var statusIndicator: View
    private lateinit var statusText: TextView
    private lateinit var currentOperation: TextView
    private lateinit var infoPanelTitle: TextView
    private lateinit var infoDisplay: TextView
    private lateinit var btnConnect: MaterialButton

    private var bluetoothAdapter: BluetoothAdapter? = null
    private var isConnected = false
    private val scanResults = StringBuilder()

    companion object {
        private const val PERMISSION_REQUEST_CODE = 1001
        private const val BLUETOOTH_REQUEST_CODE = 1002
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        initializeViews()
        setupBluetoothAdapter()
        setupClickListeners()
        checkPermissions()
    }

    private fun initializeViews() {
        statusIndicator = findViewById(R.id.statusIndicator)
        statusText = findViewById(R.id.statusText)
        currentOperation = findViewById(R.id.currentOperation)
        infoPanelTitle = findViewById(R.id.infoPanelTitle)
        infoDisplay = findViewById(R.id.infoDisplay)
        btnConnect = findViewById(R.id.btnConnect)

        // Initialize Flipper connection manager (singleton)
        FlipperConnectionManager.initialize(this)

        updateConnectionStatus(false)
        updateInfoDisplay("Ready to scan", "Waiting for scan...\n\nConnect Flipper Zero via:\n• USB-C cable (Recommended)\n• Bluetooth (Pair first in Android settings)")
    }

    private fun updateInfoDisplay(title: String, content: String) {
        runOnUiThread {
            infoPanelTitle.text = title
            infoDisplay.text = content
        }
    }

    private fun setupBluetoothAdapter() {
        val bluetoothManager = getSystemService(Context.BLUETOOTH_SERVICE) as BluetoothManager
        bluetoothAdapter = bluetoothManager.adapter
    }

    private fun setupClickListeners() {
        // Settings button
        findViewById<ImageView>(R.id.btnSettings).setOnClickListener {
            startActivity(Intent(this, SettingsActivity::class.java))
        }

        // Connect button
        btnConnect.setOnClickListener {
            if (isConnected) {
                disconnect()
            } else {
                attemptConnection()
            }
        }

        // Archive button
        findViewById<ImageView>(R.id.btnArchive).setOnClickListener {
            Toast.makeText(this, "Archive - Coming soon", Toast.LENGTH_SHORT).show()
        }

        // Function cards - Navigate to detail screens
        findViewById<MaterialCardView>(R.id.cardSubGHz).setOnClickListener {
            if (!isConnected) {
                Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            startActivity(Intent(this, SubGHzActivity::class.java))
        }

        findViewById<MaterialCardView>(R.id.cardRFID).setOnClickListener {
            if (!isConnected) {
                Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            startActivity(Intent(this, RFIDActivity::class.java))
        }

        findViewById<MaterialCardView>(R.id.cardNFC).setOnClickListener {
            if (!isConnected) {
                Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            startActivity(Intent(this, NFCActivity::class.java))
        }

        findViewById<MaterialCardView>(R.id.cardInfrared).setOnClickListener {
            if (!isConnected) {
                Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            startActivity(Intent(this, InfraredActivity::class.java))
        }

        findViewById<MaterialCardView>(R.id.cardGPIO).setOnClickListener {
            if (!isConnected) {
                Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            startActivity(Intent(this, GPIOActivity::class.java))
        }

        findViewById<MaterialCardView>(R.id.cardBadUSB).setOnClickListener {
            if (!isConnected) {
                Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            startActivity(Intent(this, BadUSBActivity::class.java))
        }

        findViewById<MaterialCardView>(R.id.cardIButton).setOnClickListener {
            if (!isConnected) {
                Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            startActivity(Intent(this, IButtonActivity::class.java))
        }

        findViewById<MaterialCardView>(R.id.cardBluetooth).setOnClickListener {
            if (!isConnected) {
                Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            startActivity(Intent(this, BluetoothActivity::class.java))
        }
    }

    private fun checkPermissions() {
        val permissions = mutableListOf<String>()

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
            if (ContextCompat.checkSelfPermission(this, Manifest.permission.BLUETOOTH_CONNECT)
                != PackageManager.PERMISSION_GRANTED) {
                permissions.add(Manifest.permission.BLUETOOTH_CONNECT)
            }
            if (ContextCompat.checkSelfPermission(this, Manifest.permission.BLUETOOTH_SCAN)
                != PackageManager.PERMISSION_GRANTED) {
                permissions.add(Manifest.permission.BLUETOOTH_SCAN)
            }
        }

        if (permissions.isNotEmpty()) {
            ActivityCompat.requestPermissions(this, permissions.toTypedArray(), PERMISSION_REQUEST_CODE)
        }
    }

    private fun attemptConnection() {
        scanResults.clear()
        updateInfoDisplay("USB SCANNER", "Scanning USB devices...")
        currentOperation.text = "Scanning for Flipper Zero..."
        statusText.text = "SEARCHING USB..."

        scanResults.append("=== USB SCAN STARTED ===\n\n")
        updateInfoDisplay("USB SCANNER", scanResults.toString())

        FlipperConnectionManager.usbManager?.setConnectionListener { success, message ->
            runOnUiThread {
                if (success) {
                    scanResults.append("✓ FOUND: Flipper Zero via USB\n")
                    scanResults.append("✓ VID:PID = 0x0483:0x5740\n")
                    scanResults.append("✓ Status: CONNECTED\n\n")
                    updateInfoDisplay("USB CONNECTION", scanResults.toString())

                    FlipperConnectionManager.setConnectionType("usb")
                    updateConnectionStatus(true)
                    statusText.text = "CONNECTED • USB-C"
                    currentOperation.text = "Connected via USB-C cable"
                    Toast.makeText(this, "✓ Connected via USB-C!", Toast.LENGTH_LONG).show()
                } else {
                    scanResults.append("✗ USB SCAN FAILED\n")
                    scanResults.append("✗ Reason: $message\n")
                    scanResults.append("\nRetrying via Bluetooth...\n\n")
                    updateInfoDisplay("USB SCAN RESULTS", scanResults.toString())

                    statusText.text = "USB FAILED - TRYING BT"
                    currentOperation.text = "USB failed, switching to Bluetooth..."

                    // Try Bluetooth after showing USB error
                    android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({
                        attemptBluetoothConnection()
                    }, 1500)
                }
            }
        }

        // Now actually connect
        FlipperConnectionManager.usbManager?.connect()
    }

    private fun attemptBluetoothConnection() {
        scanResults.append("=== BLUETOOTH SCAN STARTED ===\n\n")
        updateInfoDisplay("BLUETOOTH SCANNER", scanResults.toString())
        currentOperation.text = "Scanning Bluetooth devices..."
        statusText.text = "SCANNING BLUETOOTH..."

        if (bluetoothAdapter == null) {
            scanResults.append("✗ Bluetooth adapter not found\n")
            scanResults.append("✗ Device may not support Bluetooth\n\n")
            updateInfoDisplay("SCAN FAILED", scanResults.toString())
            updateConnectionStatus(false)
            return
        }

        if (!bluetoothAdapter!!.isEnabled) {
            scanResults.append("⚠ Bluetooth is OFF\n")
            scanResults.append("→ Requesting Bluetooth enable...\n\n")
            updateInfoDisplay("BLUETOOTH STATUS", scanResults.toString())

            val enableBtIntent = Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE)
            startActivityForResult(enableBtIntent, BLUETOOTH_REQUEST_CODE)
            return
        }

        // REAL Bluetooth scan for paired Flipper devices
        try {
            if (ActivityCompat.checkSelfPermission(this, Manifest.permission.BLUETOOTH_CONNECT) != PackageManager.PERMISSION_GRANTED) {
                scanResults.append("✗ Missing permission: BLUETOOTH_CONNECT\n\n")
                updateInfoDisplay("PERMISSION ERROR", scanResults.toString())
                updateConnectionStatus(false)
                return
            }

            val pairedDevices = bluetoothAdapter!!.bondedDevices
            scanResults.append("Found ${pairedDevices.size} paired devices:\n\n")

            var deviceNumber = 1
            var flipperDevice: BluetoothDevice? = null

            for (device in pairedDevices) {
                val deviceName = device.name ?: "Unknown"
                val deviceAddress = device.address
                val deviceType = when (device.type) {
                    BluetoothDevice.DEVICE_TYPE_CLASSIC -> "Classic"
                    BluetoothDevice.DEVICE_TYPE_LE -> "BLE"
                    BluetoothDevice.DEVICE_TYPE_DUAL -> "Dual"
                    else -> "Unknown"
                }

                scanResults.append("$deviceNumber. $deviceName\n")
                scanResults.append("   MAC: $deviceAddress\n")
                scanResults.append("   Type: $deviceType\n")

                if (device.name?.contains("Flipper", ignoreCase = true) == true) {
                    flipperDevice = device
                    scanResults.append("   >>> FLIPPER ZERO DETECTED <<<\n")
                    statusText.text = "FOUND: ${device.name}"
                }
                scanResults.append("\n")
                deviceNumber++
            }

            updateInfoDisplay("BLUETOOTH SCAN RESULTS", scanResults.toString())

            if (flipperDevice != null) {
                scanResults.append("\n✓ Connecting to Flipper Zero...\n")
                updateInfoDisplay("BLUETOOTH CONNECTION", scanResults.toString())

                // Connect via Bluetooth using FlipperConnectionManager
                FlipperConnectionManager.bluetoothManager?.connect(flipperDevice) { success, message ->
                    runOnUiThread {
                        if (success) {
                            scanResults.append("✓ CONNECTION ESTABLISHED\n")
                            scanResults.append("✓ Protocol: BLE GATT\n")
                            scanResults.append("✓ Status: READY\n")
                            updateInfoDisplay("CONNECTED VIA BLUETOOTH", scanResults.toString())

                            FlipperConnectionManager.setConnectionType("bluetooth")
                            updateConnectionStatus(true)
                            statusText.text = "CONNECTED • BLUETOOTH"
                            currentOperation.text = "Connected via Bluetooth"
                        } else {
                            scanResults.append("\n✗ CONNECTION FAILED\n")
                            scanResults.append("✗ Error: $message\n")
                            updateInfoDisplay("CONNECTION FAILED", scanResults.toString())

                            statusText.text = "BT FAILED"
                            currentOperation.text = "Connection failed"
                            updateConnectionStatus(false)
                        }
                    }
                }
            } else {
                scanResults.append("\n✗ NO FLIPPER ZERO FOUND\n")
                scanResults.append("\nTo connect:\n")
                scanResults.append("1. Turn on your Flipper Zero\n")
                scanResults.append("2. Go to Android Settings\n")
                scanResults.append("3. Bluetooth → Pair new device\n")
                scanResults.append("4. Select 'Flipper <name>'\n")
                scanResults.append("5. Return here and try again\n")
                updateInfoDisplay("NO FLIPPER DETECTED", scanResults.toString())

                statusText.text = "NO FLIPPER FOUND"
                currentOperation.text = "Pair Flipper in Android settings"
                updateConnectionStatus(false)
            }
        } catch (e: Exception) {
            scanResults.append("\n✗ SCAN ERROR\n")
            scanResults.append("✗ Exception: ${e.message}\n")
            updateInfoDisplay("SCAN ERROR", scanResults.toString())

            updateConnectionStatus(false)
            statusText.text = "SCAN FAILED"
            currentOperation.text = "Error: ${e.message}"
        }
    }

    private fun disconnect() {
        FlipperConnectionManager.disconnect()
        updateConnectionStatus(false)
        Toast.makeText(this, "Disconnected from Flipper Zero", Toast.LENGTH_SHORT).show()
    }

    override fun onDestroy() {
        super.onDestroy()
        FlipperConnectionManager.cleanup()
    }

    private fun updateConnectionStatus(connected: Boolean) {
        isConnected = connected

        if (connected) {
            statusIndicator.backgroundTintList = ContextCompat.getColorStateList(this, R.color.status_connected)
            statusText.text = "CONNECTED • FLIPPER ZERO"
            btnConnect.text = "DISCONNECT"
            btnConnect.backgroundTintList = ContextCompat.getColorStateList(this, R.color.status_disconnected)
        } else {
            statusIndicator.backgroundTintList = ContextCompat.getColorStateList(this, R.color.status_disconnected)
            statusText.text = "DISCONNECTED"
            btnConnect.text = "CONNECT"
            btnConnect.backgroundTintList = ContextCompat.getColorStateList(this, R.color.electric_blue)
        }
    }


    override fun onRequestPermissionsResult(
        requestCode: Int,
        permissions: Array<out String>,
        grantResults: IntArray
    ) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults)

        if (requestCode == PERMISSION_REQUEST_CODE) {
            if (grantResults.isNotEmpty() && grantResults.all { it == PackageManager.PERMISSION_GRANTED }) {
                Toast.makeText(this, "Permissions granted", Toast.LENGTH_SHORT).show()
            } else {
                Toast.makeText(this, "Bluetooth permissions required", Toast.LENGTH_LONG).show()
            }
        }
    }

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)

        if (requestCode == BLUETOOTH_REQUEST_CODE) {
            if (resultCode == RESULT_OK) {
                attemptConnection()
            } else {
                Toast.makeText(this, "Bluetooth must be enabled", Toast.LENGTH_SHORT).show()
            }
        }
    }
}
