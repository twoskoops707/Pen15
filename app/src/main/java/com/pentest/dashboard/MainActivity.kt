package com.pentest.dashboard

import android.Manifest
import android.content.ClipData
import android.content.ClipboardManager
import android.content.Context
import android.content.Intent
import android.content.pm.PackageManager
import android.net.Uri
import android.net.wifi.WifiManager
import android.os.Build
import android.os.Bundle
import android.widget.Button
import android.widget.EditText
import android.widget.ScrollView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.core.app.ActivityCompat
import androidx.core.content.ContextCompat
import com.google.android.material.button.MaterialButton
import com.google.android.material.textfield.TextInputEditText
import kotlinx.coroutines.*
import java.io.BufferedReader
import java.io.InputStreamReader
import java.net.NetworkInterface

class MainActivity : AppCompatActivity() {

    private lateinit var outputTextView: TextView
    private lateinit var scrollView: ScrollView
    private lateinit var targetInput: EditText
    private lateinit var deviceInfoText: TextView

    private val PERMISSION_REQUEST_CODE = 1001

    companion object {
        const val TERMUX_PACKAGE = "com.termux"
        const val TERMUX_SERVICE = "com.termux.app.RunCommandService"
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        // Initialize views
        outputTextView = findViewById(R.id.outputTextView)
        scrollView = findViewById(R.id.scrollView)
        targetInput = findViewById(R.id.targetInput)
        deviceInfoText = findViewById(R.id.deviceInfoText)

        // Check and request permissions
        checkPermissions()

        // Load device info
        updateDeviceInfo()

        // Button click listeners
        findViewById<MaterialButton>(R.id.btnUpdatePackages).setOnClickListener {
            executeTermuxCommand("pkg update -y && pkg upgrade -y")
        }

        findViewById<MaterialButton>(R.id.btnInstallTools).setOnClickListener {
            executeTermuxCommand("pkg install nmap git python wget curl termux-api build-essential clang make -y")
        }

        findViewById<MaterialButton>(R.id.btnNmapQuick).setOnClickListener {
            val target = targetInput.text.toString().ifEmpty { "192.168.1.0/24" }
            executeTermuxCommand("nmap -sn $target")
        }

        findViewById<MaterialButton>(R.id.btnNmapDetailed).setOnClickListener {
            val target = targetInput.text.toString().ifEmpty { "192.168.1.1" }
            executeTermuxCommand("nmap -A -T4 $target")
        }

        findViewById<MaterialButton>(R.id.btnArpScan).setOnClickListener {
            executeTermuxCommand("arp-scan --localnet")
        }

        findViewById<MaterialButton>(R.id.btnInstallAircrack).setOnClickListener {
            executeTermuxCommand("cd ~ && git clone https://github.com/aircrack-ng/aircrack-ng && cd aircrack-ng && autoreconf -i && ./configure --with-experimental && make && make install")
        }

        findViewById<MaterialButton>(R.id.btnInstallHashcat).setOnClickListener {
            executeTermuxCommand("cd ~ && git clone https://github.com/hashcat/hashcat && cd hashcat && make && make install")
        }

        findViewById<MaterialButton>(R.id.btnOpenTermux).setOnClickListener {
            openTermux()
        }

        findViewById<MaterialButton>(R.id.btnClearOutput).setOnClickListener {
            outputTextView.text = ""
        }

        findViewById<MaterialButton>(R.id.btnRefreshInfo).setOnClickListener {
            updateDeviceInfo()
            Toast.makeText(this, "Device info refreshed", Toast.LENGTH_SHORT).show()
        }

        // Initial message
        appendOutput("üì± Pentest Dashboard Ready\n")
        appendOutput("‚ö†Ô∏è  Only use on networks/devices you OWN\n")
        appendOutput("Select a command to execute...\n\n")
    }

    private fun checkPermissions() {
        val permissionsNeeded = mutableListOf<String>()

        if (ContextCompat.checkSelfPermission(this, Manifest.permission.INTERNET) != PackageManager.PERMISSION_GRANTED) {
            permissionsNeeded.add(Manifest.permission.INTERNET)
        }
        if (ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_WIFI_STATE) != PackageManager.PERMISSION_GRANTED) {
            permissionsNeeded.add(Manifest.permission.ACCESS_WIFI_STATE)
        }
        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.S) {
            if (ContextCompat.checkSelfPermission(this, Manifest.permission.BLUETOOTH_CONNECT) != PackageManager.PERMISSION_GRANTED) {
                permissionsNeeded.add(Manifest.permission.BLUETOOTH_CONNECT)
            }
        }

        if (permissionsNeeded.isNotEmpty()) {
            ActivityCompat.requestPermissions(this, permissionsNeeded.toTypedArray(), PERMISSION_REQUEST_CODE)
        }
    }

    private fun executeTermuxCommand(command: String) {
        appendOutput("\nüöÄ Command: $command\n")
        appendOutput("‚îÄ".repeat(50) + "\n")

        try {
            // Copy command to clipboard
            val clipboard = getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
            val clip = ClipData.newPlainText("Termux Command", command)
            clipboard.setPrimaryClip(clip)

            appendOutput("‚úÖ Command copied to clipboard!\n")
            appendOutput("üìã Opening Termux - paste with long-press\n")
            appendOutput("üí° Tip: Long-press in Termux ‚Üí Paste\n\n")

            // Open Termux
            val termuxIntent = packageManager.getLaunchIntentForPackage(TERMUX_PACKAGE)
            if (termuxIntent != null) {
                startActivity(termuxIntent)
                Toast.makeText(this, "Command copied! Long-press in Termux to paste", Toast.LENGTH_LONG).show()
            } else {
                appendOutput("‚ùå Termux not installed\n")
                appendOutput("Install from: https://f-droid.org/en/packages/com.termux/\n\n")

                // Offer to open F-Droid
                val browserIntent = Intent(Intent.ACTION_VIEW, Uri.parse("https://f-droid.org/en/packages/com.termux/"))
                startActivity(browserIntent)
            }
        } catch (e: Exception) {
            appendOutput("‚ùå Error: ${e.message}\n\n")
            Toast.makeText(this, "Error: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    private fun openTermux() {
        try {
            val intent = packageManager.getLaunchIntentForPackage(TERMUX_PACKAGE)
            if (intent != null) {
                startActivity(intent)
                appendOutput("‚úÖ Opened Termux\n\n")
            } else {
                appendOutput("‚ùå Termux not installed\n")
                appendOutput("Install from: https://f-droid.org/en/packages/com.termux/\n\n")

                // Offer to open F-Droid or browser
                val browserIntent = Intent(Intent.ACTION_VIEW, Uri.parse("https://f-droid.org/en/packages/com.termux/"))
                startActivity(browserIntent)
            }
        } catch (e: Exception) {
            appendOutput("‚ùå Error: ${e.message}\n\n")
        }
    }

    private fun appendOutput(text: String) {
        runOnUiThread {
            outputTextView.append(text)
            scrollView.post {
                scrollView.fullScroll(ScrollView.FOCUS_DOWN)
            }
        }
    }

    override fun onRequestPermissionsResult(
        requestCode: Int,
        permissions: Array<out String>,
        grantResults: IntArray
    ) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults)
        if (requestCode == PERMISSION_REQUEST_CODE) {
            val allGranted = grantResults.all { it == PackageManager.PERMISSION_GRANTED }
            if (allGranted) {
                Toast.makeText(this, "Permissions granted", Toast.LENGTH_SHORT).show()
            } else {
                Toast.makeText(this, "Some permissions denied. App may not work correctly.", Toast.LENGTH_LONG).show()
            }
        }
    }

    private fun updateDeviceInfo() {
        try {
            val info = StringBuilder()

            // Device Model
            info.append("Device: ${Build.MANUFACTURER} ${Build.MODEL}\n")

            // Android Version
            info.append("Android: ${Build.VERSION.RELEASE} (API ${Build.VERSION.SDK_INT})\n")

            // Get WiFi Info
            val wifiManager = applicationContext.getSystemService(Context.WIFI_SERVICE) as WifiManager
            val wifiInfo = wifiManager.connectionInfo

            if (wifiInfo != null && wifiInfo.ssid != null) {
                val ssid = wifiInfo.ssid.replace("\"", "")
                info.append("WiFi: $ssid\n")

                // Get IP address
                val ipAddress = wifiInfo.ipAddress
                if (ipAddress != 0) {
                    val ip = String.format(
                        "%d.%d.%d.%d",
                        ipAddress and 0xff,
                        ipAddress shr 8 and 0xff,
                        ipAddress shr 16 and 0xff,
                        ipAddress shr 24 and 0xff
                    )
                    info.append("IP: $ip\n")
                }
            } else {
                info.append("WiFi: Not connected\n")
            }

            // Get network interfaces
            val interfaces = NetworkInterface.getNetworkInterfaces()
            if (interfaces != null) {
                for (intf in interfaces) {
                    if (intf.name.startsWith("wlan") || intf.name.startsWith("eth")) {
                        val hwAddr = intf.hardwareAddress
                        if (hwAddr != null && hwAddr.isNotEmpty()) {
                            val mac = hwAddr.joinToString(":") { byte -> "%02X".format(byte) }
                            info.append("MAC (${intf.name}): $mac\n")
                        }
                    }
                }
            }

            deviceInfoText.text = info.toString().trim()
        } catch (e: Exception) {
            deviceInfoText.text = "Error loading device info:\n${e.message}"
        }
    }
}
