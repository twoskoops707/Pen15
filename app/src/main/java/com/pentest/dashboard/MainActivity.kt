package com.pentest.dashboard

import android.Manifest
import android.bluetooth.BluetoothAdapter
import android.bluetooth.BluetoothDevice
import android.bluetooth.BluetoothManager
import android.content.Context
import android.content.Intent
import android.content.pm.PackageManager
import android.net.Uri
import android.os.Build
import android.os.Bundle
import android.view.View
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.core.app.ActivityCompat
import androidx.core.content.ContextCompat
import com.google.android.material.button.MaterialButton
import com.google.android.material.card.MaterialCardView

/**
 * Pen15 Pentesting Dashboard - Main Activity
 * Provides connection management and navigation to all pentesting modules
 */
class MainActivity : AppCompatActivity() {

    // UI Components
    private lateinit var statusIndicator: View
    private lateinit var statusText: TextView
    private lateinit var currentOperation: TextView
    private lateinit var infoPanelTitle: TextView
    private lateinit var infoDisplay: TextView
    private lateinit var btnConnect: MaterialButton

    // Bluetooth & Connection Management
    private var bluetoothAdapter: BluetoothAdapter? = null
    private var isConnected = false
    private val scanResults = StringBuilder()

    companion object {
        private const val PERMISSION_REQUEST_CODE = 1001
        private const val BLUETOOTH_REQUEST_CODE = 1002
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        initializeViews()
        setupBluetoothAdapter()
        setupClickListeners()
        checkPermissions()
        
        // Auto-attempt connection on startup
        android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({
            attemptConnection()
        }, 500)
    }

    /**
     * Initialize all UI components
     */
    private fun initializeViews() {
        statusIndicator = findViewById(R.id.statusIndicator)
        statusText = findViewById(R.id.statusText)
        currentOperation = findViewById(R.id.currentOperation)
        infoPanelTitle = findViewById(R.id.infoPanelTitle)
        infoDisplay = findViewById(R.id.infoDisplay)
        btnConnect = findViewById(R.id.btnConnect)

        // Initialize Flipper connection manager (singleton)
        FlipperConnectionManager.initialize(this)

        updateConnectionStatus(false)
        updateInfoDisplay(
            "SYSTEM READY",
            "Waiting for connection...\n\nSupported connection methods:\n• USB-C cable (Recommended)\n• Bluetooth (Pair first in Android settings)"
        )
    }

    /**
     * Update the info display panel with title and content
     */
    private fun updateInfoDisplay(title: String, content: String) {
        runOnUiThread {
            infoPanelTitle.text = title
            infoDisplay.text = content
        }
    }

    /**
     * Setup Bluetooth adapter
     */
    private fun setupBluetoothAdapter() {
        val bluetoothManager = getSystemService(Context.BLUETOOTH_SERVICE) as BluetoothManager
        bluetoothAdapter = bluetoothManager.adapter
    }

    /**
     * Setup all click listeners for navigation and controls
     */
    private fun setupClickListeners() {
        // Settings button
        findViewById<ImageView>(R.id.btnSettings).setOnClickListener {
            startActivity(Intent(this, SettingsActivity::class.java))
        }

        // Connect/Disconnect button
        btnConnect.setOnClickListener {
            if (isConnected) {
                disconnect()
            } else {
                attemptConnection()
            }
        }

        // Archive button
        findViewById<ImageView>(R.id.btnArchive).setOnClickListener {
            Toast.makeText(this, "Archive - Coming soon", Toast.LENGTH_SHORT).show()
        }

        // FLIPPER MODULES - Navigate to detail screens
        setupModuleClickListener(R.id.cardSubGHz, SubGHzActivity::class.java)
        setupModuleClickListener(R.id.cardRFID, RFIDActivity::class.java)
        setupModuleClickListener(R.id.cardNFC, NFCActivity::class.java)
        setupModuleClickListener(R.id.cardInfrared, InfraredActivity::class.java)
        setupModuleClickListener(R.id.cardGPIO, GPIOActivity::class.java)
        setupModuleClickListener(R.id.cardBadUSB, BadUSBActivity::class.java)
        setupModuleClickListener(R.id.cardIButton, IButtonActivity::class.java)
        setupModuleClickListener(R.id.cardBluetooth, BluetoothActivity::class.java)

        // NETWORK MODULES
        setupModuleClickListener(R.id.cardWiFiDeauth, WiFiDeauthActivity::class.java)
        setupModuleClickListener(R.id.cardWiFiCapture, WiFiCaptureActivity::class.java)
        setupModuleClickListener(R.id.cardNetworkScanner, NetworkScannerActivity::class.java)
        setupModuleClickListener(R.id.cardPacketSniffer, PacketSnifferActivity::class.java)

        // EXPLOITATION MODULES
        setupModuleClickListener(R.id.cardHashCracker, HashCrackerActivity::class.java)
        setupModuleClickListener(R.id.cardPayloadGenerator, PayloadGeneratorActivity::class.java)
        setupModuleClickListener(R.id.cardScriptBuilder, ScriptBuilderActivity::class.java)
        setupModuleClickListener(R.id.cardARPPoisoner, ARPPoisonerActivity::class.java)

        // SPECIALIZED MODULES
        setupModuleClickListener(R.id.cardESP32Manager, ESP32ManagerActivity::class.java)
        setupModuleClickListener(R.id.cardCreditCardReader, CreditCardReaderActivity::class.java)
        setupModuleClickListener(R.id.cardExploitDatabase, ExploitDatabaseActivity::class.java)
    }

    /**
     * Helper function to setup module click listeners with connection check
     */
    private fun setupModuleClickListener(cardId: Int, activityClass: Class<*>) {
        try {
            findViewById<MaterialCardView>(cardId).setOnClickListener {
                if (!isConnected) {
                    Toast.makeText(this, "Connect Flipper Zero first", Toast.LENGTH_SHORT).show()
                    return@setOnClickListener
                }
                startActivity(Intent(this, activityClass))
            }
        } catch (e: Exception) {
            // Card might not exist in layout
        }
    }

    /**
     * Check and request required permissions
     */
    private fun checkPermissions() {
        val permissions = mutableListOf<String>()

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
            if (ContextCompat.checkSelfPermission(this, Manifest.permission.BLUETOOTH_CONNECT)
                != PackageManager.PERMISSION_GRANTED
            ) {
                permissions.add(Manifest.permission.BLUETOOTH_CONNECT)
            }
            if (ContextCompat.checkSelfPermission(this, Manifest.permission.BLUETOOTH_SCAN)
                != PackageManager.PERMISSION_GRANTED
            ) {
                permissions.add(Manifest.permission.BLUETOOTH_SCAN)
            }
        }

        if (permissions.isNotEmpty()) {
            ActivityCompat.requestPermissions(this, permissions.toTypedArray(), PERMISSION_REQUEST_CODE)
        }
    }

    /**
     * Attempt connection to Flipper Zero (USB first, then Bluetooth)
     */
    private fun attemptConnection() {
        scanResults.clear()
        updateInfoDisplay("SYSTEM SCAN", "Scanning for Flipper Zero...")
        currentOperation.text = "Scanning for Flipper Zero..."
        statusText.text = "SEARCHING..."

        scanResults.append("═══════════════════════════════════\n")
        scanResults.append("  FLIPPER ZERO CONNECTION SCANNER\n")
        scanResults.append("═══════════════════════════════════\n\n")
        scanResults.append("[*] Starting USB scan...\n")
        updateInfoDisplay("SYSTEM SCAN", scanResults.toString())

        // Try USB first
        FlipperConnectionManager.usbManager?.setConnectionListener { success, message ->
            runOnUiThread {
                if (success) {
                    scanResults.append("[✓] USB Connection: SUCCESS\n")
                    scanResults.append("[✓] Device: Flipper Zero\n")
                    scanResults.append("[✓] VID:PID: 0x0483:0x5740\n")
                    scanResults.append("[✓] Status: CONNECTED\n\n")
                    updateInfoDisplay("USB CONNECTION ESTABLISHED", scanResults.toString())

                    FlipperConnectionManager.setConnectionType("usb")
                    updateConnectionStatus(true)
                    statusText.text = "CONNECTED • USB-C"
                    currentOperation.text = "Connected via USB-C"
                    Toast.makeText(this, "✓ Connected via USB-C!", Toast.LENGTH_LONG).show()
                } else {
                    scanResults.append("[✗] USB Connection: FAILED\n")
                    scanResults.append("[!] Reason: $message\n")
                    scanResults.append("[*] Attempting Bluetooth connection...\n\n")
                    updateInfoDisplay("USB FAILED - TRYING BLUETOOTH", scanResults.toString())

                    statusText.text = "USB FAILED - TRYING BT"
                    currentOperation.text = "USB failed, switching to Bluetooth..."

                    // Try Bluetooth after showing USB error
                    android.os.Handler(android.os.Looper.getMainLooper()).postDelayed({
                        attemptBluetoothConnection()
                    }, 1500)
                }
            }
        }

        // Connect
        FlipperConnectionManager.usbManager?.connect()
    }

    /**
     * Attempt Bluetooth connection to Flipper Zero
     */
    private fun attemptBluetoothConnection() {
        scanResults.append("[*] Starting Bluetooth scan...\n\n")
        updateInfoDisplay("BLUETOOTH SCANNER", scanResults.toString())
        currentOperation.text = "Scanning Bluetooth devices..."
        statusText.text = "SCANNING BT..."

        if (bluetoothAdapter == null) {
            scanResults.append("[✗] Bluetooth adapter not found\n")
            scanResults.append("[!] Device may not support Bluetooth\n\n")
            updateInfoDisplay("SCAN FAILED", scanResults.toString())
            updateConnectionStatus(false)
            return
        }

        if (!bluetoothAdapter!!.isEnabled) {
            scanResults.append("[!] Bluetooth is disabled\n")
            scanResults.append("[*] Requesting Bluetooth enable...\n\n")
            updateInfoDisplay("BLUETOOTH STATUS", scanResults.toString())

            val enableBtIntent = Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE)
            startActivityForResult(enableBtIntent, BLUETOOTH_REQUEST_CODE)
            return
        }

        // Scan for paired Flipper devices
        try {
            if (ActivityCompat.checkSelfPermission(
                    this,
                    Manifest.permission.BLUETOOTH_CONNECT
                ) != PackageManager.PERMISSION_GRANTED
            ) {
                scanResults.append("[✗] Missing permission: BLUETOOTH_CONNECT\n\n")
                updateInfoDisplay("PERMISSION ERROR", scanResults.toString())
                updateConnectionStatus(false)
                return
            }

            val pairedDevices = bluetoothAdapter!!.bondedDevices
            scanResults.append("[*] Found ${pairedDevices.size} paired devices:\n\n")

            var deviceNumber = 1
            var flipperDevice: BluetoothDevice? = null

            for (device in pairedDevices) {
                val deviceName = device.name ?: "Unknown"
                val deviceAddress = device.address
                val deviceType = when (device.type) {
                    BluetoothDevice.DEVICE_TYPE_CLASSIC -> "Classic"
                    BluetoothDevice.DEVICE_TYPE_LE -> "BLE"
                    BluetoothDevice.DEVICE_TYPE_DUAL -> "Dual"
                    else -> "Unknown"
                }

                scanResults.append("  [$deviceNumber] $deviceName\n")
                scanResults.append("      MAC: $deviceAddress\n")
                scanResults.append("      Type: $deviceType\n")

                if (device.name?.contains("Flipper", ignoreCase = true) == true) {
                    flipperDevice = device
                    scanResults.append("      >>> FLIPPER ZERO DETECTED <<<\n")
                    statusText.text = "FOUND: ${device.name}"
                }
                scanResults.append("\n")
                deviceNumber++
            }

            updateInfoDisplay("BLUETOOTH SCAN RESULTS", scanResults.toString())

            if (flipperDevice != null) {
                scanResults.append("\n[*] Connecting to Flipper Zero...\n")
                updateInfoDisplay("BLUETOOTH CONNECTION", scanResults.toString())

                // Connect via Bluetooth
                FlipperConnectionManager.bluetoothManager?.connect(flipperDevice) { success, message ->
                    runOnUiThread {
                        if (success) {
                            scanResults.append("[✓] Connection: ESTABLISHED\n")
                            scanResults.append("[✓] Protocol: BLE GATT\n")
                            scanResults.append("[✓] Status: READY\n")
                            updateInfoDisplay("CONNECTED VIA BLUETOOTH", scanResults.toString())

                            FlipperConnectionManager.setConnectionType("bluetooth")
                            updateConnectionStatus(true)
                            statusText.text = "CONNECTED • BLUETOOTH"
                            currentOperation.text = "Connected via Bluetooth"
                        } else {
                            scanResults.append("\n[✗] Connection: FAILED\n")
                            scanResults.append("[!] Error: $message\n")
                            updateInfoDisplay("CONNECTION FAILED", scanResults.toString())

                            statusText.text = "BT FAILED"
                            currentOperation.text = "Connection failed"
                            updateConnectionStatus(false)
                        }
                    }
                }
            } else {
                scanResults.append("\n[✗] NO FLIPPER ZERO FOUND\n\n")
                scanResults.append("To connect:\n")
                scanResults.append("1. Turn on your Flipper Zero\n")
                scanResults.append("2. Go to Android Settings\n")
                scanResults.append("3. Bluetooth → Pair new device\n")
                scanResults.append("4. Select 'Flipper <name>'\n")
                scanResults.append("5. Return here and try again\n")
                updateInfoDisplay("NO FLIPPER DETECTED", scanResults.toString())

                statusText.text = "NO FLIPPER FOUND"
                currentOperation.text = "Pair Flipper in Android settings"
                updateConnectionStatus(false)
            }
        } catch (e: Exception) {
            scanResults.append("\n[✗] SCAN ERROR\n")
            scanResults.append("[!] Exception: ${e.message}\n")
            updateInfoDisplay("SCAN ERROR", scanResults.toString())

            updateConnectionStatus(false)
            statusText.text = "SCAN FAILED"
            currentOperation.text = "Error: ${e.message}"
        }
    }

    /**
     * Disconnect from Flipper Zero
     */
    private fun disconnect() {
        FlipperConnectionManager.disconnect()
        updateConnectionStatus(false)
        Toast.makeText(this, "Disconnected from Flipper Zero", Toast.LENGTH_SHORT).show()
    }

    /**
     * Update connection status UI
     */
    private fun updateConnectionStatus(connected: Boolean) {
        isConnected = connected

        if (connected) {
            statusIndicator.backgroundTintList =
                ContextCompat.getColorStateList(this, R.color.status_connected)
            statusText.text = "CONNECTED • FLIPPER ZERO"
            btnConnect.text = "[DISCONNECT]"
            btnConnect.backgroundTintList =
                ContextCompat.getColorStateList(this, R.color.status_disconnected)
        } else {
            statusIndicator.backgroundTintList =
                ContextCompat.getColorStateList(this, R.color.status_disconnected)
            statusText.text = "DISCONNECTED"
            btnConnect.text = "[CONNECT]"
            btnConnect.backgroundTintList =
                ContextCompat.getColorStateList(this, R.color.electric_blue)
        }
    }

    override fun onRequestPermissionsResult(
        requestCode: Int,
        permissions: Array<out String>,
        grantResults: IntArray
    ) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults)

        if (requestCode == PERMISSION_REQUEST_CODE) {
            if (grantResults.isNotEmpty() && grantResults.all { it == PackageManager.PERMISSION_GRANTED }) {
                Toast.makeText(this, "Permissions granted", Toast.LENGTH_SHORT).show()
            } else {
                Toast.makeText(this, "Bluetooth permissions required", Toast.LENGTH_LONG).show()
            }
        }
    }

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)

        if (requestCode == BLUETOOTH_REQUEST_CODE) {
            if (resultCode == RESULT_OK) {
                attemptConnection()
            } else {
                Toast.makeText(this, "Bluetooth must be enabled", Toast.LENGTH_SHORT).show()
            }
        }
    }

    override fun onDestroy() {
        super.onDestroy()
        FlipperConnectionManager.cleanup()
    }
}
