package com.pentest.dashboard

import android.app.PendingIntent
import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import android.content.IntentFilter
import android.hardware.usb.UsbDevice
import android.hardware.usb.UsbDeviceConnection
import android.hardware.usb.UsbManager
import android.os.Handler
import android.os.Looper
import android.util.Log
import com.hoho.android.usbserial.driver.UsbSerialDriver
import com.hoho.android.usbserial.driver.UsbSerialPort
import com.hoho.android.usbserial.driver.UsbSerialProber
import java.io.IOException

/**
 * Flipper Zero USB Serial Communication Manager
 *
 * Handles USB serial communication with Flipper Zero via USB-C cable.
 * More reliable and faster than Bluetooth.
 *
 * Flipper Zero USB Details:
 * - Vendor ID: 0x0483 (STMicroelectronics)
 * - Product ID: 0x5740 (Virtual COM Port)
 * - Baud Rate: 115200
 * - Data Bits: 8
 * - Stop Bits: 1
 * - Parity: None
 */
class FlipperUSBManager(private val context: Context) {

    companion object {
        private const val TAG = "FlipperUSB"
        private const val ACTION_USB_PERMISSION = "com.pentest.dashboard.USB_PERMISSION"

        // Flipper Zero USB identifiers
        private const val FLIPPER_VENDOR_ID = 0x0483
        private const val FLIPPER_PRODUCT_ID = 0x5740

        // Serial settings
        private const val BAUD_RATE = 115200
        private const val DATA_BITS = 8
        private const val STOP_BITS = UsbSerialPort.STOPBITS_1
        private const val PARITY = UsbSerialPort.PARITY_NONE
    }

    private val usbManager: UsbManager = context.getSystemService(Context.USB_SERVICE) as UsbManager
    private val handler = Handler(Looper.getMainLooper())

    private var serialPort: UsbSerialPort? = null
    private var usbConnection: UsbDeviceConnection? = null
    private var readingThread: Thread? = null
    @Volatile private var shouldContinueReading = false

    private var connectionCallback: ((Boolean, String) -> Unit)? = null
    private var dataReceivedCallback: ((String) -> Unit)? = null

    private val usbPermissionReceiver = object : BroadcastReceiver() {
        override fun onReceive(context: Context, intent: Intent) {
            if (ACTION_USB_PERMISSION == intent.action) {
                synchronized(this) {
                    val device: UsbDevice? = if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.TIRAMISU) {
                        intent.getParcelableExtra(UsbManager.EXTRA_DEVICE, UsbDevice::class.java)
                    } else {
                        @Suppress("DEPRECATION")
                        intent.getParcelableExtra(UsbManager.EXTRA_DEVICE)
                    }

                    if (intent.getBooleanExtra(UsbManager.EXTRA_PERMISSION_GRANTED, false)) {
                        device?.let {
                            try {
                                connectToDevice(it)
                            } catch (e: Exception) {
                                Log.e(TAG, "Error connecting to device", e)
                                handler.post {
                                    connectionCallback?.invoke(false, "Connection error: ${e.message}")
                                }
                            }
                        }
                    } else {
                        Log.d(TAG, "USB permission denied")
                        handler.post {
                            connectionCallback?.invoke(false, "USB permission denied")
                        }
                    }
                }
            }
        }
    }

    init {
        val filter = IntentFilter(ACTION_USB_PERMISSION)
        context.registerReceiver(usbPermissionReceiver, filter)
    }

    /**
     * Detect and connect to Flipper Zero via USB
     */
    fun connect(callback: (Boolean, String) -> Unit) {
        connectionCallback = callback

        val flipperDevice = findFlipperDevice()
        if (flipperDevice == null) {
            handler.post {
                callback(false, "Flipper Zero not found. Connect via USB-C cable.")
            }
            return
        }

        // Check if we have permission
        if (usbManager.hasPermission(flipperDevice)) {
            connectToDevice(flipperDevice)
        } else {
            // Request permission
            val permissionIntent = PendingIntent.getBroadcast(
                context,
                0,
                Intent(ACTION_USB_PERMISSION),
                PendingIntent.FLAG_IMMUTABLE
            )
            usbManager.requestPermission(flipperDevice, permissionIntent)
        }
    }

    /**
     * Find Flipper Zero USB device
     */
    private fun findFlipperDevice(): UsbDevice? {
        val deviceList = usbManager.deviceList

        // Log ALL USB devices for debugging
        Log.d(TAG, "=== USB DEVICE SCAN ===")
        Log.d(TAG, "Total USB devices found: ${deviceList.size}")

        if (deviceList.isEmpty()) {
            Log.d(TAG, "NO USB DEVICES FOUND!")
            Log.d(TAG, "Make sure:")
            Log.d(TAG, "1. Flipper is connected via USB-C cable")
            Log.d(TAG, "2. USB debugging is enabled")
            Log.d(TAG, "3. You granted USB permissions")
            return null
        }

        for ((_, device) in deviceList) {
            val vid = String.format("0x%04X", device.vendorId)
            val pid = String.format("0x%04X", device.productId)
            val name = device.productName ?: "Unknown"
            val mfg = device.manufacturerName ?: "Unknown"

            Log.d(TAG, "Device: $name")
            Log.d(TAG, "  Manufacturer: $mfg")
            Log.d(TAG, "  VID: $vid (need: 0x0483)")
            Log.d(TAG, "  PID: $pid (need: 0x5740)")
            Log.d(TAG, "  DeviceClass: ${device.deviceClass}")
            Log.d(TAG, "  InterfaceCount: ${device.interfaceCount}")
            Log.d(TAG, "")

            if (device.vendorId == FLIPPER_VENDOR_ID && device.productId == FLIPPER_PRODUCT_ID) {
                Log.d(TAG, "✓ FLIPPER ZERO FOUND!")
                return device
            }
        }

        Log.d(TAG, "✗ Flipper Zero NOT found in USB devices")
        Log.d(TAG, "Expected: VID=0x0483, PID=0x5740")
        return null
    }

    /**
     * Connect to the USB device and open serial port
     */
    private fun connectToDevice(device: UsbDevice) {
        try {
            // Find USB serial driver
            val drivers = UsbSerialProber.getDefaultProber().findAllDrivers(usbManager)
            if (drivers.isEmpty()) {
                Log.e(TAG, "No USB serial driver found")
                handler.post {
                    connectionCallback?.invoke(false, "USB driver not found")
                }
                return
            }

            val driver = drivers[0]
            usbConnection = usbManager.openDevice(driver.device)
            if (usbConnection == null) {
                Log.e(TAG, "Failed to open USB connection")
                handler.post {
                    connectionCallback?.invoke(false, "Failed to open USB connection")
                }
                return
            }

            // Open serial port
            serialPort = driver.ports[0]
            serialPort?.open(usbConnection)
            serialPort?.setParameters(BAUD_RATE, DATA_BITS, STOP_BITS, PARITY)

            Log.d(TAG, "USB serial port opened successfully")
            handler.post {
                connectionCallback?.invoke(true, "Connected via USB-C")
            }

            // Start reading data
            startReading()

        } catch (e: IOException) {
            Log.e(TAG, "Error opening serial port", e)
            handler.post {
                connectionCallback?.invoke(false, "Error: ${e.message}")
            }
        }
    }

    /**
     * Start reading data from serial port
     */
    private fun startReading() {
        shouldContinueReading = true
        readingThread = Thread {
            val buffer = ByteArray(1024)
            while (shouldContinueReading && serialPort != null) {
                try {
                    val numBytes = serialPort?.read(buffer, 1000) ?: 0
                    if (numBytes > 0) {
                        val data = String(buffer, 0, numBytes)
                        Log.d(TAG, "Received: $data")
                        handler.post {
                            dataReceivedCallback?.invoke(data)
                        }
                    }
                } catch (e: IOException) {
                    Log.e(TAG, "Error reading from serial port", e)
                    break
                }
            }
            Log.d(TAG, "Reading thread stopped")
        }.apply {
            name = "FlipperUSB-Reader"
            start()
        }
    }

    /**
     * Send command to Flipper Zero via USB
     */
    fun sendCommand(command: String): Boolean {
        try {
            // Ensure command ends with \r\n for proper parsing
            val cmd = if (!command.endsWith("\r\n") && !command.endsWith("\n")) {
                "$command\r\n"
            } else {
                command
            }
            val data = cmd.toByteArray()
            serialPort?.write(data, 1000)
            Log.d(TAG, "Sent command: $cmd")
            return true
        } catch (e: IOException) {
            Log.e(TAG, "Error sending command", e)
            return false
        }
    }

    /**
     * Set callback for receiving data from Flipper
     */
    fun setDataReceivedCallback(callback: (String) -> Unit) {
        dataReceivedCallback = callback
    }

    /**
     * Disconnect from Flipper Zero
     */
    fun disconnect() {
        // Stop reading thread first
        shouldContinueReading = false
        try {
            readingThread?.join(2000) // Wait max 2 seconds for thread to finish
        } catch (e: InterruptedException) {
            Thread.currentThread().interrupt()
            Log.w(TAG, "Interrupted while waiting for reading thread")
        }

        // Close connections
        try {
            serialPort?.close()
            usbConnection?.close()
            serialPort = null
            usbConnection = null
            readingThread = null
            Log.d(TAG, "Disconnected from Flipper Zero")
        } catch (e: IOException) {
            Log.e(TAG, "Error disconnecting", e)
        }
    }

    /**
     * Check if Flipper Zero is connected via USB
     */
    fun isConnected(): Boolean {
        return serialPort != null
    }

    /**
     * Clean up resources
     */
    fun cleanup() {
        disconnect()
        try {
            context.unregisterReceiver(usbPermissionReceiver)
        } catch (e: Exception) {
            // Receiver may not be registered
        }
    }
}
