package com.pentest.dashboard

import android.bluetooth.BluetoothAdapter
import android.bluetooth.BluetoothManager
import android.content.Context
import android.content.SharedPreferences
import android.os.Handler
import android.os.Looper
import android.util.Log

/**
 * Helper class to automatically connect to Flipper Zero via USB or Bluetooth
 * Tries USB first, then falls back to Bluetooth
 */
object ConnectionHelper {

    private const val TAG = "ConnectionHelper"

    /**
     * Attempt to connect to Flipper Zero automatically
     * Returns connection status via callback: (success: Boolean, message: String, type: String)
     */
    fun autoConnect(context: Context, callback: (Boolean, String, String) -> Unit) {
        FlipperConnectionManager.initialize(context)

        // Try USB first
        tryUSBConnection(context) { usbSuccess, usbMessage ->
            if (usbSuccess) {
                FlipperConnectionManager.setConnectionType("usb")
                callback(true, "Connected via USB", "usb")
            } else {
                Log.d(TAG, "USB failed: $usbMessage - trying Bluetooth...")
                // USB failed, try Bluetooth
                tryBluetoothConnection(context) { btSuccess, btMessage ->
                    if (btSuccess) {
                        FlipperConnectionManager.setConnectionType("bluetooth")
                        callback(true, "Connected via Bluetooth", "bluetooth")
                    } else {
                        callback(false, "No Flipper found (USB: $usbMessage, BT: $btMessage)", "none")
                    }
                }
            }
        }
    }

    private fun tryUSBConnection(context: Context, callback: (Boolean, String) -> Unit) {
        val usbManager = FlipperConnectionManager.usbManager

        if (usbManager == null) {
            callback(false, "USB manager not initialized")
            return
        }

        // Set connection listener
        usbManager.setConnectionListener { success, message ->
            callback(success, message)
        }

        // Attempt connection
        usbManager.connect()

        // Timeout after 3 seconds if no response
        Handler(Looper.getMainLooper()).postDelayed({
            if (!usbManager.isConnected()) {
                callback(false, "USB connection timeout")
            }
        }, 3000)
    }

    private fun tryBluetoothConnection(context: Context, callback: (Boolean, String) -> Unit) {
        try {
            val bluetoothManager = context.getSystemService(Context.BLUETOOTH_SERVICE) as? BluetoothManager
            val bluetoothAdapter = bluetoothManager?.adapter

            if (bluetoothAdapter == null || !bluetoothAdapter.isEnabled) {
                callback(false, "Bluetooth disabled or unavailable")
                return
            }

            // Get paired devices
            val pairedDevices = bluetoothAdapter.bondedDevices
            if (pairedDevices.isEmpty()) {
                callback(false, "No paired Bluetooth devices")
                return
            }

            // Find Flipper device (name contains "Flipper")
            val flipperDevice = pairedDevices.find { device ->
                device.name?.contains("Flipper", ignoreCase = true) == true
            }

            if (flipperDevice == null) {
                callback(false, "No Flipper device found in paired devices")
                return
            }

            Log.d(TAG, "Found Flipper device: ${flipperDevice.name}")

            // Connect to Flipper
            val btManager = FlipperConnectionManager.bluetoothManager
            if (btManager == null) {
                callback(false, "Bluetooth manager not initialized")
                return
            }

            btManager.connect(flipperDevice) { success, message ->
                callback(success, message)
            }

            // Timeout after 5 seconds if no response
            Handler(Looper.getMainLooper()).postDelayed({
                if (!FlipperConnectionManager.isConnected()) {
                    callback(false, "Bluetooth connection timeout")
                }
            }, 5000)

        } catch (e: Exception) {
            Log.e(TAG, "Bluetooth connection error", e)
            callback(false, "Error: ${e.message}")
        }
    }

    /**
     * Quick check if Flipper is currently connected
     */
    fun isConnected(): Boolean {
        return FlipperConnectionManager.isConnected()
    }

    /**
     * Get current connection type
     */
    fun getConnectionType(): String {
        return FlipperConnectionManager.connectionType
    }

    /**
     * Disconnect from Flipper
     */
    fun disconnect() {
        FlipperConnectionManager.disconnect()
    }
}
