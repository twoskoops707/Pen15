package com.pentest.dashboard

import android.content.Context
import android.os.Handler
import android.os.Looper
import android.widget.ScrollView
import android.widget.TextView

/**
 * Universal output monitoring for ALL activities
 * Shows REAL command output from Termux in the app
 */
class OutputMonitor(
    private val context: Context,
    private val outputTextView: TextView,
    private val scrollView: ScrollView? = null
) {
    private val handler = Handler(Looper.getMainLooper())
    private var isMonitoring = false
    private var onComplete: (() -> Unit)? = null

    /**
     * Start monitoring process output
     * Updates TextView every second with real output from commands
     */
    fun startMonitoring(onProcessComplete: (() -> Unit)? = null) {
        isMonitoring = true
        onComplete = onProcessComplete

        val monitorRunnable = object : Runnable {
            override fun run() {
                if (!isMonitoring) return

                // Read real output from ProcessManager
                val outputFile = ProcessManager.getOutputFile(context)
                if (outputFile?.exists() == true) {
                    val output = outputFile.readText()

                    // Update UI on main thread
                    if (context is android.app.Activity) {
                        context.runOnUiThread {
                            outputTextView.text = output
                            scrollView?.post {
                                scrollView.fullScroll(ScrollView.FOCUS_DOWN)
                            }
                        }
                    }
                }

                // Check if process finished
                if (!ProcessManager.isProcessRunning(context)) {
                    isMonitoring = false
                    onComplete?.invoke()
                    return
                }

                // Update every second
                handler.postDelayed(this, 1000)
            }
        }

        handler.post(monitorRunnable)
    }

    /**
     * Stop monitoring
     */
    fun stopMonitoring() {
        isMonitoring = false
        handler.removeCallbacksAndMessages(null)
    }

    /**
     * Check if currently monitoring
     */
    fun isMonitoring() = isMonitoring
}
