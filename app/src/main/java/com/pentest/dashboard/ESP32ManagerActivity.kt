package com.pentest.dashboard

import android.os.Bundle
import android.widget.ArrayAdapter
import android.widget.ImageView
import android.widget.ListView
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class ESP32ManagerActivity : AppCompatActivity() {

    private lateinit var logOutput: TextView
    private lateinit var btnConnect: MaterialButton
    private lateinit var btnScanNetworks: MaterialButton
    private lateinit var btnCreateAP: MaterialButton
    private lateinit var btnDeauth: MaterialButton
    private lateinit var btnSniff: MaterialButton
    private lateinit var btnBleScan: MaterialButton

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_esp32_manager)

        initializeViews()
        setupClickListeners()
    }

    private fun initializeViews() {
        logOutput = findViewById(R.id.logOutput)
        btnConnect = findViewById(R.id.btnConnect)
        btnScanNetworks = findViewById(R.id.btnScanNetworks)
        btnCreateAP = findViewById(R.id.btnCreateAP)
        btnDeauth = findViewById(R.id.btnDeauth)
        btnSniff = findViewById(R.id.btnSniff)
        btnBleScan = findViewById(R.id.btnBleScan)

        addLog("ESP32/AWOK Mini v3 Manager")
        addLog("Supports: WiFi Deauth, Evil Twin, Packet Sniffing, BLE Attacks")
        addLog("")
        addLog("Ready to connect...")
    }

    private fun setupClickListeners() {
        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnConnect.setOnClickListener {
            connectESP32()
        }

        btnScanNetworks.setOnClickListener {
            scanNetworks()
        }

        btnCreateAP.setOnClickListener {
            createEvilTwin()
        }

        btnDeauth.setOnClickListener {
            launchDeauth()
        }

        btnSniff.setOnClickListener {
            startSniffing()
        }

        btnBleScan.setOnClickListener {
            scanBLE()
        }
    }

    private fun connectESP32() {
        addLog("=== CONNECTING TO ESP32 ===")
        addLog("Searching for AWOK devices...")
        addLog("")
        addLog("Detection methods:")
        addLog("1. USB Serial (Flipper Zero with ESP32 board)")
        addLog("2. WiFi (ESP32 in AP mode)")
        addLog("3. Bluetooth (ESP32 BLE)")
        addLog("")
        addLog("Command to flash ESP32 Marauder:")
        addLog("esptool.py --port /dev/ttyUSB0 write_flash 0x0 esp32_marauder.bin")
    }

    private fun scanNetworks() {
        addLog("")
        addLog("=== WIFI SCAN (ESP32) ===")
        addLog("")
        addLog("Sending scan command to ESP32...")
        addLog("Command: scan -t ap")
        addLog("")
        addLog("ESP32 will scan for:")
        addLog("- Access Points (2.4GHz)")
        addLog("- Hidden SSIDs")
        addLog("- Channel info")
        addLog("- Signal strength")
        addLog("- Encryption type")
        addLog("")
        addLog("Results will appear in 5-10 seconds")
    }

    private fun createEvilTwin() {
        addLog("")
        addLog("=== EVIL TWIN AP (ESP32) ===")
        addLog("")
        addLog("Creating fake access point...")
        addLog("SSID: Free-WiFi")
        addLog("Channel: 6")
        addLog("Auth: OPEN")
        addLog("")
        addLog("Command: ap -s \"Free-WiFi\" -c 6")
        addLog("")
        addLog("Captive portal: ACTIVE")
        addLog("Credential harvesting: ENABLED")
        addLog("")
        addLog("Victims will see:")
        addLog("1. Open WiFi network")
        addLog("2. Captive portal login page")
        addLog("3. Fake authentication form")
        addLog("")
        addLog("Captured credentials saved to:")
        addLog("/sdcard/Download/esp32_creds.txt")
    }

    private fun launchDeauth() {
        addLog("")
        addLog("=== DEAUTH ATTACK (ESP32) ===")
        addLog("")
        addLog("Starting deauth flood...")
        addLog("Command: attack -t deauth -a")
        addLog("")
        addLog("Targeting ALL networks in range")
        addLog("Sending deauth frames continuously")
        addLog("")
        addLog("Effects:")
        addLog("- Clients disconnected from APs")
        addLog("- WPA handshakes captured")
        addLog("- Network disruption")
        addLog("")
        addLog("Press STOP to end attack")
        addLog("")
        addLog("WARNING: Highly detectable! Use responsibly.")
    }

    private fun startSniffing() {
        addLog("")
        addLog("=== PACKET SNIFFING (ESP32) ===")
        addLog("")
        addLog("Starting promiscuous mode...")
        addLog("Command: sniff -c 6")
        addLog("")
        addLog("Capturing:")
        addLog("- Probe requests")
        addLog("- Beacons")
        addLog("- Data frames")
        addLog("- Management frames")
        addLog("")
        addLog("Extracting:")
        addLog("- Device MAC addresses")
        addLog("- SSIDs")
        addLog("- Vendor info")
        addLog("- Signal strength")
        addLog("")
        addLog("Saving to: /sdcard/Download/esp32_capture.pcap")
    }

    private fun scanBLE() {
        addLog("")
        addLog("=== BLE SCAN (ESP32) ===")
        addLog("")
        addLog("Scanning for Bluetooth devices...")
        addLog("Command: ble scan")
        addLog("")
        addLog("Detecting:")
        addLog("- BLE devices")
        addLog("- Classic Bluetooth")
        addLog("- Device names")
        addLog("- MAC addresses")
        addLog("- RSSI values")
        addLog("- Services/UUIDs")
        addLog("")
        addLog("Scan duration: 30 seconds")
        addLog("")
        addLog("Attacks available:")
        addLog("- BLE spam")
        addLog("- Apple BLE spam")
        addLog("- Samsung BLE spam")
        addLog("- Windows Swift Pair spam")
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = logOutput.text.toString()
        logOutput.text = "[$timestamp] $message\n$currentLog"
    }
}
