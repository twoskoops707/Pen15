package com.pentest.dashboard

import android.os.Bundle
import android.widget.ArrayAdapter
import android.widget.ImageView
import android.widget.ListView
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton

class ESP32ManagerActivity : AppCompatActivity() {

    private lateinit var logOutput: TextView
    private lateinit var btnConnect: MaterialButton
    private lateinit var btnScanNetworks: MaterialButton
    private lateinit var btnCreateAP: MaterialButton
    private lateinit var btnDeauth: MaterialButton
    private lateinit var btnSniff: MaterialButton
    private lateinit var btnBleScan: MaterialButton
    private lateinit var btnStop: MaterialButton

    private var isConnected = false
    private var devicePort = "/dev/ttyUSB0" // AWOK Mini V3 default

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_esp32_manager)

        // Stop any running processes from other activities
        ProcessManager.stopCurrentProcess(this)

        initializeViews()
        setupClickListeners()
    }

    private fun initializeViews() {
        logOutput = findViewById(R.id.logOutput)
        btnConnect = findViewById(R.id.btnConnect)
        btnScanNetworks = findViewById(R.id.btnScanNetworks)
        btnCreateAP = findViewById(R.id.btnCreateAP)
        btnDeauth = findViewById(R.id.btnDeauth)
        btnSniff = findViewById(R.id.btnSniff)
        btnBleScan = findViewById(R.id.btnBleScan)
        btnStop = findViewById(R.id.btnStop)

        btnStop.setOnClickListener {
            stopAllProcesses()
        }

        addLog("=== AWOK Mini V3 / ESP32 Marauder Manager ===")
        addLog("")
        addLog("This controls your ESP32 Marauder device")
        addLog("(AWOK Mini V3 or similar ESP32 WiFi/BLE hacking board)")
        addLog("")
        addLog("Connection: USB Serial (/dev/ttyUSB0)")
        addLog("OR via Flipper Zero GPIO (forwarded to /dev/ttyACM0)")
        addLog("")
        addLog("Click CONNECT to detect device...")
    }

    private fun setupClickListeners() {
        findViewById<ImageView>(R.id.btnBack).setOnClickListener {
            stopAllProcesses()
            finish()
        }

        btnConnect.setOnClickListener {
            connectESP32()
        }

        btnScanNetworks.setOnClickListener {
            scanNetworks()
        }

        btnCreateAP.setOnClickListener {
            createEvilTwin()
        }

        btnDeauth.setOnClickListener {
            launchDeauth()
        }

        btnSniff.setOnClickListener {
            startSniffing()
        }

        btnBleScan.setOnClickListener {
            scanBLE()
        }
    }

    private fun connectESP32() {
        addLog("")
        addLog("=== DETECTING ESP32 DEVICE ===")
        addLog("Searching USB serial ports...")

        // Create detection script
        val detectScript = """
            #!/data/data/com.termux/files/usr/bin/bash

            echo "=== ESP32 / AWOK Mini V3 Detection ==="
            echo ""

            # Check for USB serial devices
            for dev in /dev/ttyUSB0 /dev/ttyUSB1 /dev/ttyACM0; do
                if [ -e "${'$'}dev" ]; then
                    echo "âœ“ Found device: ${'$'}dev"

                    # Try to send test command
                    echo "help" > ${'$'}dev 2>/dev/null && echo "  Device responding!" || echo "  No response"
                fi
            done

            echo ""
            echo "If no devices found:"
            echo "1. Connect AWOK Mini V3 via USB"
            echo "2. OR connect to Flipper GPIO"
            echo "3. Grant USB permissions in Android settings"
        """.trimIndent()

        val termux = TermuxIntegration(this)
        termux.runCommand(detectScript, background = false)

        addLog("Check Termux output for detected devices")
        addLog("")
        addLog("Once connected, you can use:")
        addLog("- WiFi scanning & deauth")
        addLog("- Evil Twin attacks")
        addLog("- BLE scanning & spam")
        addLog("- Packet sniffing")
    }

    private fun scanNetworks() {
        addLog("")
        addLog("=== WiFi SCAN (ESP32 Marauder) ===")

        val scanScript = """
            #!/data/data/com.termux/files/usr/bin/bash

            echo "=== ESP32 WiFi Scan ==="
            echo ""

            # Find ESP32 device
            DEVICE=""
            for dev in /dev/ttyUSB0 /dev/ttyUSB1 /dev/ttyACM0; do
                if [ -e "${'$'}dev" ]; then
                    DEVICE="${'$'}dev"
                    echo "Using device: ${'$'}dev"
                    break
                fi
            done

            if [ -z "${'$'}DEVICE" ]; then
                echo "ERROR: No ESP32 device found!"
                echo "Connect AWOK Mini V3 or ESP32 via USB"
                exit 1
            fi

            # Send scan command to ESP32 Marauder
            echo ""
            echo "Sending command: scan -t ap"
            echo "scan -t ap" > ${'$'}DEVICE

            # Wait for results
            echo ""
            echo "Scanning WiFi networks (2.4GHz)..."
            echo "This will show:"
            echo "- SSIDs"
            echo "- BSSIDs (MAC addresses)"
            echo "- Channels"
            echo "- Signal strength (RSSI)"
            echo "- Encryption type"
            echo ""
            echo "Results will appear on ESP32 screen"
            echo "OR via serial monitor if connected"

            # Read response (if available)
            timeout 10 cat ${'$'}DEVICE 2>/dev/null || echo "Check ESP32 screen for results"
        """.trimIndent()

        val processId = ProcessManager.startProcess(this, scanScript)
        val scriptFile = java.io.File(getExternalFilesDir(null), "scripts/script_$processId.sh")

        val termux = TermuxIntegration(this)
        termux.runCommand("bash ${scriptFile.absolutePath}", background = false)

        addLog("WiFi scan command sent to ESP32")
        addLog("Check Termux for results...")
    }

    private fun createEvilTwin() {
        addLog("")
        addLog("=== EVIL TWIN AP (ESP32) ===")
        addLog("")
        addLog("Creating fake access point...")
        addLog("SSID: Free-WiFi")
        addLog("Channel: 6")
        addLog("Auth: OPEN")
        addLog("")
        addLog("Command: ap -s \"Free-WiFi\" -c 6")
        addLog("")
        addLog("Captive portal: ACTIVE")
        addLog("Credential harvesting: ENABLED")
        addLog("")
        addLog("Victims will see:")
        addLog("1. Open WiFi network")
        addLog("2. Captive portal login page")
        addLog("3. Fake authentication form")
        addLog("")
        addLog("Captured credentials saved to:")
        addLog("/sdcard/Download/esp32_creds.txt")
    }

    private fun launchDeauth() {
        addLog("")
        addLog("=== DEAUTH ATTACK (ESP32) ===")
        addLog("")
        addLog("Starting deauth flood...")
        addLog("Command: attack -t deauth -a")
        addLog("")
        addLog("Targeting ALL networks in range")
        addLog("Sending deauth frames continuously")
        addLog("")
        addLog("Effects:")
        addLog("- Clients disconnected from APs")
        addLog("- WPA handshakes captured")
        addLog("- Network disruption")
        addLog("")
        addLog("Press STOP to end attack")
        addLog("")
        addLog("WARNING: Highly detectable! Use responsibly.")
    }

    private fun startSniffing() {
        addLog("")
        addLog("=== PACKET SNIFFING (ESP32) ===")
        addLog("")
        addLog("Starting promiscuous mode...")
        addLog("Command: sniff -c 6")
        addLog("")
        addLog("Capturing:")
        addLog("- Probe requests")
        addLog("- Beacons")
        addLog("- Data frames")
        addLog("- Management frames")
        addLog("")
        addLog("Extracting:")
        addLog("- Device MAC addresses")
        addLog("- SSIDs")
        addLog("- Vendor info")
        addLog("- Signal strength")
        addLog("")
        addLog("Saving to: /sdcard/Download/esp32_capture.pcap")
    }

    private fun scanBLE() {
        addLog("")
        addLog("=== BLE SCAN (ESP32) ===")
        addLog("")
        addLog("Scanning for Bluetooth devices...")
        addLog("Command: ble scan")
        addLog("")
        addLog("Detecting:")
        addLog("- BLE devices")
        addLog("- Classic Bluetooth")
        addLog("- Device names")
        addLog("- MAC addresses")
        addLog("- RSSI values")
        addLog("- Services/UUIDs")
        addLog("")
        addLog("Scan duration: 30 seconds")
        addLog("")
        addLog("Attacks available:")
        addLog("- BLE spam")
        addLog("- Apple BLE spam")
        addLog("- Samsung BLE spam")
        addLog("- Windows Swift Pair spam")
    }

    private fun stopAllProcesses() {
        ProcessManager.stopCurrentProcess(this)
        addLog("")
        addLog("=== ALL PROCESSES STOPPED ===")
        addLog("ESP32 operations halted")
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = logOutput.text.toString()
        logOutput.text = "[$timestamp] $message\n$currentLog"
    }

    override fun onDestroy() {
        super.onDestroy()
        stopAllProcesses()
    }

    override fun onPause() {
        super.onPause()
        ProcessManager.stopCurrentProcess(this)
    }
}
