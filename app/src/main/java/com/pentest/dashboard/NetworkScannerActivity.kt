package com.pentest.dashboard

import android.os.Bundle
import android.widget.ImageView
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton
import com.google.android.material.textfield.TextInputEditText

class NetworkScannerActivity : AppCompatActivity() {

    private lateinit var inputTarget: TextInputEditText
    private lateinit var logOutput: TextView
    private lateinit var btnQuickScan: MaterialButton
    private lateinit var btnDeepScan: MaterialButton
    private lateinit var btnPortScan: MaterialButton
    private lateinit var btnVulnScan: MaterialButton

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_network_scanner)

        initializeViews()
        setupClickListeners()
    }

    private fun initializeViews() {
        inputTarget = findViewById(R.id.inputTarget)
        logOutput = findViewById(R.id.logOutput)
        btnQuickScan = findViewById(R.id.btnQuickScan)
        btnDeepScan = findViewById(R.id.btnDeepScan)
        btnPortScan = findViewById(R.id.btnPortScan)
        btnVulnScan = findViewById(R.id.btnVulnScan)
    }

    private fun setupClickListeners() {
        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnQuickScan.setOnClickListener {
            val target = inputTarget.text.toString()
            if (target.isNotEmpty()) {
                quickScan(target)
            }
        }

        btnDeepScan.setOnClickListener {
            val target = inputTarget.text.toString()
            if (target.isNotEmpty()) {
                deepScan(target)
            }
        }

        btnPortScan.setOnClickListener {
            val target = inputTarget.text.toString()
            if (target.isNotEmpty()) {
                portScan(target)
            }
        }

        btnVulnScan.setOnClickListener {
            val target = inputTarget.text.toString()
            if (target.isNotEmpty()) {
                vulnScan(target)
            }
        }
    }

    private fun quickScan(target: String) {
        addLog("=== QUICK SCAN ===")
        addLog("Target: $target")
        addLog("")

        val command = TermuxIntegration.Network.nmapScan(target, "-sn")
        addLog("Executing: nmap -sn $target")
        addLog("(Host discovery only)")
        addLog("")
        addLog("Command:")
        addLog(command)
    }

    private fun deepScan(target: String) {
        addLog("=== DEEP SCAN ===")
        addLog("Target: $target")
        addLog("")

        val command = TermuxIntegration.Network.nmapScan(target, "-sV -sC -O")
        addLog("Executing: nmap -sV -sC -O $target")
        addLog("(Service detection + OS detection)")
        addLog("")
        addLog("This takes 5-10 minutes")
        addLog("")
        addLog("Command:")
        addLog(command)
    }

    private fun portScan(target: String) {
        addLog("=== PORT SCAN ===")
        addLog("Target: $target")
        addLog("")

        val command = TermuxIntegration.Network.nmapScan(target, "-p- -T4")
        addLog("Executing: nmap -p- -T4 $target")
        addLog("(All 65535 ports)")
        addLog("")
        addLog("This takes 10-20 minutes")
        addLog("")
        addLog("Command:")
        addLog(command)
    }

    private fun vulnScan(target: String) {
        addLog("=== VULNERABILITY SCAN ===")
        addLog("Target: $target")
        addLog("")

        val command = TermuxIntegration.Network.nmapScan(target, "--script vuln")
        addLog("Executing: nmap --script vuln $target")
        addLog("(NSE vulnerability scripts)")
        addLog("")
        addLog("Checking for:")
        addLog("- SQL injection")
        addLog("- XSS vulnerabilities")
        addLog("- RCE exploits")
        addLog("- Known CVEs")
        addLog("")
        addLog("Command:")
        addLog(command)
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = logOutput.text.toString()
        logOutput.text = "[$timestamp] $message\n$currentLog"
    }
}
