package com.pentest.dashboard

import android.os.Bundle
import android.widget.ImageView
import android.widget.TextView
import androidx.appcompat.app.AppCompatActivity
import com.google.android.material.button.MaterialButton
import com.google.android.material.textfield.TextInputEditText

class NetworkScannerActivity : AppCompatActivity() {

    private lateinit var inputTarget: TextInputEditText
    private lateinit var logOutput: TextView
    private lateinit var btnQuickScan: MaterialButton
    private lateinit var btnDeepScan: MaterialButton
    private lateinit var btnPortScan: MaterialButton
    private lateinit var btnVulnScan: MaterialButton

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_network_scanner)

        initializeViews()
        setupClickListeners()
    }

    private fun initializeViews() {
        inputTarget = findViewById(R.id.inputTarget)
        logOutput = findViewById(R.id.logOutput)
        btnQuickScan = findViewById(R.id.btnQuickScan)
        btnDeepScan = findViewById(R.id.btnDeepScan)
        btnPortScan = findViewById(R.id.btnPortScan)
        btnVulnScan = findViewById(R.id.btnVulnScan)
    }

    private fun setupClickListeners() {
        findViewById<ImageView>(R.id.btnBack).setOnClickListener { finish() }

        btnQuickScan.setOnClickListener {
            val target = inputTarget.text.toString()
            if (target.isNotEmpty()) {
                quickScan(target)
            }
        }

        btnDeepScan.setOnClickListener {
            val target = inputTarget.text.toString()
            if (target.isNotEmpty()) {
                deepScan(target)
            }
        }

        btnPortScan.setOnClickListener {
            val target = inputTarget.text.toString()
            if (target.isNotEmpty()) {
                portScan(target)
            }
        }

        btnVulnScan.setOnClickListener {
            val target = inputTarget.text.toString()
            if (target.isNotEmpty()) {
                vulnScan(target)
            }
        }
    }

    private fun quickScan(target: String) {
        // Show parameter dialog for quick scan
        val parameters = listOf(
            ParameterDialog.TARGET_IP.copy(
                label = "Target",
                hint = "IP, subnet (192.168.1.0/24), or hostname",
                defaultValue = target
            ),
            ParameterDialog.NETWORK_INTERFACE.copy(required = false)
        )

        ParameterDialog(this).showDialog(
            title = "Quick Network Scan",
            parameters = parameters
        ) { values ->
            val scanTarget = values["TARGET_IP"] ?: target
            val iface = values["NETWORK_INTERFACE"]?.takeIf { it.isNotEmpty() }

            addLog("=== QUICK SCAN ===")
            addLog("Target: $scanTarget")
            if (iface != null) addLog("Interface: $iface")
            addLog("")

            val ifaceFlag = if (iface != null) "-e $iface" else ""
            val command = "nmap -sn $ifaceFlag $scanTarget"
            addLog("Executing: $command")
            addLog("(Host discovery only)")
            addLog("")
            addLog("Command:")
            addLog(TermuxIntegration.Network.nmapScan(scanTarget, "-sn"))
        }
    }

    private fun deepScan(target: String) {
        val parameters = listOf(
            ParameterDialog.TARGET_IP.copy(defaultValue = target),
            ParameterDialog.Parameter(
                "SCAN_FLAGS",
                "Scan Options",
                "Additional nmap flags",
                defaultValue = "-sV -sC -O",
                required = false
            )
        )

        ParameterDialog(this).showDialog(
            title = "Deep Network Scan",
            parameters = parameters
        ) { values ->
            val scanTarget = values["TARGET_IP"] ?: target
            val flags = values["SCAN_FLAGS"] ?: "-sV -sC -O"

            addLog("=== DEEP SCAN ===")
            addLog("Target: $scanTarget")
            addLog("Flags: $flags")
            addLog("")

            val command = TermuxIntegration.Network.nmapScan(scanTarget, flags)
            addLog("Executing: nmap $flags $scanTarget")
            addLog("(Service detection + OS detection)")
            addLog("")
            addLog("This takes 5-10 minutes")
            addLog("")
            addLog("Command:")
            addLog(command)
        }
    }

    private fun portScan(target: String) {
        val parameters = listOf(
            ParameterDialog.TARGET_IP.copy(defaultValue = target),
            ParameterDialog.Parameter(
                "PORT_RANGE",
                "Port Range",
                "Ports to scan (e.g., 1-65535, 80,443, top 1000)",
                defaultValue = "-",
                required = true
            ),
            ParameterDialog.Parameter(
                "TIMING",
                "Timing Template",
                "T0-T5 (0=paranoid, 5=insane)",
                defaultValue = "4",
                required = true
            )
        )

        ParameterDialog(this).showDialog(
            title = "Port Scan Configuration",
            parameters = parameters
        ) { values ->
            val scanTarget = values["TARGET_IP"] ?: target
            val portRange = values["PORT_RANGE"] ?: "-"
            val timing = values["TIMING"] ?: "4"

            addLog("=== PORT SCAN ===")
            addLog("Target: $scanTarget")
            addLog("Ports: $portRange")
            addLog("Timing: T$timing")
            addLog("")

            val flags = "-p$portRange -T$timing"
            val command = TermuxIntegration.Network.nmapScan(scanTarget, flags)
            addLog("Executing: nmap $flags $scanTarget")
            addLog("(Port scanning)")
            addLog("")
            addLog("This takes 10-20 minutes for full range")
            addLog("")
            addLog("Command:")
            addLog(command)
        }
    }

    private fun vulnScan(target: String) {
        val parameters = listOf(
            ParameterDialog.TARGET_IP.copy(defaultValue = target),
            ParameterDialog.Parameter(
                "VULN_CATEGORY",
                "Vulnerability Category",
                "vuln, exploit, malware, or specific CVE",
                defaultValue = "vuln",
                required = true
            )
        )

        ParameterDialog(this).showDialog(
            title = "Vulnerability Scan",
            parameters = parameters
        ) { values ->
            val scanTarget = values["TARGET_IP"] ?: target
            val category = values["VULN_CATEGORY"] ?: "vuln"

            addLog("=== VULNERABILITY SCAN ===")
            addLog("Target: $scanTarget")
            addLog("Category: $category")
            addLog("")

            val command = TermuxIntegration.Network.nmapScan(scanTarget, "--script $category")
            addLog("Executing: nmap --script $category $scanTarget")
            addLog("(NSE vulnerability scripts)")
            addLog("")
            addLog("Checking for:")
            addLog("- SQL injection")
            addLog("- XSS vulnerabilities")
            addLog("- RCE exploits")
            addLog("- Known CVEs")
            addLog("")
            addLog("Command:")
            addLog(command)
        }
    }

    private fun addLog(message: String) {
        val timestamp = java.text.SimpleDateFormat("HH:mm:ss", java.util.Locale.US)
            .format(java.util.Date())
        val currentLog = logOutput.text.toString()
        logOutput.text = "[$timestamp] $message\n$currentLog"
    }
}
