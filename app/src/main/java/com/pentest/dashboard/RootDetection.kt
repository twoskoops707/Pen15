package com.pentest.dashboard

import android.content.Context
import android.content.pm.PackageManager
import java.io.File

/**
 * Root Detection and Management Utility
 *
 * Detects if device is rooted and provides warnings for features
 * that require root access.
 */
object RootDetection {

    /**
     * Check if device is rooted
     */
    fun isDeviceRooted(): Boolean {
        return checkRootMethod1() || checkRootMethod2() || checkRootMethod3()
    }

    /**
     * Check for su binary in common locations
     */
    private fun checkRootMethod1(): Boolean {
        val paths = arrayOf(
            "/system/app/Superuser.apk",
            "/sbin/su",
            "/system/bin/su",
            "/system/xbin/su",
            "/data/local/xbin/su",
            "/data/local/bin/su",
            "/system/sd/xbin/su",
            "/system/bin/failsafe/su",
            "/data/local/su",
            "/su/bin/su"
        )
        for (path in paths) {
            if (File(path).exists()) return true
        }
        return false
    }

    /**
     * Check for root management apps
     */
    private fun checkRootMethod2(): Boolean {
        val packages = arrayOf(
            "com.noshufou.android.su",
            "com.noshufou.android.su.elite",
            "eu.chainfire.supersu",
            "com.koushikdutta.superuser",
            "com.thirdparty.superuser",
            "com.yellowes.su",
            "com.topjohnwu.magisk"
        )

        return packages.any { packageExists(it) }
    }

    /**
     * Try to execute su command
     */
    private fun checkRootMethod3(): Boolean {
        return try {
            Runtime.getRuntime().exec("su")
            true
        } catch (e: Exception) {
            false
        }
    }

    /**
     * Check if package exists
     */
    private fun packageExists(packageName: String): Boolean {
        return try {
            Class.forName("android.content.pm.PackageManager")
                .getDeclaredField("GET_ACTIVITIES")
                .getInt(null)
            true
        } catch (e: Exception) {
            false
        }
    }

    /**
     * Features that require root access
     */
    enum class RootFeature(val displayName: String, val description: String) {
        WIFI_MONITOR_MODE(
            "WiFi Monitor Mode",
            "Requires root to enable monitor mode (airmon-ng)"
        ),
        PACKET_CAPTURE(
            "Packet Capture",
            "Requires root to capture packets (tcpdump, airodump-ng)"
        ),
        ARP_SPOOFING(
            "ARP Spoofing",
            "Requires root to modify ARP tables (arpspoof)"
        ),
        DEAUTH_ATTACK(
            "Deauth Attack",
            "Requires root to send deauth packets (aireplay-ng)"
        ),
        SSL_STRIP(
            "SSL Strip",
            "Requires root to modify iptables rules"
        ),
        IPTABLES(
            "IPTables",
            "Requires root to modify firewall rules"
        ),
        NETWORK_INJECTION(
            "Network Injection",
            "Requires root to inject packets"
        )
    }

    /**
     * Get root warning message
     */
    fun getRootWarningMessage(feature: RootFeature): String {
        return """
            ‚ö†Ô∏è ROOT REQUIRED

            Feature: ${feature.displayName}
            Requirement: ${feature.description}

            This feature requires a rooted device with Magisk or SuperSU installed.

            ALTERNATIVES:
            ‚Ä¢ Use Termux with proot-distro (limited functionality)
            ‚Ä¢ Use an external device (Flipper Zero, WiFi Pineapple)
            ‚Ä¢ Use a rooted Android emulator for testing

            Non-root features that still work:
            ‚úì Flipper Zero integration (via USB/Bluetooth)
            ‚úì Network scanning (nmap without -sS)
            ‚úì Exploit database browsing
            ‚úì Script building and export
            ‚úì Hash cracking (CPU only, no GPU)
            ‚úì OSINT tools (TheHarvester, Sublist3r)
        """.trimIndent()
    }

    /**
     * Get non-root alternatives message
     */
    fun getNonRootAlternatives(): String {
        return """
            üîß NON-ROOT PENTESTING OPTIONS

            Your device is not rooted, but you can still:

            1. FLIPPER ZERO INTEGRATION ‚úì
               ‚Ä¢ Connect via USB-C or Bluetooth
               ‚Ä¢ Use Flipper for WiFi, RFID, NFC, IR
               ‚Ä¢ All attacks run on Flipper hardware

            2. EXTERNAL HARDWARE ‚úì
               ‚Ä¢ WiFi Pineapple (WiFi attacks)
               ‚Ä¢ Proxmark3 (RFID/NFC)
               ‚Ä¢ HackRF One (SDR)
               ‚Ä¢ RTL-SDR (reception only)

            3. TERMUX TOOLS (Limited) ‚ö†Ô∏è
               ‚Ä¢ nmap (some scan types)
               ‚Ä¢ sqlmap
               ‚Ä¢ nikto
               ‚Ä¢ dirb
               ‚Ä¢ OSINT tools (whois, dig, TheHarvester)
               ‚Ä¢ Hash cracking (hashcat CPU mode)

            4. REMOTE ATTACKS ‚úì
               ‚Ä¢ Exploit database search
               ‚Ä¢ Payload generation
               ‚Ä¢ Script building
               ‚Ä¢ Network enumeration

            RECOMMENDATION:
            For full pentesting capabilities, use this app with:
            ‚Ä¢ Flipper Zero (recommended for wireless attacks)
            ‚Ä¢ Rooted device or Android emulator
            ‚Ä¢ External pentesting hardware
        """.trimIndent()
    }

    /**
     * Check if Termux has root access
     */
    fun checkTermuxRoot(): Boolean {
        return try {
            val process = Runtime.getRuntime().exec(arrayOf("su", "-c", "echo test"))
            val result = process.inputStream.bufferedReader().readText()
            process.waitFor()
            result.trim() == "test"
        } catch (e: Exception) {
            false
        }
    }

    /**
     * Get sanitized command (removes sudo for non-root)
     */
    fun sanitizeCommand(command: String, removeIfNoRoot: Boolean = false): String {
        if (isDeviceRooted()) {
            return command
        }

        return if (removeIfNoRoot) {
            command.replace(Regex("sudo\\s+"), "")
                .replace(Regex("su\\s+-c\\s+"), "")
        } else {
            command
        }
    }

    /**
     * Features available without root
     */
    fun getNonRootFeatures(): List<String> {
        return listOf(
            "Flipper Zero USB/Bluetooth Control",
            "Network Scanning (basic)",
            "Exploit Database Search",
            "Script Builder & Export",
            "Hash Cracking (CPU only)",
            "OSINT Tools (whois, dig, DNS enum)",
            "Subdomain Enumeration",
            "Email Harvesting",
            "Port Scanning (connect scan)",
            "Web Vulnerability Scanning",
            "Payload Generation",
            "Documentation & Cheat Sheets"
        )
    }

    /**
     * Features requiring root
     */
    fun getRootRequiredFeatures(): List<String> {
        return listOf(
            "WiFi Monitor Mode",
            "Packet Injection",
            "ARP Spoofing/Poisoning",
            "WiFi Deauth Attacks",
            "Packet Capture (raw sockets)",
            "SSL Strip",
            "IPTables Manipulation",
            "Deep Packet Inspection",
            "Network Traffic Interception",
            "Kernel Module Loading"
        )
    }
}
