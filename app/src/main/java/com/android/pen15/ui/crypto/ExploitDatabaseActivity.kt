package com.android.pen15.ui.crypto

import android.os.Bundle
import androidx.lifecycle.lifecycleScope
import com.android.pen15.R
import com.android.pen15.ui.base.BaseToolActivity
import com.android.pen15.utils.ToolChecker
import kotlinx.coroutines.launch

class ExploitDatabaseActivity : BaseToolActivity() {

    private var toolAvailable = false

    // Online exploit database resources
    private val exploitResources = mapOf(
        "Exploit-DB" to "https://www.exploit-db.com/",
        "Metasploit" to "https://github.com/rapid7/metasploit-framework",
        "PayloadAllTheThings" to "https://github.com/swisskyrepo/PayloadsAllTheThings",
        "SecLists" to "https://github.com/danielmiessler/SecLists",
        "GHDB" to "https://www.exploit-db.com/google-hacking-database"
    )

    override fun getToolName() = "Exploit Database"
    override fun getLayoutResource() = R.layout.activity_generic_tool
    override fun onToolExecute() { searchExploits() }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        logMessage("Exploit Database Search", includeTimestamp = false)
        logMessage("Search for public exploits and PoCs", includeTimestamp = false)
        logMessage("")

        // Check searchsploit availability
        lifecycleScope.launch {
            toolAvailable = ToolChecker.checkToolAvailable(this@ExploitDatabaseActivity, "searchsploit")

            if (!toolAvailable) {
                logMessage("⚠️ searchsploit not installed", includeTimestamp = false)
                logMessage("")
                logMessage("Install exploitdb:", includeTimestamp = false)
                logMessage("pkg install exploitdb", includeTimestamp = false)
                logMessage("")
                logMessage("Alternative: Use online resources below", includeTimestamp = false)
            } else {
                logMessage("✓ searchsploit is available", includeTimestamp = false)
                logMessage("")
                logMessage("Usage: Click Execute to update database", includeTimestamp = false)
            }

            logMessage("")
            logMessage("--- Online Exploit Resources ---", includeTimestamp = false)
            exploitResources.forEach { (name, url) ->
                logMessage("• $name", includeTimestamp = false)
                logMessage("  $url", includeTimestamp = false)
            }
        }
    }

    private fun searchExploits() {
        clearOutput()
        logMessage("Exploit Database Search")
        logMessage("")

        if (toolAvailable) {
            logMessage("Updating searchsploit database...")
            logMessage("")
            executeCommandWithProgress("searchsploit -u", useTermux = true)

            logMessage("")
            logMessage("✓ Database updated!")
            logMessage("")
            logMessage("Search examples:")
            logMessage("searchsploit apache", includeTimestamp = false)
            logMessage("searchsploit wordpress plugin", includeTimestamp = false)
            logMessage("searchsploit -t oracle windows", includeTimestamp = false)
        } else {
            logMessage("Searchsploit not available.", includeTimestamp = false)
            logMessage("")
            logMessage("Use online resources:", includeTimestamp = false)
        }

        logMessage("")
        logMessage("--- Quick Access Links ---", includeTimestamp = false)
        logMessage("")
        logMessage("Exploit-DB:", includeTimestamp = false)
        logMessage("${exploitResources["Exploit-DB"]}", includeTimestamp = false)
        logMessage("")
        logMessage("Metasploit Framework:", includeTimestamp = false)
        logMessage("${exploitResources["Metasploit"]}", includeTimestamp = false)
        logMessage("")
        logMessage("PayloadAllTheThings:", includeTimestamp = false)
        logMessage("${exploitResources["PayloadAllTheThings"]}", includeTimestamp = false)
        logMessage("")
        logMessage("Google Hacking Database:", includeTimestamp = false)
        logMessage("${exploitResources["GHDB"]}", includeTimestamp = false)
    }
}
